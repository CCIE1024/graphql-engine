<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hasura.Server.SchemaUpdate</span><span>
</span><span id="line-5"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#startSchemaSyncListenerThread"><span class="hs-identifier">startSchemaSyncListenerThread</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#startSchemaSyncProcessorThread"><span class="hs-identifier">startSchemaSyncProcessorThread</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#ThreadType"><span class="hs-identifier">ThreadType</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#ThreadError"><span class="hs-identifier">ThreadError</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span class="hs-keyword">where</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Control.Concurrent.Extended.html"><span class="hs-identifier">Control.Concurrent.Extended</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">STM</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Immortal</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Immortal</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Loops</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">L</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Control</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadBaseControl</span></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Control.Monad.Trans.Managed.html"><span class="hs-identifier">Control.Monad.Trans.Managed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Trans.Managed.html#ManagedT"><span class="hs-identifier">ManagedT</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson.Casing</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson.TH</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HM</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashSet</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HS</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Database.PG.Query</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Q</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Logging.html"><span class="hs-identifier">Hasura.Logging</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Metadata.Class.html"><span class="hs-identifier">Hasura.Metadata.Class</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Prelude.html"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.html#runCacheRWT"><span class="hs-identifier">runCacheRWT</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Catalog.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema.Catalog</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Run.html"><span class="hs-identifier">Hasura.RQL.Types.Run</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html"><span class="hs-identifier">Hasura.RQL.Types.SchemaCache</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html"><span class="hs-identifier">Hasura.RQL.Types.SchemaCache.Build</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html"><span class="hs-identifier">Hasura.RQL.Types.Source</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Logging.html"><span class="hs-identifier">Hasura.Server.Logging</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.SchemaCacheRef.html"><span class="hs-identifier">Hasura.Server.SchemaCacheRef</span></a></span><span>
</span><span id="line-36"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Server.SchemaCacheRef.html#SchemaCacheRef"><span class="hs-identifier">SchemaCacheRef</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>    </span><span class="annot"><a href="Hasura.Server.SchemaCacheRef.html#readSchemaCacheRef"><span class="hs-identifier">readSchemaCacheRef</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><a href="Hasura.Server.SchemaCacheRef.html#withSchemaCacheUpdate"><span class="hs-identifier">withSchemaCacheUpdate</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html"><span class="hs-identifier">Hasura.Server.Types</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Session.html"><span class="hs-identifier">Hasura.Session</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.HTTP.Client</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HTTP</span></span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span class="hs-keyword">data</span><span> </span><span id="ThreadType"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#ThreadType"><span class="hs-identifier hs-var">ThreadType</span></a></span></span><span>
</span><span id="line-45"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="TTListener"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#TTListener"><span class="hs-identifier hs-var">TTListener</span></a></span></span><span>
</span><span id="line-46"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TTProcessor"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#TTProcessor"><span class="hs-identifier hs-var">TTProcessor</span></a></span></span><span>
</span><span id="line-47"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621689425942"><span id="local-6989586621689425944"><span class="annot"><span class="annottext">ThreadType -&gt; ThreadType -&gt; Bool
(ThreadType -&gt; ThreadType -&gt; Bool)
-&gt; (ThreadType -&gt; ThreadType -&gt; Bool) -&gt; Eq ThreadType
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: ThreadType -&gt; ThreadType -&gt; Bool
$c/= :: ThreadType -&gt; ThreadType -&gt; Bool
== :: ThreadType -&gt; ThreadType -&gt; Bool
$c== :: ThreadType -&gt; ThreadType -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621689425936"><span id="local-6989586621689425939"><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#ThreadType"><span class="hs-identifier hs-type">ThreadType</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-50"></span><span>  </span><span id="local-6989586621689425934"><span class="annot"><span class="annottext">show :: ThreadType -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">show</span></span></span><span> </span><span class="annot"><span class="annottext">ThreadType
</span><a href="Hasura.Server.SchemaUpdate.html#TTListener"><span class="hs-identifier hs-var">TTListener</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;listener&quot;</span></span><span>
</span><span id="line-51"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ThreadType
</span><a href="Hasura.Server.SchemaUpdate.html#TTProcessor"><span class="hs-identifier hs-var">TTProcessor</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;processor&quot;</span></span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span class="hs-keyword">data</span><span> </span><span id="SchemaSyncThreadLog"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#SchemaSyncThreadLog"><span class="hs-identifier hs-var">SchemaSyncThreadLog</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SchemaSyncThreadLog"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#SchemaSyncThreadLog"><span class="hs-identifier hs-var">SchemaSyncThreadLog</span></a></span></span><span>
</span><span id="line-54"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="suelLogLevel"><span class="annot"><span class="annottext">SchemaSyncThreadLog -&gt; LogLevel
</span><a href="Hasura.Server.SchemaUpdate.html#suelLogLevel"><span class="hs-identifier hs-var hs-var">suelLogLevel</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.Logging.html#LogLevel"><span class="hs-identifier hs-type">LogLevel</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-55"></span><span>    </span><span id="suelThreadType"><span class="annot"><span class="annottext">SchemaSyncThreadLog -&gt; ThreadType
</span><a href="Hasura.Server.SchemaUpdate.html#suelThreadType"><span class="hs-identifier hs-var hs-var">suelThreadType</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#ThreadType"><span class="hs-identifier hs-type">ThreadType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-56"></span><span>    </span><span id="suelInfo"><span class="annot"><span class="annottext">SchemaSyncThreadLog -&gt; Value
</span><a href="Hasura.Server.SchemaUpdate.html#suelInfo"><span class="hs-identifier hs-var hs-var">suelInfo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span>
</span><span id="line-57"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-58"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621689425923"><span id="local-6989586621689425925"><span id="local-6989586621689425927"><span class="annot"><span class="annottext">Int -&gt; SchemaSyncThreadLog -&gt; ShowS
[SchemaSyncThreadLog] -&gt; ShowS
SchemaSyncThreadLog -&gt; String
(Int -&gt; SchemaSyncThreadLog -&gt; ShowS)
-&gt; (SchemaSyncThreadLog -&gt; String)
-&gt; ([SchemaSyncThreadLog] -&gt; ShowS)
-&gt; Show SchemaSyncThreadLog
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [SchemaSyncThreadLog] -&gt; ShowS
$cshowList :: [SchemaSyncThreadLog] -&gt; ShowS
show :: SchemaSyncThreadLog -&gt; String
$cshow :: SchemaSyncThreadLog -&gt; String
showsPrec :: Int -&gt; SchemaSyncThreadLog -&gt; ShowS
$cshowsPrec :: Int -&gt; SchemaSyncThreadLog -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689425919"><span id="local-6989586621689425921"><span class="annot"><span class="annottext">SchemaSyncThreadLog -&gt; SchemaSyncThreadLog -&gt; Bool
(SchemaSyncThreadLog -&gt; SchemaSyncThreadLog -&gt; Bool)
-&gt; (SchemaSyncThreadLog -&gt; SchemaSyncThreadLog -&gt; Bool)
-&gt; Eq SchemaSyncThreadLog
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: SchemaSyncThreadLog -&gt; SchemaSyncThreadLog -&gt; Bool
$c/= :: SchemaSyncThreadLog -&gt; SchemaSyncThreadLog -&gt; Bool
== :: SchemaSyncThreadLog -&gt; SchemaSyncThreadLog -&gt; Bool
$c== :: SchemaSyncThreadLog -&gt; SchemaSyncThreadLog -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621689425912"><span id="local-6989586621689425914"><span id="local-6989586621689425916"><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#SchemaSyncThreadLog"><span class="hs-identifier hs-type">SchemaSyncThreadLog</span></a></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-61"></span><span>  </span><span id="local-6989586621689425910"><span class="annot"><span class="annottext">toJSON :: SchemaSyncThreadLog -&gt; Value
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">toJSON</span></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#SchemaSyncThreadLog"><span class="hs-identifier hs-type">SchemaSyncThreadLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621689425908"><span class="annot"><span class="annottext">ThreadType
</span><a href="#local-6989586621689425908"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621689425907"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621689425907"><span class="hs-identifier hs-var">info</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-62"></span><span>    </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">object</span></span><span>
</span><span id="line-63"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;thread_type&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; String -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">ThreadType -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ThreadType
</span><a href="#local-6989586621689425908"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-64"></span><span>        </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;info&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Value -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621689425907"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-65"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.Logging.html#ToEngineLog"><span class="hs-identifier hs-type">ToEngineLog</span></a></span><span> </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#SchemaSyncThreadLog"><span class="hs-identifier hs-type">SchemaSyncThreadLog</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-68"></span><span>  </span><span id="local-6989586621689425901"><span class="annot"><span class="annottext">toEngineLog :: SchemaSyncThreadLog -&gt; (LogLevel, EngineLogType Hasura, Value)
</span><a href="Hasura.Logging.html#toEngineLog"><span class="hs-identifier hs-var hs-var hs-var hs-var">toEngineLog</span></a></span></span><span> </span><span id="local-6989586621689425899"><span class="annot"><span class="annottext">SchemaSyncThreadLog
</span><a href="#local-6989586621689425899"><span class="hs-identifier hs-var">threadLog</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SchemaSyncThreadLog -&gt; LogLevel
</span><a href="Hasura.Server.SchemaUpdate.html#suelLogLevel"><span class="hs-identifier hs-var hs-var">suelLogLevel</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaSyncThreadLog
</span><a href="#local-6989586621689425899"><span class="hs-identifier hs-var">threadLog</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InternalLogTypes -&gt; EngineLogType Hasura
</span><a href="Hasura.Logging.html#ELTInternal"><span class="hs-identifier hs-var">ELTInternal</span></a></span><span> </span><span class="annot"><span class="annottext">InternalLogTypes
</span><a href="Hasura.Logging.html#ILTSchemaSyncThread"><span class="hs-identifier hs-var">ILTSchemaSyncThread</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SchemaSyncThreadLog -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">SchemaSyncThreadLog
</span><a href="#local-6989586621689425899"><span class="hs-identifier hs-var">threadLog</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span class="hs-keyword">data</span><span> </span><span id="ThreadError"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#ThreadError"><span class="hs-identifier hs-var">ThreadError</span></a></span></span><span>
</span><span id="line-72"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="TEPayloadParse"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#TEPayloadParse"><span class="hs-identifier hs-var">TEPayloadParse</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-73"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TEQueryError"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#TEQueryError"><span class="hs-identifier hs-var">TEQueryError</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span class="hs-special">$(</span><span> </span><span id="local-6989586621689425887"><span id="local-6989586621689425889"><span id="local-6989586621689425891"><span id="local-6989586621689425893"><span class="hs-identifier">deriveToJSON</span><span>
</span><span id="line-76"></span><span>     </span><span class="hs-identifier">defaultOptions</span><span>
</span><span id="line-77"></span><span>       </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">constructorTagModifier</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">snakeCase</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">drop</span><span> </span><span class="hs-number">2</span><span class="hs-special">,</span><span>
</span><span id="line-78"></span><span>         </span><span class="hs-identifier">sumEncoding</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">TaggedObject</span><span> </span><span class="hs-string">&quot;type&quot;</span><span> </span><span class="hs-string">&quot;info&quot;</span><span>
</span><span id="line-79"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-80"></span><span>     </span><span class="hs-special">''</span><span class="hs-identifier">ThreadError</span></span></span></span></span><span>
</span><span id="line-81"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span>
</span><span id="line-83"></span><span id="local-6989586621689426071"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#logThreadStarted"><span class="hs-identifier hs-type">logThreadStarted</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-84"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689426071"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-85"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-86"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#InstanceId"><span class="hs-identifier hs-type">InstanceId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-87"></span><span>  </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#ThreadType"><span class="hs-identifier hs-type">ThreadType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-88"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Immortal.Thread</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-89"></span><span>  </span><span class="annot"><a href="#local-6989586621689426071"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-90"></span><span id="logThreadStarted"><span class="annot"><span class="annottext">logThreadStarted :: Logger Hasura -&gt; InstanceId -&gt; ThreadType -&gt; Thread -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logThreadStarted"><span class="hs-identifier hs-var hs-var">logThreadStarted</span></a></span></span><span> </span><span id="local-6989586621689425884"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425884"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621689425883"><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621689425883"><span class="hs-identifier hs-var">instanceId</span></a></span></span><span> </span><span id="local-6989586621689425882"><span class="annot"><span class="annottext">ThreadType
</span><a href="#local-6989586621689425882"><span class="hs-identifier hs-var">threadType</span></a></span></span><span> </span><span id="local-6989586621689425881"><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621689425881"><span class="hs-identifier hs-var">thread</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-91"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689425880"><span class="annot"><span class="annottext">msg :: Text
</span><a href="#local-6989586621689425880"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ThreadType -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="Hasura.Prelude.html#tshow"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadType
</span><a href="#local-6989586621689425882"><span class="hs-identifier hs-var">threadType</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; thread started&quot;</span></span><span>
</span><span id="line-92"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425884"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(StartupLog -&gt; m ()) -&gt; StartupLog -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-93"></span><span>        </span><span class="annot"><span class="annottext">LogLevel -&gt; Text -&gt; Value -&gt; StartupLog
</span><a href="Hasura.Server.Logging.html#StartupLog"><span class="hs-identifier hs-var">StartupLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;schema-sync&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; StartupLog) -&gt; Value -&gt; StartupLog
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-94"></span><span>          </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">object</span></span><span>
</span><span id="line-95"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;instance_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Text -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">InstanceId -&gt; Text
</span><a href="Hasura.Server.Types.html#getInstanceId"><span class="hs-identifier hs-var hs-var">getInstanceId</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621689425883"><span class="hs-identifier hs-var">instanceId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-96"></span><span>              </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;thread_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; String -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">ThreadId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Thread -&gt; ThreadId
</span><span class="hs-identifier hs-var">Immortal.threadId</span></span><span> </span><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621689425881"><span class="hs-identifier hs-var">thread</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-97"></span><span>              </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;message&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Text -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689425880"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-98"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span class="hs-comment">{- Note [Schema Cache Sync]
~~~~~~~~~~~~~~~~~~~~~~~~~~~

When multiple graphql-engine instances are serving on same metadata storage,
each instance should have schema cache in sync with latest metadata. Somehow
all instances should communicate each other when any request has modified metadata.

We track the metadata schema version in postgres and poll for this
value in a thread.  When the schema version has changed, the instance
will update its local metadata schema and remove any invalidated schema cache data.

The following steps take place when an API request made to update metadata:

1. After handling the request we insert the new metadata schema json
   into a postgres tablealong with a schema version.

2. On start up, before initialising schema cache, an async thread is
   invoked to continuously poll the Postgres notifications table for
   the latest metadata schema version. The schema version is pushed to
   a shared `TMVar`.

3. Before starting API server, another async thread is invoked to
   process events pushed by the listener thread via the `TMVar`. If
   the instance's schema version is not current with the freshly
   updated TMVar version then we update the local metadata.

Why we need two threads if we can capture and reload schema cache in a single thread?

If we want to implement schema sync in a single async thread we have to invoke the same
after initialising schema cache. We may loose events that published after schema cache
init and before invoking the thread. In such case, schema cache is not in sync with metadata.
So we choose two threads in which one will start listening before schema cache init and the
other after it.

What happens if listen connection to Postgres is lost?

Listener thread will keep trying to establish connection to Postgres for every one second.
Once connection established, it pushes @'SSEListenStart' event with time. We aren't sure
about any metadata modify requests made in meanwhile. So we reload schema cache unconditionally
if listen started after schema cache init start time.

-}</span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span class="hs-comment">-- | An async thread which listen to Postgres notify to enable schema syncing</span><span>
</span><span id="line-144"></span><span class="hs-comment">-- See Note [Schema Cache Sync]</span><span>
</span><span id="line-145"></span><span id="local-6989586621689425873"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#startSchemaSyncListenerThread"><span class="hs-identifier hs-type">startSchemaSyncListenerThread</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-146"></span><span>  </span><span class="annot"><a href="Control.Concurrent.Extended.html#ForkableMonadIO"><span class="hs-identifier hs-type">C.ForkableMonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689425873"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-147"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-148"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Q.PGPool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-149"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#InstanceId"><span class="hs-identifier hs-type">InstanceId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-150"></span><span>  </span><span class="annot"><a href="Data.Time.Clock.Units.html#Milliseconds"><span class="hs-identifier hs-type">Milliseconds</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-151"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">STM.TMVar</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataResourceVersion"><span class="hs-identifier hs-type">MetadataResourceVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-152"></span><span>  </span><span class="annot"><a href="Control.Monad.Trans.Managed.html#ManagedT"><span class="hs-identifier hs-type">ManagedT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689425873"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Immortal.Thread</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-153"></span><span id="startSchemaSyncListenerThread"><span class="annot"><span class="annottext">startSchemaSyncListenerThread :: Logger Hasura
-&gt; PGPool
-&gt; InstanceId
-&gt; Milliseconds
-&gt; TMVar MetadataResourceVersion
-&gt; ManagedT m Thread
</span><a href="Hasura.Server.SchemaUpdate.html#startSchemaSyncListenerThread"><span class="hs-identifier hs-var hs-var">startSchemaSyncListenerThread</span></a></span></span><span> </span><span id="local-6989586621689425872"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425872"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621689425871"><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621689425871"><span class="hs-identifier hs-var">pool</span></a></span></span><span> </span><span id="local-6989586621689425870"><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621689425870"><span class="hs-identifier hs-var">instanceId</span></a></span></span><span> </span><span id="local-6989586621689425869"><span class="annot"><span class="annottext">Milliseconds
</span><a href="#local-6989586621689425869"><span class="hs-identifier hs-var">interval</span></a></span></span><span> </span><span id="local-6989586621689425868"><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
</span><a href="#local-6989586621689425868"><span class="hs-identifier hs-var">metaVersionRef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-154"></span><span>  </span><span class="hs-comment">-- Start listener thread</span><span>
</span><span id="line-155"></span><span>  </span><span id="local-6989586621689425867"><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621689425867"><span class="hs-identifier hs-var">listenerThread</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-156"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Logger Hasura -&gt; m Void -&gt; ManagedT m Thread
forall (m :: * -&gt; *).
ForkableMonadIO m =&gt;
String -&gt; Logger Hasura -&gt; m Void -&gt; ManagedT m Thread
</span><a href="Control.Concurrent.Extended.html#forkManagedT"><span class="hs-identifier hs-var">C.forkManagedT</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SchemeUpdate.listener&quot;</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425872"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(m Void -&gt; ManagedT m Thread) -&gt; m Void -&gt; ManagedT m Thread
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-157"></span><span>      </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; PGPool
-&gt; TMVar MetadataResourceVersion
-&gt; Milliseconds
-&gt; m Void
forall (m :: * -&gt; *) void.
MonadIO m =&gt;
Logger Hasura
-&gt; PGPool
-&gt; TMVar MetadataResourceVersion
-&gt; Milliseconds
-&gt; m void
</span><a href="Hasura.Server.SchemaUpdate.html#listener"><span class="hs-identifier hs-var">listener</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425872"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621689425871"><span class="hs-identifier hs-var">pool</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
</span><a href="#local-6989586621689425868"><span class="hs-identifier hs-var">metaVersionRef</span></a></span><span> </span><span class="annot"><span class="annottext">Milliseconds
</span><a href="#local-6989586621689425869"><span class="hs-identifier hs-var">interval</span></a></span><span>
</span><span id="line-158"></span><span>  </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; InstanceId -&gt; ThreadType -&gt; Thread -&gt; ManagedT m ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
Logger Hasura -&gt; InstanceId -&gt; ThreadType -&gt; Thread -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logThreadStarted"><span class="hs-identifier hs-var">logThreadStarted</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425872"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621689425870"><span class="hs-identifier hs-var">instanceId</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadType
</span><a href="Hasura.Server.SchemaUpdate.html#TTListener"><span class="hs-identifier hs-var">TTListener</span></a></span><span> </span><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621689425867"><span class="hs-identifier hs-var">listenerThread</span></a></span><span>
</span><span id="line-159"></span><span>  </span><span class="annot"><span class="annottext">Thread -&gt; ManagedT m Thread
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621689425867"><span class="hs-identifier hs-var">listenerThread</span></a></span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span class="hs-comment">-- | An async thread which processes the schema sync events</span><span>
</span><span id="line-162"></span><span class="hs-comment">-- See Note [Schema Cache Sync]</span><span>
</span><span id="line-163"></span><span id="local-6989586621689425864"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#startSchemaSyncProcessorThread"><span class="hs-identifier hs-type">startSchemaSyncProcessorThread</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-164"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Control.Concurrent.Extended.html#ForkableMonadIO"><span class="hs-identifier hs-type">C.ForkableMonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689425864"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-165"></span><span>    </span><span class="annot"><a href="Hasura.Metadata.Class.html#MonadMetadataStorage"><span class="hs-identifier hs-type">MonadMetadataStorage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Metadata.Class.html#MetadataStorageT"><span class="hs-identifier hs-type">MetadataStorageT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689425864"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-166"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MonadResolveSource"><span class="hs-identifier hs-type">MonadResolveSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689425864"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-167"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-168"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-169"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">HTTP.Manager</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-170"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">STM.TMVar</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataResourceVersion"><span class="hs-identifier hs-type">MetadataResourceVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-171"></span><span>  </span><span class="annot"><a href="Hasura.Server.SchemaCacheRef.html#SchemaCacheRef"><span class="hs-identifier hs-type">SchemaCacheRef</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-172"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#InstanceId"><span class="hs-identifier hs-type">InstanceId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-173"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#ServerConfigCtx"><span class="hs-identifier hs-type">ServerConfigCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-174"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">STM.TVar</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-175"></span><span>  </span><span class="annot"><a href="Control.Monad.Trans.Managed.html#ManagedT"><span class="hs-identifier hs-type">ManagedT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689425864"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Immortal.Thread</span></span></span><span>
</span><span id="line-176"></span><span id="startSchemaSyncProcessorThread"><span class="annot"><span class="annottext">startSchemaSyncProcessorThread :: Logger Hasura
-&gt; Manager
-&gt; TMVar MetadataResourceVersion
-&gt; SchemaCacheRef
-&gt; InstanceId
-&gt; ServerConfigCtx
-&gt; TVar Bool
-&gt; ManagedT m Thread
</span><a href="Hasura.Server.SchemaUpdate.html#startSchemaSyncProcessorThread"><span class="hs-identifier hs-var hs-var">startSchemaSyncProcessorThread</span></a></span></span><span>
</span><span id="line-177"></span><span>  </span><span id="local-6989586621689425863"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425863"><span class="hs-identifier hs-var">logger</span></a></span></span><span>
</span><span id="line-178"></span><span>  </span><span id="local-6989586621689425862"><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621689425862"><span class="hs-identifier hs-var">httpMgr</span></a></span></span><span>
</span><span id="line-179"></span><span>  </span><span id="local-6989586621689425861"><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
</span><a href="#local-6989586621689425861"><span class="hs-identifier hs-var">schemaSyncEventRef</span></a></span></span><span>
</span><span id="line-180"></span><span>  </span><span id="local-6989586621689425860"><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621689425860"><span class="hs-identifier hs-var">cacheRef</span></a></span></span><span>
</span><span id="line-181"></span><span>  </span><span id="local-6989586621689425859"><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621689425859"><span class="hs-identifier hs-var">instanceId</span></a></span></span><span>
</span><span id="line-182"></span><span>  </span><span id="local-6989586621689425858"><span class="annot"><span class="annottext">ServerConfigCtx
</span><a href="#local-6989586621689425858"><span class="hs-identifier hs-var">serverConfigCtx</span></a></span></span><span>
</span><span id="line-183"></span><span>  </span><span id="local-6989586621689425857"><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621689425857"><span class="hs-identifier hs-var">logTVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-184"></span><span>    </span><span class="hs-comment">-- Start processor thread</span><span>
</span><span id="line-185"></span><span>    </span><span id="local-6989586621689425856"><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621689425856"><span class="hs-identifier hs-var">processorThread</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-186"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; Logger Hasura -&gt; m Void -&gt; ManagedT m Thread
forall (m :: * -&gt; *).
ForkableMonadIO m =&gt;
String -&gt; Logger Hasura -&gt; m Void -&gt; ManagedT m Thread
</span><a href="Control.Concurrent.Extended.html#forkManagedT"><span class="hs-identifier hs-var">C.forkManagedT</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SchemeUpdate.processor&quot;</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425863"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(m Void -&gt; ManagedT m Thread) -&gt; m Void -&gt; ManagedT m Thread
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-187"></span><span>        </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; Manager
-&gt; TMVar MetadataResourceVersion
-&gt; SchemaCacheRef
-&gt; InstanceId
-&gt; ServerConfigCtx
-&gt; TVar Bool
-&gt; m Void
forall (m :: * -&gt; *) void.
(ForkableMonadIO m, MonadMetadataStorage (MetadataStorageT m),
 MonadResolveSource m) =&gt;
Logger Hasura
-&gt; Manager
-&gt; TMVar MetadataResourceVersion
-&gt; SchemaCacheRef
-&gt; InstanceId
-&gt; ServerConfigCtx
-&gt; TVar Bool
-&gt; m void
</span><a href="Hasura.Server.SchemaUpdate.html#processor"><span class="hs-identifier hs-var">processor</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425863"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621689425862"><span class="hs-identifier hs-var">httpMgr</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
</span><a href="#local-6989586621689425861"><span class="hs-identifier hs-var">schemaSyncEventRef</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621689425860"><span class="hs-identifier hs-var">cacheRef</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621689425859"><span class="hs-identifier hs-var">instanceId</span></a></span><span> </span><span class="annot"><span class="annottext">ServerConfigCtx
</span><a href="#local-6989586621689425858"><span class="hs-identifier hs-var">serverConfigCtx</span></a></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621689425857"><span class="hs-identifier hs-var">logTVar</span></a></span><span>
</span><span id="line-188"></span><span>    </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; InstanceId -&gt; ThreadType -&gt; Thread -&gt; ManagedT m ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
Logger Hasura -&gt; InstanceId -&gt; ThreadType -&gt; Thread -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logThreadStarted"><span class="hs-identifier hs-var">logThreadStarted</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425863"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621689425859"><span class="hs-identifier hs-var">instanceId</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadType
</span><a href="Hasura.Server.SchemaUpdate.html#TTProcessor"><span class="hs-identifier hs-var">TTProcessor</span></a></span><span> </span><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621689425856"><span class="hs-identifier hs-var">processorThread</span></a></span><span>
</span><span id="line-189"></span><span>    </span><span class="annot"><span class="annottext">Thread -&gt; ManagedT m Thread
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621689425856"><span class="hs-identifier hs-var">processorThread</span></a></span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span class="hs-comment">-- TODO: This is also defined in multitenant, consider putting it in a library somewhere</span><span>
</span><span id="line-192"></span><span id="local-6989586621689426027"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#forcePut"><span class="hs-identifier hs-type">forcePut</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM.TMVar</span></span><span> </span><span class="annot"><a href="#local-6989586621689426027"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621689426027"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-193"></span><span id="forcePut"><span class="annot"><span class="annottext">forcePut :: TMVar a -&gt; a -&gt; IO ()
</span><a href="Hasura.Server.SchemaUpdate.html#forcePut"><span class="hs-identifier hs-var hs-var">forcePut</span></a></span></span><span> </span><span id="local-6989586621689425853"><span class="annot"><span class="annottext">TMVar a
</span><a href="#local-6989586621689425853"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621689425852"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689425852"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar a -&gt; STM (Maybe a)
forall a. TMVar a -&gt; STM (Maybe a)
</span><span class="hs-identifier hs-var">STM.tryTakeTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar a
</span><a href="#local-6989586621689425853"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">STM (Maybe a) -&gt; STM () -&gt; STM ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TMVar a -&gt; a -&gt; STM ()
forall a. TMVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">STM.putTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar a
</span><a href="#local-6989586621689425853"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689425852"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#schemaVersionCheckHandler"><span class="hs-identifier hs-type">schemaVersionCheckHandler</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-196"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Q.PGPool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM.TMVar</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataResourceVersion"><span class="hs-identifier hs-type">MetadataResourceVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-197"></span><span id="schemaVersionCheckHandler"><span class="annot"><span class="annottext">schemaVersionCheckHandler :: PGPool -&gt; TMVar MetadataResourceVersion -&gt; IO (Either QErr ())
</span><a href="Hasura.Server.SchemaUpdate.html#schemaVersionCheckHandler"><span class="hs-identifier hs-var hs-var">schemaVersionCheckHandler</span></a></span></span><span> </span><span id="local-6989586621689425847"><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621689425847"><span class="hs-identifier hs-var">pool</span></a></span></span><span> </span><span id="local-6989586621689425846"><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
</span><a href="#local-6989586621689425846"><span class="hs-identifier hs-var">metaVersionRef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-198"></span><span>  </span><span class="annot"><span class="annottext">ExceptT QErr IO MetadataResourceVersion
-&gt; IO (Either QErr MetadataResourceVersion)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span>
</span><span id="line-199"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">PGPool
-&gt; TxMode
-&gt; TxET QErr IO MetadataResourceVersion
-&gt; ExceptT QErr IO MetadataResourceVersion
forall (m :: * -&gt; *) e a.
(MonadIO m, MonadBaseControl IO m, FromPGTxErr e,
 FromPGConnErr e) =&gt;
PGPool -&gt; TxMode -&gt; TxET e m a -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">Q.runTx</span></span><span> </span><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621689425847"><span class="hs-identifier hs-var">pool</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxIsolation
</span><span class="hs-identifier hs-var">Q.RepeatableRead</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe TxAccess
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO MetadataResourceVersion
 -&gt; ExceptT QErr IO MetadataResourceVersion)
-&gt; TxET QErr IO MetadataResourceVersion
-&gt; ExceptT QErr IO MetadataResourceVersion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-200"></span><span>        </span><span class="annot"><span class="annottext">TxET QErr IO MetadataResourceVersion
</span><a href="Hasura.RQL.DDL.Schema.Catalog.html#fetchMetadataResourceVersionFromCatalog"><span class="hs-identifier hs-var">fetchMetadataResourceVersionFromCatalog</span></a></span><span>
</span><span id="line-201"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-202"></span><span>    </span><span class="annot"><span class="annottext">IO (Either QErr MetadataResourceVersion)
-&gt; (Either QErr MetadataResourceVersion -&gt; IO (Either QErr ()))
-&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-203"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621689425841"><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425841"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; Either QErr ()
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(() -&gt; Either QErr ()) -&gt; IO () -&gt; IO (Either QErr ())
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TMVar MetadataResourceVersion -&gt; MetadataResourceVersion -&gt; IO ()
forall a. TMVar a -&gt; a -&gt; IO ()
</span><a href="Hasura.Server.SchemaUpdate.html#forcePut"><span class="hs-identifier hs-var">forcePut</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
</span><a href="#local-6989586621689425846"><span class="hs-identifier hs-var">metaVersionRef</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425841"><span class="hs-identifier hs-var">version</span></a></span><span>
</span><span id="line-204"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621689425839"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621689425839"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either QErr () -&gt; IO (Either QErr ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either QErr () -&gt; IO (Either QErr ()))
-&gt; Either QErr () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; Either QErr ()
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621689425839"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span class="hs-keyword">data</span><span> </span><span id="ErrorState"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#ErrorState"><span class="hs-identifier hs-var">ErrorState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ErrorState"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#ErrorState"><span class="hs-identifier hs-var">ErrorState</span></a></span></span><span>
</span><span id="line-207"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_esLastErrorSeen"><span class="annot"><span class="annottext">ErrorState -&gt; Maybe QErr
</span><a href="Hasura.Server.SchemaUpdate.html#_esLastErrorSeen"><span class="hs-identifier hs-var hs-var">_esLastErrorSeen</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-208"></span><span>    </span><span id="_esLastMetadataVersion"><span class="annot"><span class="annottext">ErrorState -&gt; Maybe MetadataResourceVersion
</span><a href="Hasura.Server.SchemaUpdate.html#_esLastMetadataVersion"><span class="hs-identifier hs-var hs-var">_esLastMetadataVersion</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataResourceVersion"><span class="hs-identifier hs-type">MetadataResourceVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-210"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621689425832"><span id="local-6989586621689425834"><span class="annot"><span class="annottext">ErrorState -&gt; ErrorState -&gt; Bool
(ErrorState -&gt; ErrorState -&gt; Bool)
-&gt; (ErrorState -&gt; ErrorState -&gt; Bool) -&gt; Eq ErrorState
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: ErrorState -&gt; ErrorState -&gt; Bool
$c/= :: ErrorState -&gt; ErrorState -&gt; Bool
== :: ErrorState -&gt; ErrorState -&gt; Bool
$c== :: ErrorState -&gt; ErrorState -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-211"></span><span>
</span><span id="line-212"></span><span class="hs-comment">-- NOTE: The ErrorState type is to be used mainly for the `listener` method below.</span><span>
</span><span id="line-213"></span><span class="hs-comment">--       This will help prevent logging the same error with the same MetadataResourceVersion</span><span>
</span><span id="line-214"></span><span class="hs-comment">--       multiple times consecutively. When the `listener` is in ErrorState we don't log the</span><span>
</span><span id="line-215"></span><span class="hs-comment">--       next error until the resource version has changed/updated.</span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#defaultErrorState"><span class="hs-identifier hs-type">defaultErrorState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#ErrorState"><span class="hs-identifier hs-type">ErrorState</span></a></span><span>
</span><span id="line-218"></span><span id="defaultErrorState"><span class="annot"><span class="annottext">defaultErrorState :: ErrorState
</span><a href="Hasura.Server.SchemaUpdate.html#defaultErrorState"><span class="hs-identifier hs-var hs-var">defaultErrorState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe QErr -&gt; Maybe MetadataResourceVersion -&gt; ErrorState
</span><a href="Hasura.Server.SchemaUpdate.html#ErrorState"><span class="hs-identifier hs-var">ErrorState</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe QErr
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe MetadataResourceVersion
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-219"></span><span>
</span><span id="line-220"></span><span class="hs-comment">-- | NOTE: this can be updated to use lenses</span><span>
</span><span id="line-221"></span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#updateErrorInState"><span class="hs-identifier hs-type">updateErrorInState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#ErrorState"><span class="hs-identifier hs-type">ErrorState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataResourceVersion"><span class="hs-identifier hs-type">MetadataResourceVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#ErrorState"><span class="hs-identifier hs-type">ErrorState</span></a></span><span>
</span><span id="line-222"></span><span id="updateErrorInState"><span class="annot"><span class="annottext">updateErrorInState :: ErrorState -&gt; QErr -&gt; MetadataResourceVersion -&gt; ErrorState
</span><a href="Hasura.Server.SchemaUpdate.html#updateErrorInState"><span class="hs-identifier hs-var hs-var">updateErrorInState</span></a></span></span><span> </span><span id="local-6989586621689425829"><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621689425829"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span id="local-6989586621689425828"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621689425828"><span class="hs-identifier hs-var">qerr</span></a></span></span><span> </span><span id="local-6989586621689425827"><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425827"><span class="hs-identifier hs-var">mrv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-223"></span><span>  </span><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621689425829"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-224"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_esLastErrorSeen :: Maybe QErr
</span><a href="Hasura.Server.SchemaUpdate.html#_esLastErrorSeen"><span class="hs-identifier hs-var">_esLastErrorSeen</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QErr -&gt; Maybe QErr
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621689425828"><span class="hs-identifier hs-var">qerr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-225"></span><span>      </span><span class="annot"><span class="annottext">_esLastMetadataVersion :: Maybe MetadataResourceVersion
</span><a href="Hasura.Server.SchemaUpdate.html#_esLastMetadataVersion"><span class="hs-identifier hs-var">_esLastMetadataVersion</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion -&gt; Maybe MetadataResourceVersion
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425827"><span class="hs-identifier hs-var">mrv</span></a></span><span>
</span><span id="line-226"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-227"></span><span>
</span><span id="line-228"></span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#isInErrorState"><span class="hs-identifier hs-type">isInErrorState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#ErrorState"><span class="hs-identifier hs-type">ErrorState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-229"></span><span id="isInErrorState"><span class="annot"><span class="annottext">isInErrorState :: ErrorState -&gt; Bool
</span><a href="Hasura.Server.SchemaUpdate.html#isInErrorState"><span class="hs-identifier hs-var hs-var">isInErrorState</span></a></span></span><span> </span><span id="local-6989586621689425825"><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621689425825"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-230"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe QErr -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe QErr -&gt; Bool)
-&gt; (ErrorState -&gt; Maybe QErr) -&gt; ErrorState -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ErrorState -&gt; Maybe QErr
</span><a href="Hasura.Server.SchemaUpdate.html#_esLastErrorSeen"><span class="hs-identifier hs-var hs-var">_esLastErrorSeen</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621689425825"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe MetadataResourceVersion -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe MetadataResourceVersion -&gt; Bool)
-&gt; (ErrorState -&gt; Maybe MetadataResourceVersion)
-&gt; ErrorState
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ErrorState -&gt; Maybe MetadataResourceVersion
</span><a href="Hasura.Server.SchemaUpdate.html#_esLastMetadataVersion"><span class="hs-identifier hs-var hs-var">_esLastMetadataVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621689425825"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#toLogError"><span class="hs-identifier hs-type">toLogError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#ErrorState"><span class="hs-identifier hs-type">ErrorState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataResourceVersion"><span class="hs-identifier hs-type">MetadataResourceVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-233"></span><span id="toLogError"><span class="annot"><span class="annottext">toLogError :: ErrorState -&gt; QErr -&gt; MetadataResourceVersion -&gt; Bool
</span><a href="Hasura.Server.SchemaUpdate.html#toLogError"><span class="hs-identifier hs-var hs-var">toLogError</span></a></span></span><span> </span><span id="local-6989586621689425820"><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621689425820"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span id="local-6989586621689425819"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621689425819"><span class="hs-identifier hs-var">qerr</span></a></span></span><span> </span><span id="local-6989586621689425818"><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425818"><span class="hs-identifier hs-var">mrv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621689425816"><span class="hs-identifier hs-var">isQErrLastSeen</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621689425814"><span class="hs-identifier hs-var">isMetadataResourceVersionLastSeen</span></a></span><span>
</span><span id="line-234"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-235"></span><span>    </span><span id="local-6989586621689425816"><span class="annot"><span class="annottext">isQErrLastSeen :: Bool
</span><a href="#local-6989586621689425816"><span class="hs-identifier hs-var hs-var">isQErrLastSeen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ErrorState -&gt; Maybe QErr
</span><a href="Hasura.Server.SchemaUpdate.html#_esLastErrorSeen"><span class="hs-identifier hs-var hs-var">_esLastErrorSeen</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621689425820"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-236"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621689425813"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621689425813"><span class="hs-identifier hs-var">lErrS</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621689425813"><span class="hs-identifier hs-var">lErrS</span></a></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; QErr -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621689425819"><span class="hs-identifier hs-var">qerr</span></a></span><span>
</span><span id="line-237"></span><span>      </span><span class="annot"><span class="annottext">Maybe QErr
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span>    </span><span id="local-6989586621689425814"><span class="annot"><span class="annottext">isMetadataResourceVersionLastSeen :: Bool
</span><a href="#local-6989586621689425814"><span class="hs-identifier hs-var hs-var">isMetadataResourceVersionLastSeen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ErrorState -&gt; Maybe MetadataResourceVersion
</span><a href="Hasura.Server.SchemaUpdate.html#_esLastMetadataVersion"><span class="hs-identifier hs-var hs-var">_esLastMetadataVersion</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621689425820"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-240"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621689425812"><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425812"><span class="hs-identifier hs-var">lMRV</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425812"><span class="hs-identifier hs-var">lMRV</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion -&gt; MetadataResourceVersion -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425818"><span class="hs-identifier hs-var">mrv</span></a></span><span>
</span><span id="line-241"></span><span>      </span><span class="annot"><span class="annottext">Maybe MetadataResourceVersion
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-242"></span><span>
</span><span id="line-243"></span><span class="hs-comment">-- | An IO action that listens to postgres for events and pushes them to a Queue, in a loop forever.</span><span>
</span><span id="line-244"></span><span id="local-6989586621689426072"><span id="local-6989586621689426073"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#listener"><span class="hs-identifier hs-type">listener</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-245"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689426073"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-246"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-247"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Q.PGPool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-248"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">STM.TMVar</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataResourceVersion"><span class="hs-identifier hs-type">MetadataResourceVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-249"></span><span>  </span><span class="annot"><a href="Data.Time.Clock.Units.html#Milliseconds"><span class="hs-identifier hs-type">Milliseconds</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-250"></span><span>  </span><span class="annot"><a href="#local-6989586621689426073"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689426072"><span class="hs-identifier hs-type">void</span></a></span></span></span><span>
</span><span id="line-251"></span><span id="listener"><span class="annot"><span class="annottext">listener :: Logger Hasura
-&gt; PGPool
-&gt; TMVar MetadataResourceVersion
-&gt; Milliseconds
-&gt; m void
</span><a href="Hasura.Server.SchemaUpdate.html#listener"><span class="hs-identifier hs-var hs-var">listener</span></a></span></span><span> </span><span id="local-6989586621689425811"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425811"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621689425810"><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621689425810"><span class="hs-identifier hs-var">pool</span></a></span></span><span> </span><span id="local-6989586621689425809"><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
</span><a href="#local-6989586621689425809"><span class="hs-identifier hs-var">metaVersionRef</span></a></span></span><span> </span><span id="local-6989586621689425808"><span class="annot"><span class="annottext">Milliseconds
</span><a href="#local-6989586621689425808"><span class="hs-identifier hs-var">interval</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ErrorState -&gt; m ErrorState) -&gt; ErrorState -&gt; m void
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m a) -&gt; a -&gt; m b
</span><span class="hs-identifier hs-var">L.iterateM_</span></span><span> </span><span class="annot"><span class="annottext">ErrorState -&gt; m ErrorState
</span><a href="#local-6989586621689425806"><span class="hs-identifier hs-var">listenerLoop</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorState
</span><a href="Hasura.Server.SchemaUpdate.html#defaultErrorState"><span class="hs-identifier hs-var">defaultErrorState</span></a></span><span>
</span><span id="line-252"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-253"></span><span>    </span><span id="local-6989586621689425806"><span class="annot"><span class="annottext">listenerLoop :: ErrorState -&gt; m ErrorState
</span><a href="#local-6989586621689425806"><span class="hs-identifier hs-var hs-var">listenerLoop</span></a></span></span><span> </span><span id="local-6989586621689425805"><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621689425805"><span class="hs-identifier hs-var">errorState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-254"></span><span>      </span><span id="local-6989586621689425804"><span class="annot"><span class="annottext">Maybe MetadataResourceVersion
</span><a href="#local-6989586621689425804"><span class="hs-identifier hs-var">mrv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Maybe MetadataResourceVersion)
-&gt; m (Maybe MetadataResourceVersion)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe MetadataResourceVersion)
 -&gt; m (Maybe MetadataResourceVersion))
-&gt; IO (Maybe MetadataResourceVersion)
-&gt; m (Maybe MetadataResourceVersion)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">STM (Maybe MetadataResourceVersion)
-&gt; IO (Maybe MetadataResourceVersion)
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM (Maybe MetadataResourceVersion)
 -&gt; IO (Maybe MetadataResourceVersion))
-&gt; STM (Maybe MetadataResourceVersion)
-&gt; IO (Maybe MetadataResourceVersion)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
-&gt; STM (Maybe MetadataResourceVersion)
forall a. TMVar a -&gt; STM (Maybe a)
</span><span class="hs-identifier hs-var">STM.tryTakeTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
</span><a href="#local-6989586621689425809"><span class="hs-identifier hs-var">metaVersionRef</span></a></span><span>
</span><span id="line-255"></span><span>      </span><span id="local-6989586621689425802"><span class="annot"><span class="annottext">Either QErr ()
</span><a href="#local-6989586621689425802"><span class="hs-identifier hs-var">resp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PGPool -&gt; TMVar MetadataResourceVersion -&gt; IO (Either QErr ())
</span><a href="Hasura.Server.SchemaUpdate.html#schemaVersionCheckHandler"><span class="hs-identifier hs-var">schemaVersionCheckHandler</span></a></span><span> </span><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621689425810"><span class="hs-identifier hs-var">pool</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
</span><a href="#local-6989586621689425809"><span class="hs-identifier hs-var">metaVersionRef</span></a></span><span>
</span><span id="line-256"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689425801"><span class="annot"><span class="annottext">metadataVersion :: MetadataResourceVersion
</span><a href="#local-6989586621689425801"><span class="hs-identifier hs-var hs-var">metadataVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
-&gt; Maybe MetadataResourceVersion -&gt; MetadataResourceVersion
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="Hasura.RQL.Types.SchemaCache.html#initialResourceVersion"><span class="hs-identifier hs-var">initialResourceVersion</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe MetadataResourceVersion
</span><a href="#local-6989586621689425804"><span class="hs-identifier hs-var">mrv</span></a></span><span>
</span><span id="line-257"></span><span>      </span><span id="local-6989586621689425798"><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621689425798"><span class="hs-identifier hs-var">nextErr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either QErr ()
</span><a href="#local-6989586621689425802"><span class="hs-identifier hs-var">resp</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-258"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621689425797"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621689425797"><span class="hs-identifier hs-var">respErr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-259"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ErrorState -&gt; QErr -&gt; MetadataResourceVersion -&gt; Bool
</span><a href="Hasura.Server.SchemaUpdate.html#toLogError"><span class="hs-identifier hs-var">toLogError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621689425805"><span class="hs-identifier hs-var">errorState</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621689425797"><span class="hs-identifier hs-var">respErr</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425801"><span class="hs-identifier hs-var">metadataVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-261"></span><span>              </span><span class="annot"><span class="annottext">Logger Hasura -&gt; ThreadType -&gt; ThreadError -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadIO m, ToJSON a) =&gt;
Logger Hasura -&gt; ThreadType -&gt; a -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logError"><span class="hs-identifier hs-var">logError</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425811"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadType
</span><a href="Hasura.Server.SchemaUpdate.html#TTListener"><span class="hs-identifier hs-var">TTListener</span></a></span><span> </span><span class="annot"><span class="annottext">(ThreadError -&gt; m ()) -&gt; ThreadError -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; ThreadError
</span><a href="Hasura.Server.SchemaUpdate.html#TEQueryError"><span class="hs-identifier hs-var">TEQueryError</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621689425797"><span class="hs-identifier hs-var">respErr</span></a></span><span>
</span><span id="line-262"></span><span>              </span><span class="annot"><span class="annottext">Logger Hasura -&gt; ThreadType -&gt; Value -&gt; m ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
Logger Hasura -&gt; ThreadType -&gt; Value -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logInfo"><span class="hs-identifier hs-var">logInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425811"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadType
</span><a href="Hasura.Server.SchemaUpdate.html#TTListener"><span class="hs-identifier hs-var">TTListener</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; m ()) -&gt; Value -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">object</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;metadataResourceVersion&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Value -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425801"><span class="hs-identifier hs-var">metadataVersion</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-263"></span><span>              </span><span class="annot"><span class="annottext">ErrorState -&gt; m ErrorState
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ErrorState -&gt; m ErrorState) -&gt; ErrorState -&gt; m ErrorState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorState -&gt; QErr -&gt; MetadataResourceVersion -&gt; ErrorState
</span><a href="Hasura.Server.SchemaUpdate.html#updateErrorInState"><span class="hs-identifier hs-var">updateErrorInState</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621689425805"><span class="hs-identifier hs-var">errorState</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621689425797"><span class="hs-identifier hs-var">respErr</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425801"><span class="hs-identifier hs-var">metadataVersion</span></a></span><span>
</span><span id="line-264"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-265"></span><span>              </span><span class="annot"><span class="annottext">ErrorState -&gt; m ErrorState
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621689425805"><span class="hs-identifier hs-var">errorState</span></a></span><span>
</span><span id="line-266"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-267"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ErrorState -&gt; Bool
</span><a href="Hasura.Server.SchemaUpdate.html#isInErrorState"><span class="hs-identifier hs-var">isInErrorState</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621689425805"><span class="hs-identifier hs-var">errorState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-268"></span><span>            </span><span class="annot"><span class="annottext">Logger Hasura -&gt; ThreadType -&gt; Value -&gt; m ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
Logger Hasura -&gt; ThreadType -&gt; Value -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logInfo"><span class="hs-identifier hs-var">logInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425811"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadType
</span><a href="Hasura.Server.SchemaUpdate.html#TTListener"><span class="hs-identifier hs-var">TTListener</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; m ()) -&gt; Value -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">object</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;message&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Text -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;SchemaSync Restored...&quot;</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-269"></span><span>          </span><span class="annot"><span class="annottext">ErrorState -&gt; m ErrorState
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">ErrorState
</span><a href="Hasura.Server.SchemaUpdate.html#defaultErrorState"><span class="hs-identifier hs-var">defaultErrorState</span></a></span><span>
</span><span id="line-270"></span><span>      </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; IO ()
</span><a href="Control.Concurrent.Extended.html#sleep"><span class="hs-identifier hs-var">C.sleep</span></a></span><span> </span><span class="annot"><span class="annottext">(DiffTime -&gt; IO ()) -&gt; DiffTime -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Milliseconds -&gt; DiffTime
</span><a href="Data.Time.Clock.Units.html#milliseconds"><span class="hs-identifier hs-var hs-var">milliseconds</span></a></span><span> </span><span class="annot"><span class="annottext">Milliseconds
</span><a href="#local-6989586621689425808"><span class="hs-identifier hs-var">interval</span></a></span><span>
</span><span id="line-271"></span><span>      </span><span class="annot"><span class="annottext">ErrorState -&gt; m ErrorState
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621689425798"><span class="hs-identifier hs-var">nextErr</span></a></span><span>
</span><span id="line-272"></span><span>
</span><span id="line-273"></span><span class="hs-comment">-- | An IO action that processes events from Queue, in a loop forever.</span><span>
</span><span id="line-274"></span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#processor"><span class="hs-identifier hs-type">processor</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-275"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621689426063"><span class="annot"><a href="#local-6989586621689426063"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621689426059"><span class="annot"><a href="#local-6989586621689426059"><span class="hs-identifier hs-type">void</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-276"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Control.Concurrent.Extended.html#ForkableMonadIO"><span class="hs-identifier hs-type">C.ForkableMonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689426063"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-277"></span><span>    </span><span class="annot"><a href="Hasura.Metadata.Class.html#MonadMetadataStorage"><span class="hs-identifier hs-type">MonadMetadataStorage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Metadata.Class.html#MetadataStorageT"><span class="hs-identifier hs-type">MetadataStorageT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689426063"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-278"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MonadResolveSource"><span class="hs-identifier hs-type">MonadResolveSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689426063"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-279"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-280"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-281"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">HTTP.Manager</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-282"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">STM.TMVar</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataResourceVersion"><span class="hs-identifier hs-type">MetadataResourceVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-283"></span><span>  </span><span class="annot"><a href="Hasura.Server.SchemaCacheRef.html#SchemaCacheRef"><span class="hs-identifier hs-type">SchemaCacheRef</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-284"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#InstanceId"><span class="hs-identifier hs-type">InstanceId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-285"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#ServerConfigCtx"><span class="hs-identifier hs-type">ServerConfigCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-286"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">STM.TVar</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-287"></span><span>  </span><span class="annot"><a href="#local-6989586621689426063"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689426059"><span class="hs-identifier hs-type">void</span></a></span><span>
</span><span id="line-288"></span><span id="processor"><span class="annot"><span class="annottext">processor :: Logger Hasura
-&gt; Manager
-&gt; TMVar MetadataResourceVersion
-&gt; SchemaCacheRef
-&gt; InstanceId
-&gt; ServerConfigCtx
-&gt; TVar Bool
-&gt; m void
</span><a href="Hasura.Server.SchemaUpdate.html#processor"><span class="hs-identifier hs-var hs-var">processor</span></a></span></span><span>
</span><span id="line-289"></span><span>  </span><span id="local-6989586621689425791"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425791"><span class="hs-identifier hs-var">logger</span></a></span></span><span>
</span><span id="line-290"></span><span>  </span><span id="local-6989586621689425790"><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621689425790"><span class="hs-identifier hs-var">httpMgr</span></a></span></span><span>
</span><span id="line-291"></span><span>  </span><span id="local-6989586621689425789"><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
</span><a href="#local-6989586621689425789"><span class="hs-identifier hs-var">metaVersionRef</span></a></span></span><span>
</span><span id="line-292"></span><span>  </span><span id="local-6989586621689425788"><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621689425788"><span class="hs-identifier hs-var">cacheRef</span></a></span></span><span>
</span><span id="line-293"></span><span>  </span><span id="local-6989586621689425787"><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621689425787"><span class="hs-identifier hs-var">instanceId</span></a></span></span><span>
</span><span id="line-294"></span><span>  </span><span id="local-6989586621689425786"><span class="annot"><span class="annottext">ServerConfigCtx
</span><a href="#local-6989586621689425786"><span class="hs-identifier hs-var">serverConfigCtx</span></a></span></span><span>
</span><span id="line-295"></span><span>  </span><span id="local-6989586621689425785"><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621689425785"><span class="hs-identifier hs-var">logTVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m () -&gt; m void
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">forever</span></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m void) -&gt; m () -&gt; m void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-296"></span><span>    </span><span id="local-6989586621689425783"><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425783"><span class="hs-identifier hs-var">metaVersion</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO MetadataResourceVersion -&gt; m MetadataResourceVersion
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO MetadataResourceVersion -&gt; m MetadataResourceVersion)
-&gt; IO MetadataResourceVersion -&gt; m MetadataResourceVersion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">STM MetadataResourceVersion -&gt; IO MetadataResourceVersion
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM MetadataResourceVersion -&gt; IO MetadataResourceVersion)
-&gt; STM MetadataResourceVersion -&gt; IO MetadataResourceVersion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar MetadataResourceVersion -&gt; STM MetadataResourceVersion
forall a. TMVar a -&gt; STM a
</span><span class="hs-identifier hs-var">STM.takeTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
</span><a href="#local-6989586621689425789"><span class="hs-identifier hs-var">metaVersionRef</span></a></span><span>
</span><span id="line-297"></span><span>    </span><span id="local-6989586621689425781"><span class="annot"><span class="annottext">Either QErr ()
</span><a href="#local-6989586621689425781"><span class="hs-identifier hs-var">respErr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-298"></span><span>      </span><span class="annot"><span class="annottext">MetadataStorageT m () -&gt; m (Either QErr ())
forall (m :: * -&gt; *) a. MetadataStorageT m a -&gt; m (Either QErr a)
</span><a href="Hasura.Metadata.Class.html#runMetadataStorageT"><span class="hs-identifier hs-var">runMetadataStorageT</span></a></span><span> </span><span class="annot"><span class="annottext">(MetadataStorageT m () -&gt; m (Either QErr ()))
-&gt; MetadataStorageT m () -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-299"></span><span>        </span><span class="annot"><span class="annottext">MetadataResourceVersion
-&gt; InstanceId
-&gt; Logger Hasura
-&gt; Manager
-&gt; SchemaCacheRef
-&gt; ThreadType
-&gt; ServerConfigCtx
-&gt; TVar Bool
-&gt; MetadataStorageT m ()
forall (m :: * -&gt; *).
(MonadIO m, MonadBaseControl IO m, MonadMetadataStorage m,
 MonadResolveSource m) =&gt;
MetadataResourceVersion
-&gt; InstanceId
-&gt; Logger Hasura
-&gt; Manager
-&gt; SchemaCacheRef
-&gt; ThreadType
-&gt; ServerConfigCtx
-&gt; TVar Bool
-&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#refreshSchemaCache"><span class="hs-identifier hs-var">refreshSchemaCache</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425783"><span class="hs-identifier hs-var">metaVersion</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621689425787"><span class="hs-identifier hs-var">instanceId</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425791"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621689425790"><span class="hs-identifier hs-var">httpMgr</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621689425788"><span class="hs-identifier hs-var">cacheRef</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadType
</span><a href="Hasura.Server.SchemaUpdate.html#TTProcessor"><span class="hs-identifier hs-var">TTProcessor</span></a></span><span> </span><span class="annot"><span class="annottext">ServerConfigCtx
</span><a href="#local-6989586621689425786"><span class="hs-identifier hs-var">serverConfigCtx</span></a></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621689425785"><span class="hs-identifier hs-var">logTVar</span></a></span><span>
</span><span id="line-300"></span><span>    </span><span class="annot"><span class="annottext">Either QErr () -&gt; (QErr -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="Hasura.Prelude.html#onLeft"><span class="hs-identifier hs-var">onLeft</span></a></span><span> </span><span class="annot"><span class="annottext">Either QErr ()
</span><a href="#local-6989586621689425781"><span class="hs-identifier hs-var">respErr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Logger Hasura -&gt; ThreadType -&gt; ThreadError -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadIO m, ToJSON a) =&gt;
Logger Hasura -&gt; ThreadType -&gt; a -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logError"><span class="hs-identifier hs-var">logError</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425791"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadType
</span><a href="Hasura.Server.SchemaUpdate.html#TTProcessor"><span class="hs-identifier hs-var">TTProcessor</span></a></span><span> </span><span class="annot"><span class="annottext">(ThreadError -&gt; m ()) -&gt; (QErr -&gt; ThreadError) -&gt; QErr -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; ThreadError
</span><a href="Hasura.Server.SchemaUpdate.html#TEQueryError"><span class="hs-identifier hs-var">TEQueryError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-301"></span><span>
</span><span id="line-302"></span><span id="local-6989586621689426000"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#refreshSchemaCache"><span class="hs-identifier hs-type">refreshSchemaCache</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-303"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689426000"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-304"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621689426000"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-305"></span><span>    </span><span class="annot"><a href="Hasura.Metadata.Class.html#MonadMetadataStorage"><span class="hs-identifier hs-type">MonadMetadataStorage</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689426000"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-306"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MonadResolveSource"><span class="hs-identifier hs-type">MonadResolveSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689426000"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-307"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-308"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataResourceVersion"><span class="hs-identifier hs-type">MetadataResourceVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-309"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#InstanceId"><span class="hs-identifier hs-type">InstanceId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-310"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-311"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">HTTP.Manager</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-312"></span><span>  </span><span class="annot"><a href="Hasura.Server.SchemaCacheRef.html#SchemaCacheRef"><span class="hs-identifier hs-type">SchemaCacheRef</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-313"></span><span>  </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#ThreadType"><span class="hs-identifier hs-type">ThreadType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-314"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#ServerConfigCtx"><span class="hs-identifier hs-type">ServerConfigCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-315"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">STM.TVar</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-316"></span><span>  </span><span class="annot"><a href="#local-6989586621689426000"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-317"></span><span id="refreshSchemaCache"><span class="annot"><span class="annottext">refreshSchemaCache :: MetadataResourceVersion
-&gt; InstanceId
-&gt; Logger Hasura
-&gt; Manager
-&gt; SchemaCacheRef
-&gt; ThreadType
-&gt; ServerConfigCtx
-&gt; TVar Bool
-&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#refreshSchemaCache"><span class="hs-identifier hs-var hs-var">refreshSchemaCache</span></a></span></span><span>
</span><span id="line-318"></span><span>  </span><span id="local-6989586621689425777"><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425777"><span class="hs-identifier hs-var">resourceVersion</span></a></span></span><span>
</span><span id="line-319"></span><span>  </span><span id="local-6989586621689425776"><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621689425776"><span class="hs-identifier hs-var">instanceId</span></a></span></span><span>
</span><span id="line-320"></span><span>  </span><span id="local-6989586621689425775"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425775"><span class="hs-identifier hs-var">logger</span></a></span></span><span>
</span><span id="line-321"></span><span>  </span><span id="local-6989586621689425774"><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621689425774"><span class="hs-identifier hs-var">httpManager</span></a></span></span><span>
</span><span id="line-322"></span><span>  </span><span id="local-6989586621689425773"><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621689425773"><span class="hs-identifier hs-var">cacheRef</span></a></span></span><span>
</span><span id="line-323"></span><span>  </span><span id="local-6989586621689425772"><span class="annot"><span class="annottext">ThreadType
</span><a href="#local-6989586621689425772"><span class="hs-identifier hs-var">threadType</span></a></span></span><span>
</span><span id="line-324"></span><span>  </span><span id="local-6989586621689425771"><span class="annot"><span class="annottext">ServerConfigCtx
</span><a href="#local-6989586621689425771"><span class="hs-identifier hs-var">serverConfigCtx</span></a></span></span><span>
</span><span id="line-325"></span><span>  </span><span id="local-6989586621689425770"><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621689425770"><span class="hs-identifier hs-var">logTVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-326"></span><span>    </span><span id="local-6989586621689425769"><span class="annot"><span class="annottext">Either QErr ()
</span><a href="#local-6989586621689425769"><span class="hs-identifier hs-var">respErr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExceptT QErr m () -&gt; m (Either QErr ())
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT QErr m () -&gt; m (Either QErr ()))
-&gt; ExceptT QErr m () -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-327"></span><span>      </span><span class="annot"><span class="annottext">SchemaCacheRef
-&gt; Logger Hasura
-&gt; Maybe (TVar Bool)
-&gt; ExceptT QErr m ((), RebuildableSchemaCache)
-&gt; ExceptT QErr m ()
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
SchemaCacheRef
-&gt; Logger Hasura
-&gt; Maybe (TVar Bool)
-&gt; m (a, RebuildableSchemaCache)
-&gt; m a
</span><a href="Hasura.Server.SchemaCacheRef.html#withSchemaCacheUpdate"><span class="hs-identifier hs-var">withSchemaCacheUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621689425773"><span class="hs-identifier hs-var">cacheRef</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425775"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar Bool -&gt; Maybe (TVar Bool)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621689425770"><span class="hs-identifier hs-var">logTVar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ExceptT QErr m ((), RebuildableSchemaCache) -&gt; ExceptT QErr m ())
-&gt; ExceptT QErr m ((), RebuildableSchemaCache) -&gt; ExceptT QErr m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-328"></span><span>        </span><span id="local-6989586621689425768"><span class="annot"><span class="annottext">RebuildableSchemaCache
</span><a href="#local-6989586621689425768"><span class="hs-identifier hs-var">rebuildableCache</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO RebuildableSchemaCache -&gt; ExceptT QErr m RebuildableSchemaCache
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO RebuildableSchemaCache
 -&gt; ExceptT QErr m RebuildableSchemaCache)
-&gt; IO RebuildableSchemaCache
-&gt; ExceptT QErr m RebuildableSchemaCache
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(RebuildableSchemaCache, SchemaCacheVer) -&gt; RebuildableSchemaCache
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((RebuildableSchemaCache, SchemaCacheVer)
 -&gt; RebuildableSchemaCache)
-&gt; IO (RebuildableSchemaCache, SchemaCacheVer)
-&gt; IO RebuildableSchemaCache
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SchemaCacheRef -&gt; IO (RebuildableSchemaCache, SchemaCacheVer)
</span><a href="Hasura.Server.SchemaCacheRef.html#readSchemaCacheRef"><span class="hs-identifier hs-var">readSchemaCacheRef</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621689425773"><span class="hs-identifier hs-var">cacheRef</span></a></span><span>
</span><span id="line-329"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621689425767"><span class="annot"><span class="annottext">()
</span><a href="#local-6989586621689425767"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689425766"><span class="annot"><span class="annottext">RebuildableSchemaCache
</span><a href="#local-6989586621689425766"><span class="hs-identifier hs-var">cache</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CacheInvalidations
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RunCtx
-&gt; RunT m ((), RebuildableSchemaCache, CacheInvalidations)
-&gt; ExceptT QErr m ((), RebuildableSchemaCache, CacheInvalidations)
forall (m :: * -&gt; *) a. RunCtx -&gt; RunT m a -&gt; ExceptT QErr m a
</span><a href="Hasura.RQL.Types.Run.html#peelRun"><span class="hs-identifier hs-var">peelRun</span></a></span><span> </span><span class="annot"><span class="annottext">RunCtx
</span><a href="#local-6989586621689425764"><span class="hs-identifier hs-var">runCtx</span></a></span><span> </span><span class="annot"><span class="annottext">(RunT m ((), RebuildableSchemaCache, CacheInvalidations)
 -&gt; ExceptT QErr m ((), RebuildableSchemaCache, CacheInvalidations))
-&gt; RunT m ((), RebuildableSchemaCache, CacheInvalidations)
-&gt; ExceptT QErr m ((), RebuildableSchemaCache, CacheInvalidations)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-330"></span><span>          </span><span class="annot"><span class="annottext">RebuildableSchemaCache
-&gt; CacheRWT (RunT m) ()
-&gt; RunT m ((), RebuildableSchemaCache, CacheInvalidations)
forall (m :: * -&gt; *) a.
Functor m =&gt;
RebuildableSchemaCache
-&gt; CacheRWT m a
-&gt; m (a, RebuildableSchemaCache, CacheInvalidations)
</span><a href="Hasura.RQL.DDL.Schema.Cache.html#runCacheRWT"><span class="hs-identifier hs-var">runCacheRWT</span></a></span><span> </span><span class="annot"><span class="annottext">RebuildableSchemaCache
</span><a href="#local-6989586621689425768"><span class="hs-identifier hs-var">rebuildableCache</span></a></span><span> </span><span class="annot"><span class="annottext">(CacheRWT (RunT m) ()
 -&gt; RunT m ((), RebuildableSchemaCache, CacheInvalidations))
-&gt; CacheRWT (RunT m) ()
-&gt; RunT m ((), RebuildableSchemaCache, CacheInvalidations)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-331"></span><span>            </span><span id="local-6989586621689425763"><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621689425763"><span class="hs-identifier hs-var">schemaCache</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CacheRWT (RunT m) SchemaCache
forall (m :: * -&gt; *). CacheRM m =&gt; m SchemaCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#askSchemaCache"><span class="hs-identifier hs-var">askSchemaCache</span></a></span><span>
</span><span id="line-332"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; Maybe MetadataResourceVersion
</span><a href="Hasura.RQL.Types.SchemaCache.html#scMetadataResourceVersion"><span class="hs-identifier hs-var hs-var">scMetadataResourceVersion</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621689425763"><span class="hs-identifier hs-var">schemaCache</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-333"></span><span>              </span><span class="hs-comment">-- While starting up, the metadata resource version is set to nothing, so we want to set the version</span><span>
</span><span id="line-334"></span><span>              </span><span class="hs-comment">-- without fetching the database metadata (as we have already fetched it during the startup, so, we</span><span>
</span><span id="line-335"></span><span>              </span><span class="hs-comment">-- skip fetching it twice)</span><span>
</span><span id="line-336"></span><span>              </span><span class="annot"><span class="annottext">Maybe MetadataResourceVersion
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion -&gt; CacheRWT (RunT m) ()
forall (m :: * -&gt; *). CacheRWM m =&gt; MetadataResourceVersion -&gt; m ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#setMetadataResourceVersionInSchemaCache"><span class="hs-identifier hs-var">setMetadataResourceVersionInSchemaCache</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425777"><span class="hs-identifier hs-var">resourceVersion</span></a></span><span>
</span><span id="line-337"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621689425759"><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425759"><span class="hs-identifier hs-var">engineResourceVersion</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-338"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; CacheRWT (RunT m) () -&gt; CacheRWT (RunT m) ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425759"><span class="hs-identifier hs-var">engineResourceVersion</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion -&gt; MetadataResourceVersion -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425777"><span class="hs-identifier hs-var">resourceVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(CacheRWT (RunT m) () -&gt; CacheRWT (RunT m) ())
-&gt; CacheRWT (RunT m) () -&gt; CacheRWT (RunT m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-339"></span><span>                  </span><span class="hs-special">(</span><span id="local-6989586621689425757"><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689425757"><span class="hs-identifier hs-var">metadata</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689425756"><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425756"><span class="hs-identifier hs-var">latestResourceVersion</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CacheRWT (RunT m) (Metadata, MetadataResourceVersion)
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
m (Metadata, MetadataResourceVersion)
</span><a href="Hasura.Metadata.Class.html#fetchMetadata"><span class="hs-identifier hs-var">fetchMetadata</span></a></span><span>
</span><span id="line-340"></span><span>                  </span><span id="local-6989586621689425754"><span class="annot"><span class="annottext">[(MetadataResourceVersion, CacheInvalidations)]
</span><a href="#local-6989586621689425754"><span class="hs-identifier hs-var">notifications</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
-&gt; InstanceId
-&gt; CacheRWT
     (RunT m) [(MetadataResourceVersion, CacheInvalidations)]
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
MetadataResourceVersion
-&gt; InstanceId -&gt; m [(MetadataResourceVersion, CacheInvalidations)]
</span><a href="Hasura.Metadata.Class.html#fetchMetadataNotifications"><span class="hs-identifier hs-var">fetchMetadataNotifications</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425759"><span class="hs-identifier hs-var">engineResourceVersion</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621689425776"><span class="hs-identifier hs-var">instanceId</span></a></span><span>
</span><span id="line-341"></span><span>
</span><span id="line-342"></span><span>                  </span><span class="annot"><span class="annottext">Logger Hasura -&gt; ThreadType -&gt; String -&gt; CacheRWT (RunT m) ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
Logger Hasura -&gt; ThreadType -&gt; String -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logDebug"><span class="hs-identifier hs-var">logDebug</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425775"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadType
</span><a href="#local-6989586621689425772"><span class="hs-identifier hs-var">threadType</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; CacheRWT (RunT m) ()) -&gt; String -&gt; CacheRWT (RunT m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;DEBUG: refreshSchemaCache Called: engineResourceVersion: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425759"><span class="hs-identifier hs-var">engineResourceVersion</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;, fresh resource version: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425756"><span class="hs-identifier hs-var">latestResourceVersion</span></a></span><span>
</span><span id="line-343"></span><span>                  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[(MetadataResourceVersion, CacheInvalidations)]
</span><a href="#local-6989586621689425754"><span class="hs-identifier hs-var">notifications</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-344"></span><span>                    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-345"></span><span>                      </span><span class="annot"><span class="annottext">Logger Hasura -&gt; ThreadType -&gt; Value -&gt; CacheRWT (RunT m) ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
Logger Hasura -&gt; ThreadType -&gt; Value -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logInfo"><span class="hs-identifier hs-var">logInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425775"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadType
</span><a href="#local-6989586621689425772"><span class="hs-identifier hs-var">threadType</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; CacheRWT (RunT m) ()) -&gt; Value -&gt; CacheRWT (RunT m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">object</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;message&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Text -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Schema Version changed with no notifications&quot;</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-346"></span><span>                      </span><span class="annot"><span class="annottext">MetadataResourceVersion -&gt; CacheRWT (RunT m) ()
forall (m :: * -&gt; *). CacheRWM m =&gt; MetadataResourceVersion -&gt; m ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#setMetadataResourceVersionInSchemaCache"><span class="hs-identifier hs-var">setMetadataResourceVersionInSchemaCache</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425756"><span class="hs-identifier hs-var">latestResourceVersion</span></a></span><span>
</span><span id="line-347"></span><span>                    </span><span class="annot"><span class="annottext">[(MetadataResourceVersion, CacheInvalidations)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-348"></span><span>                      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689425751"><span class="annot"><span class="annottext">cacheInvalidations :: CacheInvalidations
</span><a href="#local-6989586621689425751"><span class="hs-identifier hs-var hs-var">cacheInvalidations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-349"></span><span>                            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">((MetadataResourceVersion, CacheInvalidations) -&gt; Bool)
-&gt; [(MetadataResourceVersion, CacheInvalidations)] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetadataResourceVersion -&gt; MetadataResourceVersion -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425759"><span class="hs-identifier hs-var">engineResourceVersion</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
-&gt; MetadataResourceVersion -&gt; MetadataResourceVersion
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(MetadataResourceVersion -&gt; Bool)
-&gt; ((MetadataResourceVersion, CacheInvalidations)
    -&gt; MetadataResourceVersion)
-&gt; (MetadataResourceVersion, CacheInvalidations)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(MetadataResourceVersion, CacheInvalidations)
-&gt; MetadataResourceVersion
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(MetadataResourceVersion, CacheInvalidations)]
</span><a href="#local-6989586621689425754"><span class="hs-identifier hs-var">notifications</span></a></span><span>
</span><span id="line-350"></span><span>                              </span><span class="hs-keyword">then</span><span> </span><span class="hs-comment">-- If (engineResourceVersion + 1) is in the list of notifications then</span><span>
</span><span id="line-351"></span><span>                              </span><span class="hs-comment">-- we know that we haven't missed any.</span><span>
</span><span id="line-352"></span><span>                                </span><span class="annot"><span class="annottext">[CacheInvalidations] -&gt; CacheInvalidations
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([CacheInvalidations] -&gt; CacheInvalidations)
-&gt; [CacheInvalidations] -&gt; CacheInvalidations
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(MetadataResourceVersion, CacheInvalidations) -&gt; CacheInvalidations
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((MetadataResourceVersion, CacheInvalidations)
 -&gt; CacheInvalidations)
-&gt; [(MetadataResourceVersion, CacheInvalidations)]
-&gt; [CacheInvalidations]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(MetadataResourceVersion, CacheInvalidations)]
</span><a href="#local-6989586621689425754"><span class="hs-identifier hs-var">notifications</span></a></span><span>
</span><span id="line-353"></span><span>                              </span><span class="hs-keyword">else</span><span> </span><span class="hs-comment">-- Otherwise we may have missed some notifications so we need to invalidate the</span><span>
</span><span id="line-354"></span><span>                              </span><span class="hs-comment">-- whole cache.</span><span>
</span><span id="line-355"></span><span>
</span><span id="line-356"></span><span>                                </span><span class="annot"><span class="annottext">CacheInvalidations :: Bool
-&gt; HashSet RemoteSchemaName
-&gt; HashSet SourceName
-&gt; CacheInvalidations
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#CacheInvalidations"><span class="hs-identifier hs-type">CacheInvalidations</span></a></span><span>
</span><span id="line-357"></span><span>                                  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ciMetadata :: Bool
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#ciMetadata"><span class="hs-identifier hs-var">ciMetadata</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span>
</span><span id="line-358"></span><span>                                    </span><span class="annot"><span class="annottext">ciRemoteSchemas :: HashSet RemoteSchemaName
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#ciRemoteSchemas"><span class="hs-identifier hs-var">ciRemoteSchemas</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[RemoteSchemaName] -&gt; HashSet RemoteSchemaName
forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><span class="hs-identifier hs-var">HS.fromList</span></span><span> </span><span class="annot"><span class="annottext">([RemoteSchemaName] -&gt; HashSet RemoteSchemaName)
-&gt; [RemoteSchemaName] -&gt; HashSet RemoteSchemaName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; [RemoteSchemaName]
</span><a href="Hasura.RQL.Types.SchemaCache.html#getAllRemoteSchemas"><span class="hs-identifier hs-var">getAllRemoteSchemas</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621689425763"><span class="hs-identifier hs-var">schemaCache</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-359"></span><span>                                    </span><span class="annot"><span class="annottext">ciSources :: HashSet SourceName
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#ciSources"><span class="hs-identifier hs-var">ciSources</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SourceName] -&gt; HashSet SourceName
forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><span class="hs-identifier hs-var">HS.fromList</span></span><span> </span><span class="annot"><span class="annottext">([SourceName] -&gt; HashSet SourceName)
-&gt; [SourceName] -&gt; HashSet SourceName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashMap SourceName BackendSourceInfo -&gt; [SourceName]
forall k v. HashMap k v -&gt; [k]
</span><span class="hs-identifier hs-var">HM.keys</span></span><span> </span><span class="annot"><span class="annottext">(HashMap SourceName BackendSourceInfo -&gt; [SourceName])
-&gt; HashMap SourceName BackendSourceInfo -&gt; [SourceName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; HashMap SourceName BackendSourceInfo
</span><a href="Hasura.RQL.Types.SchemaCache.html#scSources"><span class="hs-identifier hs-var hs-var">scSources</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621689425763"><span class="hs-identifier hs-var">schemaCache</span></a></span><span>
</span><span id="line-360"></span><span>                                  </span><span class="hs-special">}</span><span>
</span><span id="line-361"></span><span>                      </span><span class="annot"><span class="annottext">Logger Hasura -&gt; ThreadType -&gt; Value -&gt; CacheRWT (RunT m) ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
Logger Hasura -&gt; ThreadType -&gt; Value -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logInfo"><span class="hs-identifier hs-var">logInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425775"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadType
</span><a href="#local-6989586621689425772"><span class="hs-identifier hs-var">threadType</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; CacheRWT (RunT m) ()) -&gt; Value -&gt; CacheRWT (RunT m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">object</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;currentVersion&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; MetadataResourceVersion -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425759"><span class="hs-identifier hs-var">engineResourceVersion</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;latestResourceVersion&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; MetadataResourceVersion -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425756"><span class="hs-identifier hs-var">latestResourceVersion</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-362"></span><span>                      </span><span class="annot"><span class="annottext">BuildReason
-&gt; CacheInvalidations -&gt; Metadata -&gt; CacheRWT (RunT m) ()
forall (m :: * -&gt; *).
CacheRWM m =&gt;
BuildReason -&gt; CacheInvalidations -&gt; Metadata -&gt; m ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#buildSchemaCacheWithOptions"><span class="hs-identifier hs-var">buildSchemaCacheWithOptions</span></a></span><span> </span><span class="annot"><span class="annottext">BuildReason
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#CatalogSync"><span class="hs-identifier hs-var">CatalogSync</span></a></span><span> </span><span class="annot"><span class="annottext">CacheInvalidations
</span><a href="#local-6989586621689425751"><span class="hs-identifier hs-var">cacheInvalidations</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621689425757"><span class="hs-identifier hs-var">metadata</span></a></span><span>
</span><span id="line-363"></span><span>                      </span><span class="annot"><span class="annottext">MetadataResourceVersion -&gt; CacheRWT (RunT m) ()
forall (m :: * -&gt; *). CacheRWM m =&gt; MetadataResourceVersion -&gt; m ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#setMetadataResourceVersionInSchemaCache"><span class="hs-identifier hs-var">setMetadataResourceVersionInSchemaCache</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621689425756"><span class="hs-identifier hs-var">latestResourceVersion</span></a></span><span>
</span><span id="line-364"></span><span>                      </span><span class="annot"><span class="annottext">Logger Hasura -&gt; ThreadType -&gt; Value -&gt; CacheRWT (RunT m) ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
Logger Hasura -&gt; ThreadType -&gt; Value -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logInfo"><span class="hs-identifier hs-var">logInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425775"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadType
</span><a href="#local-6989586621689425772"><span class="hs-identifier hs-var">threadType</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; CacheRWT (RunT m) ()) -&gt; Value -&gt; CacheRWT (RunT m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">object</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;message&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Text -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Schema Version changed with notifications&quot;</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-365"></span><span>        </span><span class="annot"><span class="annottext">((), RebuildableSchemaCache)
-&gt; ExceptT QErr m ((), RebuildableSchemaCache)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">()
</span><a href="#local-6989586621689425767"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RebuildableSchemaCache
</span><a href="#local-6989586621689425766"><span class="hs-identifier hs-var">cache</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-366"></span><span>    </span><span class="annot"><span class="annottext">Either QErr () -&gt; (QErr -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="Hasura.Prelude.html#onLeft"><span class="hs-identifier hs-var">onLeft</span></a></span><span> </span><span class="annot"><span class="annottext">Either QErr ()
</span><a href="#local-6989586621689425769"><span class="hs-identifier hs-var">respErr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Logger Hasura -&gt; ThreadType -&gt; ThreadError -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadIO m, ToJSON a) =&gt;
Logger Hasura -&gt; ThreadType -&gt; a -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logError"><span class="hs-identifier hs-var">logError</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425775"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadType
</span><a href="#local-6989586621689425772"><span class="hs-identifier hs-var">threadType</span></a></span><span> </span><span class="annot"><span class="annottext">(ThreadError -&gt; m ()) -&gt; (QErr -&gt; ThreadError) -&gt; QErr -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; ThreadError
</span><a href="Hasura.Server.SchemaUpdate.html#TEQueryError"><span class="hs-identifier hs-var">TEQueryError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-367"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-368"></span><span>      </span><span id="local-6989586621689425764"><span class="annot"><span class="annottext">runCtx :: RunCtx
</span><a href="#local-6989586621689425764"><span class="hs-identifier hs-var hs-var">runCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UserInfo -&gt; Manager -&gt; ServerConfigCtx -&gt; RunCtx
</span><a href="Hasura.RQL.Types.Run.html#RunCtx"><span class="hs-identifier hs-var">RunCtx</span></a></span><span> </span><span class="annot"><span class="annottext">UserInfo
</span><a href="Hasura.Session.html#adminUserInfo"><span class="hs-identifier hs-var">adminUserInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621689425774"><span class="hs-identifier hs-var">httpManager</span></a></span><span> </span><span class="annot"><span class="annottext">ServerConfigCtx
</span><a href="#local-6989586621689425771"><span class="hs-identifier hs-var">serverConfigCtx</span></a></span><span>
</span><span id="line-369"></span><span>
</span><span id="line-370"></span><span id="local-6989586621689426011"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#logInfo"><span class="hs-identifier hs-type">logInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689426011"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#ThreadType"><span class="hs-identifier hs-type">ThreadType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621689426011"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-371"></span><span id="logInfo"><span class="annot"><span class="annottext">logInfo :: Logger Hasura -&gt; ThreadType -&gt; Value -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logInfo"><span class="hs-identifier hs-var hs-var">logInfo</span></a></span></span><span> </span><span id="local-6989586621689425736"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425736"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621689425735"><span class="annot"><span class="annottext">ThreadType
</span><a href="#local-6989586621689425735"><span class="hs-identifier hs-var">threadType</span></a></span></span><span> </span><span id="local-6989586621689425734"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621689425734"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-372"></span><span>  </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425736"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(SchemaSyncThreadLog -&gt; m ()) -&gt; SchemaSyncThreadLog -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-373"></span><span>    </span><span class="annot"><span class="annottext">LogLevel -&gt; ThreadType -&gt; Value -&gt; SchemaSyncThreadLog
</span><a href="Hasura.Server.SchemaUpdate.html#SchemaSyncThreadLog"><span class="hs-identifier hs-var">SchemaSyncThreadLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadType
</span><a href="#local-6989586621689425735"><span class="hs-identifier hs-var">threadType</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621689425734"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-374"></span><span>
</span><span id="line-375"></span><span id="local-6989586621689426012"><span id="local-6989586621689426013"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#logError"><span class="hs-identifier hs-type">logError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689426013"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="annot"><a href="#local-6989586621689426012"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#ThreadType"><span class="hs-identifier hs-type">ThreadType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621689426012"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621689426013"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-376"></span><span id="logError"><span class="annot"><span class="annottext">logError :: Logger Hasura -&gt; ThreadType -&gt; a -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logError"><span class="hs-identifier hs-var hs-var">logError</span></a></span></span><span> </span><span id="local-6989586621689425733"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425733"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621689425732"><span class="annot"><span class="annottext">ThreadType
</span><a href="#local-6989586621689425732"><span class="hs-identifier hs-var">threadType</span></a></span></span><span> </span><span id="local-6989586621689425731"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689425731"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-377"></span><span>  </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425733"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(SchemaSyncThreadLog -&gt; m ()) -&gt; SchemaSyncThreadLog -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-378"></span><span>    </span><span class="annot"><span class="annottext">LogLevel -&gt; ThreadType -&gt; Value -&gt; SchemaSyncThreadLog
</span><a href="Hasura.Server.SchemaUpdate.html#SchemaSyncThreadLog"><span class="hs-identifier hs-var">SchemaSyncThreadLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelError"><span class="hs-identifier hs-var">LevelError</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadType
</span><a href="#local-6989586621689425732"><span class="hs-identifier hs-var">threadType</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; SchemaSyncThreadLog) -&gt; Value -&gt; SchemaSyncThreadLog
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-379"></span><span>      </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">object</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;error&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Value -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689425731"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-380"></span><span>
</span><span id="line-381"></span><span id="local-6989586621689425974"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#logDebug"><span class="hs-identifier hs-type">logDebug</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689425974"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#ThreadType"><span class="hs-identifier hs-type">ThreadType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621689425974"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-382"></span><span id="logDebug"><span class="annot"><span class="annottext">logDebug :: Logger Hasura -&gt; ThreadType -&gt; String -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logDebug"><span class="hs-identifier hs-var hs-var">logDebug</span></a></span></span><span> </span><span id="local-6989586621689425729"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425729"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621689425728"><span class="annot"><span class="annottext">ThreadType
</span><a href="#local-6989586621689425728"><span class="hs-identifier hs-var">threadType</span></a></span></span><span> </span><span id="local-6989586621689425727"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689425727"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-383"></span><span>  </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621689425729"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(SchemaSyncThreadLog -&gt; m ()) -&gt; SchemaSyncThreadLog -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-384"></span><span>    </span><span class="annot"><span class="annottext">LogLevel -&gt; ThreadType -&gt; Value -&gt; SchemaSyncThreadLog
</span><a href="Hasura.Server.SchemaUpdate.html#SchemaSyncThreadLog"><span class="hs-identifier hs-var">SchemaSyncThreadLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelDebug"><span class="hs-identifier hs-var">LevelDebug</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadType
</span><a href="#local-6989586621689425728"><span class="hs-identifier hs-var">threadType</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; SchemaSyncThreadLog) -&gt; Value -&gt; SchemaSyncThreadLog
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">object</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;message&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; String -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621689425727"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-385"></span></pre></body></html>