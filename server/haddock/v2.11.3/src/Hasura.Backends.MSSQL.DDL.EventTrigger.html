<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE QuasiQuotes #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hasura.Backends.MSSQL.DDL.EventTrigger</span><span>
</span><span id="line-5"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#createTableEventTrigger"><span class="hs-identifier">createTableEventTrigger</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchUndeliveredEvents"><span class="hs-identifier">fetchUndeliveredEvents</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setRetry"><span class="hs-identifier">setRetry</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordSuccess"><span class="hs-identifier">recordSuccess</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordError"><span class="hs-identifier">recordError</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordError%27"><span class="hs-identifier">recordError'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerQ"><span class="hs-identifier">dropTriggerQ</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerAndArchiveEvents"><span class="hs-identifier">dropTriggerAndArchiveEvents</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropDanglingSQLTrigger"><span class="hs-identifier">dropDanglingSQLTrigger</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#redeliverEvent"><span class="hs-identifier">redeliverEvent</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertManualEvent"><span class="hs-identifier">insertManualEvent</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unlockEventsInSource"><span class="hs-identifier">unlockEventsInSource</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getMaintenanceModeVersion"><span class="hs-identifier">getMaintenanceModeVersion</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#qualifyTableName"><span class="hs-identifier">qualifyTableName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#createMissingSQLTriggers"><span class="hs-identifier">createMissingSQLTriggers</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">where</span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Control</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadBaseControl</span></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">J</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">B</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Lazy</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BL</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.FileEmbed</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">makeRelativeToProject</span></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set.NonEmpty</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NE</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Text.Extended.html"><span class="hs-identifier">Data.Text.Extended</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Text.Extended.html#commaSeparated"><span class="hs-identifier">commaSeparated</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Text.Extended.html#toTxt"><span class="hs-identifier">toTxt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Lazy</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LT</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Text.NonEmpty.html"><span class="hs-identifier">Data.Text.NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Text.NonEmpty.html#mkNonEmptyTextUnsafe"><span class="hs-identifier">mkNonEmptyTextUnsafe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Time</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html"><span class="hs-identifier">Database.MSSQL.Transaction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier">TxE</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier">multiRowQueryE</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#singleRowQueryE"><span class="hs-identifier">singleRowQueryE</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier">unitQueryE</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Database.ODBC.SQLServer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Datetime2</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">rawUnescapedText</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">toSql</span></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Database.ODBC.TH</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ODBC</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html"><span class="hs-identifier">Hasura.Backends.MSSQL.Connection</span></a></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.Source.Version.html"><span class="hs-identifier">Hasura.Backends.MSSQL.DDL.Source.Version</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.SQL.Error.html"><span class="hs-identifier">Hasura.Backends.MSSQL.SQL.Error</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HGE</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.ToQuery.html"><span class="hs-identifier">Hasura.Backends.MSSQL.ToQuery</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.ToQuery.html#fromTableName"><span class="hs-identifier">fromTableName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.ToQuery.html#toQueryFlat"><span class="hs-identifier">toQueryFlat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.html"><span class="hs-identifier">Hasura.Backends.MSSQL.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier">SchemaName</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier">TableName</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html"><span class="hs-identifier">Hasura.Backends.MSSQL.Types.Internal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#%24sel%3AcolumnNameText%3AColumnName"><span class="hs-identifier">columnNameText</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#geoTypes"><span class="hs-identifier">geoTypes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Prelude.html"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Column.html"><span class="hs-identifier">Hasura.RQL.Types.Column</span></a></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html"><span class="hs-identifier">Hasura.RQL.Types.Common</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html"><span class="hs-identifier">Hasura.RQL.Types.EventTrigger</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html"><span class="hs-identifier">Hasura.RQL.Types.Eventing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier">EventId</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#OpVar"><span class="hs-identifier">OpVar</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html"><span class="hs-identifier">Hasura.RQL.Types.Source</span></a></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Table.html"><span class="hs-identifier">Hasura.RQL.Types.Table</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Table.html#PrimaryKey"><span class="hs-identifier">PrimaryKey</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.SQL.Backend.html"><span class="hs-identifier">Hasura.SQL.Backend</span></a></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html"><span class="hs-identifier">Hasura.Server.Types</span></a></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Session.html"><span class="hs-identifier">Hasura.Session</span></a></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Tracing.html"><span class="hs-identifier">Hasura.Tracing</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Tracing</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Text.Shakespeare.Text</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ST</span></span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span id="local-6989586621689341995"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchUndeliveredEvents"><span class="hs-identifier hs-type">fetchUndeliveredEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-58"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689341995"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689341995"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-59"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-60"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-61"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-62"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-63"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#FetchBatchSize"><span class="hs-identifier hs-type">FetchBatchSize</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-64"></span><span>  </span><span class="annot"><a href="#local-6989586621689341995"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-65"></span><span id="fetchUndeliveredEvents"><span class="annot"><span class="annottext">fetchUndeliveredEvents :: MSSQLSourceConfig
-&gt; SourceName
-&gt; [TriggerName]
-&gt; MaintenanceMode ()
-&gt; FetchBatchSize
-&gt; m [Event 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchUndeliveredEvents"><span class="hs-identifier hs-var hs-var">fetchUndeliveredEvents</span></a></span></span><span> </span><span id="local-6989586621689341994"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689341994"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689341993"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689341993"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span> </span><span id="local-6989586621689341992"><span class="annot"><span class="annottext">[TriggerName]
</span><a href="#local-6989586621689341992"><span class="hs-identifier hs-var">triggerNames</span></a></span></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode ()
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621689341991"><span class="annot"><span class="annottext">FetchBatchSize
</span><a href="#local-6989586621689341991"><span class="hs-identifier hs-var">fetchBatchSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-66"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr [Event 'MSSQL]) -&gt; m [Event 'MSSQL]
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr [Event 'MSSQL]) -&gt; m [Event 'MSSQL])
-&gt; m (Either QErr [Event 'MSSQL]) -&gt; m [Event 'MSSQL]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-67"></span><span>    </span><span class="annot"><span class="annottext">IO (Either QErr [Event 'MSSQL]) -&gt; m (Either QErr [Event 'MSSQL])
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr [Event 'MSSQL]) -&gt; m (Either QErr [Event 'MSSQL]))
-&gt; IO (Either QErr [Event 'MSSQL])
-&gt; m (Either QErr [Event 'MSSQL])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-68"></span><span>      </span><span class="annot"><span class="annottext">MSSQLSourceConfig
-&gt; TxET QErr IO [Event 'MSSQL] -&gt; IO (Either QErr [Event 'MSSQL])
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689341994"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO [Event 'MSSQL] -&gt; IO (Either QErr [Event 'MSSQL]))
-&gt; TxET QErr IO [Event 'MSSQL] -&gt; IO (Either QErr [Event 'MSSQL])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-69"></span><span>        </span><span class="annot"><span class="annottext">SourceName
-&gt; [TriggerName] -&gt; FetchBatchSize -&gt; TxET QErr IO [Event 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEvents"><span class="hs-identifier hs-var">fetchEvents</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689341993"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">[TriggerName]
</span><a href="#local-6989586621689341992"><span class="hs-identifier hs-var">triggerNames</span></a></span><span> </span><span class="annot"><span class="annottext">FetchBatchSize
</span><a href="#local-6989586621689341991"><span class="hs-identifier hs-var">fetchBatchSize</span></a></span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span id="local-6989586621689341986"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setRetry"><span class="hs-identifier hs-type">setRetry</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-72"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689341986"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689341986"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-73"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-74"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-75"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">UTCTime</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-76"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-77"></span><span>  </span><span class="annot"><a href="#local-6989586621689341986"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-78"></span><span id="setRetry"><span class="annot"><span class="annottext">setRetry :: MSSQLSourceConfig
-&gt; Event 'MSSQL
-&gt; UTCTime
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setRetry"><span class="hs-identifier hs-var hs-var">setRetry</span></a></span></span><span> </span><span id="local-6989586621689341985"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689341985"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689341984"><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689341984"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span id="local-6989586621689341983"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621689341983"><span class="hs-identifier hs-var">retryTime</span></a></span></span><span> </span><span id="local-6989586621689341982"><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621689341982"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-79"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-80"></span><span>    </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-81"></span><span>      </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689341985"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-82"></span><span>        </span><span class="annot"><span class="annottext">Event 'MSSQL
-&gt; UTCTime
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setRetryTx"><span class="hs-identifier hs-var">setRetryTx</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689341984"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621689341983"><span class="hs-identifier hs-var">retryTime</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621689341982"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span id="local-6989586621689341980"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertManualEvent"><span class="hs-identifier hs-type">insertManualEvent</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689341980"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689341980"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-86"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-87"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-88"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-89"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-90"></span><span>  </span><span class="annot"><a href="Hasura.Session.html#UserInfo"><span class="hs-identifier hs-type">UserInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-91"></span><span>  </span><span class="annot"><a href="Hasura.Tracing.html#TraceContext"><span class="hs-identifier hs-type">Tracing.TraceContext</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-92"></span><span>  </span><span class="annot"><a href="#local-6989586621689341980"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span></span><span>
</span><span id="line-93"></span><span id="insertManualEvent"><span class="annot"><span class="annottext">insertManualEvent :: MSSQLSourceConfig
-&gt; TableName
-&gt; TriggerName
-&gt; Value
-&gt; UserInfo
-&gt; TraceContext
-&gt; m EventId
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertManualEvent"><span class="hs-identifier hs-var hs-var">insertManualEvent</span></a></span></span><span> </span><span id="local-6989586621689341979"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689341979"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689341978"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689341978"><span class="hs-identifier hs-var">tableName</span></a></span></span><span> </span><span id="local-6989586621689341977"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341977"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689341976"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621689341976"><span class="hs-identifier hs-var">payload</span></a></span></span><span> </span><span id="local-6989586621689341975"><span class="annot"><span class="annottext">UserInfo
</span><a href="#local-6989586621689341975"><span class="hs-identifier hs-var">_userInfo</span></a></span></span><span> </span><span id="local-6989586621689341974"><span class="annot"><span class="annottext">TraceContext
</span><a href="#local-6989586621689341974"><span class="hs-identifier hs-var">_traceCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-94"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr EventId) -&gt; m EventId
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr EventId) -&gt; m EventId)
-&gt; m (Either QErr EventId) -&gt; m EventId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-95"></span><span>    </span><span class="annot"><span class="annottext">IO (Either QErr EventId) -&gt; m (Either QErr EventId)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr EventId) -&gt; m (Either QErr EventId))
-&gt; IO (Either QErr EventId) -&gt; m (Either QErr EventId)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-96"></span><span>      </span><span class="annot"><span class="annottext">MSSQLSourceConfig
-&gt; TxET QErr IO EventId -&gt; IO (Either QErr EventId)
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689341979"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO EventId -&gt; IO (Either QErr EventId))
-&gt; TxET QErr IO EventId -&gt; IO (Either QErr EventId)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-97"></span><span>        </span><span class="hs-comment">-- TODO: Include TraceContext in payload</span><span>
</span><span id="line-98"></span><span>        </span><span class="annot"><span class="annottext">TableName -&gt; TriggerName -&gt; Value -&gt; TxET QErr IO EventId
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertMSSQLManualEventTx"><span class="hs-identifier hs-var">insertMSSQLManualEventTx</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689341978"><span class="hs-identifier hs-var">tableName</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341977"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621689341976"><span class="hs-identifier hs-var">payload</span></a></span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span id="local-6989586621689341972"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getMaintenanceModeVersion"><span class="hs-identifier hs-type">getMaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689341972"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-102"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689341972"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-104"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-105"></span><span>  </span><span class="annot"><a href="#local-6989586621689341972"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span></span><span>
</span><span id="line-106"></span><span id="getMaintenanceModeVersion"><span class="annot"><span class="annottext">getMaintenanceModeVersion :: MSSQLSourceConfig -&gt; m MaintenanceModeVersion
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getMaintenanceModeVersion"><span class="hs-identifier hs-var hs-var">getMaintenanceModeVersion</span></a></span></span><span> </span><span id="local-6989586621689341971"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689341971"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-107"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr MaintenanceModeVersion) -&gt; m MaintenanceModeVersion
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr MaintenanceModeVersion)
 -&gt; m MaintenanceModeVersion)
-&gt; m (Either QErr MaintenanceModeVersion)
-&gt; m MaintenanceModeVersion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-108"></span><span>    </span><span class="annot"><span class="annottext">IO (Either QErr MaintenanceModeVersion)
-&gt; m (Either QErr MaintenanceModeVersion)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr MaintenanceModeVersion)
 -&gt; m (Either QErr MaintenanceModeVersion))
-&gt; IO (Either QErr MaintenanceModeVersion)
-&gt; m (Either QErr MaintenanceModeVersion)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-109"></span><span>      </span><span class="annot"><span class="annottext">MSSQLSourceConfig
-&gt; TxET QErr IO MaintenanceModeVersion
-&gt; IO (Either QErr MaintenanceModeVersion)
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceReadTx"><span class="hs-identifier hs-var">runMSSQLSourceReadTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689341971"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO MaintenanceModeVersion
 -&gt; IO (Either QErr MaintenanceModeVersion))
-&gt; TxET QErr IO MaintenanceModeVersion
-&gt; IO (Either QErr MaintenanceModeVersion)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TxET QErr IO MaintenanceModeVersion
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getMaintenanceModeVersionTx"><span class="hs-identifier hs-var">getMaintenanceModeVersionTx</span></a></span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span id="local-6989586621689341968"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordSuccess"><span class="hs-identifier hs-type">recordSuccess</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-112"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689341968"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-113"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-114"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-115"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#Invocation"><span class="hs-identifier hs-type">Invocation</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventType"><span class="hs-identifier hs-type">EventType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-116"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-117"></span><span>  </span><span class="annot"><a href="#local-6989586621689341968"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-118"></span><span id="recordSuccess"><span class="annot"><span class="annottext">recordSuccess :: MSSQLSourceConfig
-&gt; Event 'MSSQL
-&gt; Invocation 'EventType
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m (Either QErr ())
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordSuccess"><span class="hs-identifier hs-var hs-var">recordSuccess</span></a></span></span><span> </span><span id="local-6989586621689341967"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689341967"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689341966"><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689341966"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span id="local-6989586621689341965"><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621689341965"><span class="hs-identifier hs-var">invocation</span></a></span></span><span> </span><span id="local-6989586621689341964"><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621689341964"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-119"></span><span>  </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-120"></span><span>    </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689341967"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-121"></span><span>      </span><span class="annot"><span class="annottext">Invocation 'EventType -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertInvocation"><span class="hs-identifier hs-var">insertInvocation</span></a></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621689341965"><span class="hs-identifier hs-var">invocation</span></a></span><span>
</span><span id="line-122"></span><span>      </span><span class="annot"><span class="annottext">Event 'MSSQL
-&gt; MaintenanceMode MaintenanceModeVersion -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setSuccessTx"><span class="hs-identifier hs-var">setSuccessTx</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689341966"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621689341964"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span>
</span><span id="line-123"></span><span>
</span><span id="line-124"></span><span id="local-6989586621689341961"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordError"><span class="hs-identifier hs-type">recordError</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-125"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689341961"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-126"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-127"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-128"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#Invocation"><span class="hs-identifier hs-type">Invocation</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventType"><span class="hs-identifier hs-type">EventType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-129"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#ProcessEventError"><span class="hs-identifier hs-type">ProcessEventError</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-130"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-131"></span><span>  </span><span class="annot"><a href="#local-6989586621689341961"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-132"></span><span id="recordError"><span class="annot"><span class="annottext">recordError :: MSSQLSourceConfig
-&gt; Event 'MSSQL
-&gt; Invocation 'EventType
-&gt; ProcessEventError
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m (Either QErr ())
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordError"><span class="hs-identifier hs-var hs-var">recordError</span></a></span></span><span> </span><span id="local-6989586621689341960"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689341960"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689341959"><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689341959"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span id="local-6989586621689341958"><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621689341958"><span class="hs-identifier hs-var">invocation</span></a></span></span><span> </span><span id="local-6989586621689341957"><span class="annot"><span class="annottext">ProcessEventError
</span><a href="#local-6989586621689341957"><span class="hs-identifier hs-var">processEventError</span></a></span></span><span> </span><span id="local-6989586621689341956"><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621689341956"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-133"></span><span>  </span><span class="annot"><span class="annottext">MSSQLSourceConfig
-&gt; Event 'MSSQL
-&gt; Maybe (Invocation 'EventType)
-&gt; ProcessEventError
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m (Either QErr ())
forall (m :: * -&gt; *).
MonadIO m =&gt;
MSSQLSourceConfig
-&gt; Event 'MSSQL
-&gt; Maybe (Invocation 'EventType)
-&gt; ProcessEventError
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m (Either QErr ())
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordError%27"><span class="hs-identifier hs-var">recordError'</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689341960"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689341959"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Invocation 'EventType -&gt; Maybe (Invocation 'EventType)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621689341958"><span class="hs-identifier hs-var">invocation</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ProcessEventError
</span><a href="#local-6989586621689341957"><span class="hs-identifier hs-var">processEventError</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621689341956"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span>
</span><span id="line-134"></span><span>
</span><span id="line-135"></span><span id="local-6989586621689342181"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordError%27"><span class="hs-identifier hs-type">recordError'</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-136"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689342181"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-137"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-138"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-139"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#Invocation"><span class="hs-identifier hs-type">Invocation</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventType"><span class="hs-identifier hs-type">EventType</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-140"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#ProcessEventError"><span class="hs-identifier hs-type">ProcessEventError</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-141"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-142"></span><span>  </span><span class="annot"><a href="#local-6989586621689342181"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-143"></span><span id="recordError%27"><span class="annot"><span class="annottext">recordError' :: MSSQLSourceConfig
-&gt; Event 'MSSQL
-&gt; Maybe (Invocation 'EventType)
-&gt; ProcessEventError
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m (Either QErr ())
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#recordError%27"><span class="hs-identifier hs-var hs-var">recordError'</span></a></span></span><span> </span><span id="local-6989586621689341955"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689341955"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689341954"><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689341954"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span id="local-6989586621689341953"><span class="annot"><span class="annottext">Maybe (Invocation 'EventType)
</span><a href="#local-6989586621689341953"><span class="hs-identifier hs-var">invocation</span></a></span></span><span> </span><span id="local-6989586621689341952"><span class="annot"><span class="annottext">ProcessEventError
</span><a href="#local-6989586621689341952"><span class="hs-identifier hs-var">processEventError</span></a></span></span><span> </span><span id="local-6989586621689341951"><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621689341951"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-144"></span><span>  </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-145"></span><span>    </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689341955"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-146"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Invocation 'EventType)
-&gt; (Invocation 'EventType -&gt; TxET QErr IO ()) -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="Hasura.Prelude.html#onJust"><span class="hs-identifier hs-var">onJust</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Invocation 'EventType)
</span><a href="#local-6989586621689341953"><span class="hs-identifier hs-var">invocation</span></a></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertInvocation"><span class="hs-identifier hs-var">insertInvocation</span></a></span><span>
</span><span id="line-147"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ProcessEventError
</span><a href="#local-6989586621689341952"><span class="hs-identifier hs-var">processEventError</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-148"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#PESetRetry"><span class="hs-identifier hs-type">PESetRetry</span></a></span><span> </span><span id="local-6989586621689341948"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621689341948"><span class="hs-identifier hs-var">retryTime</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-149"></span><span>          </span><span class="annot"><span class="annottext">Event 'MSSQL
-&gt; UTCTime
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setRetryTx"><span class="hs-identifier hs-var">setRetryTx</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689341954"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621689341948"><span class="hs-identifier hs-var">retryTime</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621689341951"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span>
</span><span id="line-150"></span><span>        </span><span class="annot"><span class="annottext">ProcessEventError
</span><a href="Hasura.RQL.Types.EventTrigger.html#PESetError"><span class="hs-identifier hs-var">PESetError</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
-&gt; MaintenanceMode MaintenanceModeVersion -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setErrorTx"><span class="hs-identifier hs-var">setErrorTx</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689341954"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621689341951"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span>
</span><span id="line-151"></span><span>
</span><span id="line-152"></span><span id="local-6989586621689341945"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#redeliverEvent"><span class="hs-identifier hs-type">redeliverEvent</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-153"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689341945"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689341945"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-154"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-155"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-156"></span><span>  </span><span class="annot"><a href="#local-6989586621689341945"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-157"></span><span id="redeliverEvent"><span class="annot"><span class="annottext">redeliverEvent :: MSSQLSourceConfig -&gt; EventId -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#redeliverEvent"><span class="hs-identifier hs-var hs-var">redeliverEvent</span></a></span></span><span> </span><span id="local-6989586621689341944"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689341944"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689341943"><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621689341943"><span class="hs-identifier hs-var">eventId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-158"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-159"></span><span>    </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-160"></span><span>      </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689341944"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-161"></span><span>        </span><span class="annot"><span class="annottext">EventId -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkEventTx"><span class="hs-identifier hs-var">checkEventTx</span></a></span><span> </span><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621689341943"><span class="hs-identifier hs-var">eventId</span></a></span><span>
</span><span id="line-162"></span><span>        </span><span class="annot"><span class="annottext">EventId -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#markForDeliveryTx"><span class="hs-identifier hs-var">markForDeliveryTx</span></a></span><span> </span><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621689341943"><span class="hs-identifier hs-var">eventId</span></a></span><span>
</span><span id="line-163"></span><span>
</span><span id="line-164"></span><span id="local-6989586621689341940"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerAndArchiveEvents"><span class="hs-identifier hs-type">dropTriggerAndArchiveEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-165"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689341940"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689341940"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-166"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-167"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-168"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-169"></span><span>  </span><span class="annot"><a href="#local-6989586621689341940"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-170"></span><span id="dropTriggerAndArchiveEvents"><span class="annot"><span class="annottext">dropTriggerAndArchiveEvents :: MSSQLSourceConfig -&gt; TriggerName -&gt; TableName -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerAndArchiveEvents"><span class="hs-identifier hs-var hs-var">dropTriggerAndArchiveEvents</span></a></span></span><span> </span><span id="local-6989586621689341939"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689341939"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689341938"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341938"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689341937"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689341937"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-171"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-172"></span><span>    </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-173"></span><span>      </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689341939"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-174"></span><span>        </span><span class="annot"><span class="annottext">TriggerName -&gt; SchemaName -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerQ"><span class="hs-identifier hs-var">dropTriggerQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341938"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableName -&gt; SchemaName
</span><a href="Hasura.Backends.MSSQL.Types.Internal.html#%24sel%3AtableSchema%3ATableName"><span class="hs-identifier hs-var hs-var">tableSchema</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689341937"><span class="hs-identifier hs-var">table</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-175"></span><span>        </span><span class="annot"><span class="annottext">TriggerName -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#archiveEvents"><span class="hs-identifier hs-var">archiveEvents</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341938"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span id="local-6989586621689341934"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropDanglingSQLTrigger"><span class="hs-identifier hs-type">dropDanglingSQLTrigger</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-178"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689341934"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689341934"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-179"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-180"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-181"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-182"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">HashSet</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Ops"><span class="hs-identifier hs-type">Ops</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-183"></span><span>  </span><span class="annot"><a href="#local-6989586621689341934"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-184"></span><span id="dropDanglingSQLTrigger"><span class="annot"><span class="annottext">dropDanglingSQLTrigger :: MSSQLSourceConfig
-&gt; TriggerName -&gt; TableName -&gt; HashSet Ops -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropDanglingSQLTrigger"><span class="hs-identifier hs-var hs-var">dropDanglingSQLTrigger</span></a></span></span><span> </span><span id="local-6989586621689341933"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689341933"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689341932"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341932"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689341931"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689341931"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span id="local-6989586621689341930"><span class="annot"><span class="annottext">HashSet Ops
</span><a href="#local-6989586621689341930"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-185"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-186"></span><span>    </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-187"></span><span>      </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689341933"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-188"></span><span>        </span><span class="annot"><span class="annottext">(Ops -&gt; TxET QErr IO ()) -&gt; HashSet Ops -&gt; TxET QErr IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName -&gt; SchemaName -&gt; Ops -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerOp"><span class="hs-identifier hs-var">dropTriggerOp</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341932"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableName -&gt; SchemaName
</span><a href="Hasura.Backends.MSSQL.Types.Internal.html#%24sel%3AtableSchema%3ATableName"><span class="hs-identifier hs-var hs-var">tableSchema</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689341931"><span class="hs-identifier hs-var">table</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashSet Ops
</span><a href="#local-6989586621689341930"><span class="hs-identifier hs-var">ops</span></a></span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span id="local-6989586621689341927"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#createTableEventTrigger"><span class="hs-identifier hs-type">createTableEventTrigger</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-191"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689341927"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-192"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#ServerConfigCtx"><span class="hs-identifier hs-type">ServerConfigCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-193"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-194"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-195"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-196"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-197"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerOpsDef"><span class="hs-identifier hs-type">TriggerOpsDef</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-198"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Table.html#PrimaryKey"><span class="hs-identifier hs-type">PrimaryKey</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-199"></span><span>  </span><span class="annot"><a href="#local-6989586621689341927"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-200"></span><span id="createTableEventTrigger"><span class="annot"><span class="annottext">createTableEventTrigger :: ServerConfigCtx
-&gt; MSSQLSourceConfig
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerName
-&gt; TriggerOpsDef 'MSSQL
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; m (Either QErr ())
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#createTableEventTrigger"><span class="hs-identifier hs-var hs-var">createTableEventTrigger</span></a></span></span><span> </span><span id="local-6989586621689341926"><span class="annot"><span class="annottext">ServerConfigCtx
</span><a href="#local-6989586621689341926"><span class="hs-identifier hs-var">_serverConfigCtx</span></a></span></span><span> </span><span id="local-6989586621689341925"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689341925"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689341924"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689341924"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span id="local-6989586621689341923"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341923"><span class="hs-identifier hs-var">columns</span></a></span></span><span> </span><span id="local-6989586621689341922"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341922"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689341921"><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621689341921"><span class="hs-identifier hs-var">opsDefinition</span></a></span></span><span> </span><span id="local-6989586621689341920"><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
</span><a href="#local-6989586621689341920"><span class="hs-identifier hs-var">primaryKeyMaybe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-201"></span><span>  </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; m (Either QErr ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr ()) -&gt; m (Either QErr ()))
-&gt; IO (Either QErr ()) -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-202"></span><span>    </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689341925"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; IO (Either QErr ()))
-&gt; TxET QErr IO () -&gt; IO (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-203"></span><span>      </span><span class="annot"><span class="annottext">TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOpsDef 'MSSQL
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; TxET QErr IO ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOpsDef 'MSSQL
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkAllTriggersQ"><span class="hs-identifier hs-var">mkAllTriggersQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341922"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689341924"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341923"><span class="hs-identifier hs-var">columns</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621689341921"><span class="hs-identifier hs-var">opsDefinition</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
</span><a href="#local-6989586621689341920"><span class="hs-identifier hs-var">primaryKeyMaybe</span></a></span><span>
</span><span id="line-204"></span><span>
</span><span id="line-205"></span><span id="local-6989586621689341918"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#createMissingSQLTriggers"><span class="hs-identifier hs-type">createMissingSQLTriggers</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-206"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689341918"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-207"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689341918"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-208"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621689341918"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-209"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-210"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-211"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-212"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Table.html#PrimaryKey"><span class="hs-identifier hs-type">PrimaryKey</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-213"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-214"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerOpsDef"><span class="hs-identifier hs-type">TriggerOpsDef</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-215"></span><span>  </span><span class="annot"><a href="#local-6989586621689341918"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-216"></span><span id="createMissingSQLTriggers"><span class="annot"><span class="annottext">createMissingSQLTriggers :: MSSQLSourceConfig
-&gt; TableName
-&gt; ([ColumnInfo 'MSSQL],
    Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)))
-&gt; TriggerName
-&gt; TriggerOpsDef 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#createMissingSQLTriggers"><span class="hs-identifier hs-var hs-var">createMissingSQLTriggers</span></a></span></span><span> </span><span id="local-6989586621689341917"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689341917"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689341916"><span class="annot"><span class="annottext">table :: TableName
</span><a href="#local-6989586621689341916"><span class="hs-identifier hs-var">table</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span id="local-6989586621689341914"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341914"><span class="hs-identifier hs-var">tableNameText</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span id="local-6989586621689341912"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341912"><span class="hs-identifier hs-var">schemaText</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621689341911"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341911"><span class="hs-identifier hs-var">allCols</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689341910"><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
</span><a href="#local-6989586621689341910"><span class="hs-identifier hs-var">primaryKeyMaybe</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621689341909"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341909"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689341908"><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621689341908"><span class="hs-identifier hs-var">opsDefinition</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-217"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-218"></span><span>    </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr m () -&gt; m (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689341917"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr m () -&gt; m (Either QErr ()))
-&gt; TxET QErr m () -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-219"></span><span>      </span><span class="annot"><span class="annottext">Maybe (SubscribeOpSpec 'MSSQL)
-&gt; (SubscribeOpSpec 'MSSQL -&gt; TxET QErr m ()) -&gt; TxET QErr m ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="Hasura.Prelude.html#onJust"><span class="hs-identifier hs-var">onJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL -&gt; Maybe (SubscribeOpSpec 'MSSQL)
forall (b :: BackendType).
TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
</span><a href="Hasura.RQL.Types.EventTrigger.html#tdInsert"><span class="hs-identifier hs-var hs-var">tdInsert</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621689341908"><span class="hs-identifier hs-var">opsDefinition</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ops -&gt; SubscribeOpSpec 'MSSQL -&gt; TxET QErr m ()
</span><a href="#local-6989586621689341906"><span class="hs-identifier hs-var">doesSQLTriggerExist</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#INSERT"><span class="hs-identifier hs-var">INSERT</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-220"></span><span>      </span><span class="annot"><span class="annottext">Maybe (SubscribeOpSpec 'MSSQL)
-&gt; (SubscribeOpSpec 'MSSQL -&gt; TxET QErr m ()) -&gt; TxET QErr m ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="Hasura.Prelude.html#onJust"><span class="hs-identifier hs-var">onJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL -&gt; Maybe (SubscribeOpSpec 'MSSQL)
forall (b :: BackendType).
TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
</span><a href="Hasura.RQL.Types.EventTrigger.html#tdUpdate"><span class="hs-identifier hs-var hs-var">tdUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621689341908"><span class="hs-identifier hs-var">opsDefinition</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ops -&gt; SubscribeOpSpec 'MSSQL -&gt; TxET QErr m ()
</span><a href="#local-6989586621689341906"><span class="hs-identifier hs-var">doesSQLTriggerExist</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#UPDATE"><span class="hs-identifier hs-var">UPDATE</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>      </span><span class="annot"><span class="annottext">Maybe (SubscribeOpSpec 'MSSQL)
-&gt; (SubscribeOpSpec 'MSSQL -&gt; TxET QErr m ()) -&gt; TxET QErr m ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="Hasura.Prelude.html#onJust"><span class="hs-identifier hs-var">onJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL -&gt; Maybe (SubscribeOpSpec 'MSSQL)
forall (b :: BackendType).
TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
</span><a href="Hasura.RQL.Types.EventTrigger.html#tdDelete"><span class="hs-identifier hs-var hs-var">tdDelete</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621689341908"><span class="hs-identifier hs-var">opsDefinition</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ops -&gt; SubscribeOpSpec 'MSSQL -&gt; TxET QErr m ()
</span><a href="#local-6989586621689341906"><span class="hs-identifier hs-var">doesSQLTriggerExist</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#DELETE"><span class="hs-identifier hs-var">DELETE</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-223"></span><span>    </span><span id="local-6989586621689341906"><span class="annot"><span class="annottext">doesSQLTriggerExist :: Ops -&gt; SubscribeOpSpec 'MSSQL -&gt; TxET QErr m ()
</span><a href="#local-6989586621689341906"><span class="hs-identifier hs-var hs-var">doesSQLTriggerExist</span></a></span></span><span> </span><span id="local-6989586621689341900"><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621689341900"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span id="local-6989586621689341899"><span class="annot"><span class="annottext">SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621689341899"><span class="hs-identifier hs-var">opSpec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-224"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689341898"><span class="annot"><span class="annottext">triggerNameWithOp :: Text
</span><a href="#local-6989586621689341898"><span class="hs-identifier hs-var hs-var">triggerNameWithOp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;notify_hasura_&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341909"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;_&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Ops -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="Hasura.Prelude.html#tshow"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621689341900"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-225"></span><span>      </span><span id="local-6989586621689341895"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621689341895"><span class="hs-identifier hs-var">doesOpTriggerExist</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-226"></span><span>        </span><span class="annot"><span class="annottext">TxE QErr Bool -&gt; TxET QErr m Bool
forall (m :: * -&gt; *) a. MonadMSSQLTx m =&gt; TxE QErr a -&gt; m a
</span><a href="Hasura.Backends.MSSQL.Connection.html#liftMSSQLTx"><span class="hs-identifier hs-var">liftMSSQLTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr Bool -&gt; TxET QErr m Bool)
-&gt; TxE QErr Bool -&gt; TxET QErr m Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-227"></span><span>          </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxE QErr Bool
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m a
</span><a href="Database.MSSQL.Transaction.html#singleRowQueryE"><span class="hs-identifier hs-var">singleRowQueryE</span></a></span><span>
</span><span id="line-228"></span><span>            </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-229"></span><span>            </span><span class="annot"><span class="">[ODBC.sql|
               SELECT CASE WHEN EXISTS
                 ( SELECT 1
                   FROM sys.triggers tr
                   INNER join sys.tables tb on tr.parent_id = tb.object_id
                   INNER join sys.schemas s on tb.schema_id = s.schema_id
                   WHERE tb.name = $tableNameText AND tr.name = $triggerNameWithOp AND s.name = $schemaText
                 )
               THEN CAST(1 AS BIT)
               ELSE CAST(0 AS BIT)
               END;
             |]</span></span><span>
</span><span id="line-241"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; TxET QErr m () -&gt; TxET QErr m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621689341895"><span class="hs-identifier hs-var">doesOpTriggerExist</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr m () -&gt; TxET QErr m ())
-&gt; TxET QErr m () -&gt; TxET QErr m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-242"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621689341900"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-243"></span><span>          </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#INSERT"><span class="hs-identifier hs-var">INSERT</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; SubscribeOpSpec 'MSSQL
-&gt; TxET QErr m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkInsertTriggerQ"><span class="hs-identifier hs-var">mkInsertTriggerQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341909"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689341916"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341911"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621689341899"><span class="hs-identifier hs-var">opSpec</span></a></span><span>
</span><span id="line-244"></span><span>          </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#UPDATE"><span class="hs-identifier hs-var">UPDATE</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; SubscribeOpSpec 'MSSQL
-&gt; TxET QErr m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkUpdateTriggerQ"><span class="hs-identifier hs-var">mkUpdateTriggerQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341909"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689341916"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341911"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
</span><a href="#local-6989586621689341910"><span class="hs-identifier hs-var">primaryKeyMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621689341899"><span class="hs-identifier hs-var">opSpec</span></a></span><span>
</span><span id="line-245"></span><span>          </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#DELETE"><span class="hs-identifier hs-var">DELETE</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; SubscribeOpSpec 'MSSQL
-&gt; TxET QErr m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkDeleteTriggerQ"><span class="hs-identifier hs-var">mkDeleteTriggerQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341909"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689341916"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341911"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621689341899"><span class="hs-identifier hs-var">opSpec</span></a></span><span>
</span><span id="line-246"></span><span>          </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#MANUAL"><span class="hs-identifier hs-var">MANUAL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TxET QErr m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span id="local-6989586621689341887"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unlockEventsInSource"><span class="hs-identifier hs-type">unlockEventsInSource</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-249"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689341887"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-250"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-type">MSSQLSourceConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-251"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">NE.NESet</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-252"></span><span>  </span><span class="annot"><a href="#local-6989586621689341887"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-253"></span><span id="unlockEventsInSource"><span class="annot"><span class="annottext">unlockEventsInSource :: MSSQLSourceConfig -&gt; NESet EventId -&gt; m (Either QErr Int)
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unlockEventsInSource"><span class="hs-identifier hs-var hs-var">unlockEventsInSource</span></a></span></span><span> </span><span id="local-6989586621689341886"><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689341886"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621689341885"><span class="annot"><span class="annottext">NESet EventId
</span><a href="#local-6989586621689341885"><span class="hs-identifier hs-var">eventIds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-254"></span><span>  </span><span class="annot"><span class="annottext">IO (Either QErr Int) -&gt; m (Either QErr Int)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr Int) -&gt; m (Either QErr Int))
-&gt; IO (Either QErr Int) -&gt; m (Either QErr Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-255"></span><span>    </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; TxET QErr IO Int -&gt; IO (Either QErr Int)
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
MSSQLSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.MSSQL.Connection.html#runMSSQLSourceWriteTx"><span class="hs-identifier hs-var">runMSSQLSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLSourceConfig
</span><a href="#local-6989586621689341886"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO Int -&gt; IO (Either QErr Int))
-&gt; TxET QErr IO Int -&gt; IO (Either QErr Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-256"></span><span>      </span><span class="annot"><span class="annottext">[EventId] -&gt; TxET QErr IO Int
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unlockEventsTx"><span class="hs-identifier hs-var">unlockEventsTx</span></a></span><span> </span><span class="annot"><span class="annottext">([EventId] -&gt; TxET QErr IO Int) -&gt; [EventId] -&gt; TxET QErr IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NESet EventId -&gt; [EventId]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">NESet EventId
</span><a href="#local-6989586621689341885"><span class="hs-identifier hs-var">eventIds</span></a></span><span>
</span><span id="line-257"></span><span>
</span><span id="line-258"></span><span class="hs-comment">---- DATABASE QUERIES ---------------------</span><span>
</span><span id="line-259"></span><span class="hs-comment">--</span><span>
</span><span id="line-260"></span><span class="hs-comment">--   The API for our in-database work queue:</span><span>
</span><span id="line-261"></span><span class="hs-comment">-------------------------------------------</span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertInvocation"><span class="hs-identifier hs-type">insertInvocation</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#Invocation"><span class="hs-identifier hs-type">Invocation</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventType"><span class="hs-identifier hs-type">EventType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span id="insertInvocation"><span class="annot"><span class="annottext">insertInvocation :: Invocation 'EventType -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertInvocation"><span class="hs-identifier hs-var hs-var">insertInvocation</span></a></span></span><span> </span><span id="local-6989586621689341882"><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621689341882"><span class="hs-identifier hs-var">invo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-265"></span><span>  </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-266"></span><span>    </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-267"></span><span>    </span><span class="annot"><span class="">[ODBC.sql|
      INSERT INTO hdb_catalog.event_invocation_logs (event_id, status, request, response)
          VALUES ($invoEventId, $invoStatus, $invoRequest, $invoResponse)
    |]</span></span><span>
</span><span id="line-271"></span><span>
</span><span id="line-272"></span><span>  </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-273"></span><span>    </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-274"></span><span>    </span><span class="annot"><span class="">[ODBC.sql|
      UPDATE hdb_catalog.event_log

      SET tries = tries + 1
      WHERE id = $invoEventId
    |]</span></span><span>
</span><span id="line-280"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-281"></span><span>    </span><span id="local-6989586621689341881"><span class="annot"><span class="annottext">invoEventId :: Text
</span><a href="#local-6989586621689341881"><span class="hs-identifier hs-var hs-var">invoEventId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventId -&gt; Text
</span><a href="Hasura.RQL.Types.Eventing.html#unEventId"><span class="hs-identifier hs-var hs-var">unEventId</span></a></span><span> </span><span class="annot"><span class="annottext">(EventId -&gt; Text) -&gt; EventId -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType -&gt; EventId
forall (a :: TriggerTypes). Invocation a -&gt; EventId
</span><a href="Hasura.RQL.Types.Eventing.html#iEventId"><span class="hs-identifier hs-var hs-var">iEventId</span></a></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621689341882"><span class="hs-identifier hs-var">invo</span></a></span><span>
</span><span id="line-282"></span><span>    </span><span id="local-6989586621689341880"><span class="annot"><span class="annottext">invoStatus :: Maybe Int
</span><a href="#local-6989586621689341880"><span class="hs-identifier hs-var hs-var">invoStatus</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int) -&gt; Maybe Int -&gt; Maybe Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType -&gt; Maybe Int
forall (a :: TriggerTypes). Invocation a -&gt; Maybe Int
</span><a href="Hasura.RQL.Types.Eventing.html#iStatus"><span class="hs-identifier hs-var hs-var">iStatus</span></a></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621689341882"><span class="hs-identifier hs-var">invo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-283"></span><span>    </span><span id="local-6989586621689341879"><span class="annot"><span class="annottext">invoRequest :: ByteString
</span><a href="#local-6989586621689341879"><span class="hs-identifier hs-var hs-var">invoRequest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">J.encode</span></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; ByteString) -&gt; Value -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">WebhookRequest -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">J.toJSON</span></span><span> </span><span class="annot"><span class="annottext">(WebhookRequest -&gt; Value) -&gt; WebhookRequest -&gt; Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType -&gt; WebhookRequest
forall (a :: TriggerTypes). Invocation a -&gt; WebhookRequest
</span><a href="Hasura.RQL.Types.Eventing.html#iRequest"><span class="hs-identifier hs-var hs-var">iRequest</span></a></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621689341882"><span class="hs-identifier hs-var">invo</span></a></span><span>
</span><span id="line-284"></span><span>    </span><span id="local-6989586621689341878"><span class="annot"><span class="annottext">invoResponse :: ByteString
</span><a href="#local-6989586621689341878"><span class="hs-identifier hs-var hs-var">invoResponse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">J.encode</span></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; ByteString) -&gt; Value -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Response 'EventType -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">J.toJSON</span></span><span> </span><span class="annot"><span class="annottext">(Response 'EventType -&gt; Value) -&gt; Response 'EventType -&gt; Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType -&gt; Response 'EventType
forall (a :: TriggerTypes). Invocation a -&gt; Response a
</span><a href="Hasura.RQL.Types.Eventing.html#iResponse"><span class="hs-identifier hs-var hs-var">iResponse</span></a></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621689341882"><span class="hs-identifier hs-var">invo</span></a></span><span>
</span><span id="line-285"></span><span>
</span><span id="line-286"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertMSSQLManualEventTx"><span class="hs-identifier hs-type">insertMSSQLManualEventTx</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-287"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-288"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-289"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-290"></span><span>  </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span>
</span><span id="line-291"></span><span id="insertMSSQLManualEventTx"><span class="annot"><span class="annottext">insertMSSQLManualEventTx :: TableName -&gt; TriggerName -&gt; Value -&gt; TxET QErr IO EventId
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#insertMSSQLManualEventTx"><span class="hs-identifier hs-var hs-var">insertMSSQLManualEventTx</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span id="local-6989586621689341869"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341869"><span class="hs-identifier hs-var">tableName</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span id="local-6989586621689341868"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341868"><span class="hs-identifier hs-var">schemaName</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621689341867"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341867"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689341866"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621689341866"><span class="hs-identifier hs-var">rowData</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-292"></span><span>  </span><span id="local-6989586621689341865"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689341865"><span class="hs-identifier hs-var">eventId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-293"></span><span>    </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ByteString
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m a
</span><a href="Database.MSSQL.Transaction.html#singleRowQueryE"><span class="hs-identifier hs-var">singleRowQueryE</span></a></span><span>
</span><span id="line-294"></span><span>      </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-295"></span><span>      </span><span class="annot"><span class="">[ODBC.sql|
          INSERT INTO hdb_catalog.event_log (schema_name, table_name, trigger_name, payload)
          OUTPUT CONVERT(varchar(MAX), inserted.id)
          VALUES
          ($schemaName, $tableName, $triggerNameTxt, $payload)
        |]</span></span><span>
</span><span id="line-301"></span><span>  </span><span class="annot"><span class="annottext">EventId -&gt; TxET QErr IO EventId
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; EventId
</span><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-var">EventId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Text
</span><a href="Hasura.Prelude.html#bsToTxt"><span class="hs-identifier hs-var">bsToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689341865"><span class="hs-identifier hs-var">eventId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-302"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-303"></span><span>    </span><span id="local-6989586621689341864"><span class="annot"><span class="annottext">triggerNameTxt :: Text
</span><a href="#local-6989586621689341864"><span class="hs-identifier hs-var hs-var">triggerNameTxt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341867"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-304"></span><span>    </span><span id="local-6989586621689341863"><span class="annot"><span class="annottext">payload :: ByteString
</span><a href="#local-6989586621689341863"><span class="hs-identifier hs-var hs-var">payload</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">J.encode</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621689341866"><span class="hs-identifier hs-var">rowData</span></a></span><span>
</span><span id="line-305"></span><span>
</span><span id="line-306"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setSuccessTx"><span class="hs-identifier hs-type">setSuccessTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-307"></span><span id="setSuccessTx"><span class="annot"><span class="annottext">setSuccessTx :: Event 'MSSQL
-&gt; MaintenanceMode MaintenanceModeVersion -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setSuccessTx"><span class="hs-identifier hs-var hs-var">setSuccessTx</span></a></span></span><span> </span><span id="local-6989586621689341860"><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689341860"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-308"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-type">MaintenanceModeEnabled</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="Hasura.RQL.Types.Source.html#PreviousMMVersion"><span class="hs-identifier hs-var">PreviousMMVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;unexpected: no previous maintenance mode version found for MSSQL source&quot;</span></span><span>
</span><span id="line-309"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-type">MaintenanceModeEnabled</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="Hasura.RQL.Types.Source.html#CurrentMMVersion"><span class="hs-identifier hs-var">CurrentMMVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TxET QErr IO ()
</span><a href="#local-6989586621689341855"><span class="hs-identifier hs-var">latestVersionSetSuccess</span></a></span><span>
</span><span id="line-310"></span><span>  </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="Hasura.Server.Types.html#MaintenanceModeDisabled"><span class="hs-identifier hs-var">MaintenanceModeDisabled</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TxET QErr IO ()
</span><a href="#local-6989586621689341855"><span class="hs-identifier hs-var">latestVersionSetSuccess</span></a></span><span>
</span><span id="line-311"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-312"></span><span>    </span><span id="local-6989586621689341853"><span class="annot"><span class="annottext">eventId :: Text
</span><a href="#local-6989586621689341853"><span class="hs-identifier hs-var hs-var">eventId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventId -&gt; Text
</span><a href="Hasura.RQL.Types.Eventing.html#unEventId"><span class="hs-identifier hs-var hs-var">unEventId</span></a></span><span> </span><span class="annot"><span class="annottext">(EventId -&gt; Text) -&gt; EventId -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL -&gt; EventId
forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689341860"><span class="hs-identifier hs-var">event</span></a></span><span>
</span><span id="line-313"></span><span>
</span><span id="line-314"></span><span>    </span><span id="local-6989586621689341855"><span class="annot"><span class="annottext">latestVersionSetSuccess :: TxET QErr IO ()
</span><a href="#local-6989586621689341855"><span class="hs-identifier hs-var hs-var">latestVersionSetSuccess</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-315"></span><span>      </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-316"></span><span>        </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-317"></span><span>        </span><span class="annot"><span class="">[ODBC.sql|
          UPDATE hdb_catalog.event_log
          SET delivered = 1 , next_retry_at = NULL, locked = NULL
          WHERE id = $eventId
        |]</span></span><span>
</span><span id="line-322"></span><span>
</span><span id="line-323"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setErrorTx"><span class="hs-identifier hs-type">setErrorTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-324"></span><span id="setErrorTx"><span class="annot"><span class="annottext">setErrorTx :: Event 'MSSQL
-&gt; MaintenanceMode MaintenanceModeVersion -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setErrorTx"><span class="hs-identifier hs-var hs-var">setErrorTx</span></a></span></span><span> </span><span id="local-6989586621689341851"><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689341851"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-325"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-type">MaintenanceModeEnabled</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="Hasura.RQL.Types.Source.html#PreviousMMVersion"><span class="hs-identifier hs-var">PreviousMMVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;unexpected: there is no previous maintenance mode version supported for MSSQL event triggers&quot;</span></span><span>
</span><span id="line-326"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-type">MaintenanceModeEnabled</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="Hasura.RQL.Types.Source.html#CurrentMMVersion"><span class="hs-identifier hs-var">CurrentMMVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TxET QErr IO ()
</span><a href="#local-6989586621689341850"><span class="hs-identifier hs-var">latestVersionSetSuccess</span></a></span><span>
</span><span id="line-327"></span><span>  </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="Hasura.Server.Types.html#MaintenanceModeDisabled"><span class="hs-identifier hs-var">MaintenanceModeDisabled</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TxET QErr IO ()
</span><a href="#local-6989586621689341850"><span class="hs-identifier hs-var">latestVersionSetSuccess</span></a></span><span>
</span><span id="line-328"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-329"></span><span>    </span><span id="local-6989586621689341849"><span class="annot"><span class="annottext">eventId :: Text
</span><a href="#local-6989586621689341849"><span class="hs-identifier hs-var hs-var">eventId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventId -&gt; Text
</span><a href="Hasura.RQL.Types.Eventing.html#unEventId"><span class="hs-identifier hs-var hs-var">unEventId</span></a></span><span> </span><span class="annot"><span class="annottext">(EventId -&gt; Text) -&gt; EventId -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL -&gt; EventId
forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689341851"><span class="hs-identifier hs-var">event</span></a></span><span>
</span><span id="line-330"></span><span>
</span><span id="line-331"></span><span>    </span><span id="local-6989586621689341850"><span class="annot"><span class="annottext">latestVersionSetSuccess :: TxET QErr IO ()
</span><a href="#local-6989586621689341850"><span class="hs-identifier hs-var hs-var">latestVersionSetSuccess</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-332"></span><span>      </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-333"></span><span>        </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-334"></span><span>        </span><span class="annot"><span class="">[ODBC.sql|
          UPDATE hdb_catalog.event_log
          SET error = 1 , next_retry_at = NULL, locked = NULL
          WHERE id = $eventId
        |]</span></span><span>
</span><span id="line-339"></span><span>
</span><span id="line-340"></span><span class="hs-comment">-- See Note [UTCTIME not supported in SQL Server]</span><span>
</span><span id="line-341"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setRetryTx"><span class="hs-identifier hs-type">setRetryTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">UTCTime</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-342"></span><span id="setRetryTx"><span class="annot"><span class="annottext">setRetryTx :: Event 'MSSQL
-&gt; UTCTime
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#setRetryTx"><span class="hs-identifier hs-var hs-var">setRetryTx</span></a></span></span><span> </span><span id="local-6989586621689341848"><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689341848"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span id="local-6989586621689341847"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621689341847"><span class="hs-identifier hs-var">utcTime</span></a></span></span><span> </span><span id="local-6989586621689341846"><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621689341846"><span class="hs-identifier hs-var">maintenanceMode</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-343"></span><span>  </span><span id="local-6989586621689341845"><span class="annot"><span class="annottext">Datetime2
</span><a href="#local-6989586621689341845"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; TxET QErr IO Datetime2
forall (m :: * -&gt; *). MonadIO m =&gt; UTCTime -&gt; m Datetime2
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#convertUTCToDatetime2"><span class="hs-identifier hs-var">convertUTCToDatetime2</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621689341847"><span class="hs-identifier hs-var">utcTime</span></a></span><span>
</span><span id="line-344"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621689341846"><span class="hs-identifier hs-var">maintenanceMode</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-345"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-type">MaintenanceModeEnabled</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="Hasura.RQL.Types.Source.html#PreviousMMVersion"><span class="hs-identifier hs-var">PreviousMMVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;unexpected: there is no previous maintenance mode version supported for MSSQL event triggers&quot;</span></span><span>
</span><span id="line-346"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-type">MaintenanceModeEnabled</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="Hasura.RQL.Types.Source.html#CurrentMMVersion"><span class="hs-identifier hs-var">CurrentMMVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Datetime2 -&gt; TxET QErr IO ()
</span><a href="#local-6989586621689341843"><span class="hs-identifier hs-var">latestVersionSetRetry</span></a></span><span> </span><span class="annot"><span class="annottext">Datetime2
</span><a href="#local-6989586621689341845"><span class="hs-identifier hs-var">time</span></a></span><span>
</span><span id="line-347"></span><span>    </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="Hasura.Server.Types.html#MaintenanceModeDisabled"><span class="hs-identifier hs-var">MaintenanceModeDisabled</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Datetime2 -&gt; TxET QErr IO ()
</span><a href="#local-6989586621689341843"><span class="hs-identifier hs-var">latestVersionSetRetry</span></a></span><span> </span><span class="annot"><span class="annottext">Datetime2
</span><a href="#local-6989586621689341845"><span class="hs-identifier hs-var">time</span></a></span><span>
</span><span id="line-348"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-349"></span><span>    </span><span id="local-6989586621689341842"><span class="annot"><span class="annottext">eventId :: Text
</span><a href="#local-6989586621689341842"><span class="hs-identifier hs-var hs-var">eventId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventId -&gt; Text
</span><a href="Hasura.RQL.Types.Eventing.html#unEventId"><span class="hs-identifier hs-var hs-var">unEventId</span></a></span><span> </span><span class="annot"><span class="annottext">(EventId -&gt; Text) -&gt; EventId -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL -&gt; EventId
forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event 'MSSQL
</span><a href="#local-6989586621689341848"><span class="hs-identifier hs-var">event</span></a></span><span>
</span><span id="line-350"></span><span>    </span><span class="hs-comment">-- NOTE: Naveen: The following method to convert from Datetime to Datetimeoffset  was</span><span>
</span><span id="line-351"></span><span>    </span><span class="hs-comment">-- taken from https://stackoverflow.com/questions/17866311/how-to-cast-datetime-to-datetimeoffset</span><span>
</span><span id="line-352"></span><span>    </span><span id="local-6989586621689341843"><span class="annot"><span class="annottext">latestVersionSetRetry :: Datetime2 -&gt; TxET QErr IO ()
</span><a href="#local-6989586621689341843"><span class="hs-identifier hs-var hs-var">latestVersionSetRetry</span></a></span></span><span> </span><span id="local-6989586621689341841"><span class="annot"><span class="annottext">Datetime2
</span><a href="#local-6989586621689341841"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-353"></span><span>      </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-354"></span><span>        </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-355"></span><span>        </span><span class="annot"><span class="">[ODBC.sql|
          UPDATE hdb_catalog.event_log
          SET next_retry_at = TODATETIMEOFFSET ($time, DATEPART(TZOFFSET, SYSDATETIMEOFFSET())), locked = NULL
          WHERE id = $eventId
        |]</span></span><span>
</span><span id="line-360"></span><span>
</span><span id="line-361"></span><span class="hs-comment">-- | Lock and return events not yet being processed or completed, up to some</span><span>
</span><span id="line-362"></span><span class="hs-comment">-- limit. Process events approximately in created_at order, but we make no</span><span>
</span><span id="line-363"></span><span class="hs-comment">-- ordering guarentees; events can and will race. Nevertheless we want to</span><span>
</span><span id="line-364"></span><span class="hs-comment">-- ensure newer change events don't starve older ones.</span><span>
</span><span id="line-365"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEvents"><span class="hs-identifier hs-type">fetchEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#FetchBatchSize"><span class="hs-identifier hs-type">FetchBatchSize</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-366"></span><span id="fetchEvents"><span class="annot"><span class="annottext">fetchEvents :: SourceName
-&gt; [TriggerName] -&gt; FetchBatchSize -&gt; TxET QErr IO [Event 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#fetchEvents"><span class="hs-identifier hs-var hs-var">fetchEvents</span></a></span></span><span> </span><span id="local-6989586621689341840"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689341840"><span class="hs-identifier hs-var">source</span></a></span></span><span> </span><span id="local-6989586621689341839"><span class="annot"><span class="annottext">[TriggerName]
</span><a href="#local-6989586621689341839"><span class="hs-identifier hs-var">triggerNames</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#FetchBatchSize"><span class="hs-identifier hs-type">FetchBatchSize</span></a></span><span> </span><span id="local-6989586621689341837"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621689341837"><span class="hs-identifier hs-var">fetchBatchSize</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-367"></span><span>  </span><span class="hs-comment">-- The reason we do not inline the SQL but rather  create a template string is due</span><span>
</span><span id="line-368"></span><span>  </span><span class="hs-comment">-- to the problem with `ODBC.sql` variable substitution. When you use a variable</span><span>
</span><span id="line-369"></span><span>  </span><span class="hs-comment">-- whose value is a text and it contains a single quote `'`, the `ODBC.sql`</span><span>
</span><span id="line-370"></span><span>  </span><span class="hs-comment">-- function escapes that single quote. i.e it converts `'` to `''`</span><span>
</span><span id="line-371"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-372"></span><span>  </span><span class="hs-comment">-- Note: A single quote in MSSQL is escaped by doubling it up (`''`)</span><span>
</span><span id="line-373"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-374"></span><span>  </span><span class="hs-comment">-- This is problematic, since we use a list of list of trigger names to fetch and</span><span>
</span><span id="line-375"></span><span>  </span><span class="hs-comment">-- lock the events. A list of trigger names in MSSQL looks like Eg:</span><span>
</span><span id="line-376"></span><span>  </span><span class="hs-comment">-- ('insert_test_books', 'et_test_bigint')</span><span>
</span><span id="line-377"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-378"></span><span>  </span><span class="hs-comment">-- We use this list of trigger names in the `IN` operator to fetch only those</span><span>
</span><span id="line-379"></span><span>  </span><span class="hs-comment">-- events.</span><span>
</span><span id="line-380"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-381"></span><span>  </span><span class="hs-comment">-- If we were to use the `ODBC.sql` function it would convert the list into</span><span>
</span><span id="line-382"></span><span>  </span><span class="hs-comment">-- something which is not a valid list.</span><span>
</span><span id="line-383"></span><span>  </span><span class="hs-comment">-- Eg: ('insert_test_books', 'et_test_bigint') -&gt; (''insert_test_books'', ''et_test_bigint'')</span><span>
</span><span id="line-384"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-385"></span><span>  </span><span class="hs-comment">-- Due to the problematic variable substitution of `ODBC.sql` it is imperative that</span><span>
</span><span id="line-386"></span><span>  </span><span class="hs-comment">-- we resort to template strings, since that does not do any changes to the string.</span><span>
</span><span id="line-387"></span><span>  </span><span id="local-6989586621689341836"><span class="annot"><span class="annottext">[(ByteString, Text, Text, Text, ByteString, Int, ByteString)]
</span><a href="#local-6989586621689341836"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-388"></span><span>    </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr)
-&gt; Query
-&gt; TxET
     QErr
     IO
     [(ByteString, Text, Text, Text, ByteString, Int, ByteString)]
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m [a]
</span><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier hs-var">multiRowQueryE</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span> </span><span class="annot"><span class="annottext">(Query
 -&gt; TxET
      QErr
      IO
      [(ByteString, Text, Text, Text, ByteString, Int, ByteString)])
-&gt; Query
-&gt; TxET
     QErr
     IO
     [(ByteString, Text, Text, Text, ByteString, Int, ByteString)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-389"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><span class="hs-identifier hs-var">rawUnescapedText</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; (Text -&gt; Text) -&gt; Text -&gt; Query
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><span class="hs-identifier hs-var">LT.toStrict</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; Text -&gt; Query
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-390"></span><span>        </span><span class="hs-special">$(</span><span class="hs-identifier">makeRelativeToProject</span><span> </span><span class="hs-string">&quot;src-rsr/mssql/mssql_fetch_events.sql.shakespeare&quot;</span><span> </span><span class="hs-operator">&gt;&gt;=</span><span> </span><span class="hs-identifier">ST.stextFile</span><span class="hs-special">)</span><span>
</span><span id="line-391"></span><span>  </span><span class="annot"><span class="annottext">((ByteString, Text, Text, Text, ByteString, Int, ByteString)
 -&gt; TxET QErr IO (Event 'MSSQL))
-&gt; [(ByteString, Text, Text, Text, ByteString, Int, ByteString)]
-&gt; TxET QErr IO [Event 'MSSQL]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(ByteString, Text, Text, Text, ByteString, Int, ByteString)
-&gt; TxET QErr IO (Event 'MSSQL)
</span><a href="#local-6989586621689341826"><span class="hs-identifier hs-var">uncurryEvent</span></a></span><span> </span><span class="annot"><span class="annottext">[(ByteString, Text, Text, Text, ByteString, Int, ByteString)]
</span><a href="#local-6989586621689341836"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-392"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-393"></span><span>    </span><span class="hs-comment">-- Creates a list of trigger names to be used for 'IN' operator</span><span>
</span><span id="line-394"></span><span>    </span><span class="hs-comment">-- Eg: ('insert_test_books', 'et_test_bigint')</span><span>
</span><span id="line-395"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-396"></span><span>    </span><span class="hs-comment">-- We cannot use 'commaseperated()' because it creates the Text as</span><span>
</span><span id="line-397"></span><span>    </span><span class="hs-comment">-- 'insert_test_books, et_test_bigint' which is not useful to compare values in</span><span>
</span><span id="line-398"></span><span>    </span><span class="hs-comment">-- 'IN' MSSQL operator.</span><span>
</span><span id="line-399"></span><span>    </span><span id="local-6989586621689341833"><span class="annot"><span class="annottext">triggerNamesTxt :: Text
</span><a href="#local-6989586621689341833"><span class="hs-identifier hs-var hs-var">triggerNamesTxt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;(&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TriggerName -&gt; Text) -&gt; [TriggerName] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621689341825"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341825"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;'&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341825"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;'&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TriggerName]
</span><a href="#local-6989586621689341839"><span class="hs-identifier hs-var">triggerNames</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;)&quot;</span></span><span>
</span><span id="line-400"></span><span>
</span><span id="line-401"></span><span>    </span><span id="local-6989586621689341826"><span class="annot"><span class="annottext">uncurryEvent :: (ByteString, Text, Text, Text, ByteString, Int, ByteString)
-&gt; TxET QErr IO (Event 'MSSQL)
</span><a href="#local-6989586621689341826"><span class="hs-identifier hs-var hs-var">uncurryEvent</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621689341824"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689341824"><span class="hs-identifier hs-var">id'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689341823"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341823"><span class="hs-identifier hs-var">sn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689341822"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341822"><span class="hs-identifier hs-var">tn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689341821"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341821"><span class="hs-identifier hs-var">trn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689341820"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689341820"><span class="hs-identifier hs-var">payload'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BL.ByteString</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689341819"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621689341819"><span class="hs-identifier hs-var">tries</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621689341818"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689341818"><span class="hs-identifier hs-var">created_at</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-402"></span><span>      </span><span id="local-6989586621689341817"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621689341817"><span class="hs-identifier hs-var">payload</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; TxET QErr IO Value
forall a (m :: * -&gt; *). (FromJSON a, QErrM m) =&gt; ByteString -&gt; m a
</span><a href="#local-6989586621689341816"><span class="hs-identifier hs-var">encodePayload</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689341820"><span class="hs-identifier hs-var">payload'</span></a></span><span>
</span><span id="line-403"></span><span>      </span><span id="local-6989586621689341815"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621689341815"><span class="hs-identifier hs-var">createdAt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; TxET QErr IO UTCTime
forall (m :: * -&gt; *). QErrM m =&gt; ByteString -&gt; m UTCTime
</span><a href="#local-6989586621689341814"><span class="hs-identifier hs-var">convertTime</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689341818"><span class="hs-identifier hs-var">created_at</span></a></span><span>
</span><span id="line-404"></span><span>
</span><span id="line-405"></span><span>      </span><span class="annot"><span class="annottext">Event 'MSSQL -&gt; TxET QErr IO (Event 'MSSQL)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Event 'MSSQL -&gt; TxET QErr IO (Event 'MSSQL))
-&gt; Event 'MSSQL -&gt; TxET QErr IO (Event 'MSSQL)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-406"></span><span>        </span><span class="annot"><span class="annottext">Event :: forall (b :: BackendType).
EventId
-&gt; SourceName
-&gt; TableName b
-&gt; TriggerMetadata
-&gt; Value
-&gt; Int
-&gt; UTCTime
-&gt; Event b
</span><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span>
</span><span id="line-407"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">eId :: EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var">eId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; EventId
</span><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-var">EventId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Text
</span><a href="Hasura.Prelude.html#bsToTxt"><span class="hs-identifier hs-var">bsToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689341824"><span class="hs-identifier hs-var">id'</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-408"></span><span>            </span><span class="annot"><span class="annottext">eSource :: SourceName
</span><a href="Hasura.RQL.Types.EventTrigger.html#eSource"><span class="hs-identifier hs-var">eSource</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621689341840"><span class="hs-identifier hs-var">source</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-409"></span><span>            </span><span class="annot"><span class="annottext">eTable :: TableName 'MSSQL
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTable"><span class="hs-identifier hs-var">eTable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; SchemaName -&gt; TableName
</span><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-var">TableName</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341822"><span class="hs-identifier hs-var">tn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; SchemaName
</span><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-var">SchemaName</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341823"><span class="hs-identifier hs-var">sn</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-410"></span><span>            </span><span class="annot"><span class="annottext">eTrigger :: TriggerMetadata
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTrigger"><span class="hs-identifier hs-var">eTrigger</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; TriggerMetadata
</span><a href="Hasura.RQL.Types.EventTrigger.html#TriggerMetadata"><span class="hs-identifier hs-var">TriggerMetadata</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmptyText -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-var">TriggerName</span></a></span><span> </span><span class="annot"><span class="annottext">(NonEmptyText -&gt; TriggerName) -&gt; NonEmptyText -&gt; TriggerName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; NonEmptyText
</span><a href="Data.Text.NonEmpty.html#mkNonEmptyTextUnsafe"><span class="hs-identifier hs-var">mkNonEmptyTextUnsafe</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341821"><span class="hs-identifier hs-var">trn</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-411"></span><span>            </span><span class="annot"><span class="annottext">eEvent :: Value
</span><a href="Hasura.RQL.Types.EventTrigger.html#eEvent"><span class="hs-identifier hs-var">eEvent</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621689341817"><span class="hs-identifier hs-var">payload</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-412"></span><span>            </span><span class="annot"><span class="annottext">eTries :: Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTries"><span class="hs-identifier hs-var">eTries</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621689341819"><span class="hs-identifier hs-var">tries</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-413"></span><span>            </span><span class="annot"><span class="annottext">eCreatedAt :: UTCTime
</span><a href="Hasura.RQL.Types.EventTrigger.html#eCreatedAt"><span class="hs-identifier hs-var">eCreatedAt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621689341815"><span class="hs-identifier hs-var">createdAt</span></a></span><span>
</span><span id="line-414"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-415"></span><span>
</span><span id="line-416"></span><span>    </span><span class="hs-comment">-- Note: We do not have JSON datatype in SQL Server. But since in</span><span>
</span><span id="line-417"></span><span>    </span><span class="hs-comment">-- 'mkAllTriggersQ' we ensure that all the values in the payload column of</span><span>
</span><span id="line-418"></span><span>    </span><span class="hs-comment">-- hdb_catalog.event_log is always a JSON. We can directly decode the payload</span><span>
</span><span id="line-419"></span><span>    </span><span class="hs-comment">-- value and not worry that the decoding will fail.</span><span>
</span><span id="line-420"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-421"></span><span>    </span><span class="hs-comment">-- We ensure that the values in 'hd_catalog.event_log' is always a JSON is by</span><span>
</span><span id="line-422"></span><span>    </span><span class="hs-comment">-- using the 'FOR JSON PATH' MSSQL operand when inserting value into the</span><span>
</span><span id="line-423"></span><span>    </span><span class="hs-comment">-- 'hdb_catalog.event_log' table.</span><span>
</span><span id="line-424"></span><span>    </span><span id="local-6989586621689342083"><span id="local-6989586621689342085"><span class="annot"><a href="#local-6989586621689341816"><span class="hs-identifier hs-type">encodePayload</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.FromJSON</span></span><span> </span><span class="annot"><a href="#local-6989586621689342085"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErrM"><span class="hs-identifier hs-type">QErrM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689342083"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BL.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621689342083"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689342085"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-425"></span><span>    </span><span id="local-6989586621689341816"><span class="annot"><span class="annottext">encodePayload :: ByteString -&gt; m a
</span><a href="#local-6989586621689341816"><span class="hs-identifier hs-var hs-var">encodePayload</span></a></span></span><span> </span><span id="local-6989586621689341804"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689341804"><span class="hs-identifier hs-var">payload</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-426"></span><span>      </span><span class="annot"><span class="annottext">Either String a -&gt; (String -&gt; m a) -&gt; m a
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="Hasura.Prelude.html#onLeft"><span class="hs-identifier hs-var">onLeft</span></a></span><span>
</span><span id="line-427"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Either String a
forall a. FromJSON a =&gt; ByteString -&gt; Either String a
</span><span class="hs-identifier hs-var">J.eitherDecode</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689341804"><span class="hs-identifier hs-var">payload</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-428"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; m a
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m a) -&gt; Text -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;payload decode failed while fetching MSSQL events&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-429"></span><span>
</span><span id="line-430"></span><span>    </span><span class="hs-comment">-- Note: The ODBC server does not have a FromJSON instance of UTCTime and only</span><span>
</span><span id="line-431"></span><span>    </span><span class="hs-comment">-- supports DateTime2  and SmallDateTime. But the above two data types do not</span><span>
</span><span id="line-432"></span><span>    </span><span class="hs-comment">-- have time offsets and 'Event' stores the time as UTCTime. But during</span><span>
</span><span id="line-433"></span><span>    </span><span class="hs-comment">-- 'mkAllTriggersQ' we do save them as UTC Time format. So we can directly decode</span><span>
</span><span id="line-434"></span><span>    </span><span class="hs-comment">-- the time we get from the DB as UTCTime and not worry about exception being</span><span>
</span><span id="line-435"></span><span>    </span><span class="hs-comment">-- thrown during decoding.</span><span>
</span><span id="line-436"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-437"></span><span>    </span><span class="hs-comment">-- We ensure that the time stored in 'create_at' column is a UTCTime, by</span><span>
</span><span id="line-438"></span><span>    </span><span class="hs-comment">-- defaulting the 'created_at' column to use 'SYSDATETIMEOFFSET()' MSSQL function</span><span>
</span><span id="line-439"></span><span>    </span><span class="hs-comment">-- in 'init_mssql_source.sql' file. The 'SYSDATETIMEOFFSET()' function returns</span><span>
</span><span id="line-440"></span><span>    </span><span class="hs-comment">-- value that contains the date and time of the computer on which the instance of</span><span>
</span><span id="line-441"></span><span>    </span><span class="hs-comment">-- SQL Server is running. The time zone offset is included.</span><span>
</span><span id="line-442"></span><span>    </span><span id="local-6989586621689342082"><span class="annot"><a href="#local-6989586621689341814"><span class="hs-identifier hs-type">convertTime</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Base.Error.html#QErrM"><span class="hs-identifier hs-type">QErrM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689342082"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621689342082"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">UTCTime</span></span></span><span>
</span><span id="line-443"></span><span>    </span><span id="local-6989586621689341814"><span class="annot"><span class="annottext">convertTime :: ByteString -&gt; m UTCTime
</span><a href="#local-6989586621689341814"><span class="hs-identifier hs-var hs-var">convertTime</span></a></span></span><span> </span><span id="local-6989586621689341800"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689341800"><span class="hs-identifier hs-var">createdAt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-444"></span><span>      </span><span class="annot"><span class="annottext">Either String UTCTime -&gt; (String -&gt; m UTCTime) -&gt; m UTCTime
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="Hasura.Prelude.html#onLeft"><span class="hs-identifier hs-var">onLeft</span></a></span><span>
</span><span id="line-445"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Either String UTCTime
forall a. Read a =&gt; String -&gt; Either String a
</span><span class="hs-identifier hs-var">readEither</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; String) -&gt; Text -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Text
</span><a href="Hasura.Prelude.html#bsToTxt"><span class="hs-identifier hs-var">bsToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621689341800"><span class="hs-identifier hs-var">createdAt</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">UTCTime</span></span><span class="hs-special">)</span><span>
</span><span id="line-446"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; m UTCTime
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m UTCTime) -&gt; Text -&gt; m UTCTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;conversion to UTCTime failed while fetching MSSQL events&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-447"></span><span>
</span><span id="line-448"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerQ"><span class="hs-identifier hs-type">dropTriggerQ</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-449"></span><span id="dropTriggerQ"><span class="annot"><span class="annottext">dropTriggerQ :: TriggerName -&gt; SchemaName -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerQ"><span class="hs-identifier hs-var hs-var">dropTriggerQ</span></a></span></span><span> </span><span id="local-6989586621689341797"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341797"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689341796"><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621689341796"><span class="hs-identifier hs-var">schemaName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-450"></span><span>  </span><span class="annot"><span class="annottext">(Ops -&gt; TxET QErr IO ()) -&gt; [Ops] -&gt; TxET QErr IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName -&gt; SchemaName -&gt; Ops -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerOp"><span class="hs-identifier hs-var">dropTriggerOp</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341797"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621689341796"><span class="hs-identifier hs-var">schemaName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#INSERT"><span class="hs-identifier hs-var">INSERT</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#UPDATE"><span class="hs-identifier hs-var">UPDATE</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#DELETE"><span class="hs-identifier hs-var">DELETE</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-451"></span><span>
</span><span id="line-452"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerOp"><span class="hs-identifier hs-type">dropTriggerOp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Ops"><span class="hs-identifier hs-type">Ops</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-453"></span><span id="dropTriggerOp"><span class="annot"><span class="annottext">dropTriggerOp :: TriggerName -&gt; SchemaName -&gt; Ops -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#dropTriggerOp"><span class="hs-identifier hs-var hs-var">dropTriggerOp</span></a></span></span><span> </span><span id="local-6989586621689341794"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341794"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689341793"><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621689341793"><span class="hs-identifier hs-var">schemaName</span></a></span></span><span> </span><span id="local-6989586621689341792"><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621689341792"><span class="hs-identifier hs-var">triggerOp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-454"></span><span>  </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-455"></span><span>    </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-456"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Query
</span><span class="hs-identifier hs-var">rawUnescapedText</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; Text -&gt; Query
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ops -&gt; Text
</span><a href="#local-6989586621689341791"><span class="hs-identifier hs-var">getDropTriggerSQL</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621689341792"><span class="hs-identifier hs-var">triggerOp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-457"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-458"></span><span>    </span><span class="annot"><a href="#local-6989586621689341791"><span class="hs-identifier hs-type">getDropTriggerSQL</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Ops"><span class="hs-identifier hs-type">Ops</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-459"></span><span>    </span><span id="local-6989586621689341791"><span class="annot"><span class="annottext">getDropTriggerSQL :: Ops -&gt; Text
</span><a href="#local-6989586621689341791"><span class="hs-identifier hs-var hs-var">getDropTriggerSQL</span></a></span></span><span> </span><span id="local-6989586621689341790"><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621689341790"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-460"></span><span>      </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;DROP TRIGGER IF EXISTS &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">QualifiedTriggerName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unQualifiedTriggerName"><span class="hs-identifier hs-var hs-var">unQualifiedTriggerName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ops -&gt; SchemaName -&gt; TriggerName -&gt; QualifiedTriggerName
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#msssqlIdenTrigger"><span class="hs-identifier hs-var">msssqlIdenTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621689341790"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621689341793"><span class="hs-identifier hs-var">schemaName</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341794"><span class="hs-identifier hs-var">triggerName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-461"></span><span>
</span><span id="line-462"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#archiveEvents"><span class="hs-identifier hs-type">archiveEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-463"></span><span id="archiveEvents"><span class="annot"><span class="annottext">archiveEvents :: TriggerName -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#archiveEvents"><span class="hs-identifier hs-var hs-var">archiveEvents</span></a></span></span><span> </span><span id="local-6989586621689341787"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341787"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-464"></span><span>  </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-465"></span><span>    </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-466"></span><span>    </span><span class="annot"><span class="">[ODBC.sql|
      UPDATE hdb_catalog.event_log
      SET archived = 1
      WHERE trigger_name = $triggerNameTxt
    |]</span></span><span>
</span><span id="line-471"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-472"></span><span>    </span><span id="local-6989586621689341786"><span class="annot"><span class="annottext">triggerNameTxt :: Text
</span><a href="#local-6989586621689341786"><span class="hs-identifier hs-var hs-var">triggerNameTxt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341787"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-473"></span><span>
</span><span id="line-474"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkEventTx"><span class="hs-identifier hs-type">checkEventTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-475"></span><span id="checkEventTx"><span class="annot"><span class="annottext">checkEventTx :: EventId -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkEventTx"><span class="hs-identifier hs-var hs-var">checkEventTx</span></a></span></span><span> </span><span id="local-6989586621689341785"><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621689341785"><span class="hs-identifier hs-var">eventId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-476"></span><span>  </span><span class="hs-comment">-- If an event got locked within the last 30 minutes then it means that the event</span><span>
</span><span id="line-477"></span><span>  </span><span class="hs-comment">-- got picked up by during the last fetch-event poll and is being processed. Hence</span><span>
</span><span id="line-478"></span><span>  </span><span class="hs-comment">-- we do not allow the redelivery of such an event.</span><span>
</span><span id="line-479"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621689341784"><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621689341784"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-480"></span><span>    </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO [Bool]
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m [a]
</span><a href="Database.MSSQL.Transaction.html#multiRowQueryE"><span class="hs-identifier hs-var">multiRowQueryE</span></a></span><span>
</span><span id="line-481"></span><span>      </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-482"></span><span>      </span><span class="annot"><span class="">[ODBC.sql|
        SELECT
          CAST(CASE 
                  WHEN (l.locked IS NOT NULL AND l.locked &gt;= DATEADD(MINUTE, -30, SYSDATETIMEOFFSET())) THEN 1 ELSE 0
              END 
          AS bit)
        FROM hdb_catalog.event_log l
        WHERE l.id = $eId
      |]</span></span><span>
</span><span id="line-491"></span><span>
</span><span id="line-492"></span><span>  </span><span id="local-6989586621689341782"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621689341782"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Bool] -&gt; TxE QErr Bool
forall (m :: * -&gt; *) a. MonadError QErr m =&gt; [a] -&gt; m a
</span><a href="#local-6989586621689341781"><span class="hs-identifier hs-var">getEvent</span></a></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621689341784"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-493"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; TxET QErr IO ()
forall (f :: * -&gt; *). MonadError QErr f =&gt; Bool -&gt; f ()
</span><a href="#local-6989586621689341780"><span class="hs-identifier hs-var">assertEventUnlocked</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621689341782"><span class="hs-identifier hs-var">event</span></a></span><span>
</span><span id="line-494"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-495"></span><span>    </span><span id="local-6989586621689341783"><span class="annot"><span class="annottext">eId :: Text
</span><a href="#local-6989586621689341783"><span class="hs-identifier hs-var hs-var">eId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventId -&gt; Text
</span><a href="Hasura.RQL.Types.Eventing.html#unEventId"><span class="hs-identifier hs-var hs-var">unEventId</span></a></span><span> </span><span class="annot"><span class="annottext">(EventId -&gt; Text) -&gt; EventId -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621689341785"><span class="hs-identifier hs-var">eventId</span></a></span><span>
</span><span id="line-496"></span><span>
</span><span id="line-497"></span><span>    </span><span id="local-6989586621689341781"><span class="annot"><span class="annottext">getEvent :: [a] -&gt; m a
</span><a href="#local-6989586621689341781"><span class="hs-identifier hs-var hs-var">getEvent</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; m a
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#NotExists"><span class="hs-identifier hs-var">NotExists</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;event not found&quot;</span></span><span>
</span><span id="line-498"></span><span>    </span><span class="annot"><a href="#local-6989586621689341781"><span class="hs-identifier hs-var">getEvent</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621689341777"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689341777"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621689341777"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-499"></span><span>
</span><span id="line-500"></span><span>    </span><span id="local-6989586621689341780"><span class="annot"><span class="annottext">assertEventUnlocked :: Bool -&gt; f ()
</span><a href="#local-6989586621689341780"><span class="hs-identifier hs-var hs-var">assertEventUnlocked</span></a></span></span><span> </span><span id="local-6989586621689341776"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621689341776"><span class="hs-identifier hs-var">locked</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-501"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; f () -&gt; f ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621689341776"><span class="hs-identifier hs-var">locked</span></a></span><span> </span><span class="annot"><span class="annottext">(f () -&gt; f ()) -&gt; f () -&gt; f ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-502"></span><span>        </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; f ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#Busy"><span class="hs-identifier hs-var">Busy</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;event is already being processed&quot;</span></span><span>
</span><span id="line-503"></span><span>
</span><span id="line-504"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#markForDeliveryTx"><span class="hs-identifier hs-type">markForDeliveryTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-505"></span><span id="markForDeliveryTx"><span class="annot"><span class="annottext">markForDeliveryTx :: EventId -&gt; TxET QErr IO ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#markForDeliveryTx"><span class="hs-identifier hs-var hs-var">markForDeliveryTx</span></a></span></span><span> </span><span id="local-6989586621689341773"><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621689341773"><span class="hs-identifier hs-var">eventId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-506"></span><span>  </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span>
</span><span id="line-507"></span><span>    </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span>
</span><span id="line-508"></span><span>    </span><span class="annot"><span class="">[ODBC.sql|
      UPDATE hdb_catalog.event_log
      SET delivered = 0, error = 0, tries = 0
      WHERE id = $eId
    |]</span></span><span>
</span><span id="line-513"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-514"></span><span>    </span><span id="local-6989586621689341772"><span class="annot"><span class="annottext">eId :: Text
</span><a href="#local-6989586621689341772"><span class="hs-identifier hs-var hs-var">eId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventId -&gt; Text
</span><a href="Hasura.RQL.Types.Eventing.html#unEventId"><span class="hs-identifier hs-var hs-var">unEventId</span></a></span><span> </span><span class="annot"><span class="annottext">(EventId -&gt; Text) -&gt; EventId -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621689341773"><span class="hs-identifier hs-var">eventId</span></a></span><span>
</span><span id="line-515"></span><span>
</span><span id="line-516"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unlockEventsTx"><span class="hs-identifier hs-type">unlockEventsTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-517"></span><span id="unlockEventsTx"><span class="annot"><span class="annottext">unlockEventsTx :: [EventId] -&gt; TxET QErr IO Int
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unlockEventsTx"><span class="hs-identifier hs-var hs-var">unlockEventsTx</span></a></span></span><span> </span><span id="local-6989586621689341771"><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621689341771"><span class="hs-identifier hs-var">eventIds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-518"></span><span>  </span><span id="local-6989586621689341770"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621689341770"><span class="hs-identifier hs-var">numEvents</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-519"></span><span>    </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO Int
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRow a) =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m a
</span><a href="Database.MSSQL.Transaction.html#singleRowQueryE"><span class="hs-identifier hs-var">singleRowQueryE</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span> </span><span class="annot"><span class="annottext">(Query -&gt; TxET QErr IO Int) -&gt; Query -&gt; TxET QErr IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-520"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><span class="hs-identifier hs-var">rawUnescapedText</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; (Text -&gt; Text) -&gt; Text -&gt; Query
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><span class="hs-identifier hs-var">LT.toStrict</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; Text -&gt; Query
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-521"></span><span>        </span><span class="hs-comment">-- EventIds as list of VALUES (Eg: ('123-abc'), ('456-vgh'), ('234-asd'))</span><span>
</span><span id="line-522"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689341769"><span class="annot"><span class="annottext">eventIdsValues :: Text
</span><a href="#local-6989586621689341769"><span class="hs-identifier hs-var hs-var">eventIdsValues</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[EventId] -&gt; Text
</span><a href="#local-6989586621689341768"><span class="hs-identifier hs-var">generateValuesFromEvents</span></a></span><span> </span><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621689341771"><span class="hs-identifier hs-var">eventIds</span></a></span><span>
</span><span id="line-523"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">$(</span><span class="hs-identifier">makeRelativeToProject</span><span> </span><span class="hs-string">&quot;src-rsr/mssql/mssql_unlock_events.sql.shakespeare&quot;</span><span> </span><span class="hs-operator">&gt;&gt;=</span><span> </span><span class="hs-identifier">ST.stextFile</span><span class="hs-special">)</span><span>
</span><span id="line-524"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; TxET QErr IO Int
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621689341770"><span class="hs-identifier hs-var">numEvents</span></a></span><span>
</span><span id="line-525"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-526"></span><span>    </span><span class="annot"><a href="#local-6989586621689341768"><span class="hs-identifier hs-type">generateValuesFromEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-527"></span><span>    </span><span class="hs-comment">-- creates a list of event id's  (('123-abc'), ('456-vgh'), ('234-asd'))</span><span>
</span><span id="line-528"></span><span>    </span><span id="local-6989586621689341768"><span class="annot"><span class="annottext">generateValuesFromEvents :: [EventId] -&gt; Text
</span><a href="#local-6989586621689341768"><span class="hs-identifier hs-var hs-var">generateValuesFromEvents</span></a></span></span><span> </span><span id="local-6989586621689341767"><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621689341767"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621689341766"><span class="hs-identifier hs-var">values</span></a></span><span>
</span><span id="line-529"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-530"></span><span>        </span><span id="local-6989586621689341766"><span class="annot"><span class="annottext">values :: [Text]
</span><a href="#local-6989586621689341766"><span class="hs-identifier hs-var hs-var">values</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(EventId -&gt; Text) -&gt; [EventId] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621689341765"><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621689341765"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;(&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">EventId -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621689341765"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;)&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621689341767"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-531"></span><span>
</span><span id="line-532"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getMaintenanceModeVersionTx"><span class="hs-identifier hs-type">getMaintenanceModeVersionTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Database.MSSQL.Transaction.html#TxE"><span class="hs-identifier hs-type">TxE</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span>
</span><span id="line-533"></span><span id="getMaintenanceModeVersionTx"><span class="annot"><span class="annottext">getMaintenanceModeVersionTx :: TxET QErr IO MaintenanceModeVersion
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getMaintenanceModeVersionTx"><span class="hs-identifier hs-var hs-var">getMaintenanceModeVersionTx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-534"></span><span>  </span><span id="local-6989586621689341764"><span class="annot"><span class="annottext">SourceCatalogVersion
</span><a href="#local-6989586621689341764"><span class="hs-identifier hs-var">catalogVersion</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TxET QErr IO SourceCatalogVersion
forall (m :: * -&gt; *). MonadMSSQLTx m =&gt; m SourceCatalogVersion
</span><a href="Hasura.Backends.MSSQL.DDL.Source.Version.html#getSourceCatalogVersion"><span class="hs-identifier hs-var">getSourceCatalogVersion</span></a></span><span>
</span><span id="line-535"></span><span>  </span><span class="hs-keyword">if</span><span>
</span><span id="line-536"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SourceCatalogVersion
</span><a href="#local-6989586621689341764"><span class="hs-identifier hs-var">catalogVersion</span></a></span><span> </span><span class="annot"><span class="annottext">SourceCatalogVersion -&gt; SourceCatalogVersion -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SourceCatalogVersion
</span><a href="Hasura.Backends.MSSQL.DDL.Source.Version.html#latestSourceCatalogVersion"><span class="hs-identifier hs-var">latestSourceCatalogVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion -&gt; TxET QErr IO MaintenanceModeVersion
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="Hasura.RQL.Types.Source.html#CurrentMMVersion"><span class="hs-identifier hs-var">CurrentMMVersion</span></a></span><span>
</span><span id="line-537"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-538"></span><span>        </span><span class="annot"><span class="annottext">Text -&gt; TxET QErr IO MaintenanceModeVersion
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; TxET QErr IO MaintenanceModeVersion)
-&gt; Text -&gt; TxET QErr IO MaintenanceModeVersion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-539"></span><span>          </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Maintenance mode is only supported with catalog versions: &quot;</span></span><span>
</span><span id="line-540"></span><span>            </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SourceCatalogVersion -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="Hasura.Prelude.html#tshow"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">SourceCatalogVersion
</span><a href="Hasura.Backends.MSSQL.DDL.Source.Version.html#latestSourceCatalogVersion"><span class="hs-identifier hs-var">latestSourceCatalogVersion</span></a></span><span>
</span><span id="line-541"></span><span>            </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; but received &quot;</span></span><span>
</span><span id="line-542"></span><span>            </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SourceCatalogVersion -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="Hasura.Prelude.html#tshow"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">SourceCatalogVersion
</span><a href="#local-6989586621689341764"><span class="hs-identifier hs-var">catalogVersion</span></a></span><span>
</span><span id="line-543"></span><span>
</span><span id="line-544"></span><span class="hs-comment">-- | Note: UTCTIME not supported in SQL Server</span><span>
</span><span id="line-545"></span><span class="hs-comment">--</span><span>
</span><span id="line-546"></span><span class="hs-comment">-- Refer 'ToSql UTCTIME' instance of odbc package:</span><span>
</span><span id="line-547"></span><span class="hs-comment">-- https://github.com/fpco/odbc/blob/f4f04ea15d14e9a3ed455f7c728dc08734eef8ae/src/Database/ODBC/SQLServer.hs#L377</span><span>
</span><span id="line-548"></span><span class="hs-comment">--</span><span>
</span><span id="line-549"></span><span class="hs-comment">-- We use SYSDATETIMEOFFSET() to store time values along with it's time</span><span>
</span><span id="line-550"></span><span class="hs-comment">-- zone offset in event_log table. Since ODBC server does not support time zones,</span><span>
</span><span id="line-551"></span><span class="hs-comment">-- we use a workaround.</span><span>
</span><span id="line-552"></span><span class="hs-comment">--</span><span>
</span><span id="line-553"></span><span class="hs-comment">-- We wrap the time value in Datetime2, but before we insert it into the</span><span>
</span><span id="line-554"></span><span class="hs-comment">-- event_log table we convert it into UTCTIME using the 'TODATETIMEOFFSET()'</span><span>
</span><span id="line-555"></span><span class="hs-comment">-- sql function.</span><span>
</span><span id="line-556"></span><span id="local-6989586621689342109"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#convertUTCToDatetime2"><span class="hs-identifier hs-type">convertUTCToDatetime2</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621689342109"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">UTCTime</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621689342109"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Datetime2</span></span></span><span>
</span><span id="line-557"></span><span id="convertUTCToDatetime2"><span class="annot"><span class="annottext">convertUTCToDatetime2 :: UTCTime -&gt; m Datetime2
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#convertUTCToDatetime2"><span class="hs-identifier hs-var hs-var">convertUTCToDatetime2</span></a></span></span><span> </span><span id="local-6989586621689341761"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621689341761"><span class="hs-identifier hs-var">utcTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-558"></span><span>  </span><span id="local-6989586621689341760"><span class="annot"><span class="annottext">TimeZone
</span><a href="#local-6989586621689341760"><span class="hs-identifier hs-var">timezone</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO TimeZone -&gt; m TimeZone
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO TimeZone -&gt; m TimeZone) -&gt; IO TimeZone -&gt; m TimeZone
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; IO TimeZone
</span><span class="hs-identifier hs-var">getTimeZone</span></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621689341761"><span class="hs-identifier hs-var">utcTime</span></a></span><span>
</span><span id="line-559"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689341758"><span class="annot"><span class="annottext">localTime :: LocalTime
</span><a href="#local-6989586621689341758"><span class="hs-identifier hs-var hs-var">localTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TimeZone -&gt; UTCTime -&gt; LocalTime
</span><span class="hs-identifier hs-var">utcToLocalTime</span></span><span> </span><span class="annot"><span class="annottext">TimeZone
</span><a href="#local-6989586621689341760"><span class="hs-identifier hs-var">timezone</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621689341761"><span class="hs-identifier hs-var">utcTime</span></a></span><span>
</span><span id="line-560"></span><span>  </span><span class="annot"><span class="annottext">Datetime2 -&gt; m Datetime2
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Datetime2 -&gt; m Datetime2) -&gt; Datetime2 -&gt; m Datetime2
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LocalTime -&gt; Datetime2
</span><span class="hs-identifier hs-var">Datetime2</span></span><span> </span><span class="annot"><span class="annottext">LocalTime
</span><a href="#local-6989586621689341758"><span class="hs-identifier hs-var">localTime</span></a></span><span>
</span><span id="line-561"></span><span>
</span><span id="line-562"></span><span class="hs-comment">---- MSSQL event trigger utility functions -----------------</span><span>
</span><span id="line-563"></span><span>
</span><span id="line-564"></span><span class="hs-keyword">newtype</span><span> </span><span id="QualifiedTriggerName"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#QualifiedTriggerName"><span class="hs-identifier hs-var">QualifiedTriggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="QualifiedTriggerName"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#QualifiedTriggerName"><span class="hs-identifier hs-var">QualifiedTriggerName</span></a></span></span><span> </span><span class="hs-special">{</span><span id="unQualifiedTriggerName"><span class="annot"><span class="annottext">QualifiedTriggerName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unQualifiedTriggerName"><span class="hs-identifier hs-var hs-var">unQualifiedTriggerName</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">}</span><span>
</span><span id="line-565"></span><span>
</span><span id="line-566"></span><span class="hs-comment">-- | Store a fragment of SQL expression</span><span>
</span><span id="line-567"></span><span class="hs-keyword">newtype</span><span> </span><span id="SQLFragment"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-var">SQLFragment</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SQLFragment"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-var">SQLFragment</span></a></span></span><span> </span><span class="hs-special">{</span><span id="unSQLFragment"><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var hs-var">unSQLFragment</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">}</span><span>
</span><span id="line-568"></span><span>
</span><span id="line-569"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#msssqlIdenTrigger"><span class="hs-identifier hs-type">msssqlIdenTrigger</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Ops"><span class="hs-identifier hs-type">Ops</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#QualifiedTriggerName"><span class="hs-identifier hs-type">QualifiedTriggerName</span></a></span><span>
</span><span id="line-570"></span><span id="msssqlIdenTrigger"><span class="annot"><span class="annottext">msssqlIdenTrigger :: Ops -&gt; SchemaName -&gt; TriggerName -&gt; QualifiedTriggerName
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#msssqlIdenTrigger"><span class="hs-identifier hs-var hs-var">msssqlIdenTrigger</span></a></span></span><span> </span><span id="local-6989586621689341752"><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621689341752"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span id="local-6989586621689341751"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341751"><span class="hs-identifier hs-var">schemaName</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621689341750"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341750"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-571"></span><span>  </span><span class="annot"><span class="annottext">Text -&gt; QualifiedTriggerName
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#QualifiedTriggerName"><span class="hs-identifier hs-var">QualifiedTriggerName</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; QualifiedTriggerName) -&gt; Text -&gt; QualifiedTriggerName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ops -&gt; Text -&gt; Text
</span><a href="#local-6989586621689341749"><span class="hs-identifier hs-var">qualifyHasuraTriggerName</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621689341752"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Text) -&gt; Text -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341750"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-572"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-573"></span><span>    </span><span id="local-6989586621689341749"><span class="annot"><span class="annottext">qualifyHasuraTriggerName :: Ops -&gt; Text -&gt; Text
</span><a href="#local-6989586621689341749"><span class="hs-identifier hs-var hs-var">qualifyHasuraTriggerName</span></a></span></span><span> </span><span id="local-6989586621689341748"><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621689341748"><span class="hs-identifier hs-var">op'</span></a></span></span><span> </span><span id="local-6989586621689341747"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341747"><span class="hs-identifier hs-var">triggerName'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341751"><span class="hs-identifier hs-var">schemaName</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;.&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;notify_hasura_&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341747"><span class="hs-identifier hs-var">triggerName'</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;_&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Ops -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="Hasura.Prelude.html#tshow"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="#local-6989586621689341748"><span class="hs-identifier hs-var">op'</span></a></span><span>
</span><span id="line-574"></span><span>
</span><span id="line-575"></span><span id="local-6989586621689342161"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkAllTriggersQ"><span class="hs-identifier hs-type">mkAllTriggersQ</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-576"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MonadMSSQLTx"><span class="hs-identifier hs-type">MonadMSSQLTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689342161"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-577"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-578"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-579"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-580"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerOpsDef"><span class="hs-identifier hs-type">TriggerOpsDef</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-581"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Table.html#PrimaryKey"><span class="hs-identifier hs-type">PrimaryKey</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-582"></span><span>  </span><span class="annot"><a href="#local-6989586621689342161"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-583"></span><span id="mkAllTriggersQ"><span class="annot"><span class="annottext">mkAllTriggersQ :: TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; TriggerOpsDef 'MSSQL
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkAllTriggersQ"><span class="hs-identifier hs-var hs-var">mkAllTriggersQ</span></a></span></span><span> </span><span id="local-6989586621689341746"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341746"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689341745"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689341745"><span class="hs-identifier hs-var">tableName</span></a></span></span><span> </span><span id="local-6989586621689341744"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341744"><span class="hs-identifier hs-var">allCols</span></a></span></span><span> </span><span id="local-6989586621689341743"><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621689341743"><span class="hs-identifier hs-var">fullSpec</span></a></span></span><span> </span><span id="local-6989586621689341742"><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
</span><a href="#local-6989586621689341742"><span class="hs-identifier hs-var">primaryKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-584"></span><span>  </span><span class="annot"><span class="annottext">Maybe (SubscribeOpSpec 'MSSQL)
-&gt; (SubscribeOpSpec 'MSSQL -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="Hasura.Prelude.html#onJust"><span class="hs-identifier hs-var">onJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL -&gt; Maybe (SubscribeOpSpec 'MSSQL)
forall (b :: BackendType).
TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
</span><a href="Hasura.RQL.Types.EventTrigger.html#tdInsert"><span class="hs-identifier hs-var hs-var">tdInsert</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621689341743"><span class="hs-identifier hs-var">fullSpec</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkInsertTriggerQ"><span class="hs-identifier hs-var">mkInsertTriggerQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341746"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689341745"><span class="hs-identifier hs-var">tableName</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341744"><span class="hs-identifier hs-var">allCols</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-585"></span><span>  </span><span class="annot"><span class="annottext">Maybe (SubscribeOpSpec 'MSSQL)
-&gt; (SubscribeOpSpec 'MSSQL -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="Hasura.Prelude.html#onJust"><span class="hs-identifier hs-var">onJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL -&gt; Maybe (SubscribeOpSpec 'MSSQL)
forall (b :: BackendType).
TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
</span><a href="Hasura.RQL.Types.EventTrigger.html#tdDelete"><span class="hs-identifier hs-var hs-var">tdDelete</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621689341743"><span class="hs-identifier hs-var">fullSpec</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkDeleteTriggerQ"><span class="hs-identifier hs-var">mkDeleteTriggerQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341746"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689341745"><span class="hs-identifier hs-var">tableName</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341744"><span class="hs-identifier hs-var">allCols</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-586"></span><span>  </span><span class="annot"><span class="annottext">Maybe (SubscribeOpSpec 'MSSQL)
-&gt; (SubscribeOpSpec 'MSSQL -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="Hasura.Prelude.html#onJust"><span class="hs-identifier hs-var">onJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL -&gt; Maybe (SubscribeOpSpec 'MSSQL)
forall (b :: BackendType).
TriggerOpsDef b -&gt; Maybe (SubscribeOpSpec b)
</span><a href="Hasura.RQL.Types.EventTrigger.html#tdUpdate"><span class="hs-identifier hs-var hs-var">tdUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef 'MSSQL
</span><a href="#local-6989586621689341743"><span class="hs-identifier hs-var">fullSpec</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkUpdateTriggerQ"><span class="hs-identifier hs-var">mkUpdateTriggerQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341746"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689341745"><span class="hs-identifier hs-var">tableName</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341744"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
</span><a href="#local-6989586621689341742"><span class="hs-identifier hs-var">primaryKey</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-587"></span><span>
</span><span id="line-588"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getApplicableColumns"><span class="hs-identifier hs-type">getApplicableColumns</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeColumns"><span class="hs-identifier hs-type">SubscribeColumns</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-589"></span><span id="getApplicableColumns"><span class="annot"><span class="annottext">getApplicableColumns :: [ColumnInfo 'MSSQL]
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getApplicableColumns"><span class="hs-identifier hs-var hs-var">getApplicableColumns</span></a></span></span><span> </span><span id="local-6989586621689341740"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341740"><span class="hs-identifier hs-var">allColumnInfos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-590"></span><span>  </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
</span><a href="Hasura.RQL.Types.EventTrigger.html#SubCStar"><span class="hs-identifier hs-var">SubCStar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341740"><span class="hs-identifier hs-var">allColumnInfos</span></a></span><span>
</span><span id="line-591"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubCArray"><span class="hs-identifier hs-type">SubCArray</span></a></span><span> </span><span id="local-6989586621689341737"><span class="annot"><span class="annottext">[Column 'MSSQL]
</span><a href="#local-6989586621689341737"><span class="hs-identifier hs-var">cols</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Column 'MSSQL] -&gt; [ColumnInfo 'MSSQL] -&gt; [ColumnInfo 'MSSQL]
forall (b :: BackendType).
Backend b =&gt;
[Column b] -&gt; [ColumnInfo b] -&gt; [ColumnInfo b]
</span><a href="Hasura.RQL.Types.Column.html#getColInfos"><span class="hs-identifier hs-var">getColInfos</span></a></span><span> </span><span class="annot"><span class="annottext">[Column 'MSSQL]
</span><a href="#local-6989586621689341737"><span class="hs-identifier hs-var">cols</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341740"><span class="hs-identifier hs-var">allColumnInfos</span></a></span><span>
</span><span id="line-592"></span><span>
</span><span id="line-593"></span><span class="hs-comment">-- | Currently we do not support Event Triggers on columns of Spatial data types.</span><span>
</span><span id="line-594"></span><span class="hs-comment">-- We do this because, currently the graphQL API for these types is broken</span><span>
</span><span id="line-595"></span><span class="hs-comment">-- for MSSQL sources. Ref: https://github.com/hasura/graphql-engine-mono/issues/787</span><span>
</span><span id="line-596"></span><span id="local-6989586621689342035"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkSpatialDataTypeColumns"><span class="hs-identifier hs-type">checkSpatialDataTypeColumns</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-597"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MonadMSSQLTx"><span class="hs-identifier hs-type">MonadMSSQLTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689342035"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-598"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-599"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeOpSpec"><span class="hs-identifier hs-type">SubscribeOpSpec</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-600"></span><span>  </span><span class="annot"><a href="#local-6989586621689342035"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-601"></span><span id="checkSpatialDataTypeColumns"><span class="annot"><span class="annottext">checkSpatialDataTypeColumns :: [ColumnInfo 'MSSQL] -&gt; SubscribeOpSpec 'MSSQL -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkSpatialDataTypeColumns"><span class="hs-identifier hs-var hs-var">checkSpatialDataTypeColumns</span></a></span></span><span> </span><span id="local-6989586621689341734"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341734"><span class="hs-identifier hs-var">allCols</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeOpSpec"><span class="hs-identifier hs-type">SubscribeOpSpec</span></a></span><span> </span><span id="local-6989586621689341732"><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
</span><a href="#local-6989586621689341732"><span class="hs-identifier hs-var">listenCols</span></a></span></span><span> </span><span id="local-6989586621689341731"><span class="annot"><span class="annottext">Maybe (SubscribeColumns 'MSSQL)
</span><a href="#local-6989586621689341731"><span class="hs-identifier hs-var">deliveryCols</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-602"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689341730"><span class="annot"><span class="annottext">listenColumns :: [ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341730"><span class="hs-identifier hs-var hs-var">listenColumns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getApplicableColumns"><span class="hs-identifier hs-var">getApplicableColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341734"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
</span><a href="#local-6989586621689341732"><span class="hs-identifier hs-var">listenCols</span></a></span><span>
</span><span id="line-603"></span><span>      </span><span id="local-6989586621689341729"><span class="annot"><span class="annottext">deliveryColumns :: [ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341729"><span class="hs-identifier hs-var hs-var">deliveryColumns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getApplicableColumns"><span class="hs-identifier hs-var">getApplicableColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341734"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL])
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
-&gt; Maybe (SubscribeColumns 'MSSQL) -&gt; SubscribeColumns 'MSSQL
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
forall (b :: BackendType). SubscribeColumns b
</span><a href="Hasura.RQL.Types.EventTrigger.html#SubCStar"><span class="hs-identifier hs-var">SubCStar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SubscribeColumns 'MSSQL)
</span><a href="#local-6989586621689341731"><span class="hs-identifier hs-var">deliveryCols</span></a></span><span>
</span><span id="line-604"></span><span>      </span><span id="local-6989586621689341727"><span class="annot"><span class="annottext">isGeoTypesInListenCols :: Bool
</span><a href="#local-6989586621689341727"><span class="hs-identifier hs-var hs-var">isGeoTypesInListenCols</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Bool) -&gt; [ColumnInfo 'MSSQL] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ScalarType 'MSSQL -&gt; Bool) -&gt; ColumnType 'MSSQL -&gt; Bool
forall (b :: BackendType).
(ScalarType b -&gt; Bool) -&gt; ColumnType b -&gt; Bool
</span><a href="Hasura.RQL.Types.Column.html#isScalarColumnWhere"><span class="hs-identifier hs-var">isScalarColumnWhere</span></a></span><span> </span><span class="annot"><span class="annottext">ScalarType 'MSSQL -&gt; Bool
ScalarType -&gt; Bool
</span><a href="#local-6989586621689341724"><span class="hs-identifier hs-var">isGeoType</span></a></span><span> </span><span class="annot"><span class="annottext">(ColumnType 'MSSQL -&gt; Bool)
-&gt; (ColumnInfo 'MSSQL -&gt; ColumnType 'MSSQL)
-&gt; ColumnInfo 'MSSQL
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL -&gt; ColumnType 'MSSQL
forall (b :: BackendType). ColumnInfo b -&gt; ColumnType b
</span><a href="Hasura.RQL.Types.Column.html#ciType"><span class="hs-identifier hs-var hs-var">ciType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341730"><span class="hs-identifier hs-var">listenColumns</span></a></span><span>
</span><span id="line-605"></span><span>      </span><span id="local-6989586621689341722"><span class="annot"><span class="annottext">isGeoTypesInDeliversCols :: Bool
</span><a href="#local-6989586621689341722"><span class="hs-identifier hs-var hs-var">isGeoTypesInDeliversCols</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Bool) -&gt; [ColumnInfo 'MSSQL] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ScalarType 'MSSQL -&gt; Bool) -&gt; ColumnType 'MSSQL -&gt; Bool
forall (b :: BackendType).
(ScalarType b -&gt; Bool) -&gt; ColumnType b -&gt; Bool
</span><a href="Hasura.RQL.Types.Column.html#isScalarColumnWhere"><span class="hs-identifier hs-var">isScalarColumnWhere</span></a></span><span> </span><span class="annot"><span class="annottext">ScalarType 'MSSQL -&gt; Bool
ScalarType -&gt; Bool
</span><a href="#local-6989586621689341724"><span class="hs-identifier hs-var">isGeoType</span></a></span><span> </span><span class="annot"><span class="annottext">(ColumnType 'MSSQL -&gt; Bool)
-&gt; (ColumnInfo 'MSSQL -&gt; ColumnType 'MSSQL)
-&gt; ColumnInfo 'MSSQL
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL -&gt; ColumnType 'MSSQL
forall (b :: BackendType). ColumnInfo b -&gt; ColumnType b
</span><a href="Hasura.RQL.Types.Column.html#ciType"><span class="hs-identifier hs-var hs-var">ciType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341729"><span class="hs-identifier hs-var">deliveryColumns</span></a></span><span>
</span><span id="line-606"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621689341727"><span class="hs-identifier hs-var">isGeoTypesInListenCols</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621689341722"><span class="hs-identifier hs-var">isGeoTypesInDeliversCols</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-607"></span><span>    </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; m ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#NotSupported"><span class="hs-identifier hs-var">NotSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Event triggers for MS-SQL sources are not supported on tables having Geometry or Geography column types&quot;</span></span><span>
</span><span id="line-608"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-609"></span><span>    </span><span id="local-6989586621689341724"><span class="annot"><span class="annottext">isGeoType :: ScalarType -&gt; Bool
</span><a href="#local-6989586621689341724"><span class="hs-identifier hs-var hs-var">isGeoType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScalarType -&gt; [ScalarType] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[ScalarType]
</span><a href="Hasura.Backends.MSSQL.Types.Internal.html#geoTypes"><span class="hs-identifier hs-var">geoTypes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-610"></span><span>
</span><span id="line-611"></span><span id="local-6989586621689342140"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkInsertTriggerQ"><span class="hs-identifier hs-type">mkInsertTriggerQ</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-612"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MonadMSSQLTx"><span class="hs-identifier hs-type">MonadMSSQLTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689342140"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-613"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-614"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-615"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-616"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeOpSpec"><span class="hs-identifier hs-type">SubscribeOpSpec</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-617"></span><span>  </span><span class="annot"><a href="#local-6989586621689342140"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-618"></span><span id="mkInsertTriggerQ"><span class="annot"><span class="annottext">mkInsertTriggerQ :: TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkInsertTriggerQ"><span class="hs-identifier hs-var hs-var">mkInsertTriggerQ</span></a></span></span><span> </span><span id="local-6989586621689341718"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341718"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689341717"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689341717"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span id="local-6989586621689341716"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341716"><span class="hs-identifier hs-var">allCols</span></a></span></span><span> </span><span id="local-6989586621689341715"><span class="annot"><span class="annottext">subOpSpec :: SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621689341715"><span class="hs-identifier hs-var">subOpSpec</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeOpSpec"><span class="hs-identifier hs-type">SubscribeOpSpec</span></a></span><span> </span><span id="local-6989586621689341714"><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
</span><a href="#local-6989586621689341714"><span class="hs-identifier hs-var">_listenCols</span></a></span></span><span> </span><span id="local-6989586621689341713"><span class="annot"><span class="annottext">Maybe (SubscribeColumns 'MSSQL)
</span><a href="#local-6989586621689341713"><span class="hs-identifier hs-var">deliveryCols</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-619"></span><span>  </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL] -&gt; SubscribeOpSpec 'MSSQL -&gt; m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
[ColumnInfo 'MSSQL] -&gt; SubscribeOpSpec 'MSSQL -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkSpatialDataTypeColumns"><span class="hs-identifier hs-var">checkSpatialDataTypeColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341716"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621689341715"><span class="hs-identifier hs-var">subOpSpec</span></a></span><span>
</span><span id="line-620"></span><span>  </span><span class="annot"><span class="annottext">TxET QErr IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadMSSQLTx m =&gt; TxE QErr a -&gt; m a
</span><a href="Hasura.Backends.MSSQL.Connection.html#liftMSSQLTx"><span class="hs-identifier hs-var">liftMSSQLTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; m ()) -&gt; TxET QErr IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-621"></span><span>    </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span> </span><span class="annot"><span class="annottext">(Query -&gt; TxET QErr IO ()) -&gt; Query -&gt; TxET QErr IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-622"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><span class="hs-identifier hs-var">rawUnescapedText</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; (Text -&gt; Text) -&gt; Text -&gt; Query
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><span class="hs-identifier hs-var">LT.toStrict</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; Text -&gt; Query
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-623"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689341712"><span class="annot"><span class="annottext">deliveryColumns :: [ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341712"><span class="hs-identifier hs-var hs-var">deliveryColumns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getApplicableColumns"><span class="hs-identifier hs-var">getApplicableColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341716"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL])
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
-&gt; Maybe (SubscribeColumns 'MSSQL) -&gt; SubscribeColumns 'MSSQL
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
forall (b :: BackendType). SubscribeColumns b
</span><a href="Hasura.RQL.Types.EventTrigger.html#SubCStar"><span class="hs-identifier hs-var">SubCStar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SubscribeColumns 'MSSQL)
</span><a href="#local-6989586621689341713"><span class="hs-identifier hs-var">deliveryCols</span></a></span><span>
</span><span id="line-624"></span><span>        </span><span class="annot"><span class="annottext">TableName -&gt; TriggerName -&gt; [ColumnInfo 'MSSQL] -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkInsertTriggerQuery"><span class="hs-identifier hs-var">mkInsertTriggerQuery</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689341717"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341718"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341712"><span class="hs-identifier hs-var">deliveryColumns</span></a></span><span>
</span><span id="line-625"></span><span>
</span><span id="line-626"></span><span id="local-6989586621689341710"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkDeleteTriggerQ"><span class="hs-identifier hs-type">mkDeleteTriggerQ</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-627"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MonadMSSQLTx"><span class="hs-identifier hs-type">MonadMSSQLTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689341710"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-628"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-629"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-630"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-631"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeOpSpec"><span class="hs-identifier hs-type">SubscribeOpSpec</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-632"></span><span>  </span><span class="annot"><a href="#local-6989586621689341710"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-633"></span><span id="mkDeleteTriggerQ"><span class="annot"><span class="annottext">mkDeleteTriggerQ :: TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkDeleteTriggerQ"><span class="hs-identifier hs-var hs-var">mkDeleteTriggerQ</span></a></span></span><span> </span><span id="local-6989586621689341709"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341709"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689341708"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689341708"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span id="local-6989586621689341707"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341707"><span class="hs-identifier hs-var">allCols</span></a></span></span><span> </span><span id="local-6989586621689341706"><span class="annot"><span class="annottext">subOpSpec :: SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621689341706"><span class="hs-identifier hs-var">subOpSpec</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeOpSpec"><span class="hs-identifier hs-type">SubscribeOpSpec</span></a></span><span> </span><span id="local-6989586621689341705"><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
</span><a href="#local-6989586621689341705"><span class="hs-identifier hs-var">_listenCols</span></a></span></span><span> </span><span id="local-6989586621689341704"><span class="annot"><span class="annottext">Maybe (SubscribeColumns 'MSSQL)
</span><a href="#local-6989586621689341704"><span class="hs-identifier hs-var">deliveryCols</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-634"></span><span>  </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL] -&gt; SubscribeOpSpec 'MSSQL -&gt; m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
[ColumnInfo 'MSSQL] -&gt; SubscribeOpSpec 'MSSQL -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkSpatialDataTypeColumns"><span class="hs-identifier hs-var">checkSpatialDataTypeColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341707"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621689341706"><span class="hs-identifier hs-var">subOpSpec</span></a></span><span>
</span><span id="line-635"></span><span>  </span><span class="annot"><span class="annottext">TxET QErr IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadMSSQLTx m =&gt; TxE QErr a -&gt; m a
</span><a href="Hasura.Backends.MSSQL.Connection.html#liftMSSQLTx"><span class="hs-identifier hs-var">liftMSSQLTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; m ()) -&gt; TxET QErr IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-636"></span><span>    </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span> </span><span class="annot"><span class="annottext">(Query -&gt; TxET QErr IO ()) -&gt; Query -&gt; TxET QErr IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-637"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><span class="hs-identifier hs-var">rawUnescapedText</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; (Text -&gt; Text) -&gt; Text -&gt; Query
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><span class="hs-identifier hs-var">LT.toStrict</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; Text -&gt; Query
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-638"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689341703"><span class="annot"><span class="annottext">deliveryColumns :: [ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341703"><span class="hs-identifier hs-var hs-var">deliveryColumns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getApplicableColumns"><span class="hs-identifier hs-var">getApplicableColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341707"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL])
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
-&gt; Maybe (SubscribeColumns 'MSSQL) -&gt; SubscribeColumns 'MSSQL
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
forall (b :: BackendType). SubscribeColumns b
</span><a href="Hasura.RQL.Types.EventTrigger.html#SubCStar"><span class="hs-identifier hs-var">SubCStar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SubscribeColumns 'MSSQL)
</span><a href="#local-6989586621689341704"><span class="hs-identifier hs-var">deliveryCols</span></a></span><span>
</span><span id="line-639"></span><span>        </span><span class="annot"><span class="annottext">TableName -&gt; TriggerName -&gt; [ColumnInfo 'MSSQL] -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkDeleteTriggerQuery"><span class="hs-identifier hs-var">mkDeleteTriggerQuery</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689341708"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341709"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341703"><span class="hs-identifier hs-var">deliveryColumns</span></a></span><span>
</span><span id="line-640"></span><span>
</span><span id="line-641"></span><span id="local-6989586621689342139"><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkUpdateTriggerQ"><span class="hs-identifier hs-type">mkUpdateTriggerQ</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-642"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MonadMSSQLTx"><span class="hs-identifier hs-type">MonadMSSQLTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621689342139"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-643"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-644"></span><span>  </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-645"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-646"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Table.html#PrimaryKey"><span class="hs-identifier hs-type">PrimaryKey</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-647"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeOpSpec"><span class="hs-identifier hs-type">SubscribeOpSpec</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-648"></span><span>  </span><span class="annot"><a href="#local-6989586621689342139"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-649"></span><span id="mkUpdateTriggerQ"><span class="annot"><span class="annottext">mkUpdateTriggerQ :: TriggerName
-&gt; TableName
-&gt; [ColumnInfo 'MSSQL]
-&gt; Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; SubscribeOpSpec 'MSSQL
-&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkUpdateTriggerQ"><span class="hs-identifier hs-var hs-var">mkUpdateTriggerQ</span></a></span></span><span> </span><span id="local-6989586621689341701"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341701"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689341700"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689341700"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span id="local-6989586621689341699"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341699"><span class="hs-identifier hs-var">allCols</span></a></span></span><span> </span><span id="local-6989586621689341698"><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
</span><a href="#local-6989586621689341698"><span class="hs-identifier hs-var">primaryKeyMaybe</span></a></span></span><span> </span><span id="local-6989586621689341697"><span class="annot"><span class="annottext">subOpSpec :: SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621689341697"><span class="hs-identifier hs-var">subOpSpec</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#SubscribeOpSpec"><span class="hs-identifier hs-type">SubscribeOpSpec</span></a></span><span> </span><span id="local-6989586621689341696"><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
</span><a href="#local-6989586621689341696"><span class="hs-identifier hs-var">listenCols</span></a></span></span><span> </span><span id="local-6989586621689341695"><span class="annot"><span class="annottext">Maybe (SubscribeColumns 'MSSQL)
</span><a href="#local-6989586621689341695"><span class="hs-identifier hs-var">deliveryCols</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-650"></span><span>  </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL] -&gt; SubscribeOpSpec 'MSSQL -&gt; m ()
forall (m :: * -&gt; *).
MonadMSSQLTx m =&gt;
[ColumnInfo 'MSSQL] -&gt; SubscribeOpSpec 'MSSQL -&gt; m ()
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#checkSpatialDataTypeColumns"><span class="hs-identifier hs-var">checkSpatialDataTypeColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341699"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">SubscribeOpSpec 'MSSQL
</span><a href="#local-6989586621689341697"><span class="hs-identifier hs-var">subOpSpec</span></a></span><span>
</span><span id="line-651"></span><span>  </span><span class="annot"><span class="annottext">TxET QErr IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadMSSQLTx m =&gt; TxE QErr a -&gt; m a
</span><a href="Hasura.Backends.MSSQL.Connection.html#liftMSSQLTx"><span class="hs-identifier hs-var">liftMSSQLTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr IO () -&gt; m ()) -&gt; TxET QErr IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-652"></span><span>    </span><span id="local-6989586621689341694"><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
</span><a href="#local-6989586621689341694"><span class="hs-identifier hs-var">primaryKey</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; TxET QErr IO (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
-&gt; TxET QErr IO (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; m a -&gt; m a
</span><a href="Hasura.Prelude.html#onNothing"><span class="hs-identifier hs-var">onNothing</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
</span><a href="#local-6989586621689341698"><span class="hs-identifier hs-var">primaryKeyMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Code
-&gt; Text -&gt; TxET QErr IO (PrimaryKey 'MSSQL (ColumnInfo 'MSSQL))
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#NotSupported"><span class="hs-identifier hs-var">NotSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Update event triggers for MS-SQL sources are only supported on tables with primary keys&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-653"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689341692"><span class="annot"><span class="annottext">deliveryColumns :: [ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341692"><span class="hs-identifier hs-var hs-var">deliveryColumns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getApplicableColumns"><span class="hs-identifier hs-var">getApplicableColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341699"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL])
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
-&gt; Maybe (SubscribeColumns 'MSSQL) -&gt; SubscribeColumns 'MSSQL
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
forall (b :: BackendType). SubscribeColumns b
</span><a href="Hasura.RQL.Types.EventTrigger.html#SubCStar"><span class="hs-identifier hs-var">SubCStar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SubscribeColumns 'MSSQL)
</span><a href="#local-6989586621689341695"><span class="hs-identifier hs-var">deliveryCols</span></a></span><span>
</span><span id="line-654"></span><span>        </span><span id="local-6989586621689341691"><span class="annot"><span class="annottext">listenColumns :: [ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341691"><span class="hs-identifier hs-var hs-var">listenColumns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
-&gt; SubscribeColumns 'MSSQL -&gt; [ColumnInfo 'MSSQL]
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#getApplicableColumns"><span class="hs-identifier hs-var">getApplicableColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341699"><span class="hs-identifier hs-var">allCols</span></a></span><span> </span><span class="annot"><span class="annottext">SubscribeColumns 'MSSQL
</span><a href="#local-6989586621689341696"><span class="hs-identifier hs-var">listenCols</span></a></span><span>
</span><span id="line-655"></span><span>    </span><span class="annot"><span class="annottext">(MSSQLTxError -&gt; QErr) -&gt; Query -&gt; TxET QErr IO ()
forall (m :: * -&gt; *) e.
MonadIO m =&gt;
(MSSQLTxError -&gt; e) -&gt; Query -&gt; TxET e m ()
</span><a href="Database.MSSQL.Transaction.html#unitQueryE"><span class="hs-identifier hs-var">unitQueryE</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLTxError -&gt; QErr
</span><a href="Hasura.Backends.MSSQL.SQL.Error.html#defaultMSSQLTxErrorHandler"><span class="hs-identifier hs-var">HGE.defaultMSSQLTxErrorHandler</span></a></span><span> </span><span class="annot"><span class="annottext">(Query -&gt; TxET QErr IO ()) -&gt; Query -&gt; TxET QErr IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-656"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><span class="hs-identifier hs-var">rawUnescapedText</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; (Text -&gt; Text) -&gt; Text -&gt; Query
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><span class="hs-identifier hs-var">LT.toStrict</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Query) -&gt; Text -&gt; Query
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-657"></span><span>        </span><span class="annot"><span class="annottext">TableName
-&gt; TriggerName
-&gt; [ColumnInfo 'MSSQL]
-&gt; [ColumnInfo 'MSSQL]
-&gt; PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
-&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkUpdateTriggerQuery"><span class="hs-identifier hs-var">mkUpdateTriggerQuery</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689341700"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341701"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341691"><span class="hs-identifier hs-var">listenColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341692"><span class="hs-identifier hs-var">deliveryColumns</span></a></span><span> </span><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
</span><a href="#local-6989586621689341694"><span class="hs-identifier hs-var">primaryKey</span></a></span><span>
</span><span id="line-658"></span><span>
</span><span id="line-659"></span><span class="hs-comment">-- Create alias for columns</span><span>
</span><span id="line-660"></span><span class="hs-comment">-- eg: If colPrefixMaybe is defined then 'inserted.id as payload.data.old.id'</span><span>
</span><span id="line-661"></span><span class="hs-comment">--     else 'id as payload.data.old.id'</span><span>
</span><span id="line-662"></span><span class="hs-comment">-- We create such an alias for the columns of the table because it helps in</span><span>
</span><span id="line-663"></span><span class="hs-comment">-- structuring the JSON payload.</span><span>
</span><span id="line-664"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateColumnTriggerAlias"><span class="hs-identifier hs-type">generateColumnTriggerAlias</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#OpVar"><span class="hs-identifier hs-type">OpVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-type">SQLFragment</span></a></span><span>
</span><span id="line-665"></span><span id="generateColumnTriggerAlias"><span class="annot"><span class="annottext">generateColumnTriggerAlias :: OpVar -&gt; Maybe Text -&gt; ColumnInfo 'MSSQL -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateColumnTriggerAlias"><span class="hs-identifier hs-var hs-var">generateColumnTriggerAlias</span></a></span></span><span> </span><span id="local-6989586621689341688"><span class="annot"><span class="annottext">OpVar
</span><a href="#local-6989586621689341688"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span id="local-6989586621689341687"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621689341687"><span class="hs-identifier hs-var">colPrefixMaybe</span></a></span></span><span> </span><span id="local-6989586621689341686"><span class="annot"><span class="annottext">ColumnInfo 'MSSQL
</span><a href="#local-6989586621689341686"><span class="hs-identifier hs-var">colInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-666"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689341685"><span class="annot"><span class="annottext">opText :: Text
</span><a href="#local-6989586621689341685"><span class="hs-identifier hs-var hs-var">opText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-667"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">OpVar
</span><a href="#local-6989586621689341688"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-668"></span><span>          </span><span class="annot"><span class="annottext">OpVar
</span><a href="Hasura.RQL.Types.Eventing.html#OLD"><span class="hs-identifier hs-var">OLD</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;old&quot;</span></span><span>
</span><span id="line-669"></span><span>          </span><span class="annot"><span class="annottext">OpVar
</span><a href="Hasura.RQL.Types.Eventing.html#NEW"><span class="hs-identifier hs-var">NEW</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;new&quot;</span></span><span>
</span><span id="line-670"></span><span>      </span><span class="hs-comment">-- Let's say we have a column 'id', dbColNameText returns the column name as</span><span>
</span><span id="line-671"></span><span>      </span><span class="hs-comment">-- text. i.e 'id'</span><span>
</span><span id="line-672"></span><span>      </span><span id="local-6989586621689341682"><span class="annot"><span class="annottext">dbColNameText :: Text
</span><a href="#local-6989586621689341682"><span class="hs-identifier hs-var hs-var">dbColNameText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ColumnName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.Types.Internal.html#%24sel%3AcolumnNameText%3AColumnName"><span class="hs-identifier hs-var hs-var">columnNameText</span></a></span><span> </span><span class="annot"><span class="annottext">(ColumnName -&gt; Text) -&gt; ColumnName -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL -&gt; Column 'MSSQL
forall (b :: BackendType). ColumnInfo b -&gt; Column b
</span><a href="Hasura.RQL.Types.Column.html#ciColumn"><span class="hs-identifier hs-var hs-var">ciColumn</span></a></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL
</span><a href="#local-6989586621689341686"><span class="hs-identifier hs-var">colInfo</span></a></span><span>
</span><span id="line-673"></span><span>      </span><span id="local-6989586621689341680"><span class="annot"><span class="annottext">joinPrefixedDbColNameText :: Text
</span><a href="#local-6989586621689341680"><span class="hs-identifier hs-var hs-var">joinPrefixedDbColNameText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-674"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621689341687"><span class="hs-identifier hs-var">colPrefixMaybe</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-675"></span><span>          </span><span class="hs-comment">-- prefix with the joining table's name</span><span>
</span><span id="line-676"></span><span>          </span><span class="hs-comment">-- `id` -&gt; `inserted.id` (prefix = 'inserted')</span><span>
</span><span id="line-677"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621689341679"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341679"><span class="hs-identifier hs-var">colPrefix</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341679"><span class="hs-identifier hs-var">colPrefix</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;.&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341682"><span class="hs-identifier hs-var">dbColNameText</span></a></span><span>
</span><span id="line-678"></span><span>          </span><span class="hs-comment">-- do not prefix anthing to the column name</span><span>
</span><span id="line-679"></span><span>          </span><span class="annot"><span class="annottext">Maybe Text
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341682"><span class="hs-identifier hs-var">dbColNameText</span></a></span><span>
</span><span id="line-680"></span><span>      </span><span class="hs-comment">-- create the alias for the column</span><span>
</span><span id="line-681"></span><span>      </span><span class="hs-comment">-- `payload.data.old.id` (opText = old) (dbColNameText = id)</span><span>
</span><span id="line-682"></span><span>      </span><span id="local-6989586621689341678"><span class="annot"><span class="annottext">dbColAlias :: Text
</span><a href="#local-6989586621689341678"><span class="hs-identifier hs-var hs-var">dbColAlias</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;payload.data&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;.&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341685"><span class="hs-identifier hs-var">opText</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;.&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341682"><span class="hs-identifier hs-var">dbColNameText</span></a></span><span>
</span><span id="line-683"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-comment">-- create the SQL alias using the `as` keyword</span><span>
</span><span id="line-684"></span><span>      </span><span class="hs-comment">-- If colPrefixMaybe existed then alias will be `inserted.id as payload.data.old.id`</span><span>
</span><span id="line-685"></span><span>      </span><span class="hs-comment">-- If no colPrefixMaybe was Nothing then alias will be 'id as payload.data.old.id`</span><span>
</span><span id="line-686"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-var">SQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; SQLFragment) -&gt; Text -&gt; SQLFragment
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><span class="hs-identifier hs-var">LT.toStrict</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Text) -&gt; Text -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="">[ST.stext| #{joinPrefixedDbColNameText} as [#{dbColAlias}]|]</span></span><span>
</span><span id="line-687"></span><span>
</span><span id="line-688"></span><span class="hs-comment">-- Converts tables name to the format [SCHEMA].[TABLENAME]</span><span>
</span><span id="line-689"></span><span class="hs-comment">-- eg: [dbo].[author], [hge].[books]</span><span>
</span><span id="line-690"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#qualifyTableName"><span class="hs-identifier hs-type">qualifyTableName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-691"></span><span id="qualifyTableName"><span class="annot"><span class="annottext">qualifyTableName :: TableName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#qualifyTableName"><span class="hs-identifier hs-var hs-var">qualifyTableName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Query -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">(Query -&gt; Text) -&gt; (TableName -&gt; Query) -&gt; TableName -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Printer -&gt; Query
</span><a href="Hasura.Backends.MSSQL.ToQuery.html#toQueryFlat"><span class="hs-identifier hs-var">toQueryFlat</span></a></span><span> </span><span class="annot"><span class="annottext">(Printer -&gt; Query) -&gt; (TableName -&gt; Printer) -&gt; TableName -&gt; Query
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TableName -&gt; Printer
</span><a href="Hasura.Backends.MSSQL.ToQuery.html#fromTableName"><span class="hs-identifier hs-var">fromTableName</span></a></span><span>
</span><span id="line-692"></span><span>
</span><span id="line-693"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkInsertTriggerQuery"><span class="hs-identifier hs-type">mkInsertTriggerQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LT.Text</span></span><span>
</span><span id="line-694"></span><span id="mkInsertTriggerQuery"><span class="annot"><span class="annottext">mkInsertTriggerQuery :: TableName -&gt; TriggerName -&gt; [ColumnInfo 'MSSQL] -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkInsertTriggerQuery"><span class="hs-identifier hs-var hs-var">mkInsertTriggerQuery</span></a></span></span><span> </span><span id="local-6989586621689341677"><span class="annot"><span class="annottext">table :: TableName
</span><a href="#local-6989586621689341677"><span class="hs-identifier hs-var">table</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span id="local-6989586621689341676"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341676"><span class="hs-identifier hs-var">tableName</span></a></span></span><span> </span><span id="local-6989586621689341675"><span class="annot"><span class="annottext">schema :: SchemaName
</span><a href="#local-6989586621689341675"><span class="hs-identifier hs-var">schema</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span id="local-6989586621689341674"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341674"><span class="hs-identifier hs-var">schemaName</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621689341673"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341673"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689341672"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341672"><span class="hs-identifier hs-var">columns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-695"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#QualifiedTriggerName"><span class="hs-identifier hs-type">QualifiedTriggerName</span></a></span><span> </span><span id="local-6989586621689341671"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341671"><span class="hs-identifier hs-var">qualifiedTriggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ops -&gt; SchemaName -&gt; TriggerName -&gt; QualifiedTriggerName
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#msssqlIdenTrigger"><span class="hs-identifier hs-var">msssqlIdenTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#INSERT"><span class="hs-identifier hs-var">INSERT</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621689341675"><span class="hs-identifier hs-var">schema</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341673"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-696"></span><span>      </span><span id="local-6989586621689341670"><span class="annot"><span class="annottext">triggerNameText :: Text
</span><a href="#local-6989586621689341670"><span class="hs-identifier hs-var hs-var">triggerNameText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341673"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-697"></span><span>      </span><span id="local-6989586621689341669"><span class="annot"><span class="annottext">qualifiedTableName :: Text
</span><a href="#local-6989586621689341669"><span class="hs-identifier hs-var hs-var">qualifiedTableName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TableName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#qualifyTableName"><span class="hs-identifier hs-var">qualifyTableName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689341677"><span class="hs-identifier hs-var">table</span></a></span><span>
</span><span id="line-698"></span><span>      </span><span id="local-6989586621689341668"><span class="annot"><span class="annottext">operation :: Text
</span><a href="#local-6989586621689341668"><span class="hs-identifier hs-var hs-var">operation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ops -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="Hasura.Prelude.html#tshow"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#INSERT"><span class="hs-identifier hs-var">INSERT</span></a></span><span>
</span><span id="line-699"></span><span>      </span><span id="local-6989586621689341667"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341667"><span class="hs-identifier hs-var">deliveryColsSQLExpression</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-700"></span><span>        </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; Text) -&gt; [Text] -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Text) -&gt; [ColumnInfo 'MSSQL] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var hs-var">unSQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLFragment -&gt; Text)
-&gt; (ColumnInfo 'MSSQL -&gt; SQLFragment) -&gt; ColumnInfo 'MSSQL -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">OpVar -&gt; Maybe Text -&gt; ColumnInfo 'MSSQL -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateColumnTriggerAlias"><span class="hs-identifier hs-var">generateColumnTriggerAlias</span></a></span><span> </span><span class="annot"><span class="annottext">OpVar
</span><a href="Hasura.RQL.Types.Eventing.html#NEW"><span class="hs-identifier hs-var">NEW</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Text
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341672"><span class="hs-identifier hs-var">columns</span></a></span><span>
</span><span id="line-701"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">$(</span><span class="hs-identifier">makeRelativeToProject</span><span> </span><span class="hs-string">&quot;src-rsr/mssql/mssql_insert_trigger.sql.shakespeare&quot;</span><span> </span><span class="hs-operator">&gt;&gt;=</span><span> </span><span class="hs-identifier">ST.stextFile</span><span class="hs-special">)</span><span>
</span><span id="line-702"></span><span>
</span><span id="line-703"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkDeleteTriggerQuery"><span class="hs-identifier hs-type">mkDeleteTriggerQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LT.Text</span></span><span>
</span><span id="line-704"></span><span id="mkDeleteTriggerQuery"><span class="annot"><span class="annottext">mkDeleteTriggerQuery :: TableName -&gt; TriggerName -&gt; [ColumnInfo 'MSSQL] -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkDeleteTriggerQuery"><span class="hs-identifier hs-var hs-var">mkDeleteTriggerQuery</span></a></span></span><span> </span><span id="local-6989586621689341666"><span class="annot"><span class="annottext">table :: TableName
</span><a href="#local-6989586621689341666"><span class="hs-identifier hs-var">table</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span id="local-6989586621689341665"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341665"><span class="hs-identifier hs-var">tableName</span></a></span></span><span> </span><span id="local-6989586621689341664"><span class="annot"><span class="annottext">schema :: SchemaName
</span><a href="#local-6989586621689341664"><span class="hs-identifier hs-var">schema</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span id="local-6989586621689341663"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341663"><span class="hs-identifier hs-var">schemaName</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621689341662"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341662"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span> </span><span id="local-6989586621689341661"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341661"><span class="hs-identifier hs-var">columns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-705"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#QualifiedTriggerName"><span class="hs-identifier hs-type">QualifiedTriggerName</span></a></span><span> </span><span id="local-6989586621689341660"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341660"><span class="hs-identifier hs-var">qualifiedTriggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ops -&gt; SchemaName -&gt; TriggerName -&gt; QualifiedTriggerName
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#msssqlIdenTrigger"><span class="hs-identifier hs-var">msssqlIdenTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#DELETE"><span class="hs-identifier hs-var">DELETE</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621689341664"><span class="hs-identifier hs-var">schema</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341662"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-706"></span><span>      </span><span id="local-6989586621689341659"><span class="annot"><span class="annottext">triggerNameText :: Text
</span><a href="#local-6989586621689341659"><span class="hs-identifier hs-var hs-var">triggerNameText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341662"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-707"></span><span>      </span><span id="local-6989586621689341658"><span class="annot"><span class="annottext">qualifiedTableName :: Text
</span><a href="#local-6989586621689341658"><span class="hs-identifier hs-var hs-var">qualifiedTableName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TableName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#qualifyTableName"><span class="hs-identifier hs-var">qualifyTableName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689341666"><span class="hs-identifier hs-var">table</span></a></span><span>
</span><span id="line-708"></span><span>      </span><span id="local-6989586621689341657"><span class="annot"><span class="annottext">operation :: Text
</span><a href="#local-6989586621689341657"><span class="hs-identifier hs-var hs-var">operation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ops -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="Hasura.Prelude.html#tshow"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#DELETE"><span class="hs-identifier hs-var">DELETE</span></a></span><span>
</span><span id="line-709"></span><span>      </span><span id="local-6989586621689341656"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341656"><span class="hs-identifier hs-var">deliveryColsSQLExpression</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; Text) -&gt; [Text] -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Text) -&gt; [ColumnInfo 'MSSQL] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var hs-var">unSQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLFragment -&gt; Text)
-&gt; (ColumnInfo 'MSSQL -&gt; SQLFragment) -&gt; ColumnInfo 'MSSQL -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">OpVar -&gt; Maybe Text -&gt; ColumnInfo 'MSSQL -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateColumnTriggerAlias"><span class="hs-identifier hs-var">generateColumnTriggerAlias</span></a></span><span> </span><span class="annot"><span class="annottext">OpVar
</span><a href="Hasura.RQL.Types.Eventing.html#OLD"><span class="hs-identifier hs-var">OLD</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Text
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341661"><span class="hs-identifier hs-var">columns</span></a></span><span>
</span><span id="line-710"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">$(</span><span class="hs-identifier">makeRelativeToProject</span><span> </span><span class="hs-string">&quot;src-rsr/mssql/mssql_delete_trigger.sql.shakespeare&quot;</span><span> </span><span class="hs-operator">&gt;&gt;=</span><span> </span><span class="hs-identifier">ST.stextFile</span><span class="hs-special">)</span><span>
</span><span id="line-711"></span><span>
</span><span id="line-712"></span><span class="hs-comment">-- Creates Primary Join key expression for UPDATE SQL Trigger</span><span>
</span><span id="line-713"></span><span class="hs-comment">-- eg: 'INSERTED.id = DELETED.id AND INSERTED.emp_code = DELETED.emp_code'</span><span>
</span><span id="line-714"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkPrimaryKeyJoinExp"><span class="hs-identifier hs-type">mkPrimaryKeyJoinExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-type">SQLFragment</span></a></span><span>
</span><span id="line-715"></span><span id="mkPrimaryKeyJoinExp"><span class="annot"><span class="annottext">mkPrimaryKeyJoinExp :: Text -&gt; Text -&gt; [ColumnInfo 'MSSQL] -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkPrimaryKeyJoinExp"><span class="hs-identifier hs-var hs-var">mkPrimaryKeyJoinExp</span></a></span></span><span> </span><span id="local-6989586621689341654"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341654"><span class="hs-identifier hs-var">lhsPrefix</span></a></span></span><span> </span><span id="local-6989586621689341653"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341653"><span class="hs-identifier hs-var">rhsPrefix</span></a></span></span><span> </span><span id="local-6989586621689341652"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341652"><span class="hs-identifier hs-var">columns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-716"></span><span>  </span><span class="annot"><span class="annottext">Text -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-var">SQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; SQLFragment) -&gt; Text -&gt; SQLFragment
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; [Text] -&gt; Text
</span><span class="hs-identifier hs-var">T.intercalate</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; AND &quot;</span></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; Text) -&gt; [Text] -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL -&gt; Text
</span><a href="#local-6989586621689341650"><span class="hs-identifier hs-var">singleColExp</span></a></span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Text) -&gt; [ColumnInfo 'MSSQL] -&gt; [Text]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341652"><span class="hs-identifier hs-var">columns</span></a></span><span>
</span><span id="line-717"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-718"></span><span>    </span><span id="local-6989586621689341650"><span class="annot"><span class="annottext">singleColExp :: ColumnInfo 'MSSQL -&gt; Text
</span><a href="#local-6989586621689341650"><span class="hs-identifier hs-var hs-var">singleColExp</span></a></span></span><span> </span><span id="local-6989586621689341649"><span class="annot"><span class="annottext">ColumnInfo 'MSSQL
</span><a href="#local-6989586621689341649"><span class="hs-identifier hs-var">colInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-719"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689341648"><span class="annot"><span class="annottext">dbColNameText :: Text
</span><a href="#local-6989586621689341648"><span class="hs-identifier hs-var hs-var">dbColNameText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ColumnName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.Types.Internal.html#%24sel%3AcolumnNameText%3AColumnName"><span class="hs-identifier hs-var hs-var">columnNameText</span></a></span><span> </span><span class="annot"><span class="annottext">(ColumnName -&gt; Text) -&gt; ColumnName -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL -&gt; Column 'MSSQL
forall (b :: BackendType). ColumnInfo b -&gt; Column b
</span><a href="Hasura.RQL.Types.Column.html#ciColumn"><span class="hs-identifier hs-var hs-var">ciColumn</span></a></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL
</span><a href="#local-6989586621689341649"><span class="hs-identifier hs-var">colInfo</span></a></span><span>
</span><span id="line-720"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><span class="hs-identifier hs-var">LT.toStrict</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Text) -&gt; Text -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="">[ST.stext| #{lhsPrefix}.#{dbColNameText} = #{rhsPrefix}.#{dbColNameText} |]</span></span><span>
</span><span id="line-721"></span><span>
</span><span id="line-722"></span><span class="hs-comment">-- Creates the WHERE clause for UPDATE SQL Trigger</span><span>
</span><span id="line-723"></span><span class="hs-comment">-- eg: If no listenColumns are defined then the where clause is an empty text</span><span>
</span><span id="line-724"></span><span class="hs-comment">--     else, 'WHERE INSERTED.id != DELETED.id OR INSERTED.name != DELTED.name'</span><span>
</span><span id="line-725"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkListenColumnsExp"><span class="hs-identifier hs-type">mkListenColumnsExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-type">SQLFragment</span></a></span><span>
</span><span id="line-726"></span><span id="mkListenColumnsExp"><span class="annot"><span class="annottext">mkListenColumnsExp :: Text -&gt; Text -&gt; [ColumnInfo 'MSSQL] -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkListenColumnsExp"><span class="hs-identifier hs-var hs-var">mkListenColumnsExp</span></a></span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-var">SQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-727"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkListenColumnsExp"><span class="hs-identifier hs-var">mkListenColumnsExp</span></a></span><span> </span><span id="local-6989586621689341646"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341646"><span class="hs-identifier hs-var">lhsPrefix</span></a></span></span><span> </span><span id="local-6989586621689341645"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341645"><span class="hs-identifier hs-var">rhsPrefix</span></a></span></span><span> </span><span id="local-6989586621689341644"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341644"><span class="hs-identifier hs-var">columns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-728"></span><span>  </span><span class="annot"><span class="annottext">Text -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-var">SQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; SQLFragment) -&gt; Text -&gt; SQLFragment
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;where &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; [Text] -&gt; Text
</span><span class="hs-identifier hs-var">T.intercalate</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; OR &quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL -&gt; Text
</span><a href="#local-6989586621689341643"><span class="hs-identifier hs-var">singleColExp</span></a></span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Text) -&gt; [ColumnInfo 'MSSQL] -&gt; [Text]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341644"><span class="hs-identifier hs-var">columns</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-729"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-730"></span><span>    </span><span id="local-6989586621689341643"><span class="annot"><span class="annottext">singleColExp :: ColumnInfo 'MSSQL -&gt; Text
</span><a href="#local-6989586621689341643"><span class="hs-identifier hs-var hs-var">singleColExp</span></a></span></span><span> </span><span id="local-6989586621689341642"><span class="annot"><span class="annottext">ColumnInfo 'MSSQL
</span><a href="#local-6989586621689341642"><span class="hs-identifier hs-var">colInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-731"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621689341641"><span class="annot"><span class="annottext">dbColNameText :: Text
</span><a href="#local-6989586621689341641"><span class="hs-identifier hs-var hs-var">dbColNameText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ColumnName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.Types.Internal.html#%24sel%3AcolumnNameText%3AColumnName"><span class="hs-identifier hs-var hs-var">columnNameText</span></a></span><span> </span><span class="annot"><span class="annottext">(ColumnName -&gt; Text) -&gt; ColumnName -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL -&gt; Column 'MSSQL
forall (b :: BackendType). ColumnInfo b -&gt; Column b
</span><a href="Hasura.RQL.Types.Column.html#ciColumn"><span class="hs-identifier hs-var hs-var">ciColumn</span></a></span><span> </span><span class="annot"><span class="annottext">ColumnInfo 'MSSQL
</span><a href="#local-6989586621689341642"><span class="hs-identifier hs-var">colInfo</span></a></span><span>
</span><span id="line-732"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><span class="hs-identifier hs-var">LT.toStrict</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Text) -&gt; Text -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="">[ST.stext| #{lhsPrefix}.#{dbColNameText} != #{rhsPrefix}.#{dbColNameText} |]</span></span><span>
</span><span id="line-733"></span><span>
</span><span id="line-734"></span><span class="hs-comment">-- | Check if primary key is present in listen columns</span><span>
</span><span id="line-735"></span><span class="hs-comment">-- We use this in update event trigger, to check if the primary key has been updated</span><span>
</span><span id="line-736"></span><span class="hs-comment">-- and construct the payload accordingly.</span><span>
</span><span id="line-737"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#isPrimaryKeyInListenColumns"><span class="hs-identifier hs-type">isPrimaryKeyInListenColumns</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Table.html#PrimaryKey"><span class="hs-identifier hs-type">PrimaryKey</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-type">SQLFragment</span></a></span><span>
</span><span id="line-738"></span><span id="isPrimaryKeyInListenColumns"><span class="annot"><span class="annottext">isPrimaryKeyInListenColumns :: [ColumnInfo 'MSSQL]
-&gt; PrimaryKey 'MSSQL (ColumnInfo 'MSSQL) -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#isPrimaryKeyInListenColumns"><span class="hs-identifier hs-var hs-var">isPrimaryKeyInListenColumns</span></a></span></span><span> </span><span id="local-6989586621689341639"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341639"><span class="hs-identifier hs-var">listenCols</span></a></span></span><span> </span><span id="local-6989586621689341638"><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
</span><a href="#local-6989586621689341638"><span class="hs-identifier hs-var">primaryKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-739"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NESeq (ColumnInfo 'MSSQL) -&gt; [ColumnInfo 'MSSQL]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL) -&gt; NESeq (ColumnInfo 'MSSQL)
forall (b :: BackendType) a. PrimaryKey b a -&gt; NESeq a
</span><a href="Hasura.RQL.Types.Table.html#_pkColumns"><span class="hs-identifier hs-var hs-var">_pkColumns</span></a></span><span> </span><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
</span><a href="#local-6989586621689341638"><span class="hs-identifier hs-var">primaryKey</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL] -&gt; [ColumnInfo 'MSSQL] -&gt; [ColumnInfo 'MSSQL]
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">`intersect`</span></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341639"><span class="hs-identifier hs-var">listenCols</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-740"></span><span>    </span><span class="hs-comment">-- Do not fire Event Trigger if primary key not in listen column</span><span>
</span><span id="line-741"></span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-var">SQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; SQLFragment) -&gt; Text -&gt; SQLFragment
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;1 != 1&quot;</span></span><span>
</span><span id="line-742"></span><span>    </span><span class="hs-comment">-- Fire Event Trigger, since primary key is in listen column</span><span>
</span><span id="line-743"></span><span>    </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#SQLFragment"><span class="hs-identifier hs-var">SQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; SQLFragment) -&gt; Text -&gt; SQLFragment
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;1 = 1&quot;</span></span><span>
</span><span id="line-744"></span><span>
</span><span id="line-745"></span><span class="hs-comment">{- Note [Update Event Trigger MSSQL Spec]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
An MS-SQL trigger is different from a postgres trigger in some ways
  * MS-SQL doesn't support triggers which trigger for each row, so in case of
    mutations which affect multiple rows, there'll only be a single trigger
    fired which will contain the data of all the rows that were affected.
  * MS-SQL maintains two logical tables, namely, [`inserted` and `deleted`](https://docs.microsoft.com/en-us/sql/relational-databases/triggers/use-the-inserted-and-deleted-tables?view=sql-server-ver15).
    The rows in the `inserted` table are copies of the new rows in the trigger
    table and similarly the `deleted` table contains the copies of the rows
    that were deleted from the trigger table.
  * When there's an update transaction, the old data (before the update) will
    be copied to the `deleted` table and the new data will be copied to the
    `inserted` table.

Since we deliver the 'old' and 'new' data in the event trigger payload, we would need
a way to correlate the values from `inserted` and `deleted` tables. And this is why,
It is mandatory for a MSSQL Update trigger table to have a primary key. We use this
primary key to correlate between `inserted` and `deleted`

MSSQL UPDATE trigger's join clause depends on the fact that the primary key is never
updated. But when the primary key is updated, you cannot join the 'INSERTED' and
the 'DELETED' tables. Hence for those cases, we consider the old payload as NULL and
the new payload will contain the updated row changes.

To figure out if a primary key has been updated, we do the following:
For each row present in the INSERTED table, we check if there are any rows in DELETED
tabled that has the same primary key as that of the row in INSERTED table. If such a
row does not exists, then it means that the primary key has been updated. The sample
SQL which does this looks like:
  SELECT * FROM INSERTED
  WHERE NOT EXISTS (SELECT * FROM DELETED WHERE  INSERTED.id = DELETED.id )

The spec for MSSQL UPDATE Event Trigger is as follows:
1. UPDATE Event Trigger can only be created on tables with a primary key.
2. When Primary Key is not updated during a UPDATE transaction then both 'data.new'
   and 'data.old' fields in payload will be constructed.
3. When Primary Key is updated during a UPDATE transaction then there are two cases:
    a. If the updated Primary key is equal to one of the already present primary key in
       the table then, we construct both the 'data.old' and 'data.new'
    b. If the updated primary key is not equal to any of the already present primary key
       in the table then, 'data.old' is NULL and only 'data.new' is constructed.
-}</span><span>
</span><span id="line-787"></span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkUpdateTriggerQuery"><span class="hs-identifier hs-type">mkUpdateTriggerQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerName"><span class="hs-identifier hs-type">TriggerName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Table.html#PrimaryKey"><span class="hs-identifier hs-type">PrimaryKey</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Column.html#ColumnInfo"><span class="hs-identifier hs-type">ColumnInfo</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LT.Text</span></span><span>
</span><span id="line-788"></span><span id="mkUpdateTriggerQuery"><span class="annot"><span class="annottext">mkUpdateTriggerQuery :: TableName
-&gt; TriggerName
-&gt; [ColumnInfo 'MSSQL]
-&gt; [ColumnInfo 'MSSQL]
-&gt; PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
-&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkUpdateTriggerQuery"><span class="hs-identifier hs-var hs-var">mkUpdateTriggerQuery</span></a></span></span><span>
</span><span id="line-789"></span><span>  </span><span id="local-6989586621689341635"><span class="annot"><span class="annottext">table :: TableName
</span><a href="#local-6989586621689341635"><span class="hs-identifier hs-var">table</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span id="local-6989586621689341634"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341634"><span class="hs-identifier hs-var">tableName</span></a></span></span><span> </span><span id="local-6989586621689341633"><span class="annot"><span class="annottext">schema :: SchemaName
</span><a href="#local-6989586621689341633"><span class="hs-identifier hs-var">schema</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Types.Internal.html#SchemaName"><span class="hs-identifier hs-type">SchemaName</span></a></span><span> </span><span id="local-6989586621689341632"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341632"><span class="hs-identifier hs-var">schemaName</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-790"></span><span>  </span><span id="local-6989586621689341631"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341631"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span>
</span><span id="line-791"></span><span>  </span><span id="local-6989586621689341630"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341630"><span class="hs-identifier hs-var">listenColumns</span></a></span></span><span>
</span><span id="line-792"></span><span>  </span><span id="local-6989586621689341629"><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341629"><span class="hs-identifier hs-var">deliveryColumns</span></a></span></span><span>
</span><span id="line-793"></span><span>  </span><span id="local-6989586621689341628"><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
</span><a href="#local-6989586621689341628"><span class="hs-identifier hs-var">primaryKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-794"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#QualifiedTriggerName"><span class="hs-identifier hs-type">QualifiedTriggerName</span></a></span><span> </span><span id="local-6989586621689341627"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341627"><span class="hs-identifier hs-var">qualifiedTriggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ops -&gt; SchemaName -&gt; TriggerName -&gt; QualifiedTriggerName
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#msssqlIdenTrigger"><span class="hs-identifier hs-var">msssqlIdenTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#UPDATE"><span class="hs-identifier hs-var">UPDATE</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621689341633"><span class="hs-identifier hs-var">schema</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341631"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-795"></span><span>        </span><span id="local-6989586621689341626"><span class="annot"><span class="annottext">triggerNameText :: Text
</span><a href="#local-6989586621689341626"><span class="hs-identifier hs-var hs-var">triggerNameText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621689341631"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-796"></span><span>        </span><span id="local-6989586621689341625"><span class="annot"><span class="annottext">qualifiedTableName :: Text
</span><a href="#local-6989586621689341625"><span class="hs-identifier hs-var hs-var">qualifiedTableName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TableName -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#qualifyTableName"><span class="hs-identifier hs-var">qualifyTableName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621689341635"><span class="hs-identifier hs-var">table</span></a></span><span>
</span><span id="line-797"></span><span>        </span><span id="local-6989586621689341624"><span class="annot"><span class="annottext">operation :: Text
</span><a href="#local-6989586621689341624"><span class="hs-identifier hs-var hs-var">operation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ops -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="Hasura.Prelude.html#tshow"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">Ops
</span><a href="Hasura.RQL.Types.EventTrigger.html#UPDATE"><span class="hs-identifier hs-var">UPDATE</span></a></span><span>
</span><span id="line-798"></span><span>
</span><span id="line-799"></span><span>        </span><span id="local-6989586621689341623"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341623"><span class="hs-identifier hs-var">oldDeliveryColsSQLExp</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; Text) -&gt; [Text] -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Text) -&gt; [ColumnInfo 'MSSQL] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var hs-var">unSQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLFragment -&gt; Text)
-&gt; (ColumnInfo 'MSSQL -&gt; SQLFragment) -&gt; ColumnInfo 'MSSQL -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">OpVar -&gt; Maybe Text -&gt; ColumnInfo 'MSSQL -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateColumnTriggerAlias"><span class="hs-identifier hs-var">generateColumnTriggerAlias</span></a></span><span> </span><span class="annot"><span class="annottext">OpVar
</span><a href="Hasura.RQL.Types.Eventing.html#OLD"><span class="hs-identifier hs-var">OLD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Maybe Text
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;DELETED&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341629"><span class="hs-identifier hs-var">deliveryColumns</span></a></span><span>
</span><span id="line-800"></span><span>        </span><span id="local-6989586621689341622"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341622"><span class="hs-identifier hs-var">newDeliveryColsSQLExp</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; Text) -&gt; [Text] -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Text) -&gt; [ColumnInfo 'MSSQL] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var hs-var">unSQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLFragment -&gt; Text)
-&gt; (ColumnInfo 'MSSQL -&gt; SQLFragment) -&gt; ColumnInfo 'MSSQL -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">OpVar -&gt; Maybe Text -&gt; ColumnInfo 'MSSQL -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateColumnTriggerAlias"><span class="hs-identifier hs-var">generateColumnTriggerAlias</span></a></span><span> </span><span class="annot"><span class="annottext">OpVar
</span><a href="Hasura.RQL.Types.Eventing.html#NEW"><span class="hs-identifier hs-var">NEW</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Maybe Text
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;INSERTED&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341629"><span class="hs-identifier hs-var">deliveryColumns</span></a></span><span>
</span><span id="line-801"></span><span>
</span><span id="line-802"></span><span>        </span><span class="hs-comment">-- When Primary key is updated, then 'data.old' would be NULL</span><span>
</span><span id="line-803"></span><span>        </span><span class="hs-comment">-- See Note [Update Event Trigger MSSQL Spec]</span><span>
</span><span id="line-804"></span><span>        </span><span id="local-6989586621689341621"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341621"><span class="hs-identifier hs-var">oldDeliveryColsSQLExpWhenPrimaryKeyUpdated</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-805"></span><span>          </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;NULL as [payload.data.old]&quot;</span></span><span>
</span><span id="line-806"></span><span>        </span><span id="local-6989586621689341620"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621689341620"><span class="hs-identifier hs-var">newDeliveryColsSQLExpWhenPrimaryKeyUpdated</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-807"></span><span>          </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; Text) -&gt; [Text] -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ColumnInfo 'MSSQL -&gt; Text) -&gt; [ColumnInfo 'MSSQL] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var hs-var">unSQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLFragment -&gt; Text)
-&gt; (ColumnInfo 'MSSQL -&gt; SQLFragment) -&gt; ColumnInfo 'MSSQL -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">OpVar -&gt; Maybe Text -&gt; ColumnInfo 'MSSQL -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#generateColumnTriggerAlias"><span class="hs-identifier hs-var">generateColumnTriggerAlias</span></a></span><span> </span><span class="annot"><span class="annottext">OpVar
</span><a href="Hasura.RQL.Types.Eventing.html#NEW"><span class="hs-identifier hs-var">NEW</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Maybe Text
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;INSERTED&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341629"><span class="hs-identifier hs-var">deliveryColumns</span></a></span><span>
</span><span id="line-808"></span><span>
</span><span id="line-809"></span><span>        </span><span id="local-6989586621689341619"><span class="annot"><span class="annottext">primaryKeyJoinExp :: Text
</span><a href="#local-6989586621689341619"><span class="hs-identifier hs-var hs-var">primaryKeyJoinExp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var hs-var">unSQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLFragment -&gt; Text) -&gt; SQLFragment -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; [ColumnInfo 'MSSQL] -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkPrimaryKeyJoinExp"><span class="hs-identifier hs-var">mkPrimaryKeyJoinExp</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;INSERTED&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;DELETED&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NESeq (ColumnInfo 'MSSQL) -&gt; [ColumnInfo 'MSSQL]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL) -&gt; NESeq (ColumnInfo 'MSSQL)
forall (b :: BackendType) a. PrimaryKey b a -&gt; NESeq a
</span><a href="Hasura.RQL.Types.Table.html#_pkColumns"><span class="hs-identifier hs-var hs-var">_pkColumns</span></a></span><span> </span><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
</span><a href="#local-6989586621689341628"><span class="hs-identifier hs-var">primaryKey</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-810"></span><span>        </span><span id="local-6989586621689341618"><span class="annot"><span class="annottext">listenColumnExp :: Text
</span><a href="#local-6989586621689341618"><span class="hs-identifier hs-var hs-var">listenColumnExp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var hs-var">unSQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLFragment -&gt; Text) -&gt; SQLFragment -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; [ColumnInfo 'MSSQL] -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#mkListenColumnsExp"><span class="hs-identifier hs-var">mkListenColumnsExp</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;INSERTED&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;DELETED&quot;</span></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341630"><span class="hs-identifier hs-var">listenColumns</span></a></span><span>
</span><span id="line-811"></span><span>        </span><span id="local-6989586621689341617"><span class="annot"><span class="annottext">isPrimaryKeyInListenColumnsExp :: Text
</span><a href="#local-6989586621689341617"><span class="hs-identifier hs-var hs-var">isPrimaryKeyInListenColumnsExp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SQLFragment -&gt; Text
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#unSQLFragment"><span class="hs-identifier hs-var hs-var">unSQLFragment</span></a></span><span> </span><span class="annot"><span class="annottext">(SQLFragment -&gt; Text) -&gt; SQLFragment -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
-&gt; PrimaryKey 'MSSQL (ColumnInfo 'MSSQL) -&gt; SQLFragment
</span><a href="Hasura.Backends.MSSQL.DDL.EventTrigger.html#isPrimaryKeyInListenColumns"><span class="hs-identifier hs-var">isPrimaryKeyInListenColumns</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo 'MSSQL]
</span><a href="#local-6989586621689341630"><span class="hs-identifier hs-var">listenColumns</span></a></span><span> </span><span class="annot"><span class="annottext">PrimaryKey 'MSSQL (ColumnInfo 'MSSQL)
</span><a href="#local-6989586621689341628"><span class="hs-identifier hs-var">primaryKey</span></a></span><span>
</span><span id="line-812"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">$(</span><span class="hs-identifier">makeRelativeToProject</span><span> </span><span class="hs-string">&quot;src-rsr/mssql/mssql_update_trigger.sql.shakespeare&quot;</span><span> </span><span class="hs-operator">&gt;&gt;=</span><span> </span><span class="hs-identifier">ST.stextFile</span><span class="hs-special">)</span><span>
</span><span id="line-813"></span></pre></body></html>