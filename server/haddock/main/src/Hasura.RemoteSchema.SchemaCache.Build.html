<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE Arrows #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hasura.RemoteSchema.SchemaCache.Build</span><span>
</span><span id="line-4"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Build.html#buildRemoteSchemas"><span class="hs-identifier">buildRemoteSchemas</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-5"></span><span>    </span><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Build.html#addRemoteSchemaP2Setup"><span class="hs-identifier">addRemoteSchemaP2Setup</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-6"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-7"></span><span class="hs-keyword">where</span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Control.Arrow.Extended.html"><span class="hs-identifier">Control.Arrow.Extended</span></a></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Control.Arrow.Interpret.html"><span class="hs-identifier">Control.Arrow.Interpret</span></a></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/bytestring-0.11.3.1/src"><span class="hs-identifier">Data.ByteString.Lazy</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BL</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Environment.html"><span class="hs-identifier">Data.Environment</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Env</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.HashMap.Strict.Extended.html"><span class="hs-identifier">Data.HashMap.Strict.Extended</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Text.Extended.html"><span class="hs-identifier">Data.Text.Extended</span></a></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.RemoteServer.html"><span class="hs-identifier">Hasura.GraphQL.RemoteServer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.RemoteServer.html#fetchRemoteSchema"><span class="hs-identifier">fetchRemoteSchema</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Incremental.html"><span class="hs-identifier">Hasura.Incremental</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Inc</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.2.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema.Cache.Common</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema.Cache.Permission</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html"><span class="hs-identifier">Hasura.RQL.Types.Metadata.Object</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Roles.html"><span class="hs-identifier">Hasura.RQL.Types.Roles</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Roles.Internal.html"><span class="hs-identifier">Hasura.RQL.Types.Roles.Internal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Roles.Internal.html#CheckPermission"><span class="hs-identifier">CheckPermission</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html"><span class="hs-identifier">Hasura.RQL.Types.SchemaCache</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html"><span class="hs-identifier">Hasura.RQL.Types.SchemaCache.Build</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.html"><span class="hs-identifier">Hasura.RemoteSchema.Metadata</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Permission.html"><span class="hs-identifier">Hasura.RemoteSchema.SchemaCache.Permission</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Permission.html#resolveRoleBasedRemoteSchema"><span class="hs-identifier">resolveRoleBasedRemoteSchema</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Types.html"><span class="hs-identifier">Hasura.RemoteSchema.SchemaCache.Types</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Session.html"><span class="hs-identifier">Hasura.Session</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Tracing.html"><span class="hs-identifier">Hasura.Tracing</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Tracing</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP.Client.Manager.html"><span class="hs-identifier">Network.HTTP.Client.Manager</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP.Client.Manager.html#HasHttpManagerM"><span class="hs-identifier">HasHttpManagerM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span class="hs-comment">-- Resolves a user specified `RemoteSchemaMetadata` into information rich `RemoteSchemaCtx`</span><span>
</span><span id="line-35"></span><span class="hs-comment">-- However, given the nature of remote relationships, we cannot fully 'resolve' them, so</span><span>
</span><span id="line-36"></span><span class="hs-comment">-- we resolve of remote relationships as much as possible.</span><span>
</span><span id="line-37"></span><span id="local-6989586621690456027"><span id="local-6989586621690456031"><span id="local-6989586621690456038"><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Build.html#buildRemoteSchemas"><span class="hs-identifier hs-type">buildRemoteSchemas</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-38"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">ArrowChoice</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690456038"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><a href="Hasura.Incremental.Internal.Rule.html#ArrowDistribute"><span class="hs-identifier hs-type">Inc.ArrowDistribute</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690456038"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><a href="Control.Arrow.Trans.html#ArrowWriter"><span class="hs-identifier hs-type">ArrowWriter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Seq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#InconsistentMetadata"><span class="hs-identifier hs-type">InconsistentMetadata</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#MetadataDependency"><span class="hs-identifier hs-type">MetadataDependency</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621690456038"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>    </span><span class="annot"><a href="Hasura.Incremental.Internal.Cache.html#ArrowCache"><span class="hs-identifier hs-type">Inc.ArrowCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690456031"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690456038"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span>    </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690456031"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-43"></span><span>    </span><span class="annot"><a href="Network.HTTP.Client.Manager.html#HasHttpManagerM"><span class="hs-identifier hs-type">HasHttpManagerM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690456031"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-44"></span><span>    </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690456027"><span class="hs-identifier hs-type">remoteRelationshipDefinition</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-45"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="annot"><a href="#local-6989586621690456027"><span class="hs-identifier hs-type">remoteRelationshipDefinition</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span>    </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/mtl-2.2.2/src"><span class="hs-identifier hs-type">MonadError</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690456031"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-47"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-48"></span><span>  </span><span class="annot"><a href="Data.Environment.html#Environment"><span class="hs-identifier hs-type">Env.Environment</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-49"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Incremental.Internal.Dependency.html#Dependency"><span class="hs-identifier hs-type">Inc.Dependency</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.Base.html#RemoteSchemaName"><span class="hs-identifier hs-type">RemoteSchemaName</span></a></span><span> </span><span class="annot"><a href="Hasura.Incremental.html#InvalidationKey"><span class="hs-identifier hs-type">Inc.InvalidationKey</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#OrderedRoles"><span class="hs-identifier hs-type">OrderedRoles</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-50"></span><span>    </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.Core.html#RemoteSchemaMetadataG"><span class="hs-identifier hs-type">RemoteSchemaMetadataG</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690456027"><span class="hs-identifier hs-type">remoteRelationshipDefinition</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-51"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span>    </span><span class="annot"><a href="#local-6989586621690456038"><span class="hs-operator hs-type">`arr`</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.Base.html#RemoteSchemaName"><span class="hs-identifier hs-type">RemoteSchemaName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Types.html#PartiallyResolvedRemoteSchemaCtxG"><span class="hs-identifier hs-type">PartiallyResolvedRemoteSchemaCtxG</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690456027"><span class="hs-identifier hs-type">remoteRelationshipDefinition</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-type">MetadataObject</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-53"></span><span id="buildRemoteSchemas"><span class="annot"><span class="annottext">buildRemoteSchemas :: forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *)
       remoteRelationshipDefinition.
(ArrowChoice arr, ArrowDistribute arr,
 ArrowWriter
   (Seq (Either InconsistentMetadata MetadataDependency)) arr,
 ArrowCache m arr, MonadIO m, HasHttpManagerM m,
 Eq remoteRelationshipDefinition,
 ToJSON remoteRelationshipDefinition, MonadError QErr m) =&gt;
Environment
-&gt; arr
     ((Dependency (HashMap RemoteSchemaName InvalidationKey),
       OrderedRoles),
      [RemoteSchemaMetadataG remoteRelationshipDefinition])
     (HashMap
        RemoteSchemaName
        (PartiallyResolvedRemoteSchemaCtxG remoteRelationshipDefinition,
         MetadataObject))
</span><a href="Hasura.RemoteSchema.SchemaCache.Build.html#buildRemoteSchemas"><span class="hs-identifier hs-var hs-var">buildRemoteSchemas</span></a></span></span><span> </span><span id="local-6989586621690455704"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621690455704"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-54"></span><span>  </span><span class="annot"><span class="annottext">forall (arr :: * -&gt; * -&gt; *) md k a e b.
(ArrowChoice arr, ArrowDistribute arr,
 ArrowWriter (Seq (Either InconsistentMetadata md)) arr,
 Hashable k) =&gt;
(a -&gt; k)
-&gt; (a -&gt; MetadataObject)
-&gt; arr (e, a) (Maybe b)
-&gt; arr (e, [a]) (HashMap k (b, MetadataObject))
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#buildInfoMapPreservingMetadata"><span class="hs-identifier hs-var">buildInfoMapPreservingMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">forall r. RemoteSchemaMetadataG r -&gt; RemoteSchemaName
</span><a href="Hasura.RemoteSchema.Metadata.Core.html#_rsmName"><span class="hs-identifier hs-var">_rsmName</span></a></span><span> </span><span class="annot"><span class="annottext">forall {r}. ToJSON r =&gt; RemoteSchemaMetadataG r -&gt; MetadataObject
</span><a href="#local-6989586621690455701"><span class="hs-identifier hs-var">mkRemoteSchemaMetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">arr
  ((Dependency (HashMap RemoteSchemaName InvalidationKey),
    OrderedRoles),
   RemoteSchemaMetadataG remoteRelationshipDefinition)
  (Maybe
     (RemoteSchemaCtxG
        (PartiallyResolvedRemoteRelationship
           remoteRelationshipDefinition)))
</span><a href="#local-6989586621690455700"><span class="hs-identifier hs-var">buildRemoteSchema</span></a></span><span>
</span><span id="line-55"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-56"></span><span>    </span><span class="hs-comment">-- We want to cache this call because it fetches the remote schema over</span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-comment">-- HTTP, and we don&#8217;t want to re-run that if the remote schema definition</span><span>
</span><span id="line-58"></span><span>    </span><span class="hs-comment">-- hasn&#8217;t changed.</span><span>
</span><span id="line-59"></span><span>    </span><span id="local-6989586621690455700"><span class="annot"><span class="annottext">buildRemoteSchema :: arr
  ((Dependency (HashMap RemoteSchemaName InvalidationKey),
    OrderedRoles),
   RemoteSchemaMetadataG remoteRelationshipDefinition)
  (Maybe
     (RemoteSchemaCtxG
        (PartiallyResolvedRemoteRelationship
           remoteRelationshipDefinition)))
</span><a href="#local-6989586621690455700"><span class="hs-identifier hs-var hs-var">buildRemoteSchema</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a b.
(ArrowCache m arr, Given Accesses =&gt; Eq a) =&gt;
arr a b -&gt; arr a b
</span><a href="Hasura.Incremental.Internal.Cache.html#cache"><span class="hs-identifier hs-var">Inc.cache</span></a></span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621690455698"><span class="annot"><span class="annottext">Dependency (HashMap RemoteSchemaName InvalidationKey)
</span><a href="#local-6989586621690455698"><span class="hs-identifier hs-var">invalidationKeys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621690455697"><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621690455697"><span class="hs-identifier hs-var">orderedRoles</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621690455696"><span class="annot"><span class="annottext">remoteSchema :: RemoteSchemaMetadataG remoteRelationshipDefinition
</span><a href="#local-6989586621690455696"><span class="hs-identifier hs-var">remoteSchema</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.Core.html#RemoteSchemaMetadata"><span class="hs-identifier hs-type">RemoteSchemaMetadata</span></a></span><span> </span><span id="local-6989586621690455694"><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621690455694"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621690455693"><span class="annot"><span class="annottext">RemoteSchemaDef
</span><a href="#local-6989586621690455693"><span class="hs-identifier hs-var">defn</span></a></span></span><span> </span><span id="local-6989586621690455692"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621690455692"><span class="hs-identifier hs-var">_comment</span></a></span></span><span> </span><span id="local-6989586621690455691"><span class="annot"><span class="annottext">[RemoteSchemaPermissionMetadata]
</span><a href="#local-6989586621690455691"><span class="hs-identifier hs-var">permissions</span></a></span></span><span> </span><span id="local-6989586621690455690"><span class="annot"><span class="annottext">SchemaRemoteRelationships remoteRelationshipDefinition
</span><a href="#local-6989586621690455690"><span class="hs-identifier hs-var">relationships</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-60"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
(ArrowCache m arr, Eq a) =&gt;
arr (Dependency a) a
</span><a href="Hasura.Incremental.Internal.Cache.html#dependOn"><span class="hs-identifier hs-var">Inc.dependOn</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">forall a k v.
(Select a, Selector a ~ ConstS k v) =&gt;
k -&gt; Dependency a -&gt; Dependency v
</span><a href="Hasura.Incremental.Internal.Dependency.html#selectKeyD"><span class="hs-identifier hs-var">Inc.selectKeyD</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621690455694"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Dependency (HashMap RemoteSchemaName InvalidationKey)
</span><a href="#local-6989586621690455698"><span class="hs-identifier hs-var">invalidationKeys</span></a></span><span>
</span><span id="line-61"></span><span>      </span><span id="local-6989586621690455687"><span class="annot"><span class="annottext">Maybe (IntrospectionResult, ByteString, RemoteSchemaInfo)
</span><a href="#local-6989586621690455687"><span class="hs-identifier hs-var">remoteSchemaContextParts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-62"></span><span>        </span><span class="hs-glyph">(|</span><span>
</span><span id="line-63"></span><span>          </span><span class="annot"><span class="annottext">forall (arr :: * -&gt; * -&gt; *) md e s a.
(ArrowChoice arr,
 ArrowWriter (Seq (Either InconsistentMetadata md)) arr) =&gt;
ErrorA QErr arr (e, s) a -&gt; arr (e, (MetadataObject, s)) (Maybe a)
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#withRecordInconsistency"><span class="hs-identifier hs-var">withRecordInconsistency</span></a></span><span>
</span><span id="line-64"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">forall (arr :: * -&gt; * -&gt; *) e a.
(ArrowChoice arr, ArrowError e arr) =&gt;
arr (Either e a) a
</span><a href="Control.Arrow.Trans.html#liftEitherA"><span class="hs-identifier hs-var">liftEitherA</span></a></span><span> </span><span class="annot"><span class="annottext">forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;&lt;&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
ArrowKleisli m arr =&gt;
arr (m a) a
</span><a href="Control.Arrow.Extended.html#bindA"><span class="hs-identifier hs-var">bindA</span></a></span><span>
</span><span id="line-65"></span><span>                </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-66"></span><span>                  </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/transformers-0.5.6.2/src"><span class="hs-identifier hs-var">runExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. TraceT (ExceptT QErr m) a -&gt; ExceptT QErr m a
</span><a href="#local-6989586621690455679"><span class="hs-identifier hs-var">noopTrace</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(QErrM m, MonadIO m, HasHttpManagerM m, MonadTrace m) =&gt;
Environment
-&gt; RemoteSchemaName
-&gt; RemoteSchemaDef
-&gt; m (IntrospectionResult, ByteString, RemoteSchemaInfo)
</span><a href="Hasura.RemoteSchema.SchemaCache.Build.html#addRemoteSchemaP2Setup"><span class="hs-identifier hs-var">addRemoteSchemaP2Setup</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621690455704"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621690455694"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaDef
</span><a href="#local-6989586621690455693"><span class="hs-identifier hs-var">defn</span></a></span><span>
</span><span id="line-67"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span>          </span><span class="hs-glyph">|)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall {r}. ToJSON r =&gt; RemoteSchemaMetadataG r -&gt; MetadataObject
</span><a href="#local-6989586621690455701"><span class="hs-identifier hs-var">mkRemoteSchemaMetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaMetadataG remoteRelationshipDefinition
</span><a href="#local-6989586621690455696"><span class="hs-identifier hs-var">remoteSchema</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (IntrospectionResult, ByteString, RemoteSchemaInfo)
</span><a href="#local-6989586621690455687"><span class="hs-identifier hs-var">remoteSchemaContextParts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-70"></span><span>        </span><span class="annot"><span class="annottext">Maybe (IntrospectionResult, ByteString, RemoteSchemaInfo)
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">returnA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-71"></span><span>        </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621690455677"><span class="annot"><span class="annottext">IntrospectionResult
</span><a href="#local-6989586621690455677"><span class="hs-identifier hs-var">introspection</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621690455676"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621690455676"><span class="hs-identifier hs-var">rawIntrospection</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621690455675"><span class="annot"><span class="annottext">RemoteSchemaInfo
</span><a href="#local-6989586621690455675"><span class="hs-identifier hs-var">remoteSchemaInfo</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-72"></span><span>          </span><span class="hs-comment">-- we then resolve permissions</span><span>
</span><span id="line-73"></span><span>          </span><span id="local-6989586621690455674"><span class="annot"><span class="annottext">HashMap RoleName IntrospectionResult
</span><a href="#local-6989586621690455674"><span class="hs-identifier hs-var">resolvedPermissions</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowDistribute arr,
 ArrowWriter
   (Seq (Either InconsistentMetadata MetadataDependency)) arr,
 ArrowCache m arr, MonadError QErr m) =&gt;
arr
  ((RemoteSchemaName, IntrospectionResult, OrderedRoles),
   [(RemoteSchemaName, RemoteSchemaPermissionMetadata)])
  (HashMap RoleName IntrospectionResult)
</span><a href="Hasura.RemoteSchema.SchemaCache.Build.html#buildRemoteSchemaPermissions"><span class="hs-identifier hs-var">buildRemoteSchemaPermissions</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621690455694"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IntrospectionResult
</span><a href="#local-6989586621690455677"><span class="hs-identifier hs-var">introspection</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621690455697"><span class="hs-identifier hs-var">orderedRoles</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621690455694"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[RemoteSchemaPermissionMetadata]
</span><a href="#local-6989586621690455691"><span class="hs-identifier hs-var">permissions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span>          </span><span class="hs-comment">-- resolve remote relationships</span><span>
</span><span id="line-75"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690455672"><span class="annot"><span class="annottext">transformedRelationships :: InsOrdHashMap
  Name
  (InsOrdHashMap
     RelName
     (PartiallyResolvedRemoteRelationship remoteRelationshipDefinition))
</span><a href="#local-6989586621690455672"><span class="hs-identifier hs-var hs-var">transformedRelationships</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaRemoteRelationships remoteRelationshipDefinition
</span><a href="#local-6989586621690455690"><span class="hs-identifier hs-var">relationships</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.RemoteRelationship.html#RemoteSchemaTypeRelationships"><span class="hs-identifier hs-type">RemoteSchemaTypeRelationships</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621690455668"><span id="local-6989586621690455669"><span class="annot"><span class="annottext">Name
RemoteRelationships remoteRelationshipDefinition
_rstrsRelationships :: forall r. RemoteSchemaTypeRelationships r -&gt; RemoteRelationships r
_rstrsName :: forall r. RemoteSchemaTypeRelationships r -&gt; Name
_rstrsRelationships :: RemoteRelationships remoteRelationshipDefinition
_rstrsName :: Name
</span><a href="Hasura.RemoteSchema.Metadata.RemoteRelationship.html#_rstrsRelationships"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall remoteRelationshipDefinition.
Name
-&gt; RemoteRelationshipG remoteRelationshipDefinition
-&gt; PartiallyResolvedRemoteRelationship remoteRelationshipDefinition
</span><a href="Hasura.RemoteSchema.SchemaCache.Types.html#PartiallyResolvedRemoteRelationship"><span class="hs-identifier hs-var">PartiallyResolvedRemoteRelationship</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621690455669"><span class="hs-identifier hs-var">_rstrsName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">RemoteRelationships remoteRelationshipDefinition
</span><a href="#local-6989586621690455668"><span class="hs-identifier hs-var">_rstrsRelationships</span></a></span><span>
</span><span id="line-76"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690455664"><span class="annot"><span class="annottext">remoteSchemaContext :: RemoteSchemaCtxG
  (PartiallyResolvedRemoteRelationship remoteRelationshipDefinition)
</span><a href="#local-6989586621690455664"><span class="hs-identifier hs-var hs-var">remoteSchemaContext</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-77"></span><span>                </span><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Types.html#RemoteSchemaCtx"><span class="hs-identifier hs-type">RemoteSchemaCtx</span></a></span><span>
</span><span id="line-78"></span><span>                  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_rscName :: RemoteSchemaName
</span><a href="Hasura.RemoteSchema.SchemaCache.Types.html#_rscName"><span class="hs-identifier hs-var">_rscName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621690455694"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-79"></span><span>                    </span><span class="annot"><span class="annottext">_rscIntroOriginal :: IntrospectionResult
</span><a href="Hasura.RemoteSchema.SchemaCache.Types.html#_rscIntroOriginal"><span class="hs-identifier hs-var">_rscIntroOriginal</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntrospectionResult
</span><a href="#local-6989586621690455677"><span class="hs-identifier hs-var">introspection</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-80"></span><span>                    </span><span class="annot"><span class="annottext">_rscInfo :: RemoteSchemaInfo
</span><a href="Hasura.RemoteSchema.SchemaCache.Types.html#_rscInfo"><span class="hs-identifier hs-var">_rscInfo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaInfo
</span><a href="#local-6989586621690455675"><span class="hs-identifier hs-var">remoteSchemaInfo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-81"></span><span>                    </span><span class="annot"><span class="annottext">_rscRawIntrospectionResult :: ByteString
</span><a href="Hasura.RemoteSchema.SchemaCache.Types.html#_rscRawIntrospectionResult"><span class="hs-identifier hs-var">_rscRawIntrospectionResult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621690455676"><span class="hs-identifier hs-var">rawIntrospection</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-82"></span><span>                    </span><span class="annot"><span class="annottext">_rscPermissions :: HashMap RoleName IntrospectionResult
</span><a href="Hasura.RemoteSchema.SchemaCache.Types.html#_rscPermissions"><span class="hs-identifier hs-var">_rscPermissions</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashMap RoleName IntrospectionResult
</span><a href="#local-6989586621690455674"><span class="hs-identifier hs-var">resolvedPermissions</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-83"></span><span>                    </span><span class="annot"><span class="annottext">_rscRemoteRelationships :: InsOrdHashMap
  Name
  (InsOrdHashMap
     RelName
     (PartiallyResolvedRemoteRelationship remoteRelationshipDefinition))
</span><a href="Hasura.RemoteSchema.SchemaCache.Types.html#_rscRemoteRelationships"><span class="hs-identifier hs-var">_rscRemoteRelationships</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InsOrdHashMap
  Name
  (InsOrdHashMap
     RelName
     (PartiallyResolvedRemoteRelationship remoteRelationshipDefinition))
</span><a href="#local-6989586621690455672"><span class="hs-identifier hs-var">transformedRelationships</span></a></span><span>
</span><span id="line-84"></span><span>                  </span><span class="hs-special">}</span><span>
</span><span id="line-85"></span><span>          </span><span class="annot"><span class="annottext">forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">returnA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaCtxG
  (PartiallyResolvedRemoteRelationship remoteRelationshipDefinition)
</span><a href="#local-6989586621690455664"><span class="hs-identifier hs-var">remoteSchemaContext</span></a></span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span>    </span><span class="hs-comment">-- TODO continue propagating MonadTrace up calls so that we can get tracing</span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-comment">-- for remote schema introspection. This will require modifying CacheBuild.</span><span>
</span><span id="line-89"></span><span>    </span><span id="local-6989586621690455679"><span class="annot"><span class="annottext">noopTrace :: TraceT (ExceptT QErr m) a -&gt; ExceptT QErr m a
</span><a href="#local-6989586621690455679"><span class="hs-identifier hs-var hs-var">noopTrace</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
MonadIO m =&gt;
Reporter -&gt; SamplingPolicy -&gt; Text -&gt; TraceT m a -&gt; m a
</span><a href="Hasura.Tracing.html#runTraceTWithReporter"><span class="hs-identifier hs-var">Tracing.runTraceTWithReporter</span></a></span><span> </span><span class="annot"><span class="annottext">Reporter
</span><a href="Hasura.Tracing.html#noReporter"><span class="hs-identifier hs-var">Tracing.noReporter</span></a></span><span> </span><span class="annot"><span class="annottext">SamplingPolicy
</span><a href="Hasura.Tracing.html#sampleNever"><span class="hs-identifier hs-var">Tracing.sampleNever</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;buildSchemaCacheRule&quot;</span></span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span>    </span><span id="local-6989586621690455701"><span class="annot"><span class="annottext">mkRemoteSchemaMetadataObject :: RemoteSchemaMetadataG r -&gt; MetadataObject
</span><a href="#local-6989586621690455701"><span class="hs-identifier hs-var hs-var">mkRemoteSchemaMetadataObject</span></a></span></span><span> </span><span id="local-6989586621690455644"><span class="annot"><span class="annottext">RemoteSchemaMetadataG r
</span><a href="#local-6989586621690455644"><span class="hs-identifier hs-var">remoteSchema</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-92"></span><span>      </span><span class="annot"><span class="annottext">MetadataObjId -&gt; Value -&gt; MetadataObject
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-var">MetadataObject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteSchemaName -&gt; MetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MORemoteSchema"><span class="hs-identifier hs-var">MORemoteSchema</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall r. RemoteSchemaMetadataG r -&gt; RemoteSchemaName
</span><a href="Hasura.RemoteSchema.Metadata.Core.html#_rsmName"><span class="hs-identifier hs-var">_rsmName</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaMetadataG r
</span><a href="#local-6989586621690455644"><span class="hs-identifier hs-var">remoteSchema</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaMetadataG r
</span><a href="#local-6989586621690455644"><span class="hs-identifier hs-var">remoteSchema</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span>
</span><span id="line-94"></span><span class="hs-comment">-- | Resolves a RemoteSchemaPermission metadata object into a 'GraphQL schema'.</span><span>
</span><span id="line-95"></span><span id="local-6989586621690455911"><span id="local-6989586621690455912"><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Build.html#buildRemoteSchemaPermissions"><span class="hs-identifier hs-type">buildRemoteSchemaPermissions</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">ArrowChoice</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690455912"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-97"></span><span>    </span><span class="annot"><a href="Hasura.Incremental.Internal.Rule.html#ArrowDistribute"><span class="hs-identifier hs-type">Inc.ArrowDistribute</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690455912"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-98"></span><span>    </span><span class="annot"><a href="Control.Arrow.Trans.html#ArrowWriter"><span class="hs-identifier hs-type">ArrowWriter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Seq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#InconsistentMetadata"><span class="hs-identifier hs-type">InconsistentMetadata</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#MetadataDependency"><span class="hs-identifier hs-type">MetadataDependency</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621690455912"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-99"></span><span>    </span><span class="annot"><a href="Hasura.Incremental.Internal.Cache.html#ArrowCache"><span class="hs-identifier hs-type">Inc.ArrowCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690455911"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690455912"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-100"></span><span>    </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/mtl-2.2.2/src"><span class="hs-identifier hs-type">MonadError</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690455911"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-comment">-- this ridiculous duplication of [(RemoteSchemaName, RemoteSchemaPermissionMetadata)]</span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-comment">-- instead of just [RemoteSchemaName] is because buildInfoMap doesn't pass `e` to the</span><span>
</span><span id="line-104"></span><span>  </span><span class="hs-comment">-- mkMetadataObject function. However, that change is very invasive.</span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.Base.html#RemoteSchemaName"><span class="hs-identifier hs-type">RemoteSchemaName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Types.html#IntrospectionResult"><span class="hs-identifier hs-type">IntrospectionResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#OrderedRoles"><span class="hs-identifier hs-type">OrderedRoles</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.Base.html#RemoteSchemaName"><span class="hs-identifier hs-type">RemoteSchemaName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.Permission.html#RemoteSchemaPermissionMetadata"><span class="hs-identifier hs-type">RemoteSchemaPermissionMetadata</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621690455912"><span class="hs-operator hs-type">`arr`</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.HashMap</span></span><span> </span><span class="annot"><a href="Hasura.Session.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span> </span><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Types.html#IntrospectionResult"><span class="hs-identifier hs-type">IntrospectionResult</span></a></span></span></span><span>
</span><span id="line-106"></span><span id="buildRemoteSchemaPermissions"><span class="annot"><span class="annottext">buildRemoteSchemaPermissions :: forall (arr :: * -&gt; * -&gt; *) (m :: * -&gt; *).
(ArrowChoice arr, ArrowDistribute arr,
 ArrowWriter
   (Seq (Either InconsistentMetadata MetadataDependency)) arr,
 ArrowCache m arr, MonadError QErr m) =&gt;
arr
  ((RemoteSchemaName, IntrospectionResult, OrderedRoles),
   [(RemoteSchemaName, RemoteSchemaPermissionMetadata)])
  (HashMap RoleName IntrospectionResult)
</span><a href="Hasura.RemoteSchema.SchemaCache.Build.html#buildRemoteSchemaPermissions"><span class="hs-identifier hs-var hs-var">buildRemoteSchemaPermissions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621690455565"><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621690455565"><span class="hs-identifier hs-var">remoteSchemaName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621690455564"><span class="annot"><span class="annottext">IntrospectionResult
</span><a href="#local-6989586621690455564"><span class="hs-identifier hs-var">originalIntrospection</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621690455563"><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621690455563"><span class="hs-identifier hs-var">orderedRoles</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621690455562"><span class="annot"><span class="annottext">[(RemoteSchemaName, RemoteSchemaPermissionMetadata)]
</span><a href="#local-6989586621690455562"><span class="hs-identifier hs-var">permissions</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-107"></span><span>  </span><span id="local-6989586621690455561"><span class="annot"><span class="annottext">HashMap RoleName IntrospectionResult
</span><a href="#local-6989586621690455561"><span class="hs-identifier hs-var">metadataPermissionsMap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-108"></span><span>    </span><span class="annot"><span class="annottext">forall (arr :: * -&gt; * -&gt; *) md k a e b.
(ArrowChoice arr, ArrowDistribute arr,
 ArrowWriter (Seq (Either InconsistentMetadata md)) arr,
 Hashable k) =&gt;
(a -&gt; k)
-&gt; (a -&gt; MetadataObject)
-&gt; arr (e, a) (Maybe b)
-&gt; arr (e, [a]) (HashMap k b)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#buildInfoMap"><span class="hs-identifier hs-var">buildInfoMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteSchemaPermissionMetadata -&gt; RoleName
</span><a href="Hasura.RemoteSchema.Metadata.Permission.html#_rspmRole"><span class="hs-identifier hs-var">_rspmRole</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">snd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RemoteSchemaName, RemoteSchemaPermissionMetadata)
-&gt; MetadataObject
</span><a href="#local-6989586621690455557"><span class="hs-identifier hs-var">mkRemoteSchemaPermissionMetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">arr
  (IntrospectionResult,
   (RemoteSchemaName, RemoteSchemaPermissionMetadata))
  (Maybe IntrospectionResult)
</span><a href="#local-6989586621690455556"><span class="hs-identifier hs-var">buildRemoteSchemaPermission</span></a></span><span>
</span><span id="line-109"></span><span>      </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-110"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntrospectionResult
</span><a href="#local-6989586621690455564"><span class="hs-identifier hs-var">originalIntrospection</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(RemoteSchemaName, RemoteSchemaPermissionMetadata)]
</span><a href="#local-6989586621690455562"><span class="hs-identifier hs-var">permissions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span>  </span><span class="hs-comment">-- convert to the intermediate form `CheckPermission` whose `Semigroup`</span><span>
</span><span id="line-112"></span><span>  </span><span class="hs-comment">-- instance is used to combine permissions</span><span>
</span><span id="line-113"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690455555"><span class="annot"><span class="annottext">metadataCheckPermissionsMap :: HashMap RoleName (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621690455555"><span class="hs-identifier hs-var hs-var">metadataCheckPermissionsMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall permissionType.
permissionType -&gt; CheckPermission permissionType
</span><a href="Hasura.RQL.Types.Roles.Internal.html#CPDefined"><span class="hs-identifier hs-var">CPDefined</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName IntrospectionResult
</span><a href="#local-6989586621690455561"><span class="hs-identifier hs-var">metadataPermissionsMap</span></a></span><span>
</span><span id="line-114"></span><span>  </span><span id="local-6989586621690455552"><span class="annot"><span class="annottext">HashMap RoleName (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621690455552"><span class="hs-identifier hs-var">allRolesUnresolvedPermissionsMap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-115"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
ArrowKleisli m arr =&gt;
arr (m a) a
</span><a href="Control.Arrow.Extended.html#bindA"><span class="hs-identifier hs-var">bindA</span></a></span><span>
</span><span id="line-116"></span><span>      </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-117"></span><span>        </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">foldM</span></a></span><span>
</span><span id="line-118"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621690455550"><span class="annot"><span class="annottext">HashMap RoleName (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621690455550"><span class="hs-identifier hs-var">accumulatedRolePermMap</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span id="local-6989586621690455548"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621690455548"><span class="hs-identifier hs-var">roleName</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Roles.html#ParentRoles"><span class="hs-identifier hs-type">ParentRoles</span></a></span><span> </span><span id="local-6989586621690455546"><span class="annot"><span class="annottext">HashSet RoleName
</span><a href="#local-6989586621690455546"><span class="hs-identifier hs-var">parentRoles</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-119"></span><span>              </span><span id="local-6989586621690455545"><span class="annot"><span class="annottext">CheckPermission IntrospectionResult
</span><a href="#local-6989586621690455545"><span class="hs-identifier hs-var">rolePermission</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; m a -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.2.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">onNothing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621690455548"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621690455550"><span class="hs-identifier hs-var">accumulatedRolePermMap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-120"></span><span>                </span><span id="local-6989586621690455542"><span class="annot"><span class="annottext">[CheckPermission IntrospectionResult]
</span><a href="#local-6989586621690455542"><span class="hs-identifier hs-var">parentRolePermissions</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-121"></span><span>                  </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f (t b)
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">for</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">toList</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet RoleName
</span><a href="#local-6989586621690455546"><span class="hs-identifier hs-var">parentRoles</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621690455539"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621690455539"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-122"></span><span>                    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; m a -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.2.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">onNothing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621690455539"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621690455550"><span class="hs-identifier hs-var">accumulatedRolePermMap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-123"></span><span>                      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw500"><span class="hs-identifier hs-var">throw500</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-124"></span><span>                        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;remote schema permissions: bad ordering of roles, could not find the permission of role: &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall t. ToTxt t =&gt; Text -&gt; t -&gt; Text
</span><a href="Data.Text.Extended.html#%3C%3E%3E"><span class="hs-operator hs-var">&lt;&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621690455539"><span class="hs-keyword hs-var">role</span></a></span><span>
</span><span id="line-125"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690455536"><span class="annot"><span class="annottext">combinedPermission :: Maybe (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621690455536"><span class="hs-identifier hs-var hs-var">combinedPermission</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; NonEmpty a -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">sconcat</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; Maybe (NonEmpty a)
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">nonEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">[CheckPermission IntrospectionResult]
</span><a href="#local-6989586621690455542"><span class="hs-identifier hs-var">parentRolePermissions</span></a></span><span>
</span><span id="line-126"></span><span>                </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">forall permissionType. CheckPermission permissionType
</span><a href="Hasura.RQL.Types.Roles.Internal.html#CPUndefined"><span class="hs-identifier hs-var">CPUndefined</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621690455536"><span class="hs-identifier hs-var">combinedPermission</span></a></span><span>
</span><span id="line-127"></span><span>              </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621690455548"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">CheckPermission IntrospectionResult
</span><a href="#local-6989586621690455545"><span class="hs-identifier hs-var">rolePermission</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621690455550"><span class="hs-identifier hs-var">accumulatedRolePermMap</span></a></span><span>
</span><span id="line-128"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span>          </span><span class="annot"><span class="annottext">HashMap RoleName (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621690455555"><span class="hs-identifier hs-var">metadataCheckPermissionsMap</span></a></span><span>
</span><span id="line-130"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrderedRoles -&gt; [Role]
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#_unOrderedRoles"><span class="hs-identifier hs-var">_unOrderedRoles</span></a></span><span> </span><span class="annot"><span class="annottext">OrderedRoles
</span><a href="#local-6989586621690455563"><span class="hs-identifier hs-var">orderedRoles</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-131"></span><span>  </span><span class="hs-comment">-- traverse through `allRolesUnresolvedPermissionsMap` to record any inconsistencies (if exists)</span><span>
</span><span id="line-132"></span><span>  </span><span id="local-6989586621690455529"><span class="annot"><span class="annottext">[(RoleName, Maybe IntrospectionResult)]
</span><a href="#local-6989586621690455529"><span class="hs-identifier hs-var">resolvedPermissions</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-133"></span><span>    </span><span class="annot"><span class="annottext">forall w (arr :: * -&gt; * -&gt; *) a.
ArrowWriter w arr =&gt;
arr (Writer w a) a
</span><a href="Control.Arrow.Interpret.html#interpretWriter"><span class="hs-identifier hs-var">interpretWriter</span></a></span><span>
</span><span id="line-134"></span><span>      </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f (t b)
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">for</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall k v. HashMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">HashMap RoleName (CheckPermission IntrospectionResult)
</span><a href="#local-6989586621690455552"><span class="hs-identifier hs-var">allRolesUnresolvedPermissionsMap</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621690455526"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621690455526"><span class="hs-identifier hs-var">roleName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621690455525"><span class="annot"><span class="annottext">CheckPermission IntrospectionResult
</span><a href="#local-6989586621690455525"><span class="hs-identifier hs-var">checkPermission</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-135"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690455524"><span class="annot"><span class="annottext">inconsistentRoleEntity :: InconsistentRoleEntity
</span><a href="#local-6989586621690455524"><span class="hs-identifier hs-var hs-var">inconsistentRoleEntity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName -&gt; InconsistentRoleEntity
</span><a href="Hasura.RQL.Types.Metadata.Object.html#InconsistentRemoteSchemaPermission"><span class="hs-identifier hs-var">InconsistentRemoteSchemaPermission</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621690455565"><span class="hs-identifier hs-var">remoteSchemaName</span></a></span><span>
</span><span id="line-136"></span><span>        </span><span id="local-6989586621690455522"><span class="annot"><span class="annottext">Maybe IntrospectionResult
</span><a href="#local-6989586621690455522"><span class="hs-identifier hs-var">resolvedCheckPermission</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall md (m :: * -&gt; *) p.
MonadWriter (Seq (Either InconsistentMetadata md)) m =&gt;
CheckPermission p
-&gt; RoleName -&gt; InconsistentRoleEntity -&gt; m (Maybe p)
</span><a href="Hasura.RQL.DDL.Schema.Cache.Permission.html#resolveCheckPermission"><span class="hs-identifier hs-var">resolveCheckPermission</span></a></span><span> </span><span class="annot"><span class="annottext">CheckPermission IntrospectionResult
</span><a href="#local-6989586621690455525"><span class="hs-identifier hs-var">checkPermission</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621690455526"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">InconsistentRoleEntity
</span><a href="#local-6989586621690455524"><span class="hs-identifier hs-var">inconsistentRoleEntity</span></a></span><span>
</span><span id="line-137"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621690455526"><span class="hs-identifier hs-var">roleName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe IntrospectionResult
</span><a href="#local-6989586621690455522"><span class="hs-identifier hs-var">resolvedCheckPermission</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-138"></span><span>  </span><span class="annot"><span class="annottext">forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">returnA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Filterable f =&gt; f (Maybe a) -&gt; f a
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall k v. (Eq k, Hashable k) =&gt; [(k, v)] -&gt; HashMap k v
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(RoleName, Maybe IntrospectionResult)]
</span><a href="#local-6989586621690455529"><span class="hs-identifier hs-var">resolvedPermissions</span></a></span><span>
</span><span id="line-139"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-140"></span><span>    </span><span id="local-6989586621690455556"><span class="annot"><span class="annottext">buildRemoteSchemaPermission :: arr
  (IntrospectionResult,
   (RemoteSchemaName, RemoteSchemaPermissionMetadata))
  (Maybe IntrospectionResult)
</span><a href="#local-6989586621690455556"><span class="hs-identifier hs-var hs-var">buildRemoteSchemaPermission</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span id="local-6989586621690455491"><span class="annot"><span class="annottext">IntrospectionResult
</span><a href="#local-6989586621690455491"><span class="hs-identifier hs-var">originalIntrospection</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621690455490"><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621690455490"><span class="hs-identifier hs-var">remoteSchemaName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621690455489"><span class="annot"><span class="annottext">RemoteSchemaPermissionMetadata
</span><a href="#local-6989586621690455489"><span class="hs-identifier hs-var">remoteSchemaPerm</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-141"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.Permission.html#RemoteSchemaPermissionMetadata"><span class="hs-identifier hs-type">RemoteSchemaPermissionMetadata</span></a></span><span> </span><span id="local-6989586621690455487"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621690455487"><span class="hs-identifier hs-var">roleName</span></a></span></span><span> </span><span id="local-6989586621690455486"><span class="annot"><span class="annottext">RemoteSchemaPermissionDefinition
</span><a href="#local-6989586621690455486"><span class="hs-identifier hs-var">defn</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaPermissionMetadata
</span><a href="#local-6989586621690455489"><span class="hs-identifier hs-var">remoteSchemaPerm</span></a></span><span>
</span><span id="line-142"></span><span>          </span><span id="local-6989586621690455485"><span class="annot"><span class="annottext">metadataObject :: MetadataObject
</span><a href="#local-6989586621690455485"><span class="hs-identifier hs-var hs-var">metadataObject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RemoteSchemaName, RemoteSchemaPermissionMetadata)
-&gt; MetadataObject
</span><a href="#local-6989586621690455557"><span class="hs-identifier hs-var">mkRemoteSchemaPermissionMetadataObject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621690455490"><span class="hs-identifier hs-var">remoteSchemaName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaPermissionMetadata
</span><a href="#local-6989586621690455489"><span class="hs-identifier hs-var">remoteSchemaPerm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-143"></span><span>          </span><span id="local-6989586621690455484"><span class="annot"><span class="annottext">schemaObject :: SchemaObjId
</span><a href="#local-6989586621690455484"><span class="hs-identifier hs-var hs-var">schemaObject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName -&gt; RoleName -&gt; SchemaObjId
</span><a href="Hasura.RQL.Types.SchemaCacheTypes.html#SORemoteSchemaPermission"><span class="hs-identifier hs-var">SORemoteSchemaPermission</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621690455490"><span class="hs-identifier hs-var">remoteSchemaName</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621690455487"><span class="hs-identifier hs-var">roleName</span></a></span><span>
</span><span id="line-144"></span><span>          </span><span id="local-6989586621690455482"><span class="annot"><span class="annottext">providedSchemaDoc :: SchemaDocument
</span><a href="#local-6989586621690455482"><span class="hs-identifier hs-var hs-var">providedSchemaDoc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaPermissionDefinition -&gt; SchemaDocument
</span><a href="Hasura.RemoteSchema.Metadata.Permission.html#_rspdSchema"><span class="hs-identifier hs-var">_rspdSchema</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaPermissionDefinition
</span><a href="#local-6989586621690455486"><span class="hs-identifier hs-var">defn</span></a></span><span>
</span><span id="line-145"></span><span>          </span><span id="local-6989586621690455480"><span class="annot"><span class="annottext">addPermContext :: Text -&gt; Text
</span><a href="#local-6989586621690455480"><span class="hs-identifier hs-var hs-var">addPermContext</span></a></span></span><span> </span><span id="local-6989586621690455479"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621690455479"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;in remote schema permission for role &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621690455487"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;: &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621690455479"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-146"></span><span>      </span><span class="hs-glyph">(|</span><span>
</span><span id="line-147"></span><span>        </span><span class="annot"><span class="annottext">forall (arr :: * -&gt; * -&gt; *) md e s a.
(ArrowChoice arr,
 ArrowWriter (Seq (Either InconsistentMetadata md)) arr) =&gt;
ErrorA QErr arr (e, s) a -&gt; arr (e, (MetadataObject, s)) (Maybe a)
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#withRecordInconsistency"><span class="hs-identifier hs-var">withRecordInconsistency</span></a></span><span>
</span><span id="line-148"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-149"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621690455475"><span class="annot"><span class="annottext">IntrospectionResult
</span><a href="#local-6989586621690455475"><span class="hs-identifier hs-var">resolvedSchemaIntrospection</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621690455474"><span class="annot"><span class="annottext">SchemaDependency
</span><a href="#local-6989586621690455474"><span class="hs-keyword hs-var">dependency</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-150"></span><span>                </span><span class="annot"><span class="annottext">forall (arr :: * -&gt; * -&gt; *) e a.
(ArrowChoice arr, ArrowError e arr) =&gt;
arr (Either e a) a
</span><a href="Control.Arrow.Trans.html#liftEitherA"><span class="hs-identifier hs-var">liftEitherA</span></a></span><span> </span><span class="annot"><span class="annottext">forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;&lt;&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (arr :: * -&gt; * -&gt; *) a.
ArrowKleisli m arr =&gt;
arr (m a) a
</span><a href="Control.Arrow.Extended.html#bindA"><span class="hs-identifier hs-var">bindA</span></a></span><span>
</span><span id="line-151"></span><span>                  </span><span class="hs-glyph">-&lt;</span><span>
</span><span id="line-152"></span><span>                    </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/transformers-0.5.6.2/src"><span class="hs-identifier hs-var">runExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. QErrM m =&gt; (Text -&gt; Text) -&gt; m a -&gt; m a
</span><a href="Hasura.Base.Error.html#modifyErr"><span class="hs-identifier hs-var">modifyErr</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><a href="#local-6989586621690455480"><span class="hs-identifier hs-var">addPermContext</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadError QErr m =&gt;
RoleName
-&gt; RemoteSchemaName
-&gt; IntrospectionResult
-&gt; SchemaDocument
-&gt; m (IntrospectionResult, SchemaDependency)
</span><a href="Hasura.RemoteSchema.SchemaCache.Permission.html#resolveRoleBasedRemoteSchema"><span class="hs-identifier hs-var">resolveRoleBasedRemoteSchema</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621690455487"><span class="hs-identifier hs-var">roleName</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621690455490"><span class="hs-identifier hs-var">remoteSchemaName</span></a></span><span> </span><span class="annot"><span class="annottext">IntrospectionResult
</span><a href="#local-6989586621690455491"><span class="hs-identifier hs-var">originalIntrospection</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaDocument
</span><a href="#local-6989586621690455482"><span class="hs-identifier hs-var">providedSchemaDoc</span></a></span><span>
</span><span id="line-153"></span><span>              </span><span class="annot"><span class="annottext">forall im (arr :: * -&gt; * -&gt; *).
ArrowWriter (Seq (Either im MetadataDependency)) arr =&gt;
arr (MetadataObject, SchemaObjId, Seq SchemaDependency) ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#recordDependencies"><span class="hs-identifier hs-var">recordDependencies</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621690455485"><span class="hs-identifier hs-var">metadataObject</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SchemaObjId
</span><a href="#local-6989586621690455484"><span class="hs-identifier hs-var">schemaObject</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaDependency
</span><a href="#local-6989586621690455474"><span class="hs-keyword hs-var">dependency</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>              </span><span class="annot"><span class="annottext">forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">returnA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">IntrospectionResult
</span><a href="#local-6989586621690455475"><span class="hs-identifier hs-var">resolvedSchemaIntrospection</span></a></span><span>
</span><span id="line-155"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-156"></span><span>        </span><span class="hs-glyph">|)</span><span> </span><span class="annot"><span class="annottext">MetadataObject
</span><a href="#local-6989586621690455485"><span class="hs-identifier hs-var">metadataObject</span></a></span><span>
</span><span id="line-157"></span><span>
</span><span id="line-158"></span><span>    </span><span class="annot"><a href="#local-6989586621690455557"><span class="hs-identifier hs-type">mkRemoteSchemaPermissionMetadataObject</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-159"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.Base.html#RemoteSchemaName"><span class="hs-identifier hs-type">RemoteSchemaName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.Permission.html#RemoteSchemaPermissionMetadata"><span class="hs-identifier hs-type">RemoteSchemaPermissionMetadata</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-160"></span><span>      </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-type">MetadataObject</span></a></span><span>
</span><span id="line-161"></span><span>    </span><span id="local-6989586621690455557"><span class="annot"><span class="annottext">mkRemoteSchemaPermissionMetadataObject :: (RemoteSchemaName, RemoteSchemaPermissionMetadata)
-&gt; MetadataObject
</span><a href="#local-6989586621690455557"><span class="hs-identifier hs-var hs-var">mkRemoteSchemaPermissionMetadataObject</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621690455471"><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621690455471"><span class="hs-identifier hs-var">rsName</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.Permission.html#RemoteSchemaPermissionMetadata"><span class="hs-identifier hs-type">RemoteSchemaPermissionMetadata</span></a></span><span> </span><span id="local-6989586621690455470"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621690455470"><span class="hs-identifier hs-var">roleName</span></a></span></span><span> </span><span id="local-6989586621690455469"><span class="annot"><span class="annottext">RemoteSchemaPermissionDefinition
</span><a href="#local-6989586621690455469"><span class="hs-identifier hs-var">defn</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-162"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690455468"><span class="annot"><span class="annottext">objectId :: MetadataObjId
</span><a href="#local-6989586621690455468"><span class="hs-identifier hs-var hs-var">objectId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName -&gt; RoleName -&gt; MetadataObjId
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MORemoteSchemaPermissions"><span class="hs-identifier hs-var">MORemoteSchemaPermissions</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621690455471"><span class="hs-identifier hs-var">rsName</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621690455470"><span class="hs-identifier hs-var">roleName</span></a></span><span>
</span><span id="line-163"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">MetadataObjId -&gt; Value -&gt; MetadataObject
</span><a href="Hasura.RQL.Types.Metadata.Object.html#MetadataObject"><span class="hs-identifier hs-var">MetadataObject</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataObjId
</span><a href="#local-6989586621690455468"><span class="hs-identifier hs-var">objectId</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaPermissionDefinition
</span><a href="#local-6989586621690455469"><span class="hs-identifier hs-var">defn</span></a></span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span id="local-6989586621690455917"><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Build.html#addRemoteSchemaP2Setup"><span class="hs-identifier hs-type">addRemoteSchemaP2Setup</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-166"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Base.Error.html#QErrM"><span class="hs-identifier hs-type">QErrM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690455917"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690455917"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.HTTP.Client.Manager.html#HasHttpManagerM"><span class="hs-identifier hs-type">HasHttpManagerM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690455917"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Tracing.html#MonadTrace"><span class="hs-identifier hs-type">Tracing.MonadTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690455917"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-167"></span><span>  </span><span class="annot"><a href="Data.Environment.html#Environment"><span class="hs-identifier hs-type">Env.Environment</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-168"></span><span>  </span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.Base.html#RemoteSchemaName"><span class="hs-identifier hs-type">RemoteSchemaName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-169"></span><span>  </span><span class="annot"><a href="Hasura.RemoteSchema.Metadata.Core.html#RemoteSchemaDef"><span class="hs-identifier hs-type">RemoteSchemaDef</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-170"></span><span>  </span><span class="annot"><a href="#local-6989586621690455917"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Types.html#IntrospectionResult"><span class="hs-identifier hs-type">IntrospectionResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/bytestring-0.11.3.1/src"><span class="hs-identifier hs-type">BL.ByteString</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RemoteSchema.SchemaCache.Types.html#RemoteSchemaInfo"><span class="hs-identifier hs-type">RemoteSchemaInfo</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-171"></span><span id="addRemoteSchemaP2Setup"><span class="annot"><span class="annottext">addRemoteSchemaP2Setup :: forall (m :: * -&gt; *).
(QErrM m, MonadIO m, HasHttpManagerM m, MonadTrace m) =&gt;
Environment
-&gt; RemoteSchemaName
-&gt; RemoteSchemaDef
-&gt; m (IntrospectionResult, ByteString, RemoteSchemaInfo)
</span><a href="Hasura.RemoteSchema.SchemaCache.Build.html#addRemoteSchemaP2Setup"><span class="hs-identifier hs-var hs-var">addRemoteSchemaP2Setup</span></a></span></span><span> </span><span id="local-6989586621690455453"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621690455453"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621690455452"><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621690455452"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621690455451"><span class="annot"><span class="annottext">RemoteSchemaDef
</span><a href="#local-6989586621690455451"><span class="hs-identifier hs-var">def</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-172"></span><span>  </span><span id="local-6989586621690455450"><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621690455450"><span class="hs-identifier hs-var">httpMgr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). HasHttpManagerM m =&gt; m Manager
</span><a href="Network.HTTP.Client.Manager.html#askHttpManager"><span class="hs-identifier hs-var">askHttpManager</span></a></span><span>
</span><span id="line-173"></span><span>  </span><span id="local-6989586621690455448"><span class="annot"><span class="annottext">ValidatedRemoteSchemaDef
</span><a href="#local-6989586621690455448"><span class="hs-identifier hs-var">rsi</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(MonadError QErr m, MonadIO m) =&gt;
Environment -&gt; RemoteSchemaDef -&gt; m ValidatedRemoteSchemaDef
</span><a href="Hasura.RemoteSchema.SchemaCache.Types.html#validateRemoteSchemaDef"><span class="hs-identifier hs-var">validateRemoteSchemaDef</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621690455453"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaDef
</span><a href="#local-6989586621690455451"><span class="hs-identifier hs-var">def</span></a></span><span>
</span><span id="line-174"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(MonadIO m, MonadError QErr m, MonadTrace m) =&gt;
Environment
-&gt; Manager
-&gt; RemoteSchemaName
-&gt; ValidatedRemoteSchemaDef
-&gt; m (IntrospectionResult, ByteString, RemoteSchemaInfo)
</span><a href="Hasura.GraphQL.RemoteServer.html#fetchRemoteSchema"><span class="hs-identifier hs-var">fetchRemoteSchema</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621690455453"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621690455450"><span class="hs-identifier hs-var">httpMgr</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteSchemaName
</span><a href="#local-6989586621690455452"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedRemoteSchemaDef
</span><a href="#local-6989586621690455448"><span class="hs-identifier hs-var">rsi</span></a></span><span>
</span><span id="line-175"></span></pre></body></html>