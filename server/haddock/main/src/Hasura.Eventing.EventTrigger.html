<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE PatternSynonyms #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- = Event Triggers</span><span>
</span><span id="line-6"></span><span class="hs-comment">--</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- Event triggers are like ordinary SQL triggers, except instead of calling a SQL</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- procedure, they call a webhook. The event delivery mechanism involves coordination</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- between both the database and graphql-engine: only the SQL database knows</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- when the events should fire, but only graphql-engine know how to actually</span><span>
</span><span id="line-11"></span><span class="hs-comment">-- deliver them.</span><span>
</span><span id="line-12"></span><span class="hs-comment">--</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- Therefore, event triggers are implemented in two parts:</span><span>
</span><span id="line-14"></span><span class="hs-comment">--</span><span>
</span><span id="line-15"></span><span class="hs-comment">-- 1. Every event trigger is backed by a bona fide SQL trigger. When the SQL trigger</span><span>
</span><span id="line-16"></span><span class="hs-comment">--    fires, it creates a new record in the hdb_catalog.event_log table.</span><span>
</span><span id="line-17"></span><span class="hs-comment">--</span><span>
</span><span id="line-18"></span><span class="hs-comment">-- 2. Concurrently, a thread in graphql-engine monitors the hdb_catalog.event_log</span><span>
</span><span id="line-19"></span><span class="hs-comment">--    table for new events. When new event(s) are found, it uses the information</span><span>
</span><span id="line-20"></span><span class="hs-comment">--    (URL,payload and headers) stored in the event to deliver the event</span><span>
</span><span id="line-21"></span><span class="hs-comment">--    to the webhook.</span><span>
</span><span id="line-22"></span><span class="hs-comment">--</span><span>
</span><span id="line-23"></span><span class="hs-comment">-- The creation and deletion of SQL trigger itself is managed by the metadata DDL</span><span>
</span><span id="line-24"></span><span class="hs-comment">-- APIs (see Hasura.RQL.DDL.EventTrigger), so this module focuses on event delivery.</span><span>
</span><span id="line-25"></span><span class="hs-comment">--</span><span>
</span><span id="line-26"></span><span class="hs-comment">-- Most of the subtleties involve guaranteeing reliable delivery of events:</span><span>
</span><span id="line-27"></span><span class="hs-comment">-- we guarantee that every event will be delivered at least once,</span><span>
</span><span id="line-28"></span><span class="hs-comment">-- even if graphql-engine crashes. This means we have to record the state</span><span>
</span><span id="line-29"></span><span class="hs-comment">-- of each event in the database, and we have to retry</span><span>
</span><span id="line-30"></span><span class="hs-comment">-- failed requests at a regular (user-configurable) interval.</span><span>
</span><span id="line-31"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hasura.Eventing.EventTrigger</span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#initEventEngineCtx"><span class="hs-identifier">initEventEngineCtx</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#processEventQueue"><span class="hs-identifier">processEventQueue</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#defaultMaxEventThreads"><span class="hs-identifier">defaultMaxEventThreads</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#defaultFetchInterval"><span class="hs-identifier">defaultFetchInterval</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier">Event</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventEngineCtx"><span class="hs-identifier">EventEngineCtx</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>    </span><span class="hs-comment">-- Exported for testing</span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#saveLockedEventTriggerEvents"><span class="hs-identifier">saveLockedEventTriggerEvents</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#removeEventTriggerEventFromLockedEvents"><span class="hs-identifier">removeEventTriggerEventFromLockedEvents</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>    </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier">logQErr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">where</span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Async.Lifted.Safe</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LA</span></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Control.Concurrent.Extended.html"><span class="hs-identifier">Control.Concurrent.Extended</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Extended.html#Forever"><span class="hs-identifier">Forever</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Extended.html#sleep"><span class="hs-identifier">sleep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/stm-2.5.0.2/src"><span class="hs-identifier">Control.Concurrent.STM.TVar</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/exceptions-0.10.4/src"><span class="hs-identifier">Control.Monad.Catch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/exceptions-0.10.4/src"><span class="hs-identifier">MonadMask</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/exceptions-0.10.4/src"><span class="hs-identifier">bracket_</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/exceptions-0.10.4/src"><span class="hs-identifier">finally</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/exceptions-0.10.4/src"><span class="hs-identifier">mask_</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/stm-2.5.0.2/src"><span class="hs-identifier">Control.Monad.STM</span></a></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Control</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadBaseControl</span></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">J</span></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson.TH</span></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Has</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.SerializableBlob.html"><span class="hs-identifier">Data.SerializableBlob</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SB</span></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">Data.String</span></a></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Text.Extended.html"><span class="hs-identifier">Data.Text.Extended</span></a></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Text.NonEmpty.html"><span class="hs-identifier">Data.Text.NonEmpty</span></a></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/time-1.11.1.1/src"><span class="hs-identifier">Data.Time.Clock</span></a></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/time-1.11.1.1/src"><span class="hs-identifier">Data.Time.Clock</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Time</span></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.SQL.Types.html"><span class="hs-identifier">Hasura.Backends.Postgres.SQL.Types</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.Postgres.SQL.Types.html#TableName"><span class="hs-identifier">TableName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Eventing.Common.html"><span class="hs-identifier">Hasura.Eventing.Common</span></a></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Eventing.HTTP.html"><span class="hs-identifier">Hasura.Eventing.HTTP</span></a></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.HTTP.html"><span class="hs-identifier">Hasura.HTTP</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.HTTP.html#getHTTPExceptionStatus"><span class="hs-identifier">getHTTPExceptionStatus</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Logging.html"><span class="hs-identifier">Hasura.Logging</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">L</span></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.2.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Headers.html"><span class="hs-identifier">Hasura.RQL.DDL.Headers</span></a></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Webhook.Transform.html"><span class="hs-identifier">Hasura.RQL.DDL.Webhook.Transform</span></a></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html"><span class="hs-identifier">Hasura.RQL.Types.Backend</span></a></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html"><span class="hs-identifier">Hasura.RQL.Types.Common</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html"><span class="hs-identifier">Hasura.RQL.Types.EventTrigger</span></a></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.Backend.html"><span class="hs-identifier">Hasura.RQL.Types.Eventing.Backend</span></a></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html"><span class="hs-identifier">Hasura.RQL.Types.SchemaCache</span></a></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html"><span class="hs-identifier">Hasura.RQL.Types.Source</span></a></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.SQL.AnyBackend.html"><span class="hs-identifier">Hasura.SQL.AnyBackend</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AB</span></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.SQL.Backend.html"><span class="hs-identifier">Hasura.SQL.Backend</span></a></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Metrics.html"><span class="hs-identifier">Hasura.Server.Metrics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Metrics.html#ServerMetrics"><span class="hs-identifier">ServerMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Prometheus.html"><span class="hs-identifier">Hasura.Server.Prometheus</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Prometheus.html#EventTriggerMetrics"><span class="hs-identifier">EventTriggerMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html"><span class="hs-identifier">Hasura.Server.Types</span></a></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Tracing.html"><span class="hs-identifier">Hasura.Tracing</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Tracing</span></span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP.Client.Transformable.html"><span class="hs-identifier">Network.HTTP.Client.Transformable</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HTTP</span></span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Refined</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NonNegative</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Positive</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Refined</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">refineTH</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unrefine</span></span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Metrics.Distribution</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">EKG.Distribution</span></span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Metrics.Gauge</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">EKG.Gauge</span></span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Metrics.Prometheus.Gauge</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Prometheus.Gauge</span></span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Metrics.Prometheus.Histogram</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Prometheus.Histogram</span></span><span>
</span><span id="line-91"></span><span>
</span><span id="line-92"></span><span class="hs-keyword">newtype</span><span> </span><span id="EventInternalErr"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventInternalErr"><span class="hs-identifier hs-var">EventInternalErr</span></a></span></span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="EventInternalErr"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventInternalErr"><span class="hs-identifier hs-var">EventInternalErr</span></a></span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span>
</span><span id="line-94"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621690396952"><span id="local-6989586621690396957"><span class="annot"><span class="annottext">EventInternalErr -&gt; EventInternalErr -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: EventInternalErr -&gt; EventInternalErr -&gt; Bool
$c/= :: EventInternalErr -&gt; EventInternalErr -&gt; Bool
== :: EventInternalErr -&gt; EventInternalErr -&gt; Bool
$c== :: EventInternalErr -&gt; EventInternalErr -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span>
</span><span id="line-96"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.Logging.html#ToEngineLog"><span class="hs-identifier hs-type">L.ToEngineLog</span></a></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventInternalErr"><span class="hs-identifier hs-type">EventInternalErr</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-97"></span><span>  </span><span id="local-6989586621690396939"><span class="annot"><span class="annottext">toEngineLog :: EventInternalErr -&gt; (LogLevel, EngineLogType Hasura, Value)
</span><a href="Hasura.Logging.html#toEngineLog"><span class="hs-identifier hs-var hs-var hs-var hs-var">toEngineLog</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventInternalErr"><span class="hs-identifier hs-type">EventInternalErr</span></a></span><span> </span><span id="local-6989586621690396937"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621690396937"><span class="hs-identifier hs-var">qerr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelError"><span class="hs-identifier hs-var">L.LevelError</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EngineLogType Hasura
</span><a href="Hasura.Logging.html#eventTriggerLogType"><span class="hs-identifier hs-var">L.eventTriggerLogType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">J.toJSON</span></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621690396937"><span class="hs-identifier hs-var">qerr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span class="hs-comment">{- Note [Maintenance mode]
~~~~~~~~~~~~~~~~~~~~~~~~~~

Maintenance mode is a mode in which users can upgrade their graphql-engine
without any down time. More on maintenance mode can be found here:
https://github.com/hasura/graphql-engine-mono/issues/431.

Basically, there are a few main things that maintenance mode boils down to:

1. No operation that may change the metadata will be allowed.
2. Migrations are not applied when the graphql-engine is started, so the
   catalog schema will be in the older version.
3. Event triggers should continue working in the new code with the older
   catalog schema i.e it should work even if there are any schema changes
   to the `hdb_catalog.event_log` table.

#1 and #2 are fairly self-explanatory. For #3, we need to support fetching
events depending upon the catalog version. So, fetch events works in the
following way now:

1. Check if maintenance mode is enabled
2. If maintenance mode is enabled then read the catalog version from the DB
   and accordingly fire the appropriate query to the events log table.
   When maintenance mode is disabled, we query the events log table according
   to the latest catalog, we do not read the catalog version for this.
-}</span><span>
</span><span id="line-125"></span><span>
</span><span id="line-126"></span><span class="hs-comment">-- | See Note [Maintenance Mode]</span><span>
</span><span id="line-127"></span><span class="hs-keyword">data</span><span> </span><span id="EventEngineCtx"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventEngineCtx"><span class="hs-identifier hs-var">EventEngineCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="EventEngineCtx"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventEngineCtx"><span class="hs-identifier hs-var">EventEngineCtx</span></a></span></span><span>
</span><span id="line-128"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_eeCtxEventThreadsCapacity"><span class="annot"><span class="annottext">EventEngineCtx -&gt; TVar Int
</span><a href="Hasura.Eventing.EventTrigger.html#_eeCtxEventThreadsCapacity"><span class="hs-identifier hs-var hs-var">_eeCtxEventThreadsCapacity</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">TVar</span></a></span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-129"></span><span>    </span><span id="_eeCtxFetchInterval"><span class="annot"><span class="annottext">EventEngineCtx -&gt; DiffTime
</span><a href="Hasura.Eventing.EventTrigger.html#_eeCtxFetchInterval"><span class="hs-identifier hs-var hs-var">_eeCtxFetchInterval</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/time-1.11.1.1/src"><span class="hs-identifier hs-type">DiffTime</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-130"></span><span>    </span><span id="_eeCtxFetchSize"><span class="annot"><span class="annottext">EventEngineCtx -&gt; Refined NonNegative Int
</span><a href="Hasura.Eventing.EventTrigger.html#_eeCtxFetchSize"><span class="hs-identifier hs-var hs-var">_eeCtxFetchSize</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Refined</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">NonNegative</span></span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-131"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span class="hs-keyword">data</span><span> </span><span id="DeliveryInfo"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#DeliveryInfo"><span class="hs-identifier hs-var">DeliveryInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="DeliveryInfo"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#DeliveryInfo"><span class="hs-identifier hs-var">DeliveryInfo</span></a></span></span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="diCurrentRetry"><span class="annot"><span class="annottext">DeliveryInfo -&gt; Int
</span><a href="Hasura.Eventing.EventTrigger.html#diCurrentRetry"><span class="hs-identifier hs-var hs-var">diCurrentRetry</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-135"></span><span>    </span><span id="diMaxRetries"><span class="annot"><span class="annottext">DeliveryInfo -&gt; Int
</span><a href="Hasura.Eventing.EventTrigger.html#diMaxRetries"><span class="hs-identifier hs-var hs-var">diMaxRetries</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-136"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-137"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621690396917"><span id="local-6989586621690396919"><span id="local-6989586621690396925"><span class="annot"><span class="annottext">Int -&gt; DeliveryInfo -&gt; ShowS
[DeliveryInfo] -&gt; ShowS
DeliveryInfo -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [DeliveryInfo] -&gt; ShowS
$cshowList :: [DeliveryInfo] -&gt; ShowS
show :: DeliveryInfo -&gt; String
$cshow :: DeliveryInfo -&gt; String
showsPrec :: Int -&gt; DeliveryInfo -&gt; ShowS
$cshowsPrec :: Int -&gt; DeliveryInfo -&gt; ShowS
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621690396909"><span id="local-6989586621690396914"><span class="annot"><span class="annottext">DeliveryInfo -&gt; DeliveryInfo -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: DeliveryInfo -&gt; DeliveryInfo -&gt; Bool
$c/= :: DeliveryInfo -&gt; DeliveryInfo -&gt; Bool
== :: DeliveryInfo -&gt; DeliveryInfo -&gt; Bool
$c== :: DeliveryInfo -&gt; DeliveryInfo -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span class="hs-special">$</span><span id="local-6989586621690396863"><span id="local-6989586621690396865"><span id="local-6989586621690396877"><span id="local-6989586621690396893"><span id="local-6989586621690396895"><span id="local-6989586621690396907"><span class="hs-special">(</span><span class="hs-identifier">deriveJSON</span><span> </span><span class="hs-identifier">hasuraJSON</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">omitNothingFields</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">True</span><span class="hs-special">}</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">DeliveryInfo</span><span class="hs-special">)</span></span></span></span></span></span></span><span>
</span><span id="line-140"></span><span>
</span><span id="line-141"></span><span class="hs-keyword">newtype</span><span> </span><span id="QualifiedTableStrict"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#QualifiedTableStrict"><span class="hs-identifier hs-var">QualifiedTableStrict</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="QualifiedTableStrict"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#QualifiedTableStrict"><span class="hs-identifier hs-var">QualifiedTableStrict</span></a></span></span><span>
</span><span id="line-142"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="getQualifiedTable"><span class="annot"><span class="annottext">QualifiedTableStrict -&gt; QualifiedTable
</span><a href="Hasura.Eventing.EventTrigger.html#getQualifiedTable"><span class="hs-identifier hs-var hs-var">getQualifiedTable</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.SQL.Types.html#QualifiedTable"><span class="hs-identifier hs-type">QualifiedTable</span></a></span><span>
</span><span id="line-143"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-144"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621690396826"><span id="local-6989586621690396828"><span id="local-6989586621690396834"><span class="annot"><span class="annottext">Int -&gt; QualifiedTableStrict -&gt; ShowS
[QualifiedTableStrict] -&gt; ShowS
QualifiedTableStrict -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [QualifiedTableStrict] -&gt; ShowS
$cshowList :: [QualifiedTableStrict] -&gt; ShowS
show :: QualifiedTableStrict -&gt; String
$cshow :: QualifiedTableStrict -&gt; String
showsPrec :: Int -&gt; QualifiedTableStrict -&gt; ShowS
$cshowsPrec :: Int -&gt; QualifiedTableStrict -&gt; ShowS
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621690396817"><span id="local-6989586621690396823"><span class="annot"><span class="annottext">QualifiedTableStrict -&gt; QualifiedTableStrict -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: QualifiedTableStrict -&gt; QualifiedTableStrict -&gt; Bool
$c/= :: QualifiedTableStrict -&gt; QualifiedTableStrict -&gt; Bool
== :: QualifiedTableStrict -&gt; QualifiedTableStrict -&gt; Bool
$c== :: QualifiedTableStrict -&gt; QualifiedTableStrict -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621690396805"><span id="local-6989586621690396807"><span id="local-6989586621690396809"><span class="annot"><span class="hs-identifier hs-type">J.ToJSON</span></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#QualifiedTableStrict"><span class="hs-identifier hs-type">QualifiedTableStrict</span></a></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-147"></span><span>  </span><span id="local-6989586621690396792"><span class="annot"><span class="annottext">toJSON :: QualifiedTableStrict -&gt; Value
</span><a href="#local-6989586621690396792"><span class="hs-identifier hs-var hs-var hs-var hs-var">toJSON</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#QualifiedTableStrict"><span class="hs-identifier hs-type">QualifiedTableStrict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.Postgres.SQL.Types.html#QualifiedObject"><span class="hs-identifier hs-type">QualifiedObject</span></a></span><span> </span><span id="local-6989586621690396790"><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621690396790"><span class="hs-identifier hs-var">sn</span></a></span></span><span> </span><span id="local-6989586621690396789"><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621690396789"><span class="hs-identifier hs-var">tn</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-148"></span><span>    </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">J.object</span></span><span>
</span><span id="line-149"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;schema&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">SchemaName
</span><a href="#local-6989586621690396790"><span class="hs-identifier hs-var">sn</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-150"></span><span>        </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;name&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">TableName
</span><a href="#local-6989586621690396789"><span class="hs-identifier hs-var">tn</span></a></span><span>
</span><span id="line-151"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span id="local-6989586621690396785"><span id="local-6989586621690396786"></span></span><span class="hs-keyword">data</span><span> </span><span id="EventPayload"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventPayload"><span class="hs-identifier hs-var">EventPayload</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621690397544"><span class="annot"><a href="#local-6989586621690397544"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.SQL.Backend.html#BackendType"><span class="hs-identifier hs-type">BackendType</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span id="EventPayload"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventPayload"><span class="hs-identifier hs-var">EventPayload</span></a></span></span><span>
</span><span id="line-154"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="epId"><span class="annot"><span class="annottext">forall (b :: BackendType). EventPayload b -&gt; EventId
</span><a href="Hasura.Eventing.EventTrigger.html#epId"><span class="hs-identifier hs-var hs-var">epId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-155"></span><span>    </span><span id="epTable"><span class="annot"><span class="annottext">forall (b :: BackendType). EventPayload b -&gt; TableName b
</span><a href="Hasura.Eventing.EventTrigger.html#epTable"><span class="hs-identifier hs-var hs-var">epTable</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#TableName"><span class="hs-identifier hs-type">TableName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397544"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-156"></span><span>    </span><span id="epTrigger"><span class="annot"><span class="annottext">forall (b :: BackendType). EventPayload b -&gt; TriggerMetadata
</span><a href="Hasura.Eventing.EventTrigger.html#epTrigger"><span class="hs-identifier hs-var hs-var">epTrigger</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#TriggerMetadata"><span class="hs-identifier hs-type">TriggerMetadata</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-157"></span><span>    </span><span id="epEvent"><span class="annot"><span class="annottext">forall (b :: BackendType). EventPayload b -&gt; Value
</span><a href="Hasura.Eventing.EventTrigger.html#epEvent"><span class="hs-identifier hs-var hs-var">epEvent</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span class="hs-special">,</span><span>
</span><span id="line-158"></span><span>    </span><span id="epDeliveryInfo"><span class="annot"><span class="annottext">forall (b :: BackendType). EventPayload b -&gt; DeliveryInfo
</span><a href="Hasura.Eventing.EventTrigger.html#epDeliveryInfo"><span class="hs-identifier hs-var hs-var">epDeliveryInfo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#DeliveryInfo"><span class="hs-identifier hs-type">DeliveryInfo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-159"></span><span>    </span><span id="epCreatedAt"><span class="annot"><span class="annottext">forall (b :: BackendType). EventPayload b -&gt; UTCTime
</span><a href="Hasura.Eventing.EventTrigger.html#epCreatedAt"><span class="hs-identifier hs-var hs-var">epCreatedAt</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/time-1.11.1.1/src"><span class="hs-identifier hs-type">Time.UTCTime</span></a></span><span>
</span><span id="line-160"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-161"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall (b :: BackendType) x.
Rep (EventPayload b) x -&gt; EventPayload b
forall (b :: BackendType) x.
EventPayload b -&gt; Rep (EventPayload b) x
$cto :: forall (b :: BackendType) x.
Rep (EventPayload b) x -&gt; EventPayload b
$cfrom :: forall (b :: BackendType) x.
EventPayload b -&gt; Rep (EventPayload b) x
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span id="local-6989586621690396757"><span id="local-6989586621690396759"><span id="local-6989586621690396772"><span id="local-6989586621690397528"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#Backend"><span class="hs-identifier hs-type">Backend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397528"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventPayload"><span class="hs-identifier hs-type">EventPayload</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397528"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span id="local-6989586621690396743"><span id="local-6989586621690396755"><span id="local-6989586621690397527"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#Backend"><span class="hs-identifier hs-type">Backend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397527"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventPayload"><span class="hs-identifier hs-type">EventPayload</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397527"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621690396736"><span id="local-6989586621690396738"><span id="local-6989586621690396740"><span id="local-6989586621690397526"><span class="annot"><a href="Hasura.RQL.Types.Backend.html#Backend"><span class="hs-identifier hs-type">Backend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397526"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.ToJSON</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventPayload"><span class="hs-identifier hs-type">EventPayload</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397526"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-168"></span><span>  </span><span id="local-6989586621690396575"><span class="annot"><span class="annottext">toJSON :: EventPayload b -&gt; Value
</span><a href="#local-6989586621690396575"><span class="hs-identifier hs-var hs-var hs-var hs-var">toJSON</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a.
(Generic a, GToJSON' Value Zero (Rep a)) =&gt;
Options -&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">J.genericToJSON</span></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.2.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">hasuraJSON</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">omitNothingFields :: Bool
</span><a href="#local-6989586621690396572"><span class="hs-identifier hs-var">omitNothingFields</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#defaultMaxEventThreads"><span class="hs-identifier hs-type">defaultMaxEventThreads</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Refined</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Positive</span></span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-171"></span><span id="defaultMaxEventThreads"><span class="annot"><span class="annottext">defaultMaxEventThreads :: Refined Positive Int
</span><a href="Hasura.Eventing.EventTrigger.html#defaultMaxEventThreads"><span class="hs-identifier hs-var hs-var">defaultMaxEventThreads</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$$</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">refineTH</span></span><span> </span><span class="annot"><span class="hs-number">100</span></span><span class="hs-special">)</span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#defaultFetchInterval"><span class="hs-identifier hs-type">defaultFetchInterval</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/time-1.11.1.1/src"><span class="hs-identifier hs-type">DiffTime</span></a></span><span>
</span><span id="line-174"></span><span id="defaultFetchInterval"><span class="annot"><span class="annottext">defaultFetchInterval :: DiffTime
</span><a href="Hasura.Eventing.EventTrigger.html#defaultFetchInterval"><span class="hs-identifier hs-var hs-var">defaultFetchInterval</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Seconds -&gt; DiffTime
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.2.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">seconds</span></a></span><span> </span><span class="annot"><span class="annottext">Seconds
</span><span class="hs-number">1</span></span><span>
</span><span id="line-175"></span><span>
</span><span id="line-176"></span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#initEventEngineCtx"><span class="hs-identifier hs-type">initEventEngineCtx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/time-1.11.1.1/src"><span class="hs-identifier hs-type">DiffTime</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Refined</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">NonNegative</span></span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventEngineCtx"><span class="hs-identifier hs-type">EventEngineCtx</span></a></span><span>
</span><span id="line-177"></span><span id="initEventEngineCtx"><span class="annot"><span class="annottext">initEventEngineCtx :: Int -&gt; DiffTime -&gt; Refined NonNegative Int -&gt; STM EventEngineCtx
</span><a href="Hasura.Eventing.EventTrigger.html#initEventEngineCtx"><span class="hs-identifier hs-var hs-var">initEventEngineCtx</span></a></span></span><span> </span><span id="local-6989586621690396568"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621690396568"><span class="hs-identifier hs-var">maxT</span></a></span></span><span> </span><span id="local-6989586621690396567"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621690396567"><span class="hs-identifier hs-var">_eeCtxFetchInterval</span></a></span></span><span> </span><span id="local-6989586621690396566"><span class="annot"><span class="annottext">Refined NonNegative Int
</span><a href="#local-6989586621690396566"><span class="hs-identifier hs-var">_eeCtxFetchSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-178"></span><span>  </span><span id="local-6989586621690396565"><span class="annot"><span class="annottext">TVar Int
</span><a href="#local-6989586621690396565"><span class="hs-identifier hs-var">_eeCtxEventThreadsCapacity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; STM (TVar a)
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">newTVar</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621690396568"><span class="hs-identifier hs-var">maxT</span></a></span><span>
</span><span id="line-179"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventEngineCtx"><span class="hs-identifier hs-type">EventEngineCtx</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">TVar Int
DiffTime
Refined NonNegative Int
_eeCtxEventThreadsCapacity :: TVar Int
_eeCtxFetchSize :: Refined NonNegative Int
_eeCtxFetchInterval :: DiffTime
_eeCtxFetchSize :: Refined NonNegative Int
_eeCtxFetchInterval :: DiffTime
_eeCtxEventThreadsCapacity :: TVar Int
</span><a href="#local-6989586621690396565"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span id="local-6989586621690397395"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#saveLockedEventTriggerEvents"><span class="hs-identifier hs-type">saveLockedEventTriggerEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397395"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">TVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Set.Set</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621690397395"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-182"></span><span id="saveLockedEventTriggerEvents"><span class="annot"><span class="annottext">saveLockedEventTriggerEvents :: forall (m :: * -&gt; *).
MonadIO m =&gt;
SourceName
-&gt; [EventId] -&gt; TVar (HashMap SourceName (Set EventId)) -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#saveLockedEventTriggerEvents"><span class="hs-identifier hs-var hs-var">saveLockedEventTriggerEvents</span></a></span></span><span> </span><span id="local-6989586621690396549"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621690396549"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span> </span><span id="local-6989586621690396548"><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621690396548"><span class="hs-identifier hs-var">eventIds</span></a></span></span><span> </span><span id="local-6989586621690396547"><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621690396547"><span class="hs-identifier hs-var">lockedEvents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-183"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-184"></span><span>    </span><span class="annot"><span class="annottext">forall a. STM a -&gt; IO a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-185"></span><span>      </span><span id="local-6989586621690396544"><span class="annot"><span class="annottext">HashMap SourceName (Set EventId)
</span><a href="#local-6989586621690396544"><span class="hs-identifier hs-var">lockedEventsVals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. TVar a -&gt; STM a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621690396547"><span class="hs-identifier hs-var">lockedEvents</span></a></span><span>
</span><span id="line-186"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621690396549"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap SourceName (Set EventId)
</span><a href="#local-6989586621690396544"><span class="hs-identifier hs-var">lockedEventsVals</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-187"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Set EventId)
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. TVar a -&gt; a -&gt; STM ()
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">writeTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621690396547"><span class="hs-identifier hs-var">lockedEvents</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">forall k v. Hashable k =&gt; k -&gt; v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621690396549"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Ord a =&gt; [a] -&gt; Set a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Set.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621690396548"><span class="hs-identifier hs-var">eventIds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-188"></span><span>        </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Set EventId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. TVar a -&gt; a -&gt; STM ()
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">writeTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621690396547"><span class="hs-identifier hs-var">lockedEvents</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">forall k v.
(Eq k, Hashable k) =&gt;
(v -&gt; v -&gt; v) -&gt; k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">M.insertWith</span></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Set.union</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621690396549"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Ord a =&gt; [a] -&gt; Set a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Set.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">[EventId]
</span><a href="#local-6989586621690396548"><span class="hs-identifier hs-var">eventIds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashMap SourceName (Set EventId)
</span><a href="#local-6989586621690396544"><span class="hs-identifier hs-var">lockedEventsVals</span></a></span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span id="local-6989586621690397375"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#removeEventTriggerEventFromLockedEvents"><span class="hs-identifier hs-type">removeEventTriggerEventFromLockedEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-191"></span><span>  </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397375"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">TVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Set.Set</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621690397375"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-192"></span><span id="removeEventTriggerEventFromLockedEvents"><span class="annot"><span class="annottext">removeEventTriggerEventFromLockedEvents :: forall (m :: * -&gt; *).
MonadIO m =&gt;
SourceName
-&gt; EventId -&gt; TVar (HashMap SourceName (Set EventId)) -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#removeEventTriggerEventFromLockedEvents"><span class="hs-identifier hs-var hs-var">removeEventTriggerEventFromLockedEvents</span></a></span></span><span> </span><span id="local-6989586621690396529"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621690396529"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span> </span><span id="local-6989586621690396528"><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621690396528"><span class="hs-identifier hs-var">eventId</span></a></span></span><span> </span><span id="local-6989586621690396527"><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621690396527"><span class="hs-identifier hs-var">lockedEvents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-193"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-194"></span><span>    </span><span class="annot"><span class="annottext">forall a. STM a -&gt; IO a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-195"></span><span>      </span><span id="local-6989586621690396526"><span class="annot"><span class="annottext">HashMap SourceName (Set EventId)
</span><a href="#local-6989586621690396526"><span class="hs-identifier hs-var">lockedEventsVals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. TVar a -&gt; STM a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621690396527"><span class="hs-identifier hs-var">lockedEvents</span></a></span><span>
</span><span id="line-196"></span><span>      </span><span class="annot"><span class="annottext">forall a. TVar a -&gt; a -&gt; STM ()
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">writeTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621690396527"><span class="hs-identifier hs-var">lockedEvents</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">forall k v.
(Eq k, Hashable k) =&gt;
(v -&gt; v) -&gt; k -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">M.adjust</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Set.delete</span></a></span><span> </span><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621690396528"><span class="hs-identifier hs-var">eventId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621690396529"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap SourceName (Set EventId)
</span><a href="#local-6989586621690396526"><span class="hs-identifier hs-var">lockedEventsVals</span></a></span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span class="hs-keyword">type</span><span> </span><span id="BackendEventWithSource"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#BackendEventWithSource"><span class="hs-identifier hs-var">BackendEventWithSource</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hasura.SQL.AnyBackend.html#AnyBackend"><span class="hs-identifier hs-type">AB.AnyBackend</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventWithSource"><span class="hs-identifier hs-type">EventWithSource</span></a></span><span>
</span><span id="line-199"></span><span>
</span><span id="line-200"></span><span class="hs-keyword">type</span><span> </span><span id="FetchEventArguments"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#FetchEventArguments"><span class="hs-identifier hs-var">FetchEventArguments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#BackendEventWithSource"><span class="hs-identifier hs-type">BackendEventWithSource</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span class="hs-comment">-- | Service events from our in-DB queue.</span><span>
</span><span id="line-203"></span><span class="hs-comment">--</span><span>
</span><span id="line-204"></span><span class="hs-comment">-- There are a few competing concerns and constraints here; we want to...</span><span>
</span><span id="line-205"></span><span class="hs-comment">--   - fetch events in batches for lower DB pressure</span><span>
</span><span id="line-206"></span><span class="hs-comment">--   - don't fetch more than N at a time (since that can mean: space leak, less</span><span>
</span><span id="line-207"></span><span class="hs-comment">--     effective scale out, possible double sends for events we've checked out</span><span>
</span><span id="line-208"></span><span class="hs-comment">--     on exit (TODO clean shutdown procedure))</span><span>
</span><span id="line-209"></span><span class="hs-comment">--   - try not to cause webhook workers to stall waiting on DB fetch</span><span>
</span><span id="line-210"></span><span class="hs-comment">--   - limit webhook HTTP concurrency per HASURA_GRAPHQL_EVENTS_HTTP_POOL_SIZE</span><span>
</span><span id="line-211"></span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#processEventQueue"><span class="hs-identifier hs-type">processEventQueue</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-212"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621690397370"><span class="annot"><a href="#local-6989586621690397370"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-213"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397370"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-214"></span><span>    </span><span class="annot"><a href="Hasura.Tracing.html#HasReporter"><span class="hs-identifier hs-type">Tracing.HasReporter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397370"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-215"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397370"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-216"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">LA.Forall</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">LA.Pure</span></span><span> </span><span class="annot"><a href="#local-6989586621690397370"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-217"></span><span>    </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/exceptions-0.10.4/src"><span class="hs-identifier hs-type">MonadMask</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397370"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-218"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-219"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">L.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-220"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">HTTP.Manager</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-221"></span><span>  </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#SchemaCache"><span class="hs-identifier hs-type">SchemaCache</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-222"></span><span>  </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventEngineCtx"><span class="hs-identifier hs-type">EventEngineCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-223"></span><span>  </span><span class="annot"><a href="Hasura.Eventing.Common.html#LockedEventsCtx"><span class="hs-identifier hs-type">LockedEventsCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-224"></span><span>  </span><span class="annot"><a href="Hasura.Server.Metrics.html#ServerMetrics"><span class="hs-identifier hs-type">ServerMetrics</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-225"></span><span>  </span><span class="annot"><a href="Hasura.Server.Prometheus.html#EventTriggerMetrics"><span class="hs-identifier hs-type">EventTriggerMetrics</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-226"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-227"></span><span>  </span><span class="annot"><a href="#local-6989586621690397370"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Extended.html#Forever"><span class="hs-identifier hs-type">Forever</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397370"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-228"></span><span id="processEventQueue"><span class="annot"><span class="annottext">processEventQueue :: forall (m :: * -&gt; *).
(MonadIO m, HasReporter m, MonadBaseControl IO m, Forall (Pure m),
 MonadMask m) =&gt;
Logger Hasura
-&gt; Manager
-&gt; IO SchemaCache
-&gt; EventEngineCtx
-&gt; LockedEventsCtx
-&gt; ServerMetrics
-&gt; EventTriggerMetrics
-&gt; MaintenanceMode ()
-&gt; m (Forever m)
</span><a href="Hasura.Eventing.EventTrigger.html#processEventQueue"><span class="hs-identifier hs-var hs-var">processEventQueue</span></a></span></span><span> </span><span id="local-6989586621690396424"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621690396424"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621690396423"><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621690396423"><span class="hs-identifier hs-var">httpMgr</span></a></span></span><span> </span><span id="local-6989586621690396422"><span class="annot"><span class="annottext">IO SchemaCache
</span><a href="#local-6989586621690396422"><span class="hs-identifier hs-var">getSchemaCache</span></a></span></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventEngineCtx"><span class="hs-identifier hs-type">EventEngineCtx</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621690396419"><span id="local-6989586621690396420"><span id="local-6989586621690396421"><span class="annot"><span class="annottext">TVar Int
DiffTime
Refined NonNegative Int
_eeCtxFetchSize :: Refined NonNegative Int
_eeCtxFetchInterval :: DiffTime
_eeCtxEventThreadsCapacity :: TVar Int
_eeCtxFetchSize :: EventEngineCtx -&gt; Refined NonNegative Int
_eeCtxFetchInterval :: EventEngineCtx -&gt; DiffTime
_eeCtxEventThreadsCapacity :: EventEngineCtx -&gt; TVar Int
</span><a href="#local-6989586621690396419"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span><span class="hs-special">}</span><span> </span><span class="annot"><a href="Hasura.Eventing.Common.html#LockedEventsCtx"><span class="hs-identifier hs-type">LockedEventsCtx</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621690396417"><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
leEvents :: LockedEventsCtx -&gt; TVar (HashMap SourceName (Set EventId))
leEvents :: TVar (HashMap SourceName (Set EventId))
</span><a href="Hasura.Eventing.Common.html#leEvents"><span class="hs-identifier hs-var hs-var">leEvents</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621690396415"><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621690396415"><span class="hs-identifier hs-var">serverMetrics</span></a></span></span><span> </span><span id="local-6989586621690396414"><span class="annot"><span class="annottext">EventTriggerMetrics
</span><a href="#local-6989586621690396414"><span class="hs-identifier hs-var">eventTriggerMetrics</span></a></span></span><span> </span><span id="local-6989586621690396413"><span class="annot"><span class="annottext">MaintenanceMode ()
</span><a href="#local-6989586621690396413"><span class="hs-identifier hs-var">maintenanceMode</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-229"></span><span>  </span><span id="local-6989586621690396412"><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621690396412"><span class="hs-identifier hs-var">events0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m [BackendEventWithSource]
</span><a href="#local-6989586621690396411"><span class="hs-identifier hs-var">popEventsBatch</span></a></span><span>
</span><span id="line-230"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. a -&gt; (a -&gt; m a) -&gt; Forever m
</span><a href="Control.Concurrent.Extended.html#Forever"><span class="hs-identifier hs-var">Forever</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621690396412"><span class="hs-identifier hs-var">events0</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FetchEventArguments -&gt; m FetchEventArguments
</span><a href="#local-6989586621690396409"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-231"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-232"></span><span>    </span><span id="local-6989586621690396408"><span class="annot"><span class="annottext">fetchBatchSize :: Int
</span><a href="#local-6989586621690396408"><span class="hs-identifier hs-var hs-var">fetchBatchSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {k} (p :: k) x. Refined p x -&gt; x
</span><span class="hs-identifier hs-var">unrefine</span></span><span> </span><span class="annot"><span class="annottext">Refined NonNegative Int
</span><a href="#local-6989586621690396419"><span class="hs-identifier hs-var">_eeCtxFetchSize</span></a></span><span>
</span><span id="line-233"></span><span>
</span><span id="line-234"></span><span>    </span><span class="annot"><a href="#local-6989586621690396411"><span class="hs-identifier hs-type">popEventsBatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621690397370"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#BackendEventWithSource"><span class="hs-identifier hs-type">BackendEventWithSource</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-235"></span><span>    </span><span id="local-6989586621690396411"><span class="annot"><span class="annottext">popEventsBatch :: m [BackendEventWithSource]
</span><a href="#local-6989586621690396411"><span class="hs-identifier hs-var hs-var">popEventsBatch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-236"></span><span>      </span><span class="hs-comment">{-
        SELECT FOR UPDATE .. SKIP LOCKED can throw serialization errors in RepeatableRead: https://stackoverflow.com/a/53289263/1911889
        We can avoid this safely by running it in ReadCommitted as Postgres will recheck the
        predicate condition if a row is updated concurrently: https://www.postgresql.org/docs/9.5/transaction-iso.html#XACT-READ-COMMITTED

        Every other action on an event_log row (like post-processing, archival, etc) are single writes (no R-W or W-R)
        so it is safe to perform them in ReadCommitted as well (the writes will then acquire some serial order).
        Any serial order of updates to a row will lead to an eventually consistent state as the row will have
        (delivered=t or error=t or archived=t) after a fixed number of tries (assuming it begins with locked='f').
      -}</span><span>
</span><span id="line-246"></span><span>      </span><span id="local-6989586621690396407"><span class="annot"><span class="annottext">SourceCache
</span><a href="#local-6989586621690396407"><span class="hs-identifier hs-var">allSources</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; SourceCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#scSources"><span class="hs-identifier hs-var">scSources</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">IO SchemaCache
</span><a href="#local-6989586621690396422"><span class="hs-identifier hs-var">getSchemaCache</span></a></span><span>
</span><span id="line-247"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">concat</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-248"></span><span>        </span><span class="hs-comment">-- fetch pending events across all the sources asynchronously</span><span>
</span><span id="line-249"></span><span>        </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, MonadBaseControl IO m, Forall (Pure m)) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">LA.forConcurrently</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall k v. HashMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">SourceCache
</span><a href="#local-6989586621690396407"><span class="hs-identifier hs-var">allSources</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621690396401"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621690396401"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621690396400"><span class="annot"><span class="annottext">BackendSourceInfo
</span><a href="#local-6989586621690396400"><span class="hs-identifier hs-var">sourceCache</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-250"></span><span>          </span><span class="annot"><span class="annottext">forall (c :: BackendType -&gt; Constraint) (i :: BackendType -&gt; *) r.
AllBackendsSatisfy c =&gt;
AnyBackend i -&gt; (forall (b :: BackendType). c b =&gt; i b -&gt; r) -&gt; r
</span><a href="Hasura.SQL.AnyBackend.html#dispatchAnyBackend"><span class="hs-identifier hs-var">AB.dispatchAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.Backend.html#BackendEventTrigger"><span class="hs-identifier hs-type">BackendEventTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">BackendSourceInfo
</span><a href="#local-6989586621690396400"><span class="hs-identifier hs-var">sourceCache</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621690396350"><span class="annot"><a href="Hasura.RQL.Types.Source.html#SourceInfo"><span class="hs-identifier hs-type">SourceInfo</span></a></span><span> </span><span id="local-6989586621690396348"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621690396348"><span class="hs-identifier hs-var">_sourceName</span></a></span></span><span> </span><span id="local-6989586621690396347"><span class="annot"><span class="annottext">TableCache b
</span><a href="#local-6989586621690396347"><span class="hs-identifier hs-var">tableCache</span></a></span></span><span> </span><span id="local-6989586621690396346"><span class="annot"><span class="annottext">FunctionCache b
</span><a href="#local-6989586621690396346"><span class="hs-identifier hs-var">_functionCache</span></a></span></span><span> </span><span id="local-6989586621690396345"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621690396345"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621690396344"><span class="annot"><span class="annottext">Maybe QueryTagsConfig
</span><a href="#local-6989586621690396344"><span class="hs-identifier hs-var">_queryTagsConfig</span></a></span></span><span> </span><span id="local-6989586621690396343"><span class="annot"><span class="annottext">ResolvedSourceCustomization
</span><a href="#local-6989586621690396343"><span class="hs-identifier hs-var">_sourceCustomization</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#SourceInfo"><span class="hs-identifier hs-type">SourceInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690396350"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-251"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690396342"><span class="annot"><span class="annottext">tables :: [TableInfo b]
</span><a href="#local-6989586621690396342"><span class="hs-identifier hs-var hs-var">tables</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k v. HashMap k v -&gt; [v]
</span><span class="hs-identifier hs-var">M.elems</span></span><span> </span><span class="annot"><span class="annottext">TableCache b
</span><a href="#local-6989586621690396347"><span class="hs-identifier hs-var">tableCache</span></a></span><span>
</span><span id="line-252"></span><span>                </span><span id="local-6989586621690396340"><span class="annot"><span class="annottext">triggerMap :: [EventTriggerInfoMap b]
</span><a href="#local-6989586621690396340"><span class="hs-identifier hs-var hs-var">triggerMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType). TableInfo b -&gt; EventTriggerInfoMap b
</span><a href="Hasura.RQL.Types.Table.html#_tiEventTriggerInfoMap"><span class="hs-identifier hs-var">_tiEventTriggerInfoMap</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[TableInfo b]
</span><a href="#local-6989586621690396342"><span class="hs-identifier hs-var">tables</span></a></span><span>
</span><span id="line-253"></span><span>                </span><span id="local-6989586621690396338"><span class="annot"><span class="annottext">eventTriggerCount :: Int
</span><a href="#local-6989586621690396338"><span class="hs-identifier hs-var hs-var">eventTriggerCount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">sum</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall k v. HashMap k v -&gt; Int
</span><span class="hs-identifier hs-var">M.size</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[EventTriggerInfoMap b]
</span><a href="#local-6989586621690396340"><span class="hs-identifier hs-var">triggerMap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-254"></span><span>                </span><span id="local-6989586621690396335"><span class="annot"><span class="annottext">triggerNames :: [TriggerName]
</span><a href="#local-6989586621690396335"><span class="hs-identifier hs-var hs-var">triggerNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">concatMap</span></a></span><span> </span><span class="annot"><span class="annottext">forall k v. HashMap k v -&gt; [k]
</span><span class="hs-identifier hs-var">M.keys</span></span><span> </span><span class="annot"><span class="annottext">[EventTriggerInfoMap b]
</span><a href="#local-6989586621690396340"><span class="hs-identifier hs-var">triggerMap</span></a></span><span>
</span><span id="line-255"></span><span>
</span><span id="line-256"></span><span>            </span><span class="hs-comment">-- only process events for this source if at least one event trigger exists</span><span>
</span><span id="line-257"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621690396338"><span class="hs-identifier hs-var">eventTriggerCount</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-258"></span><span>              </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-259"></span><span>                </span><span id="local-6989586621690396331"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621690396331"><span class="hs-identifier hs-var">eventPollStartTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/time-1.11.1.1/src"><span class="hs-identifier hs-var">getCurrentTime</span></a></span><span>
</span><span id="line-260"></span><span>                </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/transformers-0.5.6.2/src"><span class="hs-identifier hs-var">runExceptT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (b :: BackendType) (m :: * -&gt; *).
(BackendEventTrigger b, MonadIO m, MonadError QErr m) =&gt;
SourceConfig b
-&gt; SourceName
-&gt; [TriggerName]
-&gt; MaintenanceMode ()
-&gt; FetchBatchSize
-&gt; m [Event b]
</span><a href="Hasura.RQL.Types.Eventing.Backend.html#fetchUndeliveredEvents"><span class="hs-identifier hs-var">fetchUndeliveredEvents</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621690396350"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621690396345"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621690396401"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">[TriggerName]
</span><a href="#local-6989586621690396335"><span class="hs-identifier hs-var">triggerNames</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode ()
</span><a href="#local-6989586621690396413"><span class="hs-identifier hs-var">maintenanceMode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; FetchBatchSize
</span><a href="Hasura.RQL.Types.EventTrigger.html#FetchBatchSize"><span class="hs-identifier hs-var">FetchBatchSize</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621690396408"><span class="hs-identifier hs-var">fetchBatchSize</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-261"></span><span>                  </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621690396326"><span class="annot"><span class="annottext">[Event b]
</span><a href="#local-6989586621690396326"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-262"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[Event b]
</span><a href="#local-6989586621690396326"><span class="hs-identifier hs-var">events</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-263"></span><span>                      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-264"></span><span>                      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-265"></span><span>                        </span><span id="local-6989586621690396324"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621690396324"><span class="hs-identifier hs-var">eventsFetchedTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/time-1.11.1.1/src"><span class="hs-identifier hs-var">getCurrentTime</span></a></span><span> </span><span class="hs-comment">-- This is also the poll end time</span><span>
</span><span id="line-266"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690396323"><span class="annot"><span class="annottext">eventPollTime :: Double
</span><a href="#local-6989586621690396323"><span class="hs-identifier hs-var hs-var">eventPollTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (Real a, Fractional b) =&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">realToFrac</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; UTCTime -&gt; NominalDiffTime
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/time-1.11.1.1/src"><span class="hs-identifier hs-var">diffUTCTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621690396324"><span class="hs-identifier hs-var">eventsFetchedTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621690396331"><span class="hs-identifier hs-var">eventPollStartTime</span></a></span><span>
</span><span id="line-267"></span><span>                        </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Distribution -&gt; Double -&gt; IO ()
</span><span class="hs-identifier hs-var">EKG.Distribution.add</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerMetrics -&gt; Distribution
</span><a href="Hasura.Server.Metrics.html#smEventFetchTimePerBatch"><span class="hs-identifier hs-var">smEventFetchTimePerBatch</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621690396415"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621690396323"><span class="hs-identifier hs-var">eventPollTime</span></a></span><span>
</span><span id="line-268"></span><span>                        </span><span class="annot"><span class="annottext">Histogram -&gt; Double -&gt; IO ()
</span><span class="hs-identifier hs-var">Prometheus.Histogram.observe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerMetrics -&gt; Histogram
</span><a href="Hasura.Server.Prometheus.html#eventsFetchTimePerBatch"><span class="hs-identifier hs-var">eventsFetchTimePerBatch</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerMetrics
</span><a href="#local-6989586621690396414"><span class="hs-identifier hs-var">eventTriggerMetrics</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621690396323"><span class="hs-identifier hs-var">eventPollTime</span></a></span><span>
</span><span id="line-269"></span><span>                        </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Distribution -&gt; Double -&gt; IO ()
</span><span class="hs-identifier hs-var">EKG.Distribution.add</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerMetrics -&gt; Distribution
</span><a href="Hasura.Server.Metrics.html#smNumEventsFetchedPerBatch"><span class="hs-identifier hs-var">smNumEventsFetchedPerBatch</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621690396415"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">[Event b]
</span><a href="#local-6989586621690396326"><span class="hs-identifier hs-var">events</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>                        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadIO m =&gt;
SourceName
-&gt; [EventId] -&gt; TVar (HashMap SourceName (Set EventId)) -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#saveLockedEventTriggerEvents"><span class="hs-identifier hs-var">saveLockedEventTriggerEvents</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621690396401"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Event b]
</span><a href="#local-6989586621690396326"><span class="hs-identifier hs-var">events</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621690396417"><span class="hs-identifier hs-var">leEvents</span></a></span><span>
</span><span id="line-271"></span><span>                        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621690396314"><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690396314"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
i b -&gt; AnyBackend i
</span><a href="Hasura.SQL.AnyBackend.html#mkAnyBackend"><span class="hs-identifier hs-var">AB.mkAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621690396350"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType).
Event b
-&gt; SourceConfig b -&gt; SourceName -&gt; UTCTime -&gt; EventWithSource b
</span><a href="Hasura.RQL.Types.EventTrigger.html#EventWithSource"><span class="hs-identifier hs-var">EventWithSource</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690396314"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621690396345"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621690396401"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621690396324"><span class="hs-identifier hs-var">eventsFetchedTime</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Event b]
</span><a href="#local-6989586621690396326"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-272"></span><span>                  </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621690396311"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621690396311"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-273"></span><span>                    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">L.unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621690396424"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; EventInternalErr
</span><a href="Hasura.Eventing.EventTrigger.html#EventInternalErr"><span class="hs-identifier hs-var">EventInternalErr</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621690396311"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-274"></span><span>                    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-275"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-276"></span><span>
</span><span id="line-277"></span><span>    </span><span class="hs-comment">-- !!! CAREFUL !!!</span><span>
</span><span id="line-278"></span><span>    </span><span class="hs-comment">--     The logic here in particular is subtle and has been fixed, broken,</span><span>
</span><span id="line-279"></span><span>    </span><span class="hs-comment">--     and fixed again in several different ways, several times.</span><span>
</span><span id="line-280"></span><span>    </span><span class="hs-comment">-- !!! CAREFUL !!!</span><span>
</span><span id="line-281"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-282"></span><span>    </span><span class="hs-comment">-- work on this batch of events while prefetching the next. Recurse after we've forked workers</span><span>
</span><span id="line-283"></span><span>    </span><span class="hs-comment">-- for each in the batch, minding the requested pool size.</span><span>
</span><span id="line-284"></span><span>    </span><span class="annot"><a href="#local-6989586621690396409"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#FetchEventArguments"><span class="hs-identifier hs-type">FetchEventArguments</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621690397370"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#FetchEventArguments"><span class="hs-identifier hs-type">FetchEventArguments</span></a></span><span>
</span><span id="line-285"></span><span>    </span><span id="local-6989586621690396409"><span class="annot"><span class="annottext">go :: FetchEventArguments -&gt; m FetchEventArguments
</span><a href="#local-6989586621690396409"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621690396309"><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621690396309"><span class="hs-identifier hs-var">events</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621690396308"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621690396308"><span class="hs-identifier hs-var">fullFetchCount</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621690396307"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621690396307"><span class="hs-identifier hs-var">alreadyWarned</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-286"></span><span>      </span><span class="hs-comment">-- process events ASAP until we've caught up; only then can we sleep</span><span>
</span><span id="line-287"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621690396309"><span class="hs-identifier hs-var">events</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; IO ()
</span><a href="Control.Concurrent.Extended.html#sleep"><span class="hs-identifier hs-var">sleep</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621690396420"><span class="hs-identifier hs-var">_eeCtxFetchInterval</span></a></span><span>
</span><span id="line-288"></span><span>
</span><span id="line-289"></span><span>      </span><span class="hs-comment">-- Prefetch next events payload while concurrently working through our current batch.</span><span>
</span><span id="line-290"></span><span>      </span><span class="hs-comment">-- NOTE: we probably don't need to prefetch so early, but probably not</span><span>
</span><span id="line-291"></span><span>      </span><span class="hs-comment">-- worth the effort for something more fine-tuned</span><span>
</span><span id="line-292"></span><span>      </span><span id="local-6989586621690396305"><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621690396305"><span class="hs-identifier hs-var">eventsNext</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
(MonadBaseControl IO m, Forall (Pure m)) =&gt;
m a -&gt; (Async a -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">LA.withAsync</span></span><span> </span><span class="annot"><span class="annottext">m [BackendEventWithSource]
</span><a href="#local-6989586621690396411"><span class="hs-identifier hs-var">popEventsBatch</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621690396303"><span class="annot"><span class="annottext">Async [BackendEventWithSource]
</span><a href="#local-6989586621690396303"><span class="hs-identifier hs-var">eventsNextA</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-293"></span><span>        </span><span class="hs-comment">-- process approximately in order, minding HASURA_GRAPHQL_EVENTS_HTTP_POOL_SIZE:</span><span>
</span><span id="line-294"></span><span>        </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621690396309"><span class="hs-identifier hs-var">events</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621690396301"><span class="annot"><span class="annottext">BackendEventWithSource
</span><a href="#local-6989586621690396301"><span class="hs-identifier hs-var">eventWithSource</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-295"></span><span>          </span><span class="hs-comment">-- NOTE: we implement a logical bracket pattern here with the</span><span>
</span><span id="line-296"></span><span>          </span><span class="hs-comment">-- increment and decrement of _eeCtxEventThreadsCapacity which</span><span>
</span><span id="line-297"></span><span>          </span><span class="hs-comment">-- depends on not putting anything that can throw in the body here:</span><span>
</span><span id="line-298"></span><span>          </span><span class="annot"><span class="annottext">forall (c :: BackendType -&gt; Constraint) (i :: BackendType -&gt; *) r.
AllBackendsSatisfy c =&gt;
AnyBackend i -&gt; (forall (b :: BackendType). c b =&gt; i b -&gt; r) -&gt; r
</span><a href="Hasura.SQL.AnyBackend.html#dispatchAnyBackend"><span class="hs-identifier hs-var">AB.dispatchAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.Backend.html#BackendEventTrigger"><span class="hs-identifier hs-type">BackendEventTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">BackendEventWithSource
</span><a href="#local-6989586621690396301"><span class="hs-identifier hs-var">eventWithSource</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621690396268"><span id="local-6989586621690396267"><span class="annot"><span class="annottext">EventWithSource b
</span><a href="#local-6989586621690396267"><span class="hs-identifier hs-var">eventWithSource'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventWithSource"><span class="hs-identifier hs-type">EventWithSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690396268"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-299"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadMask m =&gt; m a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/exceptions-0.10.4/src"><span class="hs-identifier hs-var">mask_</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-300"></span><span>              </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-301"></span><span>                </span><span class="annot"><span class="annottext">forall a. STM a -&gt; IO a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-302"></span><span>                  </span><span class="hs-comment">-- block until &lt; HASURA_GRAPHQL_EVENTS_HTTP_POOL_SIZE threads:</span><span>
</span><span id="line-303"></span><span>                  </span><span id="local-6989586621690396266"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621690396266"><span class="hs-identifier hs-var">capacity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. TVar a -&gt; STM a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar Int
</span><a href="#local-6989586621690396421"><span class="hs-identifier hs-var">_eeCtxEventThreadsCapacity</span></a></span><span>
</span><span id="line-304"></span><span>                  </span><span class="annot"><span class="annottext">Bool -&gt; STM ()
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/stm-2.5.0.2/src"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621690396266"><span class="hs-identifier hs-var">capacity</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-305"></span><span>                  </span><span class="annot"><span class="annottext">forall a. TVar a -&gt; a -&gt; STM ()
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">writeTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar Int
</span><a href="#local-6989586621690396421"><span class="hs-identifier hs-var">_eeCtxEventThreadsCapacity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621690396266"><span class="hs-identifier hs-var">capacity</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-306"></span><span>              </span><span class="hs-comment">-- since there is some capacity in our worker threads, we can launch another:</span><span>
</span><span id="line-307"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690396264"><span class="annot"><span class="annottext">restoreCapacity :: ReaderT (Logger Hasura, Manager) m ()
</span><a href="#local-6989586621690396264"><span class="hs-identifier hs-var hs-var">restoreCapacity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-308"></span><span>                    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-309"></span><span>                      </span><span class="annot"><span class="annottext">forall a. STM a -&gt; IO a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-310"></span><span>                        </span><span class="annot"><span class="annottext">forall a. TVar a -&gt; (a -&gt; a) -&gt; STM ()
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/stm-2.5.0.2/src"><span class="hs-identifier hs-var">modifyTVar'</span></a></span><span> </span><span class="annot"><span class="annottext">TVar Int
</span><a href="#local-6989586621690396421"><span class="hs-identifier hs-var">_eeCtxEventThreadsCapacity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-311"></span><span>              </span><span id="local-6989586621690396261"><span class="annot"><span class="annottext">Async ()
</span><a href="#local-6989586621690396261"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-312"></span><span>                </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadBaseControl IO m, Forall (Pure m)) =&gt;
m a -&gt; m (Async a)
</span><span class="hs-identifier hs-var">LA.async</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-313"></span><span>                  </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/transformers-0.5.6.2/src"><span class="hs-identifier hs-var">runReaderT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621690396424"><span class="hs-identifier hs-var">logger</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621690396423"><span class="hs-identifier hs-var">httpMgr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-314"></span><span>                    </span><span class="annot"><span class="annottext">forall (io :: * -&gt; *) r (b :: BackendType).
(MonadIO io, MonadReader r io, Has Manager r,
 Has (Logger Hasura) r, HasReporter io, MonadMask io,
 BackendEventTrigger b) =&gt;
EventWithSource b -&gt; io ()
</span><a href="#local-6989586621690396257"><span class="hs-identifier hs-var">processEvent</span></a></span><span> </span><span class="annot"><span class="annottext">EventWithSource b
</span><a href="#local-6989586621690396267"><span class="hs-identifier hs-var">eventWithSource'</span></a></span><span>
</span><span id="line-315"></span><span>                      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. MonadMask m =&gt; m a -&gt; m b -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/exceptions-0.10.4/src"><span class="hs-operator hs-var">`finally`</span></a></span><span>
</span><span id="line-316"></span><span>                      </span><span class="hs-comment">-- NOTE!: this needs to happen IN THE FORKED THREAD:</span><span>
</span><span id="line-317"></span><span>                      </span><span class="annot"><span class="annottext">ReaderT (Logger Hasura, Manager) m ()
</span><a href="#local-6989586621690396264"><span class="hs-identifier hs-var">restoreCapacity</span></a></span><span>
</span><span id="line-318"></span><span>              </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadBase IO m =&gt; Async a -&gt; m ()
</span><span class="hs-identifier hs-var">LA.link</span></span><span> </span><span class="annot"><span class="annottext">Async ()
</span><a href="#local-6989586621690396261"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span>        </span><span class="hs-comment">-- return when next batch ready; some 'processEvent' threads may be running.</span><span>
</span><span id="line-321"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadBase IO m, Forall (Pure m)) =&gt;
Async a -&gt; m a
</span><span class="hs-identifier hs-var">LA.wait</span></span><span> </span><span class="annot"><span class="annottext">Async [BackendEventWithSource]
</span><a href="#local-6989586621690396303"><span class="hs-identifier hs-var">eventsNextA</span></a></span><span>
</span><span id="line-322"></span><span>
</span><span id="line-323"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690396254"><span class="annot"><span class="annottext">lenEvents :: Int
</span><a href="#local-6989586621690396254"><span class="hs-identifier hs-var hs-var">lenEvents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621690396309"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-324"></span><span>      </span><span class="hs-keyword">if</span><span>
</span><span id="line-325"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621690396254"><span class="hs-identifier hs-var">lenEvents</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621690396408"><span class="hs-identifier hs-var">fetchBatchSize</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-326"></span><span>              </span><span class="hs-comment">-- If we've seen N fetches in a row from the DB come back full (i.e. only limited</span><span>
</span><span id="line-327"></span><span>              </span><span class="hs-comment">-- by our LIMIT clause), then we say we're clearly falling behind:</span><span>
</span><span id="line-328"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690396253"><span class="annot"><span class="annottext">clearlyBehind :: Bool
</span><a href="#local-6989586621690396253"><span class="hs-identifier hs-var hs-var">clearlyBehind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621690396308"><span class="hs-identifier hs-var">fullFetchCount</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">3</span></span><span>
</span><span id="line-329"></span><span>              </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621690396307"><span class="hs-identifier hs-var">alreadyWarned</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-330"></span><span>                </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621690396253"><span class="hs-identifier hs-var">clearlyBehind</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-331"></span><span>                  </span><span class="annot"><span class="annottext">forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">L.unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621690396424"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-332"></span><span>                    </span><span class="annot"><span class="annottext">LogLevel -&gt; SerializableBlob -&gt; UnstructuredLog
</span><a href="Hasura.Logging.html#UnstructuredLog"><span class="hs-identifier hs-var">L.UnstructuredLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelWarn"><span class="hs-identifier hs-var">L.LevelWarn</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-333"></span><span>                      </span><span class="annot"><span class="annottext">forall a. IsString a =&gt; String -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fromString</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-334"></span><span>                        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Events processor may not be keeping up with events generated in postgres, &quot;</span></span><span>
</span><span id="line-335"></span><span>                          </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;or we're working on a backlog of events. Consider increasing &quot;</span></span><span>
</span><span id="line-336"></span><span>                          </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;HASURA_GRAPHQL_EVENTS_HTTP_POOL_SIZE&quot;</span></span><span>
</span><span id="line-337"></span><span>              </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621690396305"><span class="hs-identifier hs-var">eventsNext</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621690396308"><span class="hs-identifier hs-var">fullFetchCount</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621690396307"><span class="hs-identifier hs-var">alreadyWarned</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">||</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621690396253"><span class="hs-identifier hs-var">clearlyBehind</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-338"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-339"></span><span>              </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621690396254"><span class="hs-identifier hs-var">lenEvents</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621690396408"><span class="hs-identifier hs-var">fetchBatchSize</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621690396307"><span class="hs-identifier hs-var">alreadyWarned</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-340"></span><span>                </span><span class="hs-comment">-- emit as warning in case users are only logging warning severity and saw above</span><span>
</span><span id="line-341"></span><span>                </span><span class="annot"><span class="annottext">forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">L.unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621690396424"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-342"></span><span>                  </span><span class="annot"><span class="annottext">LogLevel -&gt; SerializableBlob -&gt; UnstructuredLog
</span><a href="Hasura.Logging.html#UnstructuredLog"><span class="hs-identifier hs-var">L.UnstructuredLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelWarn"><span class="hs-identifier hs-var">L.LevelWarn</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-343"></span><span>                    </span><span class="annot"><span class="annottext">forall a. IsString a =&gt; String -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fromString</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-344"></span><span>                      </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;It looks like the events processor is keeping up again.&quot;</span></span><span>
</span><span id="line-345"></span><span>              </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[BackendEventWithSource]
</span><a href="#local-6989586621690396305"><span class="hs-identifier hs-var">eventsNext</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-346"></span><span>
</span><span id="line-347"></span><span>    </span><span class="annot"><a href="#local-6989586621690396257"><span class="hs-identifier hs-type">processEvent</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-348"></span><span>      </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621690397203"><span class="annot"><a href="#local-6989586621690397203"><span class="hs-identifier hs-type">io</span></a></span></span><span> </span><span id="local-6989586621690397202"><span class="annot"><a href="#local-6989586621690397202"><span class="hs-identifier hs-type">r</span></a></span></span><span> </span><span id="local-6989586621690397201"><span class="annot"><a href="#local-6989586621690397201"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-349"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397203"><span class="hs-identifier hs-type">io</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-350"></span><span>        </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/mtl-2.2.2/src"><span class="hs-identifier hs-type">MonadReader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397202"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397203"><span class="hs-identifier hs-type">io</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-351"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Has</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HTTP.Manager</span></span><span> </span><span class="annot"><a href="#local-6989586621690397202"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-352"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Has</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">L.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621690397202"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-353"></span><span>        </span><span class="annot"><a href="Hasura.Tracing.html#HasReporter"><span class="hs-identifier hs-type">Tracing.HasReporter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397203"><span class="hs-identifier hs-type">io</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-354"></span><span>        </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/exceptions-0.10.4/src"><span class="hs-identifier hs-type">MonadMask</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397203"><span class="hs-identifier hs-type">io</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-355"></span><span>        </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.Backend.html#BackendEventTrigger"><span class="hs-identifier hs-type">BackendEventTrigger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397201"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-356"></span><span>      </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-357"></span><span>      </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventWithSource"><span class="hs-identifier hs-type">EventWithSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397201"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-358"></span><span>      </span><span class="annot"><a href="#local-6989586621690397203"><span class="hs-identifier hs-type">io</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-359"></span><span>    </span><span id="local-6989586621690396257"><span class="annot"><span class="annottext">processEvent :: forall (io :: * -&gt; *) r (b :: BackendType).
(MonadIO io, MonadReader r io, Has Manager r,
 Has (Logger Hasura) r, HasReporter io, MonadMask io,
 BackendEventTrigger b) =&gt;
EventWithSource b -&gt; io ()
</span><a href="#local-6989586621690396257"><span class="hs-identifier hs-var hs-var">processEvent</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventWithSource"><span class="hs-identifier hs-type">EventWithSource</span></a></span><span> </span><span id="local-6989586621690396095"><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690396095"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621690396094"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621690396094"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621690396093"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621690396093"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span> </span><span id="local-6989586621690396092"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621690396092"><span class="hs-identifier hs-var">eventFetchedTime</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-360"></span><span>      </span><span class="hs-comment">-- Track Queue Time of Event (in seconds). See `smEventQueueTime`</span><span>
</span><span id="line-361"></span><span>      </span><span class="hs-comment">-- Queue Time = Time when the event was fetched from DB - Time when the event is being processed</span><span>
</span><span id="line-362"></span><span>      </span><span id="local-6989586621690396091"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621690396091"><span class="hs-identifier hs-var">eventProcessTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/time-1.11.1.1/src"><span class="hs-identifier hs-var">getCurrentTime</span></a></span><span>
</span><span id="line-363"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690396090"><span class="annot"><span class="annottext">eventQueueTime :: Double
</span><a href="#local-6989586621690396090"><span class="hs-identifier hs-var hs-var">eventQueueTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (Real a, Fractional b) =&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">realToFrac</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; UTCTime -&gt; NominalDiffTime
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/time-1.11.1.1/src"><span class="hs-identifier hs-var">diffUTCTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621690396091"><span class="hs-identifier hs-var">eventProcessTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621690396092"><span class="hs-identifier hs-var">eventFetchedTime</span></a></span><span>
</span><span id="line-364"></span><span>      </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Distribution -&gt; Double -&gt; IO ()
</span><span class="hs-identifier hs-var">EKG.Distribution.add</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerMetrics -&gt; Distribution
</span><a href="Hasura.Server.Metrics.html#smEventQueueTime"><span class="hs-identifier hs-var">smEventQueueTime</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621690396415"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621690396090"><span class="hs-identifier hs-var">eventQueueTime</span></a></span><span>
</span><span id="line-365"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Histogram -&gt; Double -&gt; IO ()
</span><span class="hs-identifier hs-var">Prometheus.Histogram.observe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerMetrics -&gt; Histogram
</span><a href="Hasura.Server.Prometheus.html#eventQueueTimeSeconds"><span class="hs-identifier hs-var">eventQueueTimeSeconds</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerMetrics
</span><a href="#local-6989586621690396414"><span class="hs-identifier hs-var">eventTriggerMetrics</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621690396090"><span class="hs-identifier hs-var">eventQueueTime</span></a></span><span>
</span><span id="line-366"></span><span>
</span><span id="line-367"></span><span>      </span><span id="local-6989586621690396087"><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621690396087"><span class="hs-identifier hs-var">cache</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">IO SchemaCache
</span><a href="#local-6989586621690396422"><span class="hs-identifier hs-var">getSchemaCache</span></a></span><span>
</span><span id="line-368"></span><span>
</span><span id="line-369"></span><span>      </span><span id="local-6989586621690396086"><span class="annot"><span class="annottext">Maybe TraceContext
</span><a href="#local-6989586621690396086"><span class="hs-identifier hs-var">tracingCtx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Value -&gt; IO (Maybe TraceContext)
</span><a href="Hasura.Tracing.html#extractEventContext"><span class="hs-identifier hs-var">Tracing.extractEventContext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (b :: BackendType). Event b -&gt; Value
</span><a href="Hasura.RQL.Types.EventTrigger.html#eEvent"><span class="hs-identifier hs-var">eEvent</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690396095"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-370"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690396079"><span class="annot"><span class="annottext">spanName :: EventTriggerInfo b -&gt; Text
</span><a href="#local-6989586621690396079"><span class="hs-identifier hs-var hs-var">spanName</span></a></span></span><span> </span><span id="local-6989586621690396078"><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621690396078"><span class="hs-identifier hs-var">eti</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Event trigger: &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmptyText -&gt; Text
</span><a href="Data.Text.NonEmpty.html#unNonEmptyText"><span class="hs-identifier hs-var">unNonEmptyText</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TriggerName -&gt; NonEmptyText
</span><a href="Hasura.RQL.Types.EventTrigger.html#unTriggerName"><span class="hs-identifier hs-var">unTriggerName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (b :: BackendType). EventTriggerInfo b -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiName"><span class="hs-identifier hs-var">etiName</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621690396078"><span class="hs-identifier hs-var">eti</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-371"></span><span>          </span><span id="local-6989586621690396074"><span class="annot"><span class="annottext">runTraceT :: Text -&gt; TraceT io () -&gt; io ()
</span><a href="#local-6989586621690396074"><span class="hs-identifier hs-var hs-var">runTraceT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-372"></span><span>            </span><span class="annot"><span class="annottext">forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">maybe</span></a></span><span>
</span><span id="line-373"></span><span>              </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(HasReporter m, MonadIO m) =&gt;
Text -&gt; TraceT m a -&gt; m a
</span><a href="Hasura.Tracing.html#runTraceT"><span class="hs-identifier hs-var">Tracing.runTraceT</span></a></span><span>
</span><span id="line-374"></span><span>              </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, HasReporter m) =&gt;
TraceContext -&gt; Text -&gt; TraceT m a -&gt; m a
</span><a href="Hasura.Tracing.html#runTraceTInContext"><span class="hs-identifier hs-var">Tracing.runTraceTInContext</span></a></span><span>
</span><span id="line-375"></span><span>              </span><span class="annot"><span class="annottext">Maybe TraceContext
</span><a href="#local-6989586621690396086"><span class="hs-identifier hs-var">tracingCtx</span></a></span><span>
</span><span id="line-376"></span><span>
</span><span id="line-377"></span><span>      </span><span id="local-6989586621690396070"><span class="annot"><span class="annottext">Either QErr (MaintenanceMode MaintenanceModeVersion)
</span><a href="#local-6989586621690396070"><span class="hs-identifier hs-var">maintenanceModeVersionEither</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-378"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MaintenanceMode ()
</span><a href="#local-6989586621690396413"><span class="hs-identifier hs-var">maintenanceMode</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-379"></span><span>          </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-type">MaintenanceModeEnabled</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-380"></span><span>            </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/transformers-0.5.6.2/src"><span class="hs-identifier hs-var">runExceptT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (b :: BackendType) (m :: * -&gt; *).
(BackendEventTrigger b, MonadIO m, MonadError QErr m) =&gt;
SourceConfig b -&gt; m MaintenanceModeVersion
</span><a href="Hasura.RQL.Types.Eventing.Backend.html#getMaintenanceModeVersion"><span class="hs-identifier hs-var">getMaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621690397201"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621690396094"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;&amp;&gt;</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-381"></span><span>              </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621690396066"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621690396066"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621690396066"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-382"></span><span>              </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621690396065"><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="#local-6989586621690396065"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a b. b -&gt; Either a b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; MaintenanceMode a
</span><a href="Hasura.Server.Types.html#MaintenanceModeEnabled"><span class="hs-identifier hs-var">MaintenanceModeEnabled</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceModeVersion
</span><a href="#local-6989586621690396065"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-383"></span><span>          </span><span class="annot"><span class="annottext">MaintenanceMode ()
</span><a href="Hasura.Server.Types.html#MaintenanceModeDisabled"><span class="hs-identifier hs-var">MaintenanceModeDisabled</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. b -&gt; Either a b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. MaintenanceMode a
</span><a href="Hasura.Server.Types.html#MaintenanceModeDisabled"><span class="hs-identifier hs-var">MaintenanceModeDisabled</span></a></span><span>
</span><span id="line-384"></span><span>
</span><span id="line-385"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either QErr (MaintenanceMode MaintenanceModeVersion)
</span><a href="#local-6989586621690396070"><span class="hs-identifier hs-var">maintenanceModeVersionEither</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-386"></span><span>        </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621690396063"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621690396063"><span class="hs-identifier hs-var">maintenanceModeVersionErr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall r (m :: * -&gt; *).
(MonadReader r m, Has (Logger Hasura) r, MonadIO m) =&gt;
QErr -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier hs-var">logQErr</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621690396063"><span class="hs-identifier hs-var">maintenanceModeVersionErr</span></a></span><span>
</span><span id="line-387"></span><span>        </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621690396062"><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621690396062"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-388"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType).
Backend b =&gt;
SchemaCache -&gt; Event b -&gt; Either Text (EventTriggerInfo b)
</span><a href="Hasura.Eventing.EventTrigger.html#getEventTriggerInfoFromEvent"><span class="hs-identifier hs-var">getEventTriggerInfoFromEvent</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621690396087"><span class="hs-identifier hs-var">cache</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690396095"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-389"></span><span>            </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621690396060"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621690396060"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-390"></span><span>              </span><span class="hs-comment">--  This rare error can happen in the following known cases:</span><span>
</span><span id="line-391"></span><span>              </span><span class="hs-comment">--  i) schema cache is not up-to-date (due to some bug, say during schema syncing across multiple instances)</span><span>
</span><span id="line-392"></span><span>              </span><span class="hs-comment">--  ii) the event trigger is dropped when this event was just fetched</span><span>
</span><span id="line-393"></span><span>              </span><span class="annot"><span class="annottext">forall r (m :: * -&gt; *).
(MonadReader r m, Has (Logger Hasura) r, MonadIO m) =&gt;
QErr -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier hs-var">logQErr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; QErr
</span><a href="Hasura.Base.Error.html#err500"><span class="hs-identifier hs-var">err500</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#Unexpected"><span class="hs-identifier hs-var">Unexpected</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621690396060"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-394"></span><span>              </span><span id="local-6989586621690396057"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621690396057"><span class="hs-identifier hs-var">currentTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/time-1.11.1.1/src"><span class="hs-identifier hs-var">getCurrentTime</span></a></span><span>
</span><span id="line-395"></span><span>              </span><span class="hs-comment">-- For such an event, we unlock the event and retry after a minute</span><span>
</span><span id="line-396"></span><span>              </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/transformers-0.5.6.2/src"><span class="hs-identifier hs-var">runExceptT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (b :: BackendType) (m :: * -&gt; *).
(BackendEventTrigger b, MonadIO m, MonadError QErr m) =&gt;
SourceConfig b
-&gt; Event b
-&gt; UTCTime
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m ()
</span><a href="Hasura.RQL.Types.Eventing.Backend.html#setRetry"><span class="hs-identifier hs-var">setRetry</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621690396094"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690396095"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NominalDiffTime -&gt; UTCTime -&gt; UTCTime
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/time-1.11.1.1/src"><span class="hs-identifier hs-var">addUTCTime</span></a></span><span> </span><span class="annot"><span class="annottext">NominalDiffTime
</span><span class="hs-number">60</span></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621690396057"><span class="hs-identifier hs-var">currentTime</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621690396062"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-397"></span><span>                </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.2.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">onLeft</span></a></span><span> </span><span class="annot"><span class="annottext">forall r (m :: * -&gt; *).
(MonadReader r m, Has (Logger Hasura) r, MonadIO m) =&gt;
QErr -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier hs-var">logQErr</span></a></span><span>
</span><span id="line-398"></span><span>            </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621690396053"><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621690396053"><span class="hs-identifier hs-var">eti</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; TraceT io () -&gt; io ()
</span><a href="#local-6989586621690396074"><span class="hs-identifier hs-var">runTraceT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall {b :: BackendType}. EventTriggerInfo b -&gt; Text
</span><a href="#local-6989586621690396079"><span class="hs-identifier hs-var">spanName</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621690396053"><span class="hs-identifier hs-var">eti</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-399"></span><span>              </span><span id="local-6989586621690396052"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621690396052"><span class="hs-identifier hs-var">eventExecutionStartTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/time-1.11.1.1/src"><span class="hs-identifier hs-var">getCurrentTime</span></a></span><span>
</span><span id="line-400"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690396051"><span class="annot"><span class="annottext">webhook :: EnvRecord ResolvedWebhook
</span><a href="#local-6989586621690396051"><span class="hs-identifier hs-var hs-var">webhook</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WebhookConfInfo -&gt; EnvRecord ResolvedWebhook
</span><a href="Hasura.RQL.Types.EventTrigger.html#wciCachedValue"><span class="hs-identifier hs-var">wciCachedValue</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType). EventTriggerInfo b -&gt; WebhookConfInfo
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiWebhookInfo"><span class="hs-identifier hs-var">etiWebhookInfo</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621690396053"><span class="hs-identifier hs-var">eti</span></a></span><span>
</span><span id="line-401"></span><span>                  </span><span id="local-6989586621690396048"><span class="annot"><span class="annottext">retryConf :: RetryConf
</span><a href="#local-6989586621690396048"><span class="hs-identifier hs-var hs-var">retryConf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType). EventTriggerInfo b -&gt; RetryConf
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiRetryConf"><span class="hs-identifier hs-var">etiRetryConf</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621690396053"><span class="hs-identifier hs-var">eti</span></a></span><span>
</span><span id="line-402"></span><span>                  </span><span id="local-6989586621690396046"><span class="annot"><span class="annottext">timeoutSeconds :: Int
</span><a href="#local-6989586621690396046"><span class="hs-identifier hs-var hs-var">timeoutSeconds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#defaultTimeoutSeconds"><span class="hs-identifier hs-var">defaultTimeoutSeconds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RetryConf -&gt; Maybe Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#rcTimeoutSec"><span class="hs-identifier hs-var">rcTimeoutSec</span></a></span><span> </span><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621690396048"><span class="hs-identifier hs-var">retryConf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-403"></span><span>                  </span><span id="local-6989586621690396042"><span class="annot"><span class="annottext">httpTimeout :: ResponseTimeout
</span><a href="#local-6989586621690396042"><span class="hs-identifier hs-var hs-var">httpTimeout</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ResponseTimeout
</span><span class="hs-identifier hs-var">HTTP.responseTimeoutMicro</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621690396046"><span class="hs-identifier hs-var">timeoutSeconds</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1000000</span></span><span class="hs-special">)</span><span>
</span><span id="line-404"></span><span>                  </span><span class="hs-special">(</span><span id="local-6989586621690396039"><span class="annot"><span class="annottext">[Header]
</span><a href="#local-6989586621690396039"><span class="hs-identifier hs-var">headers</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621690396038"><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621690396038"><span class="hs-identifier hs-var">logHeaders</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[EventHeaderInfo] -&gt; ([Header], [HeaderConf])
</span><a href="Hasura.Eventing.HTTP.html#prepareHeaders"><span class="hs-identifier hs-var">prepareHeaders</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (b :: BackendType). EventTriggerInfo b -&gt; [EventHeaderInfo]
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiHeaders"><span class="hs-identifier hs-var">etiHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621690396053"><span class="hs-identifier hs-var">eti</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-405"></span><span>                  </span><span id="local-6989586621690396035"><span class="annot"><span class="annottext">ep :: EventPayload b
</span><a href="#local-6989586621690396035"><span class="hs-identifier hs-var hs-var">ep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType). RetryConf -&gt; Event b -&gt; EventPayload b
</span><a href="Hasura.Eventing.EventTrigger.html#createEventPayload"><span class="hs-identifier hs-var">createEventPayload</span></a></span><span> </span><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621690396048"><span class="hs-identifier hs-var">retryConf</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690396095"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-406"></span><span>                  </span><span id="local-6989586621690396033"><span class="annot"><span class="annottext">payload :: ByteString
</span><a href="#local-6989586621690396033"><span class="hs-identifier hs-var hs-var">payload</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">J.encode</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">J.toJSON</span></span><span> </span><span class="annot"><span class="annottext">EventPayload b
</span><a href="#local-6989586621690396035"><span class="hs-identifier hs-var">ep</span></a></span><span>
</span><span id="line-407"></span><span>                  </span><span id="local-6989586621690396031"><span class="annot"><span class="annottext">extraLogCtx :: ExtraLogContext
</span><a href="#local-6989586621690396031"><span class="hs-identifier hs-var hs-var">extraLogCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventId -&gt; Maybe TriggerName -&gt; ExtraLogContext
</span><a href="Hasura.Eventing.HTTP.html#ExtraLogContext"><span class="hs-identifier hs-var">ExtraLogContext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (b :: BackendType). EventPayload b -&gt; EventId
</span><a href="Hasura.Eventing.EventTrigger.html#epId"><span class="hs-identifier hs-var">epId</span></a></span><span> </span><span class="annot"><span class="annottext">EventPayload b
</span><a href="#local-6989586621690396035"><span class="hs-identifier hs-var">ep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType). EventTriggerInfo b -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiName"><span class="hs-identifier hs-var">etiName</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621690396053"><span class="hs-identifier hs-var">eti</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-408"></span><span>                  </span><span id="local-6989586621690396029"><span class="annot"><span class="annottext">requestTransform :: Maybe RequestTransform
</span><a href="#local-6989586621690396029"><span class="hs-identifier hs-var hs-var">requestTransform</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType).
EventTriggerInfo b -&gt; Maybe RequestTransform
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiRequestTransform"><span class="hs-identifier hs-var">etiRequestTransform</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621690396053"><span class="hs-identifier hs-var">eti</span></a></span><span>
</span><span id="line-409"></span><span>                  </span><span id="local-6989586621690396027"><span class="annot"><span class="annottext">responseTransform :: Maybe ResponseTransform
</span><a href="#local-6989586621690396027"><span class="hs-identifier hs-var hs-var">responseTransform</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MetadataResponseTransform -&gt; ResponseTransform
</span><a href="Hasura.RQL.DDL.Webhook.Transform.html#mkResponseTransform"><span class="hs-identifier hs-var">mkResponseTransform</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType).
EventTriggerInfo b -&gt; Maybe MetadataResponseTransform
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiResponseTransform"><span class="hs-identifier hs-var">etiResponseTransform</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo b
</span><a href="#local-6989586621690396053"><span class="hs-identifier hs-var">eti</span></a></span><span>
</span><span id="line-410"></span><span>              </span><span id="local-6989586621690396024"><span class="annot"><span class="annottext">Either
  (TransformableRequestError 'EventType)
  (Request, HTTPResp 'EventType)
</span><a href="#local-6989586621690396024"><span class="hs-identifier hs-var">eitherReqRes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-411"></span><span>                </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/transformers-0.5.6.2/src"><span class="hs-identifier hs-var">runExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-412"></span><span>                  </span><span class="annot"><span class="annottext">forall (a :: TriggerTypes) (m :: * -&gt; *).
MonadError (TransformableRequestError a) m =&gt;
[Header]
-&gt; ResponseTimeout
-&gt; ByteString
-&gt; Maybe RequestTransform
-&gt; ResolvedWebhook
-&gt; m RequestDetails
</span><a href="Hasura.Eventing.HTTP.html#mkRequest"><span class="hs-identifier hs-var">mkRequest</span></a></span><span> </span><span class="annot"><span class="annottext">[Header]
</span><a href="#local-6989586621690396039"><span class="hs-identifier hs-var">headers</span></a></span><span> </span><span class="annot"><span class="annottext">ResponseTimeout
</span><a href="#local-6989586621690396042"><span class="hs-identifier hs-var">httpTimeout</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621690396033"><span class="hs-identifier hs-var">payload</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe RequestTransform
</span><a href="#local-6989586621690396029"><span class="hs-identifier hs-var">requestTransform</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. EnvRecord a -&gt; a
</span><a href="Hasura.RQL.Types.Common.html#_envVarValue"><span class="hs-identifier hs-var">_envVarValue</span></a></span><span> </span><span class="annot"><span class="annottext">EnvRecord ResolvedWebhook
</span><a href="#local-6989586621690396051"><span class="hs-identifier hs-var">webhook</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621690396021"><span class="annot"><span class="annottext">RequestDetails
</span><a href="#local-6989586621690396021"><span class="hs-identifier hs-var">reqDetails</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-413"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690396020"><span class="annot"><span class="annottext">request :: Request
</span><a href="#local-6989586621690396020"><span class="hs-identifier hs-var hs-var">request</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RequestDetails -&gt; Request
</span><a href="Hasura.Eventing.HTTP.html#extractRequest"><span class="hs-identifier hs-var">extractRequest</span></a></span><span> </span><span class="annot"><span class="annottext">RequestDetails
</span><a href="#local-6989586621690396021"><span class="hs-identifier hs-var">reqDetails</span></a></span><span>
</span><span id="line-414"></span><span>                        </span><span id="local-6989586621690396018"><span class="annot"><span class="annottext">logger' :: Either (HTTPErr 'EventType) (HTTPResp 'EventType)
-&gt; RequestDetails
-&gt; ExceptT (TransformableRequestError 'EventType) (TraceT io) ()
</span><a href="#local-6989586621690396018"><span class="hs-identifier hs-var hs-var">logger'</span></a></span></span><span> </span><span id="local-6989586621690396017"><span class="annot"><span class="annottext">Either (HTTPErr 'EventType) (HTTPResp 'EventType)
</span><a href="#local-6989586621690396017"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span id="local-6989586621690396016"><span class="annot"><span class="annottext">RequestDetails
</span><a href="#local-6989586621690396016"><span class="hs-identifier hs-var">details</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall r (m :: * -&gt; *).
(MonadReader r m, Has (Logger Hasura) r, MonadIO m) =&gt;
Either (HTTPErr 'EventType) (HTTPResp 'EventType)
-&gt; ExtraLogContext
-&gt; RequestDetails
-&gt; Text
-&gt; [HeaderConf]
-&gt; m ()
</span><a href="Hasura.Eventing.HTTP.html#logHTTPForET"><span class="hs-identifier hs-var">logHTTPForET</span></a></span><span> </span><span class="annot"><span class="annottext">Either (HTTPErr 'EventType) (HTTPResp 'EventType)
</span><a href="#local-6989586621690396017"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">ExtraLogContext
</span><a href="#local-6989586621690396031"><span class="hs-identifier hs-var">extraLogCtx</span></a></span><span> </span><span class="annot"><span class="annottext">RequestDetails
</span><a href="#local-6989586621690396016"><span class="hs-identifier hs-var">details</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. EnvRecord a -&gt; Text
</span><a href="Hasura.RQL.Types.Common.html#_envVarName"><span class="hs-identifier hs-var">_envVarName</span></a></span><span> </span><span class="annot"><span class="annottext">EnvRecord ResolvedWebhook
</span><a href="#local-6989586621690396051"><span class="hs-identifier hs-var">webhook</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621690396038"><span class="hs-identifier hs-var">logHeaders</span></a></span><span>
</span><span id="line-415"></span><span>                    </span><span class="hs-comment">-- Event Triggers have a configuration parameter called</span><span>
</span><span id="line-416"></span><span>                    </span><span class="hs-comment">-- HASURA_GRAPHQL_EVENTS_HTTP_WORKERS, which is used</span><span>
</span><span id="line-417"></span><span>                    </span><span class="hs-comment">-- to control the concurrency of http delivery.</span><span>
</span><span id="line-418"></span><span>                    </span><span class="hs-comment">-- This bracket is used to increment and decrement an</span><span>
</span><span id="line-419"></span><span>                    </span><span class="hs-comment">-- HTTP Worker EKG Gauge for the duration of the</span><span>
</span><span id="line-420"></span><span>                    </span><span class="hs-comment">-- request invocation</span><span>
</span><span id="line-421"></span><span>                    </span><span id="local-6989586621690396013"><span class="annot"><span class="annottext">HTTPResp 'EventType
</span><a href="#local-6989586621690396013"><span class="hs-identifier hs-var">resp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-422"></span><span>                      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a c b. MonadMask m =&gt; m a -&gt; m c -&gt; m b -&gt; m b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/exceptions-0.10.4/src"><span class="hs-identifier hs-var">bracket_</span></a></span><span>
</span><span id="line-423"></span><span>                        </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-424"></span><span>                            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><span class="hs-identifier hs-var">EKG.Gauge.inc</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics -&gt; Gauge
</span><a href="Hasura.Server.Metrics.html#smNumEventHTTPWorkers"><span class="hs-identifier hs-var">smNumEventHTTPWorkers</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621690396415"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span>
</span><span id="line-425"></span><span>                            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><span class="hs-identifier hs-var">Prometheus.Gauge.inc</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerMetrics -&gt; Gauge
</span><a href="Hasura.Server.Prometheus.html#eventTriggerHTTPWorkers"><span class="hs-identifier hs-var">eventTriggerHTTPWorkers</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerMetrics
</span><a href="#local-6989586621690396414"><span class="hs-identifier hs-var">eventTriggerMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-426"></span><span>                        </span><span class="hs-special">)</span><span>
</span><span id="line-427"></span><span>                        </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-428"></span><span>                            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><span class="hs-identifier hs-var">EKG.Gauge.dec</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics -&gt; Gauge
</span><a href="Hasura.Server.Metrics.html#smNumEventHTTPWorkers"><span class="hs-identifier hs-var">smNumEventHTTPWorkers</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621690396415"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span>
</span><span id="line-429"></span><span>                            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><span class="hs-identifier hs-var">Prometheus.Gauge.dec</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerMetrics -&gt; Gauge
</span><a href="Hasura.Server.Prometheus.html#eventTriggerHTTPWorkers"><span class="hs-identifier hs-var">eventTriggerHTTPWorkers</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerMetrics
</span><a href="#local-6989586621690396414"><span class="hs-identifier hs-var">eventTriggerMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-430"></span><span>                        </span><span class="hs-special">)</span><span>
</span><span id="line-431"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall r (m :: * -&gt; *) (a :: TriggerTypes).
(MonadReader r m, MonadError (TransformableRequestError a) m,
 Has Manager r, Has (Logger Hasura) r, MonadIO m, MonadTrace m) =&gt;
RequestDetails
-&gt; Maybe ResponseTransform
-&gt; Maybe SessionVariables
-&gt; (Either (HTTPErr a) (HTTPResp a) -&gt; RequestDetails -&gt; m ())
-&gt; m (HTTPResp a)
</span><a href="Hasura.Eventing.HTTP.html#invokeRequest"><span class="hs-identifier hs-var">invokeRequest</span></a></span><span> </span><span class="annot"><span class="annottext">RequestDetails
</span><a href="#local-6989586621690396021"><span class="hs-identifier hs-var">reqDetails</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseTransform
</span><a href="#local-6989586621690396027"><span class="hs-identifier hs-var">responseTransform</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestDetails -&gt; Maybe SessionVariables
</span><a href="Hasura.Eventing.HTTP.html#_rdSessionVars"><span class="hs-identifier hs-var">_rdSessionVars</span></a></span><span> </span><span class="annot"><span class="annottext">RequestDetails
</span><a href="#local-6989586621690396021"><span class="hs-identifier hs-var">reqDetails</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Either (HTTPErr 'EventType) (HTTPResp 'EventType)
-&gt; RequestDetails
-&gt; ExceptT (TransformableRequestError 'EventType) (TraceT io) ()
</span><a href="#local-6989586621690396018"><span class="hs-identifier hs-var">logger'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-432"></span><span>                    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621690396020"><span class="hs-identifier hs-var">request</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HTTPResp 'EventType
</span><a href="#local-6989586621690396013"><span class="hs-identifier hs-var">resp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-433"></span><span>              </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either
  (TransformableRequestError 'EventType)
  (Request, HTTPResp 'EventType)
</span><a href="#local-6989586621690396024"><span class="hs-identifier hs-var">eitherReqRes</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-434"></span><span>                </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621690396004"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621690396004"><span class="hs-identifier hs-var">req</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621690396003"><span class="annot"><span class="annottext">HTTPResp 'EventType
</span><a href="#local-6989586621690396003"><span class="hs-identifier hs-var">resp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-435"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690396002"><span class="annot"><span class="annottext">reqBody :: Value
</span><a href="#local-6989586621690396002"><span class="hs-identifier hs-var hs-var">reqBody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><span class="hs-identifier hs-var">J.Null</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a. MonadReader s m =&gt; Getting a s a -&gt; m a
</span><span class="hs-identifier hs-var">view</span></span><span> </span><span class="annot"><span class="annottext">Lens' Request (Maybe ByteString)
</span><a href="Network.HTTP.Client.Transformable.html#body"><span class="hs-identifier hs-var">HTTP.body</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621690396004"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. FromJSON a =&gt; ByteString -&gt; Maybe a
</span><span class="hs-identifier hs-var">J.decode</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span>
</span><span id="line-436"></span><span>                  </span><span class="annot"><span class="annottext">forall (b :: BackendType) (m :: * -&gt; *) (a :: TriggerTypes).
(MonadIO m, BackendEventTrigger b) =&gt;
SourceConfig b
-&gt; Event b
-&gt; [HeaderConf]
-&gt; Value
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; HTTPResp a
-&gt; m (Either QErr ())
</span><a href="Hasura.Eventing.EventTrigger.html#processSuccess"><span class="hs-identifier hs-var">processSuccess</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621690396094"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690396095"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621690396038"><span class="hs-identifier hs-var">logHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621690396002"><span class="hs-identifier hs-var">reqBody</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621690396062"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPResp 'EventType
</span><a href="#local-6989586621690396003"><span class="hs-identifier hs-var">resp</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.2.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">onLeft</span></a></span><span> </span><span class="annot"><span class="annottext">forall r (m :: * -&gt; *).
(MonadReader r m, Has (Logger Hasura) r, MonadIO m) =&gt;
QErr -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier hs-var">logQErr</span></a></span><span>
</span><span id="line-437"></span><span>                  </span><span id="local-6989586621690395996"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621690395996"><span class="hs-identifier hs-var">eventExecutionFinishTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/time-1.11.1.1/src"><span class="hs-identifier hs-var">getCurrentTime</span></a></span><span>
</span><span id="line-438"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690395995"><span class="annot"><span class="annottext">eventWebhookProcessingTime' :: Double
</span><a href="#local-6989586621690395995"><span class="hs-identifier hs-var hs-var">eventWebhookProcessingTime'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (Real a, Fractional b) =&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">realToFrac</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; UTCTime -&gt; NominalDiffTime
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/time-1.11.1.1/src"><span class="hs-identifier hs-var">diffUTCTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621690395996"><span class="hs-identifier hs-var">eventExecutionFinishTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621690396052"><span class="hs-identifier hs-var">eventExecutionStartTime</span></a></span><span>
</span><span id="line-439"></span><span>                      </span><span class="hs-comment">-- For event_processing_time, the start time is defined as the expected delivery time for an event, i.e.:</span><span>
</span><span id="line-440"></span><span>                      </span><span class="hs-comment">--  - For event with no retries: created_at time</span><span>
</span><span id="line-441"></span><span>                      </span><span class="hs-comment">--  - For event with retries: next_retry_at time</span><span>
</span><span id="line-442"></span><span>                      </span><span id="local-6989586621690395994"><span class="annot"><span class="annottext">eventStartTime :: UTCTime
</span><a href="#local-6989586621690395994"><span class="hs-identifier hs-var hs-var">eventStartTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (b :: BackendType). Event b -&gt; UTCTime
</span><a href="Hasura.RQL.Types.EventTrigger.html#eCreatedAt"><span class="hs-identifier hs-var">eCreatedAt</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690396095"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (b :: BackendType). Event b -&gt; Maybe UTCTime
</span><a href="Hasura.RQL.Types.EventTrigger.html#eRetryAt"><span class="hs-identifier hs-var">eRetryAt</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690396095"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-443"></span><span>                      </span><span class="hs-comment">-- The timestamps in the DB are supposed to be UTC time, so the timestamps (`eventExecutionFinishTime` and</span><span>
</span><span id="line-444"></span><span>                      </span><span class="hs-comment">-- `eventStartTime`) used here in calculation are all UTC time.</span><span>
</span><span id="line-445"></span><span>                      </span><span id="local-6989586621690395991"><span class="annot"><span class="annottext">eventProcessingTime' :: Double
</span><a href="#local-6989586621690395991"><span class="hs-identifier hs-var hs-var">eventProcessingTime'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (Real a, Fractional b) =&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">realToFrac</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; UTCTime -&gt; NominalDiffTime
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/time-1.11.1.1/src"><span class="hs-identifier hs-var">diffUTCTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621690395996"><span class="hs-identifier hs-var">eventExecutionFinishTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621690395994"><span class="hs-identifier hs-var">eventStartTime</span></a></span><span>
</span><span id="line-446"></span><span>                  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-447"></span><span>                    </span><span class="annot"><span class="annottext">Distribution -&gt; Double -&gt; IO ()
</span><span class="hs-identifier hs-var">EKG.Distribution.add</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerMetrics -&gt; Distribution
</span><a href="Hasura.Server.Metrics.html#smEventWebhookProcessingTime"><span class="hs-identifier hs-var">smEventWebhookProcessingTime</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621690396415"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621690395995"><span class="hs-identifier hs-var">eventWebhookProcessingTime'</span></a></span><span>
</span><span id="line-448"></span><span>                    </span><span class="annot"><span class="annottext">Histogram -&gt; Double -&gt; IO ()
</span><span class="hs-identifier hs-var">Prometheus.Histogram.observe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerMetrics -&gt; Histogram
</span><a href="Hasura.Server.Prometheus.html#eventWebhookProcessingTime"><span class="hs-identifier hs-var">eventWebhookProcessingTime</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerMetrics
</span><a href="#local-6989586621690396414"><span class="hs-identifier hs-var">eventTriggerMetrics</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621690395995"><span class="hs-identifier hs-var">eventWebhookProcessingTime'</span></a></span><span>
</span><span id="line-449"></span><span>                    </span><span class="annot"><span class="annottext">Distribution -&gt; Double -&gt; IO ()
</span><span class="hs-identifier hs-var">EKG.Distribution.add</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerMetrics -&gt; Distribution
</span><a href="Hasura.Server.Metrics.html#smEventProcessingTime"><span class="hs-identifier hs-var">smEventProcessingTime</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621690396415"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621690395991"><span class="hs-identifier hs-var">eventProcessingTime'</span></a></span><span>
</span><span id="line-450"></span><span>                    </span><span class="annot"><span class="annottext">Histogram -&gt; Double -&gt; IO ()
</span><span class="hs-identifier hs-var">Prometheus.Histogram.observe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerMetrics -&gt; Histogram
</span><a href="Hasura.Server.Prometheus.html#eventProcessingTime"><span class="hs-identifier hs-var">eventProcessingTime</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerMetrics
</span><a href="#local-6989586621690396414"><span class="hs-identifier hs-var">eventTriggerMetrics</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621690395991"><span class="hs-identifier hs-var">eventProcessingTime'</span></a></span><span>
</span><span id="line-451"></span><span>                </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.HTTP.html#HTTPError"><span class="hs-identifier hs-type">HTTPError</span></a></span><span> </span><span id="local-6989586621690395985"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621690395985"><span class="hs-identifier hs-var">reqBody</span></a></span></span><span> </span><span id="local-6989586621690395984"><span class="annot"><span class="annottext">HTTPErr 'EventType
</span><a href="#local-6989586621690395984"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-452"></span><span>                  </span><span class="annot"><span class="annottext">forall (b :: BackendType) (m :: * -&gt; *) (a :: TriggerTypes).
(MonadIO m, BackendEventTrigger b) =&gt;
SourceConfig b
-&gt; Event b
-&gt; RetryConf
-&gt; [HeaderConf]
-&gt; Value
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; HTTPErr a
-&gt; m (Either QErr ())
</span><a href="Hasura.Eventing.EventTrigger.html#processError"><span class="hs-identifier hs-var">processError</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621690397201"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621690396094"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690396095"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621690396048"><span class="hs-identifier hs-var">retryConf</span></a></span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621690396038"><span class="hs-identifier hs-var">logHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621690395985"><span class="hs-identifier hs-var">reqBody</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621690396062"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPErr 'EventType
</span><a href="#local-6989586621690395984"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.2.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">onLeft</span></a></span><span> </span><span class="annot"><span class="annottext">forall r (m :: * -&gt; *).
(MonadReader r m, Has (Logger Hasura) r, MonadIO m) =&gt;
QErr -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier hs-var">logQErr</span></a></span><span>
</span><span id="line-453"></span><span>                </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.HTTP.html#TransformationError"><span class="hs-identifier hs-type">TransformationError</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621690395981"><span class="annot"><span class="annottext">TransformErrorBundle
</span><a href="#local-6989586621690395981"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-454"></span><span>                  </span><span class="annot"><span class="annottext">forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">L.unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621690396424"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel -&gt; SerializableBlob -&gt; UnstructuredLog
</span><a href="Hasura.Logging.html#UnstructuredLog"><span class="hs-identifier hs-var">L.UnstructuredLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelError"><span class="hs-identifier hs-var">L.LevelError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; SerializableBlob
</span><a href="Data.SerializableBlob.html#fromLBS"><span class="hs-identifier hs-var">SB.fromLBS</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">J.encode</span></span><span> </span><span class="annot"><span class="annottext">TransformErrorBundle
</span><a href="#local-6989586621690395981"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-455"></span><span>
</span><span id="line-456"></span><span>                  </span><span class="hs-comment">-- Record an Event Error</span><span>
</span><span id="line-457"></span><span>                  </span><span class="annot"><span class="annottext">forall (b :: BackendType) (m :: * -&gt; *).
(BackendEventTrigger b, MonadIO m) =&gt;
SourceConfig b
-&gt; Event b
-&gt; Maybe (Invocation 'EventType)
-&gt; ProcessEventError
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m (Either QErr ())
</span><a href="Hasura.RQL.Types.Eventing.Backend.html#recordError%27"><span class="hs-identifier hs-var">recordError'</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621690397201"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621690396094"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690396095"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">ProcessEventError
</span><a href="Hasura.RQL.Types.EventTrigger.html#PESetError"><span class="hs-identifier hs-var">PESetError</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621690396062"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.2.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">onLeft</span></a></span><span> </span><span class="annot"><span class="annottext">forall r (m :: * -&gt; *).
(MonadReader r m, Has (Logger Hasura) r, MonadIO m) =&gt;
QErr -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier hs-var">logQErr</span></a></span><span>
</span><span id="line-458"></span><span>      </span><span class="hs-comment">-- removing an event from the _eeCtxLockedEvents after the event has been processed:</span><span>
</span><span id="line-459"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadIO m =&gt;
SourceName
-&gt; EventId -&gt; TVar (HashMap SourceName (Set EventId)) -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#removeEventTriggerEventFromLockedEvents"><span class="hs-identifier hs-var">removeEventTriggerEventFromLockedEvents</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621690396093"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690396095"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set EventId))
</span><a href="#local-6989586621690396417"><span class="hs-identifier hs-var">leEvents</span></a></span><span>
</span><span id="line-460"></span><span>
</span><span id="line-461"></span><span id="local-6989586621690397119"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#createEventPayload"><span class="hs-identifier hs-type">createEventPayload</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#RetryConf"><span class="hs-identifier hs-type">RetryConf</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397119"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventPayload"><span class="hs-identifier hs-type">EventPayload</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397119"><span class="hs-identifier hs-type">b</span></a></span></span><span>
</span><span id="line-462"></span><span id="createEventPayload"><span class="annot"><span class="annottext">createEventPayload :: forall (b :: BackendType). RetryConf -&gt; Event b -&gt; EventPayload b
</span><a href="Hasura.Eventing.EventTrigger.html#createEventPayload"><span class="hs-identifier hs-var hs-var">createEventPayload</span></a></span></span><span> </span><span id="local-6989586621690395977"><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621690395977"><span class="hs-identifier hs-var">retryConf</span></a></span></span><span> </span><span id="local-6989586621690395976"><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690395976"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-463"></span><span>  </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#EventPayload"><span class="hs-identifier hs-type">EventPayload</span></a></span><span>
</span><span id="line-464"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">epId :: EventId
</span><a href="Hasura.Eventing.EventTrigger.html#epId"><span class="hs-identifier hs-var">epId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690395976"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-465"></span><span>      </span><span class="annot"><span class="annottext">epTable :: TableName b
</span><a href="Hasura.Eventing.EventTrigger.html#epTable"><span class="hs-identifier hs-var">epTable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType). Event b -&gt; TableName b
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTable"><span class="hs-identifier hs-var">eTable</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690395976"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-466"></span><span>      </span><span class="annot"><span class="annottext">epTrigger :: TriggerMetadata
</span><a href="Hasura.Eventing.EventTrigger.html#epTrigger"><span class="hs-identifier hs-var">epTrigger</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType). Event b -&gt; TriggerMetadata
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTrigger"><span class="hs-identifier hs-var">eTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690395976"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-467"></span><span>      </span><span class="annot"><span class="annottext">epEvent :: Value
</span><a href="Hasura.Eventing.EventTrigger.html#epEvent"><span class="hs-identifier hs-var">epEvent</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType). Event b -&gt; Value
</span><a href="Hasura.RQL.Types.EventTrigger.html#eEvent"><span class="hs-identifier hs-var">eEvent</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690395976"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-468"></span><span>      </span><span class="annot"><span class="annottext">epDeliveryInfo :: DeliveryInfo
</span><a href="Hasura.Eventing.EventTrigger.html#epDeliveryInfo"><span class="hs-identifier hs-var">epDeliveryInfo</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-469"></span><span>        </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#DeliveryInfo"><span class="hs-identifier hs-type">DeliveryInfo</span></a></span><span>
</span><span id="line-470"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">diCurrentRetry :: Int
</span><a href="Hasura.Eventing.EventTrigger.html#diCurrentRetry"><span class="hs-identifier hs-var">diCurrentRetry</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType). Event b -&gt; Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTries"><span class="hs-identifier hs-var">eTries</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690395976"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-471"></span><span>            </span><span class="annot"><span class="annottext">diMaxRetries :: Int
</span><a href="Hasura.Eventing.EventTrigger.html#diMaxRetries"><span class="hs-identifier hs-var">diMaxRetries</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RetryConf -&gt; Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#rcNumRetries"><span class="hs-identifier hs-var">rcNumRetries</span></a></span><span> </span><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621690395977"><span class="hs-identifier hs-var">retryConf</span></a></span><span>
</span><span id="line-472"></span><span>          </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-473"></span><span>      </span><span class="annot"><span class="annottext">epCreatedAt :: UTCTime
</span><a href="Hasura.Eventing.EventTrigger.html#epCreatedAt"><span class="hs-identifier hs-var">epCreatedAt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType). Event b -&gt; UTCTime
</span><a href="Hasura.RQL.Types.EventTrigger.html#eCreatedAt"><span class="hs-identifier hs-var">eCreatedAt</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690395976"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-474"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-475"></span><span>
</span><span id="line-476"></span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#processSuccess"><span class="hs-identifier hs-type">processSuccess</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-477"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621690397084"><span class="annot"><a href="#local-6989586621690397084"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621690397085"><span class="annot"><a href="#local-6989586621690397085"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621690397083"><span class="annot"><a href="#local-6989586621690397083"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-478"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397085"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.Backend.html#BackendEventTrigger"><span class="hs-identifier hs-type">BackendEventTrigger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397084"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-479"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#SourceConfig"><span class="hs-identifier hs-type">SourceConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397084"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-480"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397084"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-481"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.DDL.Headers.html#HeaderConf"><span class="hs-identifier hs-type">HeaderConf</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-482"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-483"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-484"></span><span>  </span><span class="annot"><a href="Hasura.Eventing.HTTP.html#HTTPResp"><span class="hs-identifier hs-type">HTTPResp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397083"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-485"></span><span>  </span><span class="annot"><a href="#local-6989586621690397085"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-486"></span><span id="processSuccess"><span class="annot"><span class="annottext">processSuccess :: forall (b :: BackendType) (m :: * -&gt; *) (a :: TriggerTypes).
(MonadIO m, BackendEventTrigger b) =&gt;
SourceConfig b
-&gt; Event b
-&gt; [HeaderConf]
-&gt; Value
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; HTTPResp a
-&gt; m (Either QErr ())
</span><a href="Hasura.Eventing.EventTrigger.html#processSuccess"><span class="hs-identifier hs-var hs-var">processSuccess</span></a></span></span><span> </span><span id="local-6989586621690395967"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621690395967"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621690395966"><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690395966"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621690395965"><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621690395965"><span class="hs-identifier hs-var">reqHeaders</span></a></span></span><span> </span><span id="local-6989586621690395964"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621690395964"><span class="hs-identifier hs-var">ep</span></a></span></span><span> </span><span id="local-6989586621690395963"><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621690395963"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span></span><span> </span><span id="local-6989586621690395962"><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621690395962"><span class="hs-identifier hs-var">resp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-487"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690395961"><span class="annot"><span class="annottext">respBody :: SerializableBlob
</span><a href="#local-6989586621690395961"><span class="hs-identifier hs-var hs-var">respBody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (a :: TriggerTypes). HTTPResp a -&gt; SerializableBlob
</span><a href="Hasura.Eventing.HTTP.html#hrsBody"><span class="hs-identifier hs-var">hrsBody</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621690395962"><span class="hs-identifier hs-var">resp</span></a></span><span>
</span><span id="line-488"></span><span>      </span><span id="local-6989586621690395959"><span class="annot"><span class="annottext">respHeaders :: [HeaderConf]
</span><a href="#local-6989586621690395959"><span class="hs-identifier hs-var hs-var">respHeaders</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (a :: TriggerTypes). HTTPResp a -&gt; [HeaderConf]
</span><a href="Hasura.Eventing.HTTP.html#hrsHeaders"><span class="hs-identifier hs-var">hrsHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621690395962"><span class="hs-identifier hs-var">resp</span></a></span><span>
</span><span id="line-489"></span><span>      </span><span id="local-6989586621690395957"><span class="annot"><span class="annottext">respStatus :: Int
</span><a href="#local-6989586621690395957"><span class="hs-identifier hs-var hs-var">respStatus</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (a :: TriggerTypes). HTTPResp a -&gt; Int
</span><a href="Hasura.Eventing.HTTP.html#hrsStatus"><span class="hs-identifier hs-var">hrsStatus</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621690395962"><span class="hs-identifier hs-var">resp</span></a></span><span>
</span><span id="line-490"></span><span>      </span><span id="local-6989586621690395955"><span class="annot"><span class="annottext">eid :: EventId
</span><a href="#local-6989586621690395955"><span class="hs-identifier hs-var hs-var">eid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690395966"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-491"></span><span>      </span><span id="local-6989586621690395954"><span class="annot"><span class="annottext">invocation :: Invocation 'EventType
</span><a href="#local-6989586621690395954"><span class="hs-identifier hs-var hs-var">invocation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventId
-&gt; Value
-&gt; Maybe Int
-&gt; [HeaderConf]
-&gt; SerializableBlob
-&gt; [HeaderConf]
-&gt; Invocation 'EventType
</span><a href="Hasura.Eventing.EventTrigger.html#mkInvocation"><span class="hs-identifier hs-var">mkInvocation</span></a></span><span> </span><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621690395955"><span class="hs-identifier hs-var">eid</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621690395964"><span class="hs-identifier hs-var">ep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621690395957"><span class="hs-identifier hs-var">respStatus</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621690395965"><span class="hs-identifier hs-var">reqHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">SerializableBlob
</span><a href="#local-6989586621690395961"><span class="hs-identifier hs-var">respBody</span></a></span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621690395959"><span class="hs-identifier hs-var">respHeaders</span></a></span><span>
</span><span id="line-492"></span><span>  </span><span class="annot"><span class="annottext">forall (b :: BackendType) (m :: * -&gt; *).
(BackendEventTrigger b, MonadIO m) =&gt;
SourceConfig b
-&gt; Event b
-&gt; Invocation 'EventType
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m (Either QErr ())
</span><a href="Hasura.RQL.Types.Eventing.Backend.html#recordSuccess"><span class="hs-identifier hs-var">recordSuccess</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621690397084"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621690395967"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690395966"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621690395954"><span class="hs-identifier hs-var">invocation</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621690395963"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span>
</span><span id="line-493"></span><span>
</span><span id="line-494"></span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#processError"><span class="hs-identifier hs-type">processError</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-495"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621690397079"><span class="annot"><a href="#local-6989586621690397079"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621690397080"><span class="annot"><a href="#local-6989586621690397080"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621690397078"><span class="annot"><a href="#local-6989586621690397078"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-496"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397080"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-497"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.Backend.html#BackendEventTrigger"><span class="hs-identifier hs-type">BackendEventTrigger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397079"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-498"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-499"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#SourceConfig"><span class="hs-identifier hs-type">SourceConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397079"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-500"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397079"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-501"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#RetryConf"><span class="hs-identifier hs-type">RetryConf</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-502"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.DDL.Headers.html#HeaderConf"><span class="hs-identifier hs-type">HeaderConf</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-503"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-504"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#MaintenanceMode"><span class="hs-identifier hs-type">MaintenanceMode</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MaintenanceModeVersion"><span class="hs-identifier hs-type">MaintenanceModeVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-505"></span><span>  </span><span class="annot"><a href="Hasura.Eventing.HTTP.html#HTTPErr"><span class="hs-identifier hs-type">HTTPErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397078"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-506"></span><span>  </span><span class="annot"><a href="#local-6989586621690397080"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-507"></span><span id="processError"><span class="annot"><span class="annottext">processError :: forall (b :: BackendType) (m :: * -&gt; *) (a :: TriggerTypes).
(MonadIO m, BackendEventTrigger b) =&gt;
SourceConfig b
-&gt; Event b
-&gt; RetryConf
-&gt; [HeaderConf]
-&gt; Value
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; HTTPErr a
-&gt; m (Either QErr ())
</span><a href="Hasura.Eventing.EventTrigger.html#processError"><span class="hs-identifier hs-var hs-var">processError</span></a></span></span><span> </span><span id="local-6989586621690395937"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621690395937"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621690395936"><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690395936"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621690395935"><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621690395935"><span class="hs-identifier hs-var">retryConf</span></a></span></span><span> </span><span id="local-6989586621690395934"><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621690395934"><span class="hs-identifier hs-var">reqHeaders</span></a></span></span><span> </span><span id="local-6989586621690395933"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621690395933"><span class="hs-identifier hs-var">ep</span></a></span></span><span> </span><span id="local-6989586621690395932"><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621690395932"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span></span><span> </span><span id="local-6989586621690395931"><span class="annot"><span class="annottext">HTTPErr a
</span><a href="#local-6989586621690395931"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-508"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690395930"><span class="annot"><span class="annottext">invocation :: Invocation 'EventType
</span><a href="#local-6989586621690395930"><span class="hs-identifier hs-var hs-var">invocation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HTTPErr a
</span><a href="#local-6989586621690395931"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-509"></span><span>        </span><span class="annot"><a href="Hasura.Eventing.HTTP.html#HClient"><span class="hs-identifier hs-type">HClient</span></a></span><span> </span><span id="local-6989586621690395928"><span class="annot"><span class="annottext">HttpException
</span><a href="#local-6989586621690395928"><span class="hs-identifier hs-var">httpException</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-510"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690395927"><span class="annot"><span class="annottext">statusMaybe :: Maybe Int
</span><a href="#local-6989586621690395927"><span class="hs-identifier hs-var hs-var">statusMaybe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HttpException -&gt; Maybe Int
</span><a href="Hasura.HTTP.html#getHTTPExceptionStatus"><span class="hs-identifier hs-var">getHTTPExceptionStatus</span></a></span><span> </span><span class="annot"><span class="annottext">HttpException
</span><a href="#local-6989586621690395928"><span class="hs-identifier hs-var">httpException</span></a></span><span>
</span><span id="line-511"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">EventId
-&gt; Value
-&gt; Maybe Int
-&gt; [HeaderConf]
-&gt; SerializableBlob
-&gt; [HeaderConf]
-&gt; Invocation 'EventType
</span><a href="Hasura.Eventing.EventTrigger.html#mkInvocation"><span class="hs-identifier hs-var">mkInvocation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690395936"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621690395933"><span class="hs-identifier hs-var">ep</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621690395927"><span class="hs-identifier hs-var">statusMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621690395934"><span class="hs-identifier hs-var">reqHeaders</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; SerializableBlob
</span><a href="Data.SerializableBlob.html#fromLBS"><span class="hs-identifier hs-var">SB.fromLBS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">J.encode</span></span><span> </span><span class="annot"><span class="annottext">HttpException
</span><a href="#local-6989586621690395928"><span class="hs-identifier hs-var">httpException</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-512"></span><span>        </span><span class="annot"><a href="Hasura.Eventing.HTTP.html#HStatus"><span class="hs-identifier hs-type">HStatus</span></a></span><span> </span><span id="local-6989586621690395925"><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621690395925"><span class="hs-identifier hs-var">errResp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-513"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690395924"><span class="annot"><span class="annottext">respPayload :: SerializableBlob
</span><a href="#local-6989586621690395924"><span class="hs-identifier hs-var hs-var">respPayload</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (a :: TriggerTypes). HTTPResp a -&gt; SerializableBlob
</span><a href="Hasura.Eventing.HTTP.html#hrsBody"><span class="hs-identifier hs-var">hrsBody</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621690395925"><span class="hs-identifier hs-var">errResp</span></a></span><span>
</span><span id="line-514"></span><span>              </span><span id="local-6989586621690395923"><span class="annot"><span class="annottext">respHeaders :: [HeaderConf]
</span><a href="#local-6989586621690395923"><span class="hs-identifier hs-var hs-var">respHeaders</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (a :: TriggerTypes). HTTPResp a -&gt; [HeaderConf]
</span><a href="Hasura.Eventing.HTTP.html#hrsHeaders"><span class="hs-identifier hs-var">hrsHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621690395925"><span class="hs-identifier hs-var">errResp</span></a></span><span>
</span><span id="line-515"></span><span>              </span><span id="local-6989586621690395922"><span class="annot"><span class="annottext">respStatus :: Int
</span><a href="#local-6989586621690395922"><span class="hs-identifier hs-var hs-var">respStatus</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (a :: TriggerTypes). HTTPResp a -&gt; Int
</span><a href="Hasura.Eventing.HTTP.html#hrsStatus"><span class="hs-identifier hs-var">hrsStatus</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621690395925"><span class="hs-identifier hs-var">errResp</span></a></span><span>
</span><span id="line-516"></span><span>          </span><span class="annot"><span class="annottext">EventId
-&gt; Value
-&gt; Maybe Int
-&gt; [HeaderConf]
-&gt; SerializableBlob
-&gt; [HeaderConf]
-&gt; Invocation 'EventType
</span><a href="Hasura.Eventing.EventTrigger.html#mkInvocation"><span class="hs-identifier hs-var">mkInvocation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690395936"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621690395933"><span class="hs-identifier hs-var">ep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621690395922"><span class="hs-identifier hs-var">respStatus</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621690395934"><span class="hs-identifier hs-var">reqHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">SerializableBlob
</span><a href="#local-6989586621690395924"><span class="hs-identifier hs-var">respPayload</span></a></span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621690395923"><span class="hs-identifier hs-var">respHeaders</span></a></span><span>
</span><span id="line-517"></span><span>        </span><span class="annot"><a href="Hasura.Eventing.HTTP.html#HOther"><span class="hs-identifier hs-type">HOther</span></a></span><span> </span><span id="local-6989586621690395920"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621690395920"><span class="hs-identifier hs-var">detail</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-518"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690395919"><span class="annot"><span class="annottext">errMsg :: SerializableBlob
</span><a href="#local-6989586621690395919"><span class="hs-identifier hs-var hs-var">errMsg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; SerializableBlob
</span><a href="Data.SerializableBlob.html#fromLBS"><span class="hs-identifier hs-var">SB.fromLBS</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">J.encode</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621690395920"><span class="hs-identifier hs-var">detail</span></a></span><span>
</span><span id="line-519"></span><span>          </span><span class="annot"><span class="annottext">EventId
-&gt; Value
-&gt; Maybe Int
-&gt; [HeaderConf]
-&gt; SerializableBlob
-&gt; [HeaderConf]
-&gt; Invocation 'EventType
</span><a href="Hasura.Eventing.EventTrigger.html#mkInvocation"><span class="hs-identifier hs-var">mkInvocation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (b :: BackendType). Event b -&gt; EventId
</span><a href="Hasura.RQL.Types.EventTrigger.html#eId"><span class="hs-identifier hs-var">eId</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690395936"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621690395933"><span class="hs-identifier hs-var">ep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">500</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621690395934"><span class="hs-identifier hs-var">reqHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">SerializableBlob
</span><a href="#local-6989586621690395919"><span class="hs-identifier hs-var">errMsg</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-520"></span><span>  </span><span id="local-6989586621690395918"><span class="annot"><span class="annottext">ProcessEventError
</span><a href="#local-6989586621690395918"><span class="hs-identifier hs-var">retryOrError</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (b :: BackendType) (a :: TriggerTypes).
MonadIO m =&gt;
Event b -&gt; RetryConf -&gt; HTTPErr a -&gt; m ProcessEventError
</span><a href="Hasura.Eventing.EventTrigger.html#retryOrSetError"><span class="hs-identifier hs-var">retryOrSetError</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690395936"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621690395935"><span class="hs-identifier hs-var">retryConf</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPErr a
</span><a href="#local-6989586621690395931"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-521"></span><span>  </span><span class="annot"><span class="annottext">forall (b :: BackendType) (m :: * -&gt; *).
(BackendEventTrigger b, MonadIO m) =&gt;
SourceConfig b
-&gt; Event b
-&gt; Invocation 'EventType
-&gt; ProcessEventError
-&gt; MaintenanceMode MaintenanceModeVersion
-&gt; m (Either QErr ())
</span><a href="Hasura.RQL.Types.Eventing.Backend.html#recordError"><span class="hs-identifier hs-var">recordError</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621690397079"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621690395937"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690395936"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Invocation 'EventType
</span><a href="#local-6989586621690395930"><span class="hs-identifier hs-var">invocation</span></a></span><span> </span><span class="annot"><span class="annottext">ProcessEventError
</span><a href="#local-6989586621690395918"><span class="hs-identifier hs-var">retryOrError</span></a></span><span> </span><span class="annot"><span class="annottext">MaintenanceMode MaintenanceModeVersion
</span><a href="#local-6989586621690395932"><span class="hs-identifier hs-var">maintenanceModeVersion</span></a></span><span>
</span><span id="line-522"></span><span>
</span><span id="line-523"></span><span id="local-6989586621690397056"><span id="local-6989586621690397057"><span id="local-6989586621690397058"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#retryOrSetError"><span class="hs-identifier hs-type">retryOrSetError</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-524"></span><span>  </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397058"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-525"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397057"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-526"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#RetryConf"><span class="hs-identifier hs-type">RetryConf</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-527"></span><span>  </span><span class="annot"><a href="Hasura.Eventing.HTTP.html#HTTPErr"><span class="hs-identifier hs-type">HTTPErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397056"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-528"></span><span>  </span><span class="annot"><a href="#local-6989586621690397058"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#ProcessEventError"><span class="hs-identifier hs-type">ProcessEventError</span></a></span></span></span></span><span>
</span><span id="line-529"></span><span id="retryOrSetError"><span class="annot"><span class="annottext">retryOrSetError :: forall (m :: * -&gt; *) (b :: BackendType) (a :: TriggerTypes).
MonadIO m =&gt;
Event b -&gt; RetryConf -&gt; HTTPErr a -&gt; m ProcessEventError
</span><a href="Hasura.Eventing.EventTrigger.html#retryOrSetError"><span class="hs-identifier hs-var hs-var">retryOrSetError</span></a></span></span><span> </span><span id="local-6989586621690395904"><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690395904"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621690395903"><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621690395903"><span class="hs-identifier hs-var">retryConf</span></a></span></span><span> </span><span id="local-6989586621690395902"><span class="annot"><span class="annottext">HTTPErr a
</span><a href="#local-6989586621690395902"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-530"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690395901"><span class="annot"><span class="annottext">mretryHeader :: Maybe Text
</span><a href="#local-6989586621690395901"><span class="hs-identifier hs-var hs-var">mretryHeader</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {a :: TriggerTypes}. HTTPErr a -&gt; Maybe Text
</span><a href="#local-6989586621690395900"><span class="hs-identifier hs-var">getRetryAfterHeaderFromError</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPErr a
</span><a href="#local-6989586621690395902"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-531"></span><span>      </span><span id="local-6989586621690395899"><span class="annot"><span class="annottext">tries :: Int
</span><a href="#local-6989586621690395899"><span class="hs-identifier hs-var hs-var">tries</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType). Event b -&gt; Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTries"><span class="hs-identifier hs-var">eTries</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690395904"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-532"></span><span>      </span><span id="local-6989586621690395898"><span class="annot"><span class="annottext">mretryHeaderSeconds :: Maybe Int
</span><a href="#local-6989586621690395898"><span class="hs-identifier hs-var hs-var">mretryHeaderSeconds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621690395901"><span class="hs-identifier hs-var">mretryHeader</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Maybe Int
</span><a href="#local-6989586621690395897"><span class="hs-identifier hs-var">parseRetryHeader</span></a></span><span>
</span><span id="line-533"></span><span>      </span><span id="local-6989586621690395896"><span class="annot"><span class="annottext">triesExhausted :: Bool
</span><a href="#local-6989586621690395896"><span class="hs-identifier hs-var hs-var">triesExhausted</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621690395899"><span class="hs-identifier hs-var">tries</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">RetryConf -&gt; Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#rcNumRetries"><span class="hs-identifier hs-var">rcNumRetries</span></a></span><span> </span><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621690395903"><span class="hs-identifier hs-var">retryConf</span></a></span><span>
</span><span id="line-534"></span><span>      </span><span id="local-6989586621690395895"><span class="annot"><span class="annottext">noRetryHeader :: Bool
</span><a href="#local-6989586621690395895"><span class="hs-identifier hs-var hs-var">noRetryHeader</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">isNothing</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621690395898"><span class="hs-identifier hs-var">mretryHeaderSeconds</span></a></span><span>
</span><span id="line-535"></span><span>  </span><span class="hs-comment">-- current_try = tries + 1 , allowed_total_tries = rcNumRetries retryConf + 1</span><span>
</span><span id="line-536"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621690395896"><span class="hs-identifier hs-var">triesExhausted</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621690395895"><span class="hs-identifier hs-var">noRetryHeader</span></a></span><span>
</span><span id="line-537"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">ProcessEventError
</span><a href="Hasura.RQL.Types.EventTrigger.html#PESetError"><span class="hs-identifier hs-var">PESetError</span></a></span><span>
</span><span id="line-538"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-539"></span><span>      </span><span id="local-6989586621690395893"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621690395893"><span class="hs-identifier hs-var">currentTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/time-1.11.1.1/src"><span class="hs-identifier hs-var">getCurrentTime</span></a></span><span>
</span><span id="line-540"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690395892"><span class="annot"><span class="annottext">delay :: Int
</span><a href="#local-6989586621690395892"><span class="hs-identifier hs-var hs-var">delay</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RetryConf -&gt; Int
</span><a href="Hasura.RQL.Types.EventTrigger.html#rcIntervalSec"><span class="hs-identifier hs-var">rcIntervalSec</span></a></span><span> </span><span class="annot"><span class="annottext">RetryConf
</span><a href="#local-6989586621690395903"><span class="hs-identifier hs-var">retryConf</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621690395898"><span class="hs-identifier hs-var">mretryHeaderSeconds</span></a></span><span>
</span><span id="line-541"></span><span>          </span><span id="local-6989586621690395890"><span class="annot"><span class="annottext">diff :: NominalDiffTime
</span><a href="#local-6989586621690395890"><span class="hs-identifier hs-var hs-var">diff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621690395892"><span class="hs-identifier hs-var">delay</span></a></span><span>
</span><span id="line-542"></span><span>          </span><span id="local-6989586621690395889"><span class="annot"><span class="annottext">retryTime :: UTCTime
</span><a href="#local-6989586621690395889"><span class="hs-identifier hs-var hs-var">retryTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NominalDiffTime -&gt; UTCTime -&gt; UTCTime
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/time-1.11.1.1/src"><span class="hs-identifier hs-var">addUTCTime</span></a></span><span> </span><span class="annot"><span class="annottext">NominalDiffTime
</span><a href="#local-6989586621690395890"><span class="hs-identifier hs-var">diff</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621690395893"><span class="hs-identifier hs-var">currentTime</span></a></span><span>
</span><span id="line-543"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; ProcessEventError
</span><a href="Hasura.RQL.Types.EventTrigger.html#PESetRetry"><span class="hs-identifier hs-var">PESetRetry</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621690395889"><span class="hs-identifier hs-var">retryTime</span></a></span><span>
</span><span id="line-544"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-545"></span><span>    </span><span id="local-6989586621690395900"><span class="annot"><span class="annottext">getRetryAfterHeaderFromError :: HTTPErr a -&gt; Maybe Text
</span><a href="#local-6989586621690395900"><span class="hs-identifier hs-var hs-var">getRetryAfterHeaderFromError</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Eventing.HTTP.html#HStatus"><span class="hs-identifier hs-type">HStatus</span></a></span><span> </span><span id="local-6989586621690395887"><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621690395887"><span class="hs-identifier hs-var">resp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (a :: TriggerTypes). HTTPResp a -&gt; Maybe Text
</span><a href="Hasura.Eventing.HTTP.html#getRetryAfterHeaderFromResp"><span class="hs-identifier hs-var">getRetryAfterHeaderFromResp</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPResp a
</span><a href="#local-6989586621690395887"><span class="hs-identifier hs-var">resp</span></a></span><span>
</span><span id="line-546"></span><span>    </span><span class="annot"><a href="#local-6989586621690395900"><span class="hs-identifier hs-var">getRetryAfterHeaderFromError</span></a></span><span> </span><span class="annot"><span class="annottext">HTTPErr a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-547"></span><span>
</span><span id="line-548"></span><span>    </span><span id="local-6989586621690395897"><span class="annot"><span class="annottext">parseRetryHeader :: Text -&gt; Maybe Int
</span><a href="#local-6989586621690395897"><span class="hs-identifier hs-var hs-var">parseRetryHeader</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadPlus m =&gt; (a -&gt; Bool) -&gt; m a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">mfilter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Read a =&gt; String -&gt; Maybe a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">readMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span>
</span><span id="line-549"></span><span>
</span><span id="line-550"></span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#mkInvocation"><span class="hs-identifier hs-type">mkInvocation</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-551"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventId"><span class="hs-identifier hs-type">EventId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-552"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-553"></span><span>  </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-554"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.DDL.Headers.html#HeaderConf"><span class="hs-identifier hs-type">HeaderConf</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-555"></span><span>  </span><span class="annot"><a href="Data.SerializableBlob.html#SerializableBlob"><span class="hs-identifier hs-type">SB.SerializableBlob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-556"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.DDL.Headers.html#HeaderConf"><span class="hs-identifier hs-type">HeaderConf</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-557"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#Invocation"><span class="hs-identifier hs-type">Invocation</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.html#EventType"><span class="hs-identifier hs-type">EventType</span></a></span><span>
</span><span id="line-558"></span><span id="mkInvocation"><span class="annot"><span class="annottext">mkInvocation :: EventId
-&gt; Value
-&gt; Maybe Int
-&gt; [HeaderConf]
-&gt; SerializableBlob
-&gt; [HeaderConf]
-&gt; Invocation 'EventType
</span><a href="Hasura.Eventing.EventTrigger.html#mkInvocation"><span class="hs-identifier hs-var hs-var">mkInvocation</span></a></span></span><span> </span><span id="local-6989586621690395876"><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621690395876"><span class="hs-identifier hs-var">eid</span></a></span></span><span> </span><span id="local-6989586621690395875"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621690395875"><span class="hs-identifier hs-var">ep</span></a></span></span><span> </span><span id="local-6989586621690395874"><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621690395874"><span class="hs-identifier hs-var">statusMaybe</span></a></span></span><span> </span><span id="local-6989586621690395873"><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621690395873"><span class="hs-identifier hs-var">reqHeaders</span></a></span></span><span> </span><span id="local-6989586621690395872"><span class="annot"><span class="annottext">SerializableBlob
</span><a href="#local-6989586621690395872"><span class="hs-identifier hs-var">respBody</span></a></span></span><span> </span><span id="local-6989586621690395871"><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621690395871"><span class="hs-identifier hs-var">respHeaders</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-559"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690395870"><span class="annot"><span class="annottext">resp :: Response 'EventType
</span><a href="#local-6989586621690395870"><span class="hs-identifier hs-var hs-var">resp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-560"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621690395874"><span class="hs-identifier hs-var">statusMaybe</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-561"></span><span>          </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (a :: TriggerTypes). SerializableBlob -&gt; Response a
</span><a href="Hasura.Eventing.HTTP.html#mkClientErr"><span class="hs-identifier hs-var">mkClientErr</span></a></span><span> </span><span class="annot"><span class="annottext">SerializableBlob
</span><a href="#local-6989586621690395872"><span class="hs-identifier hs-var">respBody</span></a></span><span>
</span><span id="line-562"></span><span>          </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621690395868"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621690395868"><span class="hs-identifier hs-var">status</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-563"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621690395868"><span class="hs-identifier hs-var">status</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">200</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621690395868"><span class="hs-identifier hs-var">status</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">300</span></span><span>
</span><span id="line-564"></span><span>              </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall (a :: TriggerTypes).
Int -&gt; SerializableBlob -&gt; [HeaderConf] -&gt; Response a
</span><a href="Hasura.Eventing.HTTP.html#mkResp"><span class="hs-identifier hs-var">mkResp</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621690395868"><span class="hs-identifier hs-var">status</span></a></span><span> </span><span class="annot"><span class="annottext">SerializableBlob
</span><a href="#local-6989586621690395872"><span class="hs-identifier hs-var">respBody</span></a></span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621690395871"><span class="hs-identifier hs-var">respHeaders</span></a></span><span>
</span><span id="line-565"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall (a :: TriggerTypes). SerializableBlob -&gt; Response a
</span><a href="Hasura.Eventing.HTTP.html#mkClientErr"><span class="hs-identifier hs-var">mkClientErr</span></a></span><span> </span><span class="annot"><span class="annottext">SerializableBlob
</span><a href="#local-6989586621690395872"><span class="hs-identifier hs-var">respBody</span></a></span><span>
</span><span id="line-566"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (a :: TriggerTypes).
EventId
-&gt; Maybe Int -&gt; WebhookRequest -&gt; Response a -&gt; Invocation a
</span><a href="Hasura.RQL.Types.Eventing.html#Invocation"><span class="hs-identifier hs-var">Invocation</span></a></span><span>
</span><span id="line-567"></span><span>        </span><span class="annot"><span class="annottext">EventId
</span><a href="#local-6989586621690395876"><span class="hs-identifier hs-var">eid</span></a></span><span>
</span><span id="line-568"></span><span>        </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621690395874"><span class="hs-identifier hs-var">statusMaybe</span></a></span><span>
</span><span id="line-569"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Value -&gt; [HeaderConf] -&gt; Text -&gt; WebhookRequest
</span><a href="Hasura.Eventing.HTTP.html#mkWebhookReq"><span class="hs-identifier hs-var">mkWebhookReq</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621690395875"><span class="hs-identifier hs-var">ep</span></a></span><span> </span><span class="annot"><span class="annottext">[HeaderConf]
</span><a href="#local-6989586621690395873"><span class="hs-identifier hs-var">reqHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="Hasura.RQL.Types.Eventing.html#invocationVersionET"><span class="hs-identifier hs-var">invocationVersionET</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-570"></span><span>        </span><span class="annot"><span class="annottext">Response 'EventType
</span><a href="#local-6989586621690395870"><span class="hs-identifier hs-var">resp</span></a></span><span>
</span><span id="line-571"></span><span>
</span><span id="line-572"></span><span id="local-6989586621690397138"><span id="local-6989586621690397139"><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier hs-type">logQErr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/mtl-2.2.2/src"><span class="hs-identifier hs-type">MonadReader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397139"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397138"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Has</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">L.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621690397139"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397138"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621690397138"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-573"></span><span id="logQErr"><span class="annot"><span class="annottext">logQErr :: forall r (m :: * -&gt; *).
(MonadReader r m, Has (Logger Hasura) r, MonadIO m) =&gt;
QErr -&gt; m ()
</span><a href="Hasura.Eventing.EventTrigger.html#logQErr"><span class="hs-identifier hs-var hs-var">logQErr</span></a></span></span><span> </span><span id="local-6989586621690395852"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621690395852"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-574"></span><span>  </span><span id="local-6989586621690395851"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621690395851"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">L.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/mtl-2.2.2/src"><span class="hs-identifier hs-var">asks</span></a></span><span> </span><span class="annot"><span class="annottext">forall a t. Has a t =&gt; t -&gt; a
</span><span class="hs-identifier hs-var">getter</span></span><span>
</span><span id="line-575"></span><span>  </span><span class="annot"><span class="annottext">forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">L.unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621690395851"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; EventInternalErr
</span><a href="Hasura.Eventing.EventTrigger.html#EventInternalErr"><span class="hs-identifier hs-var">EventInternalErr</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621690395852"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-576"></span><span>
</span><span id="line-577"></span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html#getEventTriggerInfoFromEvent"><span class="hs-identifier hs-type">getEventTriggerInfoFromEvent</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-578"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621690397137"><span class="annot"><a href="#local-6989586621690397137"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#Backend"><span class="hs-identifier hs-type">Backend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397137"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#SchemaCache"><span class="hs-identifier hs-type">SchemaCache</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397137"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.EventTrigger.html#EventTriggerInfo"><span class="hs-identifier hs-type">EventTriggerInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621690397137"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-579"></span><span id="getEventTriggerInfoFromEvent"><span class="annot"><span class="annottext">getEventTriggerInfoFromEvent :: forall (b :: BackendType).
Backend b =&gt;
SchemaCache -&gt; Event b -&gt; Either Text (EventTriggerInfo b)
</span><a href="Hasura.Eventing.EventTrigger.html#getEventTriggerInfoFromEvent"><span class="hs-identifier hs-var hs-var">getEventTriggerInfoFromEvent</span></a></span></span><span> </span><span id="local-6989586621690395824"><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621690395824"><span class="hs-identifier hs-var">sc</span></a></span></span><span> </span><span id="local-6989586621690395823"><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690395823"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-580"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690395822"><span class="annot"><span class="annottext">table :: TableName b
</span><a href="#local-6989586621690395822"><span class="hs-identifier hs-var hs-var">table</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType). Event b -&gt; TableName b
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTable"><span class="hs-identifier hs-var">eTable</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690395823"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-581"></span><span>      </span><span id="local-6989586621690395821"><span class="annot"><span class="annottext">mTableInfo :: Maybe (TableInfo b)
</span><a href="#local-6989586621690395821"><span class="hs-identifier hs-var hs-var">mTableInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType).
Backend b =&gt;
SourceName -&gt; TableName b -&gt; SourceCache -&gt; Maybe (TableInfo b)
</span><a href="Hasura.RQL.Types.SchemaCache.html#unsafeTableInfo"><span class="hs-identifier hs-var">unsafeTableInfo</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621690397137"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (b :: BackendType). Event b -&gt; SourceName
</span><a href="Hasura.RQL.Types.EventTrigger.html#eSource"><span class="hs-identifier hs-var">eSource</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690395823"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621690395822"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; SourceCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#scSources"><span class="hs-identifier hs-var">scSources</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621690395824"><span class="hs-identifier hs-var">sc</span></a></span><span>
</span><span id="line-582"></span><span>  </span><span id="local-6989586621690395818"><span class="annot"><span class="annottext">TableInfo b
</span><a href="#local-6989586621690395818"><span class="hs-identifier hs-var">tableInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; m a -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.2.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">onNothing</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TableInfo b)
</span><a href="#local-6989586621690395821"><span class="hs-identifier hs-var">mTableInfo</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;table '&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621690395822"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;' not found&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-583"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621690395815"><span class="annot"><span class="annottext">triggerName :: TriggerName
</span><a href="#local-6989586621690395815"><span class="hs-identifier hs-var hs-var">triggerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TriggerMetadata -&gt; TriggerName
</span><a href="Hasura.RQL.Types.EventTrigger.html#tmName"><span class="hs-identifier hs-var">tmName</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType). Event b -&gt; TriggerMetadata
</span><a href="Hasura.RQL.Types.EventTrigger.html#eTrigger"><span class="hs-identifier hs-var">eTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">Event b
</span><a href="#local-6989586621690395823"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-584"></span><span>      </span><span id="local-6989586621690395813"><span class="annot"><span class="annottext">mEventTriggerInfo :: Maybe (EventTriggerInfo b)
</span><a href="#local-6989586621690395813"><span class="hs-identifier hs-var hs-var">mEventTriggerInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621690395815"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (b :: BackendType). TableInfo b -&gt; EventTriggerInfoMap b
</span><a href="Hasura.RQL.Types.Table.html#_tiEventTriggerInfoMap"><span class="hs-identifier hs-var">_tiEventTriggerInfoMap</span></a></span><span> </span><span class="annot"><span class="annottext">TableInfo b
</span><a href="#local-6989586621690395818"><span class="hs-identifier hs-var">tableInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-585"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; m a -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.2.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">onNothing</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (EventTriggerInfo b)
</span><a href="#local-6989586621690395813"><span class="hs-identifier hs-var">mEventTriggerInfo</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-586"></span><span>    </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span>
</span><span id="line-587"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;event trigger '&quot;</span></span><span>
</span><span id="line-588"></span><span>          </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; Text
</span><a href="Hasura.RQL.Types.EventTrigger.html#triggerNameToTxt"><span class="hs-identifier hs-var">triggerNameToTxt</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621690395815"><span class="hs-identifier hs-var">triggerName</span></a></span><span>
</span><span id="line-589"></span><span>          </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;' on table '&quot;</span></span><span>
</span><span id="line-590"></span><span>          </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TableName b
</span><a href="#local-6989586621690395822"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;' not found&quot;</span></span><span>
</span><span id="line-591"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-592"></span></pre></body></html>