<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | Connect to a postgres db and run queries.</span><span>
</span><span id="line-2"></span><span class="hs-comment">--   This module is meant for simple one-off checks against</span><span>
</span><span id="line-3"></span><span class="hs-comment">--   a postgres database, such as health checks or version checks,</span><span>
</span><span id="line-4"></span><span class="hs-comment">--   and not for normal work.</span><span>
</span><span id="line-5"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hasura.Backends.Postgres.Connection.Connect</span><span>
</span><span id="line-6"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.Connect.html#withPostgresDB"><span class="hs-identifier">withPostgresDB</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-8"></span><span class="hs-keyword">where</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Environment.html"><span class="hs-identifier">Data.Environment</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Env</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.html"><span class="hs-identifier">Database.PG.Query</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PG</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.html"><span class="hs-identifier">Hasura.Backends.Postgres.Connection</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PG</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier">QErr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html"><span class="hs-identifier">Hasura.RQL.Types.Common</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Common.html#resolveUrlConf"><span class="hs-identifier">resolveUrlConf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="annot"><span class="hs-comment">-- | Connect to a postgres database and run a transaction.</span></span><span>
</span><span id="line-18"></span><span id="local-6989586621687274129"><span class="annot"><a href="Hasura.Backends.Postgres.Connection.Connect.html#withPostgresDB"><span class="hs-identifier hs-type">withPostgresDB</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Environment.html#Environment"><span class="hs-identifier hs-type">Env.Environment</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.Settings.html#PostgresConnConfiguration"><span class="hs-identifier hs-type">PG.PostgresConnConfiguration</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Transaction.html#TxET"><span class="hs-identifier hs-type">PG.TxET</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621687274129"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621687274129"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-19"></span><span id="withPostgresDB"><span class="annot"><span class="annottext">withPostgresDB :: forall a.
Environment
-&gt; PostgresConnConfiguration
-&gt; TxET QErr IO a
-&gt; IO (Either QErr a)
</span><a href="Hasura.Backends.Postgres.Connection.Connect.html#withPostgresDB"><span class="hs-identifier hs-var hs-var">withPostgresDB</span></a></span></span><span> </span><span id="local-6989586621687274200"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621687274200"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.Settings.html#PostgresConnConfiguration"><span class="hs-identifier hs-type">PG.PostgresConnConfiguration</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621687274202"><span id="local-6989586621687274203"><span id="local-6989586621687274204"><span id="local-6989586621687274205"><span id="local-6989586621687274206"><span class="annot"><span class="annottext">Maybe (NonEmpty PostgresSourceConnInfo)
Maybe PostgresConnectionSet
Maybe ConnectionTemplate
ExtensionsSchema
PostgresSourceConnInfo
_pccConnectionInfo :: PostgresSourceConnInfo
_pccReadReplicas :: Maybe (NonEmpty PostgresSourceConnInfo)
_pccExtensionsSchema :: ExtensionsSchema
_pccConnectionTemplate :: Maybe ConnectionTemplate
_pccConnectionSet :: Maybe PostgresConnectionSet
_pccConnectionInfo :: PostgresConnConfiguration -&gt; PostgresSourceConnInfo
_pccReadReplicas :: PostgresConnConfiguration
-&gt; Maybe (NonEmpty PostgresSourceConnInfo)
_pccExtensionsSchema :: PostgresConnConfiguration -&gt; ExtensionsSchema
_pccConnectionTemplate :: PostgresConnConfiguration -&gt; Maybe ConnectionTemplate
_pccConnectionSet :: PostgresConnConfiguration -&gt; Maybe PostgresConnectionSet
</span><a href="#local-6989586621687274202"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621687274212"><span class="annot"><span class="annottext">TxET QErr IO a
</span><a href="#local-6989586621687274212"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-20"></span><span>  </span><span class="annot"><span class="annottext">PostgresSourceConnInfo -&gt; IO (Either QErr PGPool)
</span><a href="#local-6989586621687274213"><span class="hs-identifier hs-var">generateMinimalPool</span></a></span><span> </span><span class="annot"><span class="annottext">PostgresSourceConnInfo
</span><a href="#local-6989586621687274202"><span class="hs-identifier hs-var">_pccConnectionInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr PGPool)
-&gt; (Either QErr PGPool -&gt; IO (Either QErr a)) -&gt; IO (Either QErr a)
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621687274214"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621687274214"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-22"></span><span>      </span><span class="hs-comment">-- Cannot able to intialise a pool due to a bad connection config.</span><span>
</span><span id="line-23"></span><span>      </span><span class="annot"><span class="annottext">Either QErr a -&gt; IO (Either QErr a)
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either QErr a -&gt; IO (Either QErr a))
-&gt; Either QErr a -&gt; IO (Either QErr a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; Either QErr a
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621687274214"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621687274215"><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621687274215"><span class="hs-identifier hs-var">pool</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ExceptT QErr IO a -&gt; IO (Either QErr a)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PGPool -&gt; TxET QErr IO a -&gt; ExceptT QErr IO a
forall (m :: * -&gt; *) e a.
(MonadIO m, MonadBaseControl IO m, FromPGConnErr e) =&gt;
PGPool -&gt; TxET e m a -&gt; ExceptT e m a
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Pool.html#runTx%27"><span class="hs-identifier hs-var">PG.runTx'</span></a></span><span> </span><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621687274215"><span class="hs-identifier hs-var">pool</span></a></span><span> </span><span class="annot"><span class="annottext">TxET QErr IO a
</span><a href="#local-6989586621687274212"><span class="hs-identifier hs-var">tx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><a href="#local-6989586621687274213"><span class="hs-identifier hs-type">generateMinimalPool</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.Settings.html#PostgresSourceConnInfo"><span class="hs-identifier hs-type">PG.PostgresSourceConnInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Pool.html#PGPool"><span class="hs-identifier hs-type">PG.PGPool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span>    </span><span id="local-6989586621687274213"><span class="annot"><span class="annottext">generateMinimalPool :: PostgresSourceConnInfo -&gt; IO (Either QErr PGPool)
</span><a href="#local-6989586621687274213"><span class="hs-identifier hs-var hs-var">generateMinimalPool</span></a></span></span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.Settings.html#PostgresSourceConnInfo"><span class="hs-identifier hs-type">PG.PostgresSourceConnInfo</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621687274219"><span id="local-6989586621687274220"><span id="local-6989586621687274221"><span id="local-6989586621687274222"><span id="local-6989586621687274223"><span class="annot"><span class="annottext">Bool
Maybe (PGClientCerts CertVar CertVar)
Maybe PostgresPoolSettings
TxIsolation
UrlConf
_psciDatabaseUrl :: UrlConf
_psciPoolSettings :: Maybe PostgresPoolSettings
_psciUsePreparedStatements :: Bool
_psciIsolationLevel :: TxIsolation
_psciSslConfiguration :: Maybe (PGClientCerts CertVar CertVar)
_psciDatabaseUrl :: PostgresSourceConnInfo -&gt; UrlConf
_psciPoolSettings :: PostgresSourceConnInfo -&gt; Maybe PostgresPoolSettings
_psciUsePreparedStatements :: PostgresSourceConnInfo -&gt; Bool
_psciIsolationLevel :: PostgresSourceConnInfo -&gt; TxIsolation
_psciSslConfiguration :: PostgresSourceConnInfo -&gt; Maybe (PGClientCerts CertVar CertVar)
</span><a href="#local-6989586621687274219"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT QErr IO PGPool -&gt; IO (Either QErr PGPool)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-28"></span><span>      </span><span id="local-6989586621687274229"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687274229"><span class="hs-identifier hs-var">urlText</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Environment -&gt; UrlConf -&gt; ExceptT QErr IO Text
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
Environment -&gt; UrlConf -&gt; m Text
</span><a href="Hasura.RQL.Types.Common.html#resolveUrlConf"><span class="hs-identifier hs-var">resolveUrlConf</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621687274200"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">UrlConf
</span><a href="#local-6989586621687274219"><span class="hs-identifier hs-var">_psciDatabaseUrl</span></a></span><span>
</span><span id="line-29"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621687274230"><span class="annot"><span class="annottext">connInfo :: ConnInfo
</span><a href="#local-6989586621687274230"><span class="hs-identifier hs-var hs-var">connInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ConnDetails -&gt; ConnInfo
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Connection.html#ConnInfo"><span class="hs-identifier hs-var">PG.ConnInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">(ConnDetails -&gt; ConnInfo) -&gt; ConnDetails -&gt; ConnInfo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ConnDetails
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Connection.html#CDDatabaseURI"><span class="hs-identifier hs-var">PG.CDDatabaseURI</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ConnDetails) -&gt; ByteString -&gt; ConnDetails
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; ByteString
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html#txtToBs"><span class="hs-identifier hs-var">txtToBs</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621687274229"><span class="hs-identifier hs-var">urlText</span></a></span><span>
</span><span id="line-30"></span><span>          </span><span class="hs-comment">-- Create pool with only one connection</span><span>
</span><span id="line-31"></span><span>          </span><span id="local-6989586621687274234"><span class="annot"><span class="annottext">connParams :: ConnParams
</span><a href="#local-6989586621687274234"><span class="hs-identifier hs-var hs-var">connParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnParams
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Pool.html#defaultConnParams"><span class="hs-identifier hs-var">PG.defaultConnParams</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">cpConns :: Int
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Pool.html#cpConns"><span class="hs-identifier hs-var">PG.cpConns</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">}</span><span>
</span><span id="line-32"></span><span>      </span><span class="annot"><span class="annottext">IO PGPool -&gt; ExceptT QErr IO PGPool
forall a. IO a -&gt; ExceptT QErr IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO PGPool -&gt; ExceptT QErr IO PGPool)
-&gt; IO PGPool -&gt; ExceptT QErr IO PGPool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConnInfo -&gt; ConnParams -&gt; PGLogger -&gt; IO PGPool
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/pg-client-0.1.0/opt/doc/html/pg-client/src/Database.PG.Query.Pool.html#initPGPool"><span class="hs-identifier hs-var">PG.initPGPool</span></a></span><span> </span><span class="annot"><span class="annottext">ConnInfo
</span><a href="#local-6989586621687274230"><span class="hs-identifier hs-var">connInfo</span></a></span><span> </span><span class="annot"><span class="annottext">ConnParams
</span><a href="#local-6989586621687274234"><span class="hs-identifier hs-var">connParams</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">PGLogEvent
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-33"></span></pre></body></html>