<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hasura.Server.SchemaUpdate</span><span>
</span><span id="line-5"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#startSchemaSyncListenerThread"><span class="hs-identifier">startSchemaSyncListenerThread</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#startSchemaSyncProcessorThread"><span class="hs-identifier">startSchemaSyncProcessorThread</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Hasura.Server.Logging.html#SchemaSyncThreadType"><span class="hs-identifier">SchemaSyncThreadType</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-9"></span><span class="hs-keyword">where</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Control.Concurrent.Extended.html"><span class="hs-identifier">Control.Concurrent.Extended</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/stm-2.5.0.2/src"><span class="hs-identifier">Control.Concurrent.STM</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">STM</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Immortal</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Immortal</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Loops</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">L</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Control</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadBaseControl</span></span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Control.Monad.Trans.Managed.html"><span class="hs-identifier">Control.Monad.Trans.Managed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Trans.Managed.html#ManagedT"><span class="hs-identifier">ManagedT</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson.Casing</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson.TH</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HM</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashSet</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HS</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.2.5/pg-client-0.1.0/opt/doc/html/pg-client/src"><span class="hs-identifier">Database.PG.Query</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PG</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.App.State.html"><span class="hs-identifier">Hasura.App.State</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Logging.html"><span class="hs-identifier">Hasura.Logging</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Metadata.Class.html"><span class="hs-identifier">Hasura.Metadata.Class</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.2.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.html#runCacheRWT"><span class="hs-identifier">runCacheRWT</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Config.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema.Cache.Config</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Catalog.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema.Catalog</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html"><span class="hs-identifier">Hasura.RQL.Types.SchemaCache</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html"><span class="hs-identifier">Hasura.RQL.Types.SchemaCache.Build</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html"><span class="hs-identifier">Hasura.RQL.Types.Source</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.SQL.Backend.html"><span class="hs-identifier">Hasura.SQL.Backend</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.SQL.Backend.html#BackendType"><span class="hs-identifier">BackendType</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.SQL.BackendMap.html"><span class="hs-identifier">Hasura.SQL.BackendMap</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BackendMap</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.AppStateRef.html"><span class="hs-identifier">Hasura.Server.AppStateRef</span></a></span><span>
</span><span id="line-38"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Server.AppStateRef.html#AppStateRef"><span class="hs-identifier">AppStateRef</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><a href="Hasura.Server.AppStateRef.html#getAppContext"><span class="hs-identifier">getAppContext</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><a href="Hasura.Server.AppStateRef.html#getRebuildableSchemaCacheWithVersion"><span class="hs-identifier">getRebuildableSchemaCacheWithVersion</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>    </span><span class="annot"><a href="Hasura.Server.AppStateRef.html#withSchemaCacheUpdate"><span class="hs-identifier">withSchemaCacheUpdate</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Logging.html"><span class="hs-identifier">Hasura.Server.Logging</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html"><span class="hs-identifier">Hasura.Server.Types</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Services.html"><span class="hs-identifier">Hasura.Services</span></a></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Refined</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NonNegative</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Refined</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unrefine</span></span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="hs-keyword">data</span><span> </span><span id="ThreadError"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#ThreadError"><span class="hs-identifier hs-var">ThreadError</span></a></span></span><span>
</span><span id="line-49"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="TEPayloadParse"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#TEPayloadParse"><span class="hs-identifier hs-var">TEPayloadParse</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-50"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TEQueryError"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#TEQueryError"><span class="hs-identifier hs-var">TEQueryError</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="hs-special">$</span><span id="local-6989586621691178226"><span id="local-6989586621691178228"><span id="local-6989586621691178239"><span id="local-6989586621691178257"><span class="hs-special">(</span><span> </span><span class="hs-identifier">deriveToJSON</span><span>
</span><span id="line-53"></span><span>     </span><span class="hs-identifier">defaultOptions</span><span>
</span><span id="line-54"></span><span>       </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">constructorTagModifier</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">snakeCase</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">drop</span><span> </span><span class="hs-number">2</span><span class="hs-special">,</span><span>
</span><span id="line-55"></span><span>         </span><span class="hs-identifier">sumEncoding</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">TaggedObject</span><span> </span><span class="hs-string">&quot;type&quot;</span><span> </span><span class="hs-string">&quot;info&quot;</span><span>
</span><span id="line-56"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-57"></span><span>     </span><span class="hs-special">''</span><span class="hs-identifier">ThreadError</span><span>
</span><span id="line-58"></span><span> </span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span id="local-6989586621691178536"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#logThreadStarted"><span class="hs-identifier hs-type">logThreadStarted</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-61"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178536"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-62"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-63"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#InstanceId"><span class="hs-identifier hs-type">InstanceId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-64"></span><span>  </span><span class="annot"><a href="Hasura.Server.Logging.html#SchemaSyncThreadType"><span class="hs-identifier hs-type">SchemaSyncThreadType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-65"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Immortal.Thread</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-66"></span><span>  </span><span class="annot"><a href="#local-6989586621691178536"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-67"></span><span id="logThreadStarted"><span class="annot"><span class="annottext">logThreadStarted :: forall (m :: * -&gt; *).
MonadIO m =&gt;
Logger Hasura
-&gt; InstanceId -&gt; SchemaSyncThreadType -&gt; Thread -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logThreadStarted"><span class="hs-identifier hs-var hs-var">logThreadStarted</span></a></span></span><span> </span><span id="local-6989586621691178176"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621691178176"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621691178175"><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621691178175"><span class="hs-identifier hs-var">instanceId</span></a></span></span><span> </span><span id="local-6989586621691178174"><span class="annot"><span class="annottext">SchemaSyncThreadType
</span><a href="#local-6989586621691178174"><span class="hs-identifier hs-var">threadType</span></a></span></span><span> </span><span id="local-6989586621691178173"><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621691178173"><span class="hs-identifier hs-var">thread</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-68"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621691178172"><span class="annot"><span class="annottext">msg :: Text
</span><a href="#local-6989586621691178172"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; Text
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.2.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">tshow</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaSyncThreadType
</span><a href="#local-6989586621691178174"><span class="hs-identifier hs-var">threadType</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; thread started&quot;</span></span><span>
</span><span id="line-69"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621691178176"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-70"></span><span>        </span><span class="annot"><span class="annottext">LogLevel -&gt; Text -&gt; Value -&gt; StartupLog
</span><a href="Hasura.Server.Logging.html#StartupLog"><span class="hs-identifier hs-var">StartupLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;schema-sync&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-71"></span><span>          </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">object</span></span><span>
</span><span id="line-72"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;instance_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">InstanceId -&gt; Text
</span><a href="Hasura.Server.Types.html#getInstanceId"><span class="hs-identifier hs-var">getInstanceId</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621691178175"><span class="hs-identifier hs-var">instanceId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-73"></span><span>              </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;thread_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Thread -&gt; ThreadId
</span><span class="hs-identifier hs-var">Immortal.threadId</span></span><span> </span><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621691178173"><span class="hs-identifier hs-var">thread</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-74"></span><span>              </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;message&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621691178172"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-75"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span class="hs-comment">{- Note [Schema Cache Sync]
~~~~~~~~~~~~~~~~~~~~~~~~~~~

When multiple graphql-engine instances are serving on same metadata storage,
each instance should have schema cache in sync with latest metadata. Somehow
all instances should communicate each other when any request has modified metadata.

We track the metadata schema version in postgres and poll for this
value in a thread.  When the schema version has changed, the instance
will update its local metadata schema and remove any invalidated schema cache data.

The following steps take place when an API request made to update metadata:

1. After handling the request we insert the new metadata schema json
   into a postgres tablealong with a schema version.

2. On start up, before initialising schema cache, an async thread is
   invoked to continuously poll the Postgres notifications table for
   the latest metadata schema version. The schema version is pushed to
   a shared `TMVar`.

3. Before starting API server, another async thread is invoked to
   process events pushed by the listener thread via the `TMVar`. If
   the instance's schema version is not current with the freshly
   updated TMVar version then we update the local metadata.

Why we need two threads if we can capture and reload schema cache in a single thread?

If we want to implement schema sync in a single async thread we have to invoke the same
after initialising schema cache. We may loose events that published after schema cache
init and before invoking the thread. In such case, schema cache is not in sync with metadata.
So we choose two threads in which one will start listening before schema cache init and the
other after it.

What happens if listen connection to Postgres is lost?

Listener thread will keep trying to establish connection to Postgres for every one second.
Once connection established, it pushes @'SSEListenStart' event with time. We aren't sure
about any metadata modify requests made in meanwhile. So we reload schema cache unconditionally
if listen started after schema cache init start time.

-}</span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span class="hs-comment">-- | An async thread which listen to Postgres notify to enable schema syncing</span><span>
</span><span id="line-121"></span><span class="hs-comment">-- See Note [Schema Cache Sync]</span><span>
</span><span id="line-122"></span><span id="local-6989586621691178511"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#startSchemaSyncListenerThread"><span class="hs-identifier hs-type">startSchemaSyncListenerThread</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-123"></span><span>  </span><span class="annot"><a href="Control.Concurrent.Extended.html#ForkableMonadIO"><span class="hs-identifier hs-type">C.ForkableMonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178511"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-124"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-125"></span><span>  </span><span class="annot"><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.2.5/pg-client-0.1.0/opt/doc/html/pg-client/src"><span class="hs-identifier hs-type">PG.PGPool</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-126"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#InstanceId"><span class="hs-identifier hs-type">InstanceId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-127"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Refined</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">NonNegative</span></span><span> </span><span class="annot"><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.2.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-type">Milliseconds</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-128"></span><span>  </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/stm-2.5.0.2/src"><span class="hs-identifier hs-type">STM.TMVar</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataResourceVersion"><span class="hs-identifier hs-type">MetadataResourceVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-129"></span><span>  </span><span class="annot"><a href="Control.Monad.Trans.Managed.html#ManagedT"><span class="hs-identifier hs-type">ManagedT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178511"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Immortal.Thread</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-130"></span><span id="startSchemaSyncListenerThread"><span class="annot"><span class="annottext">startSchemaSyncListenerThread :: forall (m :: * -&gt; *).
ForkableMonadIO m =&gt;
Logger Hasura
-&gt; PGPool
-&gt; InstanceId
-&gt; Refined NonNegative Milliseconds
-&gt; TMVar MetadataResourceVersion
-&gt; ManagedT m Thread
</span><a href="Hasura.Server.SchemaUpdate.html#startSchemaSyncListenerThread"><span class="hs-identifier hs-var hs-var">startSchemaSyncListenerThread</span></a></span></span><span> </span><span id="local-6989586621691178150"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621691178150"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621691178149"><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621691178149"><span class="hs-identifier hs-var">pool</span></a></span></span><span> </span><span id="local-6989586621691178148"><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621691178148"><span class="hs-identifier hs-var">instanceId</span></a></span></span><span> </span><span id="local-6989586621691178147"><span class="annot"><span class="annottext">Refined NonNegative Milliseconds
</span><a href="#local-6989586621691178147"><span class="hs-identifier hs-var">interval</span></a></span></span><span> </span><span id="local-6989586621691178146"><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
</span><a href="#local-6989586621691178146"><span class="hs-identifier hs-var">metaVersionRef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-131"></span><span>  </span><span class="hs-comment">-- Start listener thread</span><span>
</span><span id="line-132"></span><span>  </span><span id="local-6989586621691178145"><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621691178145"><span class="hs-identifier hs-var">listenerThread</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-133"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
ForkableMonadIO m =&gt;
String -&gt; Logger Hasura -&gt; m Void -&gt; ManagedT m Thread
</span><a href="Control.Concurrent.Extended.html#forkManagedT"><span class="hs-identifier hs-var">C.forkManagedT</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SchemeUpdate.listener&quot;</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621691178150"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-134"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) void.
MonadIO m =&gt;
Logger Hasura
-&gt; PGPool
-&gt; TMVar MetadataResourceVersion
-&gt; Milliseconds
-&gt; m void
</span><a href="Hasura.Server.SchemaUpdate.html#listener"><span class="hs-identifier hs-var">listener</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621691178150"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621691178149"><span class="hs-identifier hs-var">pool</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
</span><a href="#local-6989586621691178146"><span class="hs-identifier hs-var">metaVersionRef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall {k} (p :: k) x. Refined p x -&gt; x
</span><span class="hs-identifier hs-var">unrefine</span></span><span> </span><span class="annot"><span class="annottext">Refined NonNegative Milliseconds
</span><a href="#local-6989586621691178147"><span class="hs-identifier hs-var">interval</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-135"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadIO m =&gt;
Logger Hasura
-&gt; InstanceId -&gt; SchemaSyncThreadType -&gt; Thread -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logThreadStarted"><span class="hs-identifier hs-var">logThreadStarted</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621691178150"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621691178148"><span class="hs-identifier hs-var">instanceId</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaSyncThreadType
</span><a href="Hasura.Server.Logging.html#TTListener"><span class="hs-identifier hs-var">TTListener</span></a></span><span> </span><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621691178145"><span class="hs-identifier hs-var">listenerThread</span></a></span><span>
</span><span id="line-136"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621691178145"><span class="hs-identifier hs-var">listenerThread</span></a></span><span>
</span><span id="line-137"></span><span>
</span><span id="line-138"></span><span class="hs-comment">-- | An async thread which processes the schema sync events</span><span>
</span><span id="line-139"></span><span class="hs-comment">-- See Note [Schema Cache Sync]</span><span>
</span><span id="line-140"></span><span id="local-6989586621691178479"><span id="local-6989586621691178485"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#startSchemaSyncProcessorThread"><span class="hs-identifier hs-type">startSchemaSyncProcessorThread</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Control.Concurrent.Extended.html#ForkableMonadIO"><span class="hs-identifier hs-type">C.ForkableMonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178485"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-142"></span><span>    </span><span class="annot"><a href="Hasura.App.State.html#HasAppEnv"><span class="hs-identifier hs-type">HasAppEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178485"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-143"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Config.html#HasCacheStaticConfig"><span class="hs-identifier hs-type">HasCacheStaticConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178485"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-144"></span><span>    </span><span class="annot"><a href="Hasura.Metadata.Class.html#MonadMetadataStorage"><span class="hs-identifier hs-type">MonadMetadataStorage</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178485"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-145"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MonadResolveSource"><span class="hs-identifier hs-type">MonadResolveSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178485"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-146"></span><span>    </span><span class="annot"><a href="Hasura.Services.Network.html#ProvidesNetwork"><span class="hs-identifier hs-type">ProvidesNetwork</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178485"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-147"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-148"></span><span>  </span><span class="annot"><a href="Hasura.Server.AppStateRef.html#AppStateRef"><span class="hs-identifier hs-type">AppStateRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178479"><span class="hs-identifier hs-type">impl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-149"></span><span>  </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">STM.TVar</span></a></span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-150"></span><span>  </span><span class="annot"><a href="Control.Monad.Trans.Managed.html#ManagedT"><span class="hs-identifier hs-type">ManagedT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178485"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Immortal.Thread</span></span></span></span><span>
</span><span id="line-151"></span><span id="startSchemaSyncProcessorThread"><span class="annot"><span class="annottext">startSchemaSyncProcessorThread :: forall (m :: * -&gt; *) impl.
(ForkableMonadIO m, HasAppEnv m, HasCacheStaticConfig m,
 MonadMetadataStorage m, MonadResolveSource m, ProvidesNetwork m) =&gt;
AppStateRef impl -&gt; TVar Bool -&gt; ManagedT m Thread
</span><a href="Hasura.Server.SchemaUpdate.html#startSchemaSyncProcessorThread"><span class="hs-identifier hs-var hs-var">startSchemaSyncProcessorThread</span></a></span></span><span> </span><span id="local-6989586621691178115"><span class="annot"><span class="annottext">AppStateRef impl
</span><a href="#local-6989586621691178115"><span class="hs-identifier hs-var">appStateRef</span></a></span></span><span> </span><span id="local-6989586621691178114"><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621691178114"><span class="hs-identifier hs-var">logTVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-152"></span><span>  </span><span class="annot"><a href="Hasura.App.State.html#AppEnv"><span class="hs-identifier hs-type">AppEnv</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621691178084"><span id="local-6989586621691178085"><span id="local-6989586621691178086"><span id="local-6989586621691178087"><span id="local-6989586621691178088"><span id="local-6989586621691178089"><span id="local-6989586621691178090"><span id="local-6989586621691178091"><span id="local-6989586621691178092"><span id="local-6989586621691178093"><span id="local-6989586621691178094"><span id="local-6989586621691178095"><span id="local-6989586621691178096"><span id="local-6989586621691178097"><span id="local-6989586621691178098"><span id="local-6989586621691178099"><span id="local-6989586621691178100"><span id="local-6989586621691178101"><span id="local-6989586621691178102"><span id="local-6989586621691178103"><span id="local-6989586621691178104"><span id="local-6989586621691178105"><span id="local-6989586621691178106"><span id="local-6989586621691178107"><span id="local-6989586621691178108"><span id="local-6989586621691178109"><span id="local-6989586621691178110"><span id="local-6989586621691178111"><span id="local-6989586621691178112"><span class="annot"><span class="annottext">Maybe Text
Maybe (CredentialCache AgentLicenseKey)
SamplingPolicy
PGPool
ConnParams
TxIsolation
TMVar MetadataResourceVersion
Refined NonNegative Seconds
Manager
CheckFeatureFlag
ServerMetrics
PrometheusMetrics
EventingMode
ReadOnlyMode
MaintenanceMode ()
InstanceId
ShutdownLatch
LockedEventsCtx
LoggingSettings
HostPreference
ConnectionOptions
WSConnectionInitTimeout
KeepAliveDelay
OptionalInterval
Port
SubscriptionsState
Loggers
appEnvLicenseKeyCache :: AppEnv -&gt; Maybe (CredentialCache AgentLicenseKey)
appEnvCheckFeatureFlag :: AppEnv -&gt; CheckFeatureFlag
appEnvSchemaPollInterval :: AppEnv -&gt; OptionalInterval
appEnvGracefulShutdownTimeout :: AppEnv -&gt; Refined NonNegative Seconds
appEnvWebSocketConnectionInitTimeout :: AppEnv -&gt; WSConnectionInitTimeout
appEnvWebSocketKeepAlive :: AppEnv -&gt; KeepAliveDelay
appEnvConnectionOptions :: AppEnv -&gt; ConnectionOptions
appEnvConsoleSentryDsn :: AppEnv -&gt; Maybe Text
appEnvConsoleAssetsDir :: AppEnv -&gt; Maybe Text
appEnvTxIso :: AppEnv -&gt; TxIsolation
appEnvConnParams :: AppEnv -&gt; ConnParams
appEnvLockedEventsCtx :: AppEnv -&gt; LockedEventsCtx
appEnvSubscriptionState :: AppEnv -&gt; SubscriptionsState
appEnvTraceSamplingPolicy :: AppEnv -&gt; SamplingPolicy
appEnvPrometheusMetrics :: AppEnv -&gt; PrometheusMetrics
appEnvMetaVersionRef :: AppEnv -&gt; TMVar MetadataResourceVersion
appEnvShutdownLatch :: AppEnv -&gt; ShutdownLatch
appEnvServerMetrics :: AppEnv -&gt; ServerMetrics
appEnvEnableReadOnlyMode :: AppEnv -&gt; ReadOnlyMode
appEnvEventingMode :: AppEnv -&gt; EventingMode
appEnvLoggingSettings :: AppEnv -&gt; LoggingSettings
appEnvEnableMaintenanceMode :: AppEnv -&gt; MaintenanceMode ()
appEnvInstanceId :: AppEnv -&gt; InstanceId
appEnvMetadataVersionRef :: AppEnv -&gt; TMVar MetadataResourceVersion
appEnvLoggers :: AppEnv -&gt; Loggers
appEnvManager :: AppEnv -&gt; Manager
appEnvMetadataDbPool :: AppEnv -&gt; PGPool
appEnvHost :: AppEnv -&gt; HostPreference
appEnvPort :: AppEnv -&gt; Port
appEnvLicenseKeyCache :: Maybe (CredentialCache AgentLicenseKey)
appEnvCheckFeatureFlag :: CheckFeatureFlag
appEnvSchemaPollInterval :: OptionalInterval
appEnvGracefulShutdownTimeout :: Refined NonNegative Seconds
appEnvWebSocketConnectionInitTimeout :: WSConnectionInitTimeout
appEnvWebSocketKeepAlive :: KeepAliveDelay
appEnvConnectionOptions :: ConnectionOptions
appEnvConsoleSentryDsn :: Maybe Text
appEnvConsoleAssetsDir :: Maybe Text
appEnvTxIso :: TxIsolation
appEnvConnParams :: ConnParams
appEnvLockedEventsCtx :: LockedEventsCtx
appEnvSubscriptionState :: SubscriptionsState
appEnvTraceSamplingPolicy :: SamplingPolicy
appEnvPrometheusMetrics :: PrometheusMetrics
appEnvMetaVersionRef :: TMVar MetadataResourceVersion
appEnvShutdownLatch :: ShutdownLatch
appEnvServerMetrics :: ServerMetrics
appEnvEnableReadOnlyMode :: ReadOnlyMode
appEnvEventingMode :: EventingMode
appEnvLoggingSettings :: LoggingSettings
appEnvEnableMaintenanceMode :: MaintenanceMode ()
appEnvInstanceId :: InstanceId
appEnvMetadataVersionRef :: TMVar MetadataResourceVersion
appEnvLoggers :: Loggers
appEnvManager :: Manager
appEnvMetadataDbPool :: PGPool
appEnvHost :: HostPreference
appEnvPort :: Port
</span><a href="Hasura.App.State.html#appEnvLicenseKeyCache"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/transformers-0.5.6.2/src"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). HasAppEnv m =&gt; m AppEnv
</span><a href="Hasura.App.State.html#askAppEnv"><span class="hs-identifier hs-var">askAppEnv</span></a></span><span>
</span><span id="line-153"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621691178052"><span class="annot"><span class="annottext">logger :: Logger Hasura
</span><a href="#local-6989586621691178052"><span class="hs-identifier hs-var hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Loggers -&gt; Logger Hasura
</span><a href="Hasura.App.State.html#_lsLogger"><span class="hs-identifier hs-var">_lsLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Loggers
</span><a href="#local-6989586621691178108"><span class="hs-identifier hs-var">appEnvLoggers</span></a></span><span>
</span><span id="line-154"></span><span>  </span><span class="hs-comment">-- Start processor thread</span><span>
</span><span id="line-155"></span><span>  </span><span id="local-6989586621691178050"><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621691178050"><span class="hs-identifier hs-var">processorThread</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-156"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
ForkableMonadIO m =&gt;
String -&gt; Logger Hasura -&gt; m Void -&gt; ManagedT m Thread
</span><a href="Control.Concurrent.Extended.html#forkManagedT"><span class="hs-identifier hs-var">C.forkManagedT</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SchemeUpdate.processor&quot;</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621691178052"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-157"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) void impl.
(ForkableMonadIO m, HasAppEnv m, HasCacheStaticConfig m,
 MonadMetadataStorage m, MonadResolveSource m, ProvidesNetwork m) =&gt;
TMVar MetadataResourceVersion
-&gt; AppStateRef impl -&gt; TVar Bool -&gt; m void
</span><a href="Hasura.Server.SchemaUpdate.html#processor"><span class="hs-identifier hs-var">processor</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
</span><a href="#local-6989586621691178107"><span class="hs-identifier hs-var">appEnvMetadataVersionRef</span></a></span><span> </span><span class="annot"><span class="annottext">AppStateRef impl
</span><a href="#local-6989586621691178115"><span class="hs-identifier hs-var">appStateRef</span></a></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621691178114"><span class="hs-identifier hs-var">logTVar</span></a></span><span>
</span><span id="line-158"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadIO m =&gt;
Logger Hasura
-&gt; InstanceId -&gt; SchemaSyncThreadType -&gt; Thread -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logThreadStarted"><span class="hs-identifier hs-var">logThreadStarted</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621691178052"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621691178106"><span class="hs-identifier hs-var">appEnvInstanceId</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaSyncThreadType
</span><a href="Hasura.Server.Logging.html#TTProcessor"><span class="hs-identifier hs-var">TTProcessor</span></a></span><span> </span><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621691178050"><span class="hs-identifier hs-var">processorThread</span></a></span><span>
</span><span id="line-159"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621691178050"><span class="hs-identifier hs-var">processorThread</span></a></span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span class="hs-comment">-- TODO: This is also defined in multitenant, consider putting it in a library somewhere</span><span>
</span><span id="line-162"></span><span id="local-6989586621691178440"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#forcePut"><span class="hs-identifier hs-type">forcePut</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/stm-2.5.0.2/src"><span class="hs-identifier hs-type">STM.TMVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178440"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621691178440"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-163"></span><span id="forcePut"><span class="annot"><span class="annottext">forcePut :: forall a. TMVar a -&gt; a -&gt; IO ()
</span><a href="Hasura.Server.SchemaUpdate.html#forcePut"><span class="hs-identifier hs-var hs-var">forcePut</span></a></span></span><span> </span><span id="local-6989586621691178044"><span class="annot"><span class="annottext">TMVar a
</span><a href="#local-6989586621691178044"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621691178043"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621691178043"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. STM a -&gt; IO a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">STM.atomically</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. TMVar a -&gt; STM (Maybe a)
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/stm-2.5.0.2/src"><span class="hs-identifier hs-var">STM.tryTakeTMVar</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar a
</span><a href="#local-6989586621691178044"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. TMVar a -&gt; a -&gt; STM ()
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/stm-2.5.0.2/src"><span class="hs-identifier hs-var">STM.putTMVar</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar a
</span><a href="#local-6989586621691178044"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621691178043"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#schemaVersionCheckHandler"><span class="hs-identifier hs-type">schemaVersionCheckHandler</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-166"></span><span>  </span><span class="annot"><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.2.5/pg-client-0.1.0/opt/doc/html/pg-client/src"><span class="hs-identifier hs-type">PG.PGPool</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/stm-2.5.0.2/src"><span class="hs-identifier hs-type">STM.TMVar</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataResourceVersion"><span class="hs-identifier hs-type">MetadataResourceVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span id="schemaVersionCheckHandler"><span class="annot"><span class="annottext">schemaVersionCheckHandler :: PGPool -&gt; TMVar MetadataResourceVersion -&gt; IO (Either QErr ())
</span><a href="Hasura.Server.SchemaUpdate.html#schemaVersionCheckHandler"><span class="hs-identifier hs-var hs-var">schemaVersionCheckHandler</span></a></span></span><span> </span><span id="local-6989586621691178038"><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621691178038"><span class="hs-identifier hs-var">pool</span></a></span></span><span> </span><span id="local-6989586621691178037"><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
</span><a href="#local-6989586621691178037"><span class="hs-identifier hs-var">metaVersionRef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-168"></span><span>  </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/transformers-0.5.6.2/src"><span class="hs-identifier hs-var">runExceptT</span></a></span><span>
</span><span id="line-169"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) e a.
(MonadIO m, MonadBaseControl IO m, FromPGTxErr e,
 FromPGConnErr e) =&gt;
PGPool -&gt; TxMode -&gt; TxET e m a -&gt; ExceptT e m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.2.5/pg-client-0.1.0/opt/doc/html/pg-client/src"><span class="hs-identifier hs-var">PG.runTx</span></a></span><span> </span><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621691178038"><span class="hs-identifier hs-var">pool</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxIsolation
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.2.5/pg-client-0.1.0/opt/doc/html/pg-client/src"><span class="hs-identifier hs-var">PG.RepeatableRead</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-170"></span><span>        </span><span class="annot"><span class="annottext">TxE QErr MetadataResourceVersion
</span><a href="Hasura.RQL.DDL.Schema.Catalog.html#fetchMetadataResourceVersionFromCatalog"><span class="hs-identifier hs-var">fetchMetadataResourceVersionFromCatalog</span></a></span><span>
</span><span id="line-171"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-172"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-173"></span><span>      </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621691178032"><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621691178032"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a b. b -&gt; Either a b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. TMVar a -&gt; a -&gt; IO ()
</span><a href="Hasura.Server.SchemaUpdate.html#forcePut"><span class="hs-identifier hs-var">forcePut</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
</span><a href="#local-6989586621691178037"><span class="hs-identifier hs-var">metaVersionRef</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621691178032"><span class="hs-identifier hs-var">version</span></a></span><span>
</span><span id="line-174"></span><span>      </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621691178030"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621691178030"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621691178030"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-175"></span><span>
</span><span id="line-176"></span><span class="hs-keyword">data</span><span> </span><span id="ErrorState"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#ErrorState"><span class="hs-identifier hs-var">ErrorState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ErrorState"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#ErrorState"><span class="hs-identifier hs-var">ErrorState</span></a></span></span><span>
</span><span id="line-177"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_esLastErrorSeen"><span class="annot"><span class="annottext">ErrorState -&gt; Maybe QErr
</span><a href="Hasura.Server.SchemaUpdate.html#_esLastErrorSeen"><span class="hs-identifier hs-var hs-var">_esLastErrorSeen</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-178"></span><span>    </span><span id="_esLastMetadataVersion"><span class="annot"><span class="annottext">ErrorState -&gt; Maybe MetadataResourceVersion
</span><a href="Hasura.Server.SchemaUpdate.html#_esLastMetadataVersion"><span class="hs-identifier hs-var hs-var">_esLastMetadataVersion</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataResourceVersion"><span class="hs-identifier hs-type">MetadataResourceVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-179"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-180"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621691178020"><span id="local-6989586621691178025"><span class="annot"><span class="annottext">ErrorState -&gt; ErrorState -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: ErrorState -&gt; ErrorState -&gt; Bool
$c/= :: ErrorState -&gt; ErrorState -&gt; Bool
== :: ErrorState -&gt; ErrorState -&gt; Bool
$c== :: ErrorState -&gt; ErrorState -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span class="hs-comment">-- NOTE: The ErrorState type is to be used mainly for the `listener` method below.</span><span>
</span><span id="line-183"></span><span class="hs-comment">--       This will help prevent logging the same error with the same MetadataResourceVersion</span><span>
</span><span id="line-184"></span><span class="hs-comment">--       multiple times consecutively. When the `listener` is in ErrorState we don't log the</span><span>
</span><span id="line-185"></span><span class="hs-comment">--       next error until the resource version has changed/updated.</span><span>
</span><span id="line-186"></span><span>
</span><span id="line-187"></span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#defaultErrorState"><span class="hs-identifier hs-type">defaultErrorState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#ErrorState"><span class="hs-identifier hs-type">ErrorState</span></a></span><span>
</span><span id="line-188"></span><span id="defaultErrorState"><span class="annot"><span class="annottext">defaultErrorState :: ErrorState
</span><a href="Hasura.Server.SchemaUpdate.html#defaultErrorState"><span class="hs-identifier hs-var hs-var">defaultErrorState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe QErr -&gt; Maybe MetadataResourceVersion -&gt; ErrorState
</span><a href="Hasura.Server.SchemaUpdate.html#ErrorState"><span class="hs-identifier hs-var">ErrorState</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span class="hs-comment">-- | NOTE: this can be updated to use lenses</span><span>
</span><span id="line-191"></span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#updateErrorInState"><span class="hs-identifier hs-type">updateErrorInState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#ErrorState"><span class="hs-identifier hs-type">ErrorState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataResourceVersion"><span class="hs-identifier hs-type">MetadataResourceVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#ErrorState"><span class="hs-identifier hs-type">ErrorState</span></a></span><span>
</span><span id="line-192"></span><span id="updateErrorInState"><span class="annot"><span class="annottext">updateErrorInState :: ErrorState -&gt; QErr -&gt; MetadataResourceVersion -&gt; ErrorState
</span><a href="Hasura.Server.SchemaUpdate.html#updateErrorInState"><span class="hs-identifier hs-var hs-var">updateErrorInState</span></a></span></span><span> </span><span id="local-6989586621691178016"><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621691178016"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span id="local-6989586621691178015"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621691178015"><span class="hs-identifier hs-var">qerr</span></a></span></span><span> </span><span id="local-6989586621691178014"><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621691178014"><span class="hs-identifier hs-var">mrv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-193"></span><span>  </span><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621691178016"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-194"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_esLastErrorSeen :: Maybe QErr
</span><a href="Hasura.Server.SchemaUpdate.html#_esLastErrorSeen"><span class="hs-identifier hs-var">_esLastErrorSeen</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621691178015"><span class="hs-identifier hs-var">qerr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-195"></span><span>      </span><span class="annot"><span class="annottext">_esLastMetadataVersion :: Maybe MetadataResourceVersion
</span><a href="Hasura.Server.SchemaUpdate.html#_esLastMetadataVersion"><span class="hs-identifier hs-var">_esLastMetadataVersion</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621691178014"><span class="hs-identifier hs-var">mrv</span></a></span><span>
</span><span id="line-196"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#isInErrorState"><span class="hs-identifier hs-type">isInErrorState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#ErrorState"><span class="hs-identifier hs-type">ErrorState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-199"></span><span id="isInErrorState"><span class="annot"><span class="annottext">isInErrorState :: ErrorState -&gt; Bool
</span><a href="Hasura.Server.SchemaUpdate.html#isInErrorState"><span class="hs-identifier hs-var hs-var">isInErrorState</span></a></span></span><span> </span><span id="local-6989586621691178012"><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621691178012"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-200"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Maybe a -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">isJust</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorState -&gt; Maybe QErr
</span><a href="Hasura.Server.SchemaUpdate.html#_esLastErrorSeen"><span class="hs-identifier hs-var">_esLastErrorSeen</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621691178012"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Maybe a -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">isJust</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorState -&gt; Maybe MetadataResourceVersion
</span><a href="Hasura.Server.SchemaUpdate.html#_esLastMetadataVersion"><span class="hs-identifier hs-var">_esLastMetadataVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621691178012"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#toLogError"><span class="hs-identifier hs-type">toLogError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#ErrorState"><span class="hs-identifier hs-type">ErrorState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataResourceVersion"><span class="hs-identifier hs-type">MetadataResourceVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-203"></span><span id="toLogError"><span class="annot"><span class="annottext">toLogError :: ErrorState -&gt; QErr -&gt; MetadataResourceVersion -&gt; Bool
</span><a href="Hasura.Server.SchemaUpdate.html#toLogError"><span class="hs-identifier hs-var hs-var">toLogError</span></a></span></span><span> </span><span id="local-6989586621691178007"><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621691178007"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span id="local-6989586621691178006"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621691178006"><span class="hs-identifier hs-var">qerr</span></a></span></span><span> </span><span id="local-6989586621691178005"><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621691178005"><span class="hs-identifier hs-var">mrv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621691178003"><span class="hs-identifier hs-var">isQErrLastSeen</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">||</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621691178001"><span class="hs-identifier hs-var">isMetadataResourceVersionLastSeen</span></a></span><span>
</span><span id="line-204"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-205"></span><span>    </span><span id="local-6989586621691178003"><span class="annot"><span class="annottext">isQErrLastSeen :: Bool
</span><a href="#local-6989586621691178003"><span class="hs-identifier hs-var hs-var">isQErrLastSeen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ErrorState -&gt; Maybe QErr
</span><a href="Hasura.Server.SchemaUpdate.html#_esLastErrorSeen"><span class="hs-identifier hs-var">_esLastErrorSeen</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621691178007"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-206"></span><span>      </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621691178000"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621691178000"><span class="hs-identifier hs-var">lErrS</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621691178000"><span class="hs-identifier hs-var">lErrS</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621691178006"><span class="hs-identifier hs-var">qerr</span></a></span><span>
</span><span id="line-207"></span><span>      </span><span class="annot"><span class="annottext">Maybe QErr
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-208"></span><span>
</span><span id="line-209"></span><span>    </span><span id="local-6989586621691178001"><span class="annot"><span class="annottext">isMetadataResourceVersionLastSeen :: Bool
</span><a href="#local-6989586621691178001"><span class="hs-identifier hs-var hs-var">isMetadataResourceVersionLastSeen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ErrorState -&gt; Maybe MetadataResourceVersion
</span><a href="Hasura.Server.SchemaUpdate.html#_esLastMetadataVersion"><span class="hs-identifier hs-var">_esLastMetadataVersion</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621691178007"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-210"></span><span>      </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621691177999"><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621691177999"><span class="hs-identifier hs-var">lMRV</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621691177999"><span class="hs-identifier hs-var">lMRV</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621691178005"><span class="hs-identifier hs-var">mrv</span></a></span><span>
</span><span id="line-211"></span><span>      </span><span class="annot"><span class="annottext">Maybe MetadataResourceVersion
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span class="hs-comment">-- | An IO action that listens to postgres for events and pushes them to a Queue, in a loop forever.</span><span>
</span><span id="line-214"></span><span id="local-6989586621691178491"><span id="local-6989586621691178492"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#listener"><span class="hs-identifier hs-type">listener</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-215"></span><span>  </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178492"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-216"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-217"></span><span>  </span><span class="annot"><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.2.5/pg-client-0.1.0/opt/doc/html/pg-client/src"><span class="hs-identifier hs-type">PG.PGPool</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-218"></span><span>  </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/stm-2.5.0.2/src"><span class="hs-identifier hs-type">STM.TMVar</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataResourceVersion"><span class="hs-identifier hs-type">MetadataResourceVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-219"></span><span>  </span><span class="annot"><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.2.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-type">Milliseconds</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-220"></span><span>  </span><span class="annot"><a href="#local-6989586621691178492"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178491"><span class="hs-identifier hs-type">void</span></a></span></span></span><span>
</span><span id="line-221"></span><span id="listener"><span class="annot"><span class="annottext">listener :: forall (m :: * -&gt; *) void.
MonadIO m =&gt;
Logger Hasura
-&gt; PGPool
-&gt; TMVar MetadataResourceVersion
-&gt; Milliseconds
-&gt; m void
</span><a href="Hasura.Server.SchemaUpdate.html#listener"><span class="hs-identifier hs-var hs-var">listener</span></a></span></span><span> </span><span id="local-6989586621691177962"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621691177962"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621691177961"><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621691177961"><span class="hs-identifier hs-var">pool</span></a></span></span><span> </span><span id="local-6989586621691177960"><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
</span><a href="#local-6989586621691177960"><span class="hs-identifier hs-var">metaVersionRef</span></a></span></span><span> </span><span id="local-6989586621691177959"><span class="annot"><span class="annottext">Milliseconds
</span><a href="#local-6989586621691177959"><span class="hs-identifier hs-var">interval</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m a) -&gt; a -&gt; m b
</span><span class="hs-identifier hs-var">L.iterateM_</span></span><span> </span><span class="annot"><span class="annottext">ErrorState -&gt; m ErrorState
</span><a href="#local-6989586621691177957"><span class="hs-identifier hs-var">listenerLoop</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorState
</span><a href="Hasura.Server.SchemaUpdate.html#defaultErrorState"><span class="hs-identifier hs-var">defaultErrorState</span></a></span><span>
</span><span id="line-222"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-223"></span><span>    </span><span id="local-6989586621691177957"><span class="annot"><span class="annottext">listenerLoop :: ErrorState -&gt; m ErrorState
</span><a href="#local-6989586621691177957"><span class="hs-identifier hs-var hs-var">listenerLoop</span></a></span></span><span> </span><span id="local-6989586621691177956"><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621691177956"><span class="hs-identifier hs-var">errorState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-224"></span><span>      </span><span id="local-6989586621691177955"><span class="annot"><span class="annottext">Maybe MetadataResourceVersion
</span><a href="#local-6989586621691177955"><span class="hs-identifier hs-var">mrv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. STM a -&gt; IO a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">STM.atomically</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. TMVar a -&gt; STM (Maybe a)
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/stm-2.5.0.2/src"><span class="hs-identifier hs-var">STM.tryTakeTMVar</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
</span><a href="#local-6989586621691177960"><span class="hs-identifier hs-var">metaVersionRef</span></a></span><span>
</span><span id="line-225"></span><span>      </span><span id="local-6989586621691177953"><span class="annot"><span class="annottext">Either QErr ()
</span><a href="#local-6989586621691177953"><span class="hs-identifier hs-var">resp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">PGPool -&gt; TMVar MetadataResourceVersion -&gt; IO (Either QErr ())
</span><a href="Hasura.Server.SchemaUpdate.html#schemaVersionCheckHandler"><span class="hs-identifier hs-var">schemaVersionCheckHandler</span></a></span><span> </span><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621691177961"><span class="hs-identifier hs-var">pool</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
</span><a href="#local-6989586621691177960"><span class="hs-identifier hs-var">metaVersionRef</span></a></span><span>
</span><span id="line-226"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621691177952"><span class="annot"><span class="annottext">metadataVersion :: MetadataResourceVersion
</span><a href="#local-6989586621691177952"><span class="hs-identifier hs-var hs-var">metadataVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="Hasura.RQL.Types.SchemaCache.html#initialResourceVersion"><span class="hs-identifier hs-var">initialResourceVersion</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe MetadataResourceVersion
</span><a href="#local-6989586621691177955"><span class="hs-identifier hs-var">mrv</span></a></span><span>
</span><span id="line-227"></span><span>      </span><span id="local-6989586621691177949"><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621691177949"><span class="hs-identifier hs-var">nextErr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either QErr ()
</span><a href="#local-6989586621691177953"><span class="hs-identifier hs-var">resp</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-228"></span><span>        </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621691177948"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621691177948"><span class="hs-identifier hs-var">respErr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-229"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ErrorState -&gt; QErr -&gt; MetadataResourceVersion -&gt; Bool
</span><a href="Hasura.Server.SchemaUpdate.html#toLogError"><span class="hs-identifier hs-var">toLogError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621691177956"><span class="hs-identifier hs-var">errorState</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621691177948"><span class="hs-identifier hs-var">respErr</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621691177952"><span class="hs-identifier hs-var">metadataVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-230"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-231"></span><span>              </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, ToJSON a) =&gt;
Logger Hasura -&gt; SchemaSyncThreadType -&gt; a -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logError"><span class="hs-identifier hs-var">logError</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621691177962"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaSyncThreadType
</span><a href="Hasura.Server.Logging.html#TTListener"><span class="hs-identifier hs-var">TTListener</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; ThreadError
</span><a href="Hasura.Server.SchemaUpdate.html#TEQueryError"><span class="hs-identifier hs-var">TEQueryError</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621691177948"><span class="hs-identifier hs-var">respErr</span></a></span><span>
</span><span id="line-232"></span><span>              </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadIO m =&gt;
Logger Hasura -&gt; SchemaSyncThreadType -&gt; Value -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logInfo"><span class="hs-identifier hs-var">logInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621691177962"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaSyncThreadType
</span><a href="Hasura.Server.Logging.html#TTListener"><span class="hs-identifier hs-var">TTListener</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">object</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;metadataResourceVersion&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621691177952"><span class="hs-identifier hs-var">metadataVersion</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-233"></span><span>              </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorState -&gt; QErr -&gt; MetadataResourceVersion -&gt; ErrorState
</span><a href="Hasura.Server.SchemaUpdate.html#updateErrorInState"><span class="hs-identifier hs-var">updateErrorInState</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621691177956"><span class="hs-identifier hs-var">errorState</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621691177948"><span class="hs-identifier hs-var">respErr</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621691177952"><span class="hs-identifier hs-var">metadataVersion</span></a></span><span>
</span><span id="line-234"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-235"></span><span>              </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621691177956"><span class="hs-identifier hs-var">errorState</span></a></span><span>
</span><span id="line-236"></span><span>        </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-237"></span><span>          </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ErrorState -&gt; Bool
</span><a href="Hasura.Server.SchemaUpdate.html#isInErrorState"><span class="hs-identifier hs-var">isInErrorState</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621691177956"><span class="hs-identifier hs-var">errorState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-238"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadIO m =&gt;
Logger Hasura -&gt; SchemaSyncThreadType -&gt; Value -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logInfo"><span class="hs-identifier hs-var">logInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621691177962"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaSyncThreadType
</span><a href="Hasura.Server.Logging.html#TTListener"><span class="hs-identifier hs-var">TTListener</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-239"></span><span>              </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">object</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;message&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;SchemaSync Restored...&quot;</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-240"></span><span>          </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorState
</span><a href="Hasura.Server.SchemaUpdate.html#defaultErrorState"><span class="hs-identifier hs-var">defaultErrorState</span></a></span><span>
</span><span id="line-241"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; IO ()
</span><a href="Control.Concurrent.Extended.html#sleep"><span class="hs-identifier hs-var">C.sleep</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Milliseconds -&gt; DiffTime
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.2.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">milliseconds</span></a></span><span> </span><span class="annot"><span class="annottext">Milliseconds
</span><a href="#local-6989586621691177959"><span class="hs-identifier hs-var">interval</span></a></span><span>
</span><span id="line-242"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorState
</span><a href="#local-6989586621691177949"><span class="hs-identifier hs-var">nextErr</span></a></span><span>
</span><span id="line-243"></span><span>
</span><span id="line-244"></span><span class="hs-comment">-- | An IO action that processes events from Queue, in a loop forever.</span><span>
</span><span id="line-245"></span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#processor"><span class="hs-identifier hs-type">processor</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621691178443"><span class="annot"><a href="#local-6989586621691178443"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621691178441"><span class="annot"><a href="#local-6989586621691178441"><span class="hs-identifier hs-type">void</span></a></span></span><span> </span><span id="local-6989586621691178442"><span class="annot"><a href="#local-6989586621691178442"><span class="hs-identifier hs-type">impl</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-247"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Control.Concurrent.Extended.html#ForkableMonadIO"><span class="hs-identifier hs-type">C.ForkableMonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178443"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-248"></span><span>    </span><span class="annot"><a href="Hasura.App.State.html#HasAppEnv"><span class="hs-identifier hs-type">HasAppEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178443"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-249"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Config.html#HasCacheStaticConfig"><span class="hs-identifier hs-type">HasCacheStaticConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178443"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-250"></span><span>    </span><span class="annot"><a href="Hasura.Metadata.Class.html#MonadMetadataStorage"><span class="hs-identifier hs-type">MonadMetadataStorage</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178443"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-251"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MonadResolveSource"><span class="hs-identifier hs-type">MonadResolveSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178443"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-252"></span><span>    </span><span class="annot"><a href="Hasura.Services.Network.html#ProvidesNetwork"><span class="hs-identifier hs-type">ProvidesNetwork</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178443"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-254"></span><span>  </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/stm-2.5.0.2/src"><span class="hs-identifier hs-type">STM.TMVar</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataResourceVersion"><span class="hs-identifier hs-type">MetadataResourceVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-255"></span><span>  </span><span class="annot"><a href="Hasura.Server.AppStateRef.html#AppStateRef"><span class="hs-identifier hs-type">AppStateRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178442"><span class="hs-identifier hs-type">impl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-256"></span><span>  </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">STM.TVar</span></a></span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-257"></span><span>  </span><span class="annot"><a href="#local-6989586621691178443"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178441"><span class="hs-identifier hs-type">void</span></a></span><span>
</span><span id="line-258"></span><span id="processor"><span class="annot"><span class="annottext">processor :: forall (m :: * -&gt; *) void impl.
(ForkableMonadIO m, HasAppEnv m, HasCacheStaticConfig m,
 MonadMetadataStorage m, MonadResolveSource m, ProvidesNetwork m) =&gt;
TMVar MetadataResourceVersion
-&gt; AppStateRef impl -&gt; TVar Bool -&gt; m void
</span><a href="Hasura.Server.SchemaUpdate.html#processor"><span class="hs-identifier hs-var hs-var">processor</span></a></span></span><span>
</span><span id="line-259"></span><span>  </span><span id="local-6989586621691177922"><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
</span><a href="#local-6989586621691177922"><span class="hs-identifier hs-var">metaVersionRef</span></a></span></span><span>
</span><span id="line-260"></span><span>  </span><span id="local-6989586621691177921"><span class="annot"><span class="annottext">AppStateRef impl
</span><a href="#local-6989586621691177921"><span class="hs-identifier hs-var">appStateRef</span></a></span></span><span>
</span><span id="line-261"></span><span>  </span><span id="local-6989586621691177920"><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621691177920"><span class="hs-identifier hs-var">logTVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">forever</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-262"></span><span>    </span><span id="local-6989586621691177918"><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621691177918"><span class="hs-identifier hs-var">metaVersion</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. STM a -&gt; IO a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">STM.atomically</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. TMVar a -&gt; STM a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/stm-2.5.0.2/src"><span class="hs-identifier hs-var">STM.takeTMVar</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
</span><a href="#local-6989586621691177922"><span class="hs-identifier hs-var">metaVersionRef</span></a></span><span>
</span><span id="line-263"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) impl.
(MonadIO m, MonadBaseControl IO m, HasAppEnv m,
 HasCacheStaticConfig m, MonadMetadataStorage m,
 MonadResolveSource m, ProvidesNetwork m) =&gt;
MetadataResourceVersion
-&gt; AppStateRef impl -&gt; SchemaSyncThreadType -&gt; TVar Bool -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#refreshSchemaCache"><span class="hs-identifier hs-var">refreshSchemaCache</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621691177918"><span class="hs-identifier hs-var">metaVersion</span></a></span><span> </span><span class="annot"><span class="annottext">AppStateRef impl
</span><a href="#local-6989586621691177921"><span class="hs-identifier hs-var">appStateRef</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaSyncThreadType
</span><a href="Hasura.Server.Logging.html#TTProcessor"><span class="hs-identifier hs-var">TTProcessor</span></a></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621691177920"><span class="hs-identifier hs-var">logTVar</span></a></span><span>
</span><span id="line-264"></span><span>
</span><span id="line-265"></span><span id="local-6989586621691178390"><span id="local-6989586621691178391"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#refreshSchemaCache"><span class="hs-identifier hs-type">refreshSchemaCache</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-266"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178391"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-267"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178391"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-268"></span><span>    </span><span class="annot"><a href="Hasura.App.State.html#HasAppEnv"><span class="hs-identifier hs-type">HasAppEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178391"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-269"></span><span>    </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Config.html#HasCacheStaticConfig"><span class="hs-identifier hs-type">HasCacheStaticConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178391"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-270"></span><span>    </span><span class="annot"><a href="Hasura.Metadata.Class.html#MonadMetadataStorage"><span class="hs-identifier hs-type">MonadMetadataStorage</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178391"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-271"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MonadResolveSource"><span class="hs-identifier hs-type">MonadResolveSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178391"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-272"></span><span>    </span><span class="annot"><a href="Hasura.Services.Network.html#ProvidesNetwork"><span class="hs-identifier hs-type">ProvidesNetwork</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178391"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-273"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-274"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataResourceVersion"><span class="hs-identifier hs-type">MetadataResourceVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-275"></span><span>  </span><span class="annot"><a href="Hasura.Server.AppStateRef.html#AppStateRef"><span class="hs-identifier hs-type">AppStateRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178390"><span class="hs-identifier hs-type">impl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-276"></span><span>  </span><span class="annot"><a href="Hasura.Server.Logging.html#SchemaSyncThreadType"><span class="hs-identifier hs-type">SchemaSyncThreadType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-277"></span><span>  </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">STM.TVar</span></a></span><span> </span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-278"></span><span>  </span><span class="annot"><a href="#local-6989586621691178391"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-279"></span><span id="refreshSchemaCache"><span class="annot"><span class="annottext">refreshSchemaCache :: forall (m :: * -&gt; *) impl.
(MonadIO m, MonadBaseControl IO m, HasAppEnv m,
 HasCacheStaticConfig m, MonadMetadataStorage m,
 MonadResolveSource m, ProvidesNetwork m) =&gt;
MetadataResourceVersion
-&gt; AppStateRef impl -&gt; SchemaSyncThreadType -&gt; TVar Bool -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#refreshSchemaCache"><span class="hs-identifier hs-var hs-var">refreshSchemaCache</span></a></span></span><span>
</span><span id="line-280"></span><span>  </span><span id="local-6989586621691177794"><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621691177794"><span class="hs-identifier hs-var">resourceVersion</span></a></span></span><span>
</span><span id="line-281"></span><span>  </span><span id="local-6989586621691177793"><span class="annot"><span class="annottext">AppStateRef impl
</span><a href="#local-6989586621691177793"><span class="hs-identifier hs-var">appStateRef</span></a></span></span><span>
</span><span id="line-282"></span><span>  </span><span id="local-6989586621691177792"><span class="annot"><span class="annottext">SchemaSyncThreadType
</span><a href="#local-6989586621691177792"><span class="hs-identifier hs-var">threadType</span></a></span></span><span>
</span><span id="line-283"></span><span>  </span><span id="local-6989586621691177791"><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621691177791"><span class="hs-identifier hs-var">logTVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-284"></span><span>    </span><span id="local-6989586621691177790"><span class="annot"><span class="annottext">appEnv :: AppEnv
</span><a href="#local-6989586621691177790"><span class="hs-identifier hs-var">appEnv</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.App.State.html#AppEnv"><span class="hs-identifier hs-type">AppEnv</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621691177761"><span id="local-6989586621691177762"><span id="local-6989586621691177763"><span id="local-6989586621691177764"><span id="local-6989586621691177765"><span id="local-6989586621691177766"><span id="local-6989586621691177767"><span id="local-6989586621691177768"><span id="local-6989586621691177769"><span id="local-6989586621691177770"><span id="local-6989586621691177771"><span id="local-6989586621691177772"><span id="local-6989586621691177773"><span id="local-6989586621691177774"><span id="local-6989586621691177775"><span id="local-6989586621691177776"><span id="local-6989586621691177777"><span id="local-6989586621691177778"><span id="local-6989586621691177779"><span id="local-6989586621691177780"><span id="local-6989586621691177781"><span id="local-6989586621691177782"><span id="local-6989586621691177783"><span id="local-6989586621691177784"><span id="local-6989586621691177785"><span id="local-6989586621691177786"><span id="local-6989586621691177787"><span id="local-6989586621691177788"><span id="local-6989586621691177789"><span class="annot"><span class="annottext">Maybe Text
Maybe (CredentialCache AgentLicenseKey)
SamplingPolicy
PGPool
ConnParams
TxIsolation
TMVar MetadataResourceVersion
Refined NonNegative Seconds
Manager
CheckFeatureFlag
ServerMetrics
PrometheusMetrics
EventingMode
ReadOnlyMode
MaintenanceMode ()
InstanceId
ShutdownLatch
LockedEventsCtx
LoggingSettings
HostPreference
ConnectionOptions
WSConnectionInitTimeout
KeepAliveDelay
OptionalInterval
Port
SubscriptionsState
Loggers
appEnvLicenseKeyCache :: Maybe (CredentialCache AgentLicenseKey)
appEnvCheckFeatureFlag :: CheckFeatureFlag
appEnvSchemaPollInterval :: OptionalInterval
appEnvGracefulShutdownTimeout :: Refined NonNegative Seconds
appEnvWebSocketConnectionInitTimeout :: WSConnectionInitTimeout
appEnvWebSocketKeepAlive :: KeepAliveDelay
appEnvConnectionOptions :: ConnectionOptions
appEnvConsoleSentryDsn :: Maybe Text
appEnvConsoleAssetsDir :: Maybe Text
appEnvTxIso :: TxIsolation
appEnvConnParams :: ConnParams
appEnvLockedEventsCtx :: LockedEventsCtx
appEnvSubscriptionState :: SubscriptionsState
appEnvTraceSamplingPolicy :: SamplingPolicy
appEnvPrometheusMetrics :: PrometheusMetrics
appEnvMetaVersionRef :: TMVar MetadataResourceVersion
appEnvShutdownLatch :: ShutdownLatch
appEnvServerMetrics :: ServerMetrics
appEnvEnableReadOnlyMode :: ReadOnlyMode
appEnvEventingMode :: EventingMode
appEnvLoggingSettings :: LoggingSettings
appEnvEnableMaintenanceMode :: MaintenanceMode ()
appEnvInstanceId :: InstanceId
appEnvMetadataVersionRef :: TMVar MetadataResourceVersion
appEnvLoggers :: Loggers
appEnvManager :: Manager
appEnvMetadataDbPool :: PGPool
appEnvHost :: HostPreference
appEnvPort :: Port
appEnvLicenseKeyCache :: AppEnv -&gt; Maybe (CredentialCache AgentLicenseKey)
appEnvCheckFeatureFlag :: AppEnv -&gt; CheckFeatureFlag
appEnvSchemaPollInterval :: AppEnv -&gt; OptionalInterval
appEnvGracefulShutdownTimeout :: AppEnv -&gt; Refined NonNegative Seconds
appEnvWebSocketConnectionInitTimeout :: AppEnv -&gt; WSConnectionInitTimeout
appEnvWebSocketKeepAlive :: AppEnv -&gt; KeepAliveDelay
appEnvConnectionOptions :: AppEnv -&gt; ConnectionOptions
appEnvConsoleSentryDsn :: AppEnv -&gt; Maybe Text
appEnvConsoleAssetsDir :: AppEnv -&gt; Maybe Text
appEnvTxIso :: AppEnv -&gt; TxIsolation
appEnvConnParams :: AppEnv -&gt; ConnParams
appEnvLockedEventsCtx :: AppEnv -&gt; LockedEventsCtx
appEnvSubscriptionState :: AppEnv -&gt; SubscriptionsState
appEnvTraceSamplingPolicy :: AppEnv -&gt; SamplingPolicy
appEnvPrometheusMetrics :: AppEnv -&gt; PrometheusMetrics
appEnvMetaVersionRef :: AppEnv -&gt; TMVar MetadataResourceVersion
appEnvShutdownLatch :: AppEnv -&gt; ShutdownLatch
appEnvServerMetrics :: AppEnv -&gt; ServerMetrics
appEnvEnableReadOnlyMode :: AppEnv -&gt; ReadOnlyMode
appEnvEventingMode :: AppEnv -&gt; EventingMode
appEnvLoggingSettings :: AppEnv -&gt; LoggingSettings
appEnvEnableMaintenanceMode :: AppEnv -&gt; MaintenanceMode ()
appEnvInstanceId :: AppEnv -&gt; InstanceId
appEnvMetadataVersionRef :: AppEnv -&gt; TMVar MetadataResourceVersion
appEnvLoggers :: AppEnv -&gt; Loggers
appEnvManager :: AppEnv -&gt; Manager
appEnvMetadataDbPool :: AppEnv -&gt; PGPool
appEnvHost :: AppEnv -&gt; HostPreference
appEnvPort :: AppEnv -&gt; Port
</span><a href="#local-6989586621691177761"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). HasAppEnv m =&gt; m AppEnv
</span><a href="Hasura.App.State.html#askAppEnv"><span class="hs-identifier hs-var">askAppEnv</span></a></span><span>
</span><span id="line-285"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621691177760"><span class="annot"><span class="annottext">logger :: Logger Hasura
</span><a href="#local-6989586621691177760"><span class="hs-identifier hs-var hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Loggers -&gt; Logger Hasura
</span><a href="Hasura.App.State.html#_lsLogger"><span class="hs-identifier hs-var">_lsLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Loggers
</span><a href="#local-6989586621691177785"><span class="hs-identifier hs-var">appEnvLoggers</span></a></span><span>
</span><span id="line-286"></span><span>    </span><span id="local-6989586621691177759"><span class="annot"><span class="annottext">Either QErr ()
</span><a href="#local-6989586621691177759"><span class="hs-identifier hs-var">respErr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/transformers-0.5.6.2/src"><span class="hs-identifier hs-var">runExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-287"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) impl a.
(MonadIO m, MonadBaseControl IO m) =&gt;
AppStateRef impl
-&gt; Logger Hasura
-&gt; Maybe (TVar Bool)
-&gt; m (a, RebuildableSchemaCache)
-&gt; m a
</span><a href="Hasura.Server.AppStateRef.html#withSchemaCacheUpdate"><span class="hs-identifier hs-var">withSchemaCacheUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">AppStateRef impl
</span><a href="#local-6989586621691177793"><span class="hs-identifier hs-var">appStateRef</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621691177760"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621691177791"><span class="hs-identifier hs-var">logTVar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-288"></span><span>        </span><span id="local-6989586621691177758"><span class="annot"><span class="annottext">RebuildableSchemaCache
</span><a href="#local-6989586621691177758"><span class="hs-identifier hs-var">rebuildableCache</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall impl.
AppStateRef impl -&gt; IO (RebuildableSchemaCache, SchemaCacheVer)
</span><a href="Hasura.Server.AppStateRef.html#getRebuildableSchemaCacheWithVersion"><span class="hs-identifier hs-var">getRebuildableSchemaCacheWithVersion</span></a></span><span> </span><span class="annot"><span class="annottext">AppStateRef impl
</span><a href="#local-6989586621691177793"><span class="hs-identifier hs-var">appStateRef</span></a></span><span>
</span><span id="line-289"></span><span>        </span><span id="local-6989586621691177757"><span class="annot"><span class="annottext">AppContext
</span><a href="#local-6989586621691177757"><span class="hs-identifier hs-var">appContext</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall impl. AppStateRef impl -&gt; IO AppContext
</span><a href="Hasura.Server.AppStateRef.html#getAppContext"><span class="hs-identifier hs-var">getAppContext</span></a></span><span> </span><span class="annot"><span class="annottext">AppStateRef impl
</span><a href="#local-6989586621691177793"><span class="hs-identifier hs-var">appStateRef</span></a></span><span>
</span><span id="line-290"></span><span>        </span><span id="local-6989586621691177756"><span class="annot"><span class="annottext">CacheDynamicConfig
</span><a href="#local-6989586621691177756"><span class="hs-identifier hs-var">dynamicConfig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadIO m =&gt;
AppEnv -&gt; AppContext -&gt; m CacheDynamicConfig
</span><a href="Hasura.App.State.html#buildCacheDynamicConfig"><span class="hs-identifier hs-var">buildCacheDynamicConfig</span></a></span><span> </span><span class="annot"><span class="annottext">AppEnv
</span><a href="#local-6989586621691177790"><span class="hs-identifier hs-var">appEnv</span></a></span><span> </span><span class="annot"><span class="annottext">AppContext
</span><a href="#local-6989586621691177757"><span class="hs-identifier hs-var">appContext</span></a></span><span>
</span><span id="line-291"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621691177754"><span class="annot"><span class="annottext">()
</span><a href="#local-6989586621691177754"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621691177753"><span class="annot"><span class="annottext">RebuildableSchemaCache
</span><a href="#local-6989586621691177753"><span class="hs-identifier hs-var">cache</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CacheInvalidations
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-292"></span><span>          </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
Monad m =&gt;
CacheDynamicConfig
-&gt; RebuildableSchemaCache
-&gt; CacheRWT m a
-&gt; m (a, RebuildableSchemaCache, CacheInvalidations)
</span><a href="Hasura.RQL.DDL.Schema.Cache.html#runCacheRWT"><span class="hs-identifier hs-var">runCacheRWT</span></a></span><span> </span><span class="annot"><span class="annottext">CacheDynamicConfig
</span><a href="#local-6989586621691177756"><span class="hs-identifier hs-var">dynamicConfig</span></a></span><span> </span><span class="annot"><span class="annottext">RebuildableSchemaCache
</span><a href="#local-6989586621691177758"><span class="hs-identifier hs-var">rebuildableCache</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-293"></span><span>            </span><span id="local-6989586621691177752"><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621691177752"><span class="hs-identifier hs-var">schemaCache</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). CacheRM m =&gt; m SchemaCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#askSchemaCache"><span class="hs-identifier hs-var">askSchemaCache</span></a></span><span>
</span><span id="line-294"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621691177750"><span class="annot"><span class="annottext">engineResourceVersion :: MetadataResourceVersion
</span><a href="#local-6989586621691177750"><span class="hs-identifier hs-var hs-var">engineResourceVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; MetadataResourceVersion
</span><a href="Hasura.RQL.Types.SchemaCache.html#scMetadataResourceVersion"><span class="hs-identifier hs-var">scMetadataResourceVersion</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621691177752"><span class="hs-identifier hs-var">schemaCache</span></a></span><span>
</span><span id="line-295"></span><span>            </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621691177750"><span class="hs-identifier hs-var">engineResourceVersion</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621691177794"><span class="hs-identifier hs-var">resourceVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-296"></span><span>              </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadIO m =&gt;
Logger Hasura -&gt; SchemaSyncThreadType -&gt; Value -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logInfo"><span class="hs-identifier hs-var">logInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621691177760"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaSyncThreadType
</span><a href="#local-6989586621691177792"><span class="hs-identifier hs-var">threadType</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-297"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; Value
</span><span class="hs-identifier hs-var">String</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-298"></span><span>                  </span><span class="annot"><span class="annottext">[Text] -&gt; Text
</span><span class="hs-identifier hs-var">T.unwords</span></span><span>
</span><span id="line-299"></span><span>                    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Received metadata resource version:&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-300"></span><span>                      </span><span class="annot"><span class="annottext">MetadataResourceVersion -&gt; Text
</span><a href="Hasura.RQL.Types.SchemaCache.html#showMetadataResourceVersion"><span class="hs-identifier hs-var">showMetadataResourceVersion</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621691177794"><span class="hs-identifier hs-var">resourceVersion</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;,&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-301"></span><span>                      </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;different from the current engine resource version:&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-302"></span><span>                      </span><span class="annot"><span class="annottext">MetadataResourceVersion -&gt; Text
</span><a href="Hasura.RQL.Types.SchemaCache.html#showMetadataResourceVersion"><span class="hs-identifier hs-var">showMetadataResourceVersion</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621691177750"><span class="hs-identifier hs-var">engineResourceVersion</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;.&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-303"></span><span>                      </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Trying to update the schema cache.&quot;</span></span><span>
</span><span id="line-304"></span><span>                    </span><span class="hs-special">]</span><span>
</span><span id="line-305"></span><span>
</span><span id="line-306"></span><span>              </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataWithResourceVersion"><span class="hs-identifier hs-type">MetadataWithResourceVersion</span></a></span><span> </span><span id="local-6989586621691177744"><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621691177744"><span class="hs-identifier hs-var">metadata</span></a></span></span><span> </span><span id="local-6989586621691177743"><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621691177743"><span class="hs-identifier hs-var">latestResourceVersion</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.2.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
m (Either QErr MetadataWithResourceVersion)
</span><a href="Hasura.Metadata.Class.html#fetchMetadata"><span class="hs-identifier hs-var">fetchMetadata</span></a></span><span>
</span><span id="line-307"></span><span>
</span><span id="line-308"></span><span>              </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadIO m =&gt;
Logger Hasura -&gt; SchemaSyncThreadType -&gt; Value -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logInfo"><span class="hs-identifier hs-var">logInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621691177760"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaSyncThreadType
</span><a href="#local-6989586621691177792"><span class="hs-identifier hs-var">threadType</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-309"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; Value
</span><span class="hs-identifier hs-var">String</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-310"></span><span>                  </span><span class="annot"><span class="annottext">[Text] -&gt; Text
</span><span class="hs-identifier hs-var">T.unwords</span></span><span>
</span><span id="line-311"></span><span>                    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Fetched metadata with resource version:&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-312"></span><span>                      </span><span class="annot"><span class="annottext">MetadataResourceVersion -&gt; Text
</span><a href="Hasura.RQL.Types.SchemaCache.html#showMetadataResourceVersion"><span class="hs-identifier hs-var">showMetadataResourceVersion</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621691177743"><span class="hs-identifier hs-var">latestResourceVersion</span></a></span><span>
</span><span id="line-313"></span><span>                    </span><span class="hs-special">]</span><span>
</span><span id="line-314"></span><span>
</span><span id="line-315"></span><span>              </span><span id="local-6989586621691177740"><span class="annot"><span class="annottext">[(MetadataResourceVersion, CacheInvalidations)]
</span><a href="#local-6989586621691177740"><span class="hs-identifier hs-var">notifications</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.2.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
MetadataResourceVersion
-&gt; InstanceId
-&gt; m (Either QErr [(MetadataResourceVersion, CacheInvalidations)])
</span><a href="Hasura.Metadata.Class.html#fetchMetadataNotifications"><span class="hs-identifier hs-var">fetchMetadataNotifications</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621691177750"><span class="hs-identifier hs-var">engineResourceVersion</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621691177783"><span class="hs-identifier hs-var">appEnvInstanceId</span></a></span><span>
</span><span id="line-316"></span><span>
</span><span id="line-317"></span><span>              </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[(MetadataResourceVersion, CacheInvalidations)]
</span><a href="#local-6989586621691177740"><span class="hs-identifier hs-var">notifications</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-318"></span><span>                </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-319"></span><span>                  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadIO m =&gt;
Logger Hasura -&gt; SchemaSyncThreadType -&gt; Value -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logInfo"><span class="hs-identifier hs-var">logInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621691177760"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaSyncThreadType
</span><a href="#local-6989586621691177792"><span class="hs-identifier hs-var">threadType</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-320"></span><span>                    </span><span class="annot"><span class="annottext">Text -&gt; Value
</span><span class="hs-identifier hs-var">String</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-321"></span><span>                      </span><span class="annot"><span class="annottext">[Text] -&gt; Text
</span><span class="hs-identifier hs-var">T.unwords</span></span><span>
</span><span id="line-322"></span><span>                        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Fetched metadata notifications and received no notifications. Not updating the schema cache.&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-323"></span><span>                          </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Only setting resource version:&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-324"></span><span>                          </span><span class="annot"><span class="annottext">MetadataResourceVersion -&gt; Text
</span><a href="Hasura.RQL.Types.SchemaCache.html#showMetadataResourceVersion"><span class="hs-identifier hs-var">showMetadataResourceVersion</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621691177743"><span class="hs-identifier hs-var">latestResourceVersion</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-325"></span><span>                          </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;in schema cache&quot;</span></span><span>
</span><span id="line-326"></span><span>                        </span><span class="hs-special">]</span><span>
</span><span id="line-327"></span><span>                  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). CacheRWM m =&gt; MetadataResourceVersion -&gt; m ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#setMetadataResourceVersionInSchemaCache"><span class="hs-identifier hs-var">setMetadataResourceVersionInSchemaCache</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621691177743"><span class="hs-identifier hs-var">latestResourceVersion</span></a></span><span>
</span><span id="line-328"></span><span>                </span><span class="annot"><span class="annottext">[(MetadataResourceVersion, CacheInvalidations)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-329"></span><span>                  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadIO m =&gt;
Logger Hasura -&gt; SchemaSyncThreadType -&gt; Value -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logInfo"><span class="hs-identifier hs-var">logInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621691177760"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaSyncThreadType
</span><a href="#local-6989586621691177792"><span class="hs-identifier hs-var">threadType</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-330"></span><span>                    </span><span class="annot"><span class="annottext">Text -&gt; Value
</span><span class="hs-identifier hs-var">String</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Fetched metadata notifications and received some notifications. Updating the schema cache.&quot;</span></span><span>
</span><span id="line-331"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621691177737"><span class="annot"><span class="annottext">cacheInvalidations :: CacheInvalidations
</span><a href="#local-6989586621691177737"><span class="hs-identifier hs-var hs-var">cacheInvalidations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-332"></span><span>                        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">any</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621691177750"><span class="hs-identifier hs-var">engineResourceVersion</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(MetadataResourceVersion, CacheInvalidations)]
</span><a href="#local-6989586621691177740"><span class="hs-identifier hs-var">notifications</span></a></span><span>
</span><span id="line-333"></span><span>                          </span><span class="hs-keyword">then</span><span> </span><span class="hs-comment">-- If (engineResourceVersion + 1) is in the list of notifications then</span><span>
</span><span id="line-334"></span><span>                          </span><span class="hs-comment">-- we know that we haven't missed any.</span><span>
</span><span id="line-335"></span><span>                            </span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; [a] -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">mconcat</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[(MetadataResourceVersion, CacheInvalidations)]
</span><a href="#local-6989586621691177740"><span class="hs-identifier hs-var">notifications</span></a></span><span>
</span><span id="line-336"></span><span>                          </span><span class="hs-keyword">else</span><span> </span><span class="hs-comment">-- Otherwise we may have missed some notifications so we need to invalidate the</span><span>
</span><span id="line-337"></span><span>                          </span><span class="hs-comment">-- whole cache.</span><span>
</span><span id="line-338"></span><span>
</span><span id="line-339"></span><span>                            </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CacheInvalidations"><span class="hs-identifier hs-type">CacheInvalidations</span></a></span><span>
</span><span id="line-340"></span><span>                              </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ciMetadata :: Bool
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#ciMetadata"><span class="hs-identifier hs-var">ciMetadata</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-341"></span><span>                                </span><span class="annot"><span class="annottext">ciRemoteSchemas :: HashSet RemoteSchemaName
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#ciRemoteSchemas"><span class="hs-identifier hs-var">ciRemoteSchemas</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><span class="hs-identifier hs-var">HS.fromList</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; [RemoteSchemaName]
</span><a href="Hasura.RQL.Types.SchemaCache.html#getAllRemoteSchemas"><span class="hs-identifier hs-var">getAllRemoteSchemas</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621691177752"><span class="hs-identifier hs-var">schemaCache</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-342"></span><span>                                </span><span class="annot"><span class="annottext">ciSources :: HashSet SourceName
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#ciSources"><span class="hs-identifier hs-var">ciSources</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><span class="hs-identifier hs-var">HS.fromList</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall k v. HashMap k v -&gt; [k]
</span><span class="hs-identifier hs-var">HM.keys</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; SourceCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#scSources"><span class="hs-identifier hs-var">scSources</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621691177752"><span class="hs-identifier hs-var">schemaCache</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-343"></span><span>                                </span><span class="annot"><span class="annottext">ciDataConnectors :: HashSet DataConnectorName
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#ciDataConnectors"><span class="hs-identifier hs-var">ciDataConnectors</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-344"></span><span>                                  </span><span class="annot"><span class="annottext">forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><span class="hs-identifier hs-var">HS.fromList</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall k v. HashMap k v -&gt; [k]
</span><span class="hs-identifier hs-var">HM.keys</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType). BackendInfoWrapper b -&gt; BackendInfo b
</span><a href="Hasura.RQL.Types.SchemaCache.html#unBackendInfoWrapper"><span class="hs-identifier hs-var">unBackendInfoWrapper</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-345"></span><span>                                    </span><span class="annot"><span class="annottext">forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
BackendMap i -&gt; Maybe (i b)
</span><a href="Hasura.SQL.BackendMap.html#lookup"><span class="hs-identifier hs-var">BackendMap.lookup</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#DataConnector"><span class="hs-identifier hs-type">DataConnector</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-346"></span><span>                                      </span><span class="annot"><span class="annottext">SchemaCache -&gt; BackendCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#scBackendCache"><span class="hs-identifier hs-var">scBackendCache</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621691177752"><span class="hs-identifier hs-var">schemaCache</span></a></span><span>
</span><span id="line-347"></span><span>                              </span><span class="hs-special">}</span><span>
</span><span id="line-348"></span><span>                  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
CacheRWM m =&gt;
BuildReason -&gt; CacheInvalidations -&gt; Metadata -&gt; m ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#buildSchemaCacheWithOptions"><span class="hs-identifier hs-var">buildSchemaCacheWithOptions</span></a></span><span> </span><span class="annot"><span class="annottext">BuildReason
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#CatalogSync"><span class="hs-identifier hs-var">CatalogSync</span></a></span><span> </span><span class="annot"><span class="annottext">CacheInvalidations
</span><a href="#local-6989586621691177737"><span class="hs-identifier hs-var">cacheInvalidations</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621691177744"><span class="hs-identifier hs-var">metadata</span></a></span><span>
</span><span id="line-349"></span><span>                  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). CacheRWM m =&gt; MetadataResourceVersion -&gt; m ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#setMetadataResourceVersionInSchemaCache"><span class="hs-identifier hs-var">setMetadataResourceVersionInSchemaCache</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621691177743"><span class="hs-identifier hs-var">latestResourceVersion</span></a></span><span>
</span><span id="line-350"></span><span>                  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadIO m =&gt;
Logger Hasura -&gt; SchemaSyncThreadType -&gt; Value -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logInfo"><span class="hs-identifier hs-var">logInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621691177760"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaSyncThreadType
</span><a href="#local-6989586621691177792"><span class="hs-identifier hs-var">threadType</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-351"></span><span>                    </span><span class="annot"><span class="annottext">Text -&gt; Value
</span><span class="hs-identifier hs-var">String</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-352"></span><span>                      </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Schema cache updated with resource version: &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion -&gt; Text
</span><a href="Hasura.RQL.Types.SchemaCache.html#showMetadataResourceVersion"><span class="hs-identifier hs-var">showMetadataResourceVersion</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621691177743"><span class="hs-identifier hs-var">latestResourceVersion</span></a></span><span>
</span><span id="line-353"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">()
</span><a href="#local-6989586621691177754"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RebuildableSchemaCache
</span><a href="#local-6989586621691177753"><span class="hs-identifier hs-var">cache</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-354"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="../file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.2.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src"><span class="hs-identifier hs-var">onLeft</span></a></span><span> </span><span class="annot"><span class="annottext">Either QErr ()
</span><a href="#local-6989586621691177759"><span class="hs-identifier hs-var">respErr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, ToJSON a) =&gt;
Logger Hasura -&gt; SchemaSyncThreadType -&gt; a -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logError"><span class="hs-identifier hs-var">logError</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621691177760"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaSyncThreadType
</span><a href="#local-6989586621691177792"><span class="hs-identifier hs-var">threadType</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; ThreadError
</span><a href="Hasura.Server.SchemaUpdate.html#TEQueryError"><span class="hs-identifier hs-var">TEQueryError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-355"></span><span>
</span><span id="line-356"></span><span id="local-6989586621691178400"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#logInfo"><span class="hs-identifier hs-type">logInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178400"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.Logging.html#SchemaSyncThreadType"><span class="hs-identifier hs-type">SchemaSyncThreadType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621691178400"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-357"></span><span id="logInfo"><span class="annot"><span class="annottext">logInfo :: forall (m :: * -&gt; *).
MonadIO m =&gt;
Logger Hasura -&gt; SchemaSyncThreadType -&gt; Value -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logInfo"><span class="hs-identifier hs-var hs-var">logInfo</span></a></span></span><span> </span><span id="local-6989586621691177714"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621691177714"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621691177713"><span class="annot"><span class="annottext">SchemaSyncThreadType
</span><a href="#local-6989586621691177713"><span class="hs-identifier hs-var">threadType</span></a></span></span><span> </span><span id="local-6989586621691177712"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621691177712"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-358"></span><span>  </span><span class="annot"><span class="annottext">forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621691177714"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-359"></span><span>    </span><span class="annot"><span class="annottext">LogLevel -&gt; SchemaSyncThreadType -&gt; Value -&gt; SchemaSyncLog
</span><a href="Hasura.Server.Logging.html#SchemaSyncLog"><span class="hs-identifier hs-var">SchemaSyncLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaSyncThreadType
</span><a href="#local-6989586621691177713"><span class="hs-identifier hs-var">threadType</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621691177712"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-360"></span><span>
</span><span id="line-361"></span><span id="local-6989586621691178401"><span id="local-6989586621691178402"><span class="annot"><a href="Hasura.Server.SchemaUpdate.html#logError"><span class="hs-identifier hs-type">logError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621691178402"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="annot"><a href="#local-6989586621691178401"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.Logging.html#SchemaSyncThreadType"><span class="hs-identifier hs-type">SchemaSyncThreadType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621691178401"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621691178402"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-362"></span><span id="logError"><span class="annot"><span class="annottext">logError :: forall (m :: * -&gt; *) a.
(MonadIO m, ToJSON a) =&gt;
Logger Hasura -&gt; SchemaSyncThreadType -&gt; a -&gt; m ()
</span><a href="Hasura.Server.SchemaUpdate.html#logError"><span class="hs-identifier hs-var hs-var">logError</span></a></span></span><span> </span><span id="local-6989586621691177700"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621691177700"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621691177699"><span class="annot"><span class="annottext">SchemaSyncThreadType
</span><a href="#local-6989586621691177699"><span class="hs-identifier hs-var">threadType</span></a></span></span><span> </span><span id="local-6989586621691177698"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621691177698"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-363"></span><span>  </span><span class="annot"><span class="annottext">forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621691177700"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-364"></span><span>    </span><span class="annot"><span class="annottext">LogLevel -&gt; SchemaSyncThreadType -&gt; Value -&gt; SchemaSyncLog
</span><a href="Hasura.Server.Logging.html#SchemaSyncLog"><span class="hs-identifier hs-var">SchemaSyncLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelError"><span class="hs-identifier hs-var">LevelError</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaSyncThreadType
</span><a href="#local-6989586621691177699"><span class="hs-identifier hs-var">threadType</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///root/.ghcup/ghc/9.2.5/share/doc/ghc-9.2.5/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-365"></span><span>      </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">object</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;error&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621691177698"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-366"></span></pre></body></html>